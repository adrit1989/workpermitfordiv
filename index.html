<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    
    <style nonce="NONCE_PLACEHOLDER">
        /* --- GLOBAL STYLES --- */
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .glass { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        input, select, textarea { width: 100%; border: 1px solid #d1d5db; padding: 10px 12px; border-radius: 8px; font-size: 1rem; background: #fff; margin-bottom: 0.5rem; }
        input:focus, select:focus, textarea:focus { border-color: #ea580c; outline: none; ring: 2px solid #fdba74; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
        button { touch-action: manipulation; transition: transform 0.1s; cursor: pointer; }
        button:active { transform: scale(0.98); }
        .section-title { font-weight: 800; color: #c2410c; margin: 1.5rem 0 1rem 0; border-bottom: 2px solid #fdba74; padding-bottom: 0.5rem; font-size: 1.1rem; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5rem; color: #ea580c; font-weight: bold; flex-direction: column; gap: 10px; }
        
        .btn-pdf { display: inline-block; padding: 8px 12px; background-color: #dc2626; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.8rem; text-align: center; cursor: pointer; }
        .btn-pdf:hover { background-color: #b91c1c; }

        /* Mobile Responsive Table */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; position: relative; background: white; }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; padding: 0.75rem 0; text-align: right; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: 600; margin-right: 1rem; color: #6b7280; flex-shrink: 0; }
            .checklist-row { flex-direction: column; align-items: flex-start; }
            #actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 1rem; z-index: 100; flex-direction: column; gap: 0.5rem; }
            #actions button { width: 100%; padding: 12px; font-size: 1.1rem; }
            #view-map { flex-direction: column; }
            #map-list { height: 35%; width: 100%; order: 2; border-top: 2px solid #ccc; }
            #map-container { height: 65%; width: 100%; order: 1; }
        }
        @media (min-width: 769px) {
            .desktop-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
            table.mobile-table { width: 100%; border-collapse: collapse; display: table; }
            table.mobile-table thead { display: table-header-group; background: #ea580c; color: white; }
            table.mobile-table th { padding: 12px; text-align: left; border-bottom: 2px solid #c2410c; }
            table.mobile-table tr { display: table-row; }
            table.mobile-table td { display: table-cell; border-bottom: 1px solid #e5e7eb; padding: 12px; vertical-align: top; }
            #view-map { flex-direction: row; }
            #map-list { width: 350px; height: 100%; border-right: 1px solid #ddd; overflow-y: auto; }
            #map-container { flex: 1; height: 100%; }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-600 mx-auto mb-2"></div>
        <div class="font-bold text-orange-600">Processing...</div>
    </div>

    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 bg-orange-50">
        <div class="glass w-full max-w-md text-center shadow-xl border-t-4 border-orange-600">
           <div class="flex justify-center items-center gap-4 mb-4">
                <img src="/public/logo.png" alt="IOCL Logo" class="h-24 object-contain">
                <img src="/public/rhino.png" alt="Rhino Logo" class="h-24 object-contain">
            </div>
            <h1 class="text-3xl font-extrabold text-orange-600 mb-2">IndianOil</h1>
            <p class="text-gray-500 mb-6 font-semibold"> Mainline Work Permit System (By ERPL)</p>
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Role</label>
                    <select id="login-role" class="w-full bg-gray-50 h-12">
                        <option value="Requester">Requester</option>
                        <option value="Reviewer">Reviewer</option>
                        <option value="Approver">Approver</option>
                    </select>
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">User</label><select id="login-name" class="w-full bg-gray-50 h-12" disabled><option>Loading Users...</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-50 h-12"></div>
                <button type="submit" class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg hover:bg-orange-700">Sign In</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-2 pb-24 hidden desktop-container">
        
        <div class="mb-4">
            <img src="/public/safety_banner.png" alt="Golden Safety Rules" class="w-full h-auto rounded-xl shadow-lg border-2 border-orange-600 object-cover">
        </div>
        
        <div class="flex justify-between items-center mb-4 bg-orange-600 p-4 rounded-xl shadow-lg text-white sticky top-2 z-40">
           <div class="flex items-center gap-3">
                <img src="/public/logo.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <img src="/public/rhino.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <div class="flex flex-col"><h1 class="text-lg font-bold leading-tight">Mainline Permit System </h1><span id="user-info" class="text-xs text-orange-100 font-medium"></span></div>
           </div>
           <div class="flex gap-2">
               <button id="btn-nav-worker" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Workers">üë∑</button>
               <button id="btn-nav-map" class="bg-white/20 p-2 rounded-lg hover:bg-white/30 hidden" title="Map">üó∫Ô∏è</button>
               <button id="btn-nav-logout" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Logout">üö™</button>
            </div>
        </div>

        <div id="view-worker-management" class="hidden">
             <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Worker Management</h2><button id="btn-back-worker" class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded">‚Üê Back</button></div>
             
             <div id="worker-form-container" class="glass hidden border-l-4 border-blue-500 animate-fade-in">
                 <h3 class="font-bold mb-3 text-lg">Add/Edit Worker</h3>
                 <form id="worker-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                     <input type="hidden" id="w-id">
                     <input id="w-name" placeholder="Full Name" required>
                     <input id="w-father" placeholder="Father's Name" required>
                     <input id="w-address" placeholder="Address">
                     <input id="w-contact" placeholder="Contact No" type="tel">
                     <div>
                         <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Any Other</option></select>
                         <input id="w-id-type-other" placeholder="Specify ID Type" class="hidden bg-yellow-50 mt-1">
                     </div>
                     <input id="w-idcard" placeholder="ID Number (No Aadhar)" required>
                     <select id="w-gender"><option>Male</option><option>Female</option></select>
                     <input id="w-age" type="number" placeholder="Age (Must be 18+)" min="18" required>
                     <button type="submit" class="bg-green-600 text-white py-3 rounded-lg font-bold mt-2 shadow md:col-span-2">Save Worker</button>
                 </form>
             </div>
             
             <button id="btn-add-worker" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold mb-4 shadow hidden">+ Add New Worker</button>
             <table class="mobile-table w-full text-left text-sm" id="table-workers">
                 <thead class="hidden md:table-header-group bg-gray-100 text-gray-700"><tr><th>Name</th><th>Father Name</th><th>ID Details</th><th>Address & Contact</th><th>Requestor</th><th>Status</th><th>Action</th></tr></thead>
                 <tbody class="divide-y divide-gray-200"></tbody>
             </table>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="text-xl font-bold text-gray-800">Dashboard</h2>
                <button id="btn-new-permit" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow hidden">+ New</button>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button id="btn-add-user" class="bg-purple-100 text-purple-700 py-2 rounded font-bold text-sm hidden">Users</button>
                <button id="btn-view-map" class="bg-blue-100 text-blue-700 py-2 rounded font-bold text-sm hidden">Map</button>
                <button id="btn-download-excel" class="bg-green-100 text-green-700 py-2 rounded font-bold text-sm hidden">Excel</button>
            </div>

            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
                <div class="glass h-64"><canvas id="chartStatus"></canvas></div>
                <div class="glass h-64"><canvas id="chartType"></canvas></div>
            </div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Action Required</h3>
            <div class="mb-6 overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-pending"><thead class="bg-red-50 text-red-900 border-b-2 border-red-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Active Permits</h3>
            <div class="mb-6 overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-active"><thead class="bg-green-50 text-green-900 border-b-2 border-green-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Closed / Other</h3>
            <div class="overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-other"><thead class="bg-gray-50 text-gray-700 border-b-2 border-gray-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
        </div>
        
        <div id="view-add-user" class="hidden flex justify-center fixed inset-0 z-50 bg-black/50 items-center p-4">
            <div class="glass w-full max-w-sm relative animate-scale-up">
                <button id="btn-close-adduser" class="absolute top-2 right-2 text-gray-400 hover:text-gray-800 text-xl font-bold px-2">‚úï</button>
                <h3 class="font-bold mb-4 text-lg">Add New User</h3>
                <form id="adduser-form" class="space-y-3">
                    <input id="new-user-name" placeholder="Full Name" required>
                    <input id="new-user-email" placeholder="Email Address" required>
                    <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                    <input id="new-user-pass" type="password" placeholder="Set Password" required>
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button>
                </form>
            </div>
        </div>

        <div id="view-form" class="hidden">
            <div class="flex items-center gap-2 mb-2">
                <button id="btn-back-form" class="bg-white border text-gray-600 px-3 py-2 rounded-lg font-bold shadow-sm">‚Üê Back</button>
                <div id="permit-header-display" class="flex-1 p-2 bg-blue-100 text-blue-800 rounded-lg font-bold text-center text-sm truncate"></div>
            </div>
            
            <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden">
                 <h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers & Approval Status</h3>
                 <div id="assigned-worker-audit" class="overflow-x-auto"></div>
            </div>

            <form id="pf" class="space-y-4">
                <input type="hidden" id="PermitID" name="PermitID">
                <input type="hidden" id="Status" name="Status">
                
                <div class="glass">
                    <h3 class="section-title">1. Permit Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                        <div><label class="text-xs font-bold text-gray-500">Location (GPS)</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coords"><button type="button" id="btn-get-geo" class="bg-orange-100 text-orange-600 px-4 rounded-lg font-bold">üìç GPS</button></div></div>
                        <input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude">
                        <div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                        <div><label class="text-xs font-bold text-gray-500">Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div>
                        <div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom"></div>
                        <div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo"></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName"></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                        <div><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                        <div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly></div>
                        <div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                        <div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                        <div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div>
                        <div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div>
                    </div>
                </div>

                <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50 hidden">
                    <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                        <input type="checkbox" id="chk-init-renewal" class="w-5 h-5"> Request 1st Renewal with Permit
                    </label>
                    <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                        <div class="text-xs font-bold text-gray-500 mb-2">Renewal Details</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                            <input type="datetime-local" name="InitRenFrom" placeholder="From">
                            <input type="datetime-local" name="InitRenTo" placeholder="To">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input name="InitRenHC" placeholder="HC %">
                            <input name="InitRenTox" placeholder="Tox">
                            <input name="InitRenO2" placeholder="O2 %">
                        </div>
                        <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                        <div class="mt-2 border-t pt-2">
                             <label class="text-xs font-bold text-red-600 uppercase block mb-1">Mandatory Photo (1st Renewal)</label>
                             <input type="file" id="ren-cam-1" name="InitRenImage" accept="image/*" capture="environment" class="text-sm">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* Applied to all selected workers</p>
                    </div>
                </div>

                <div class="glass" id="section-e">
                    <h3 class="section-title">E. References</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No">
                        <input name="JsaNo" id="JsaNo" placeholder="JSA No">
                        <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip">
                        <input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                        <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No">
                        <input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"> 
                    </div>
                </div>

                <div class="glass"><h3 class="section-title">2. Checklists</h3><div id="checklists-wrapper" class="space-y-4"></div></div>

                <div class="glass" id="worker-select-section">
                    <h3 class="section-title">Workers</h3>
                    <div id="worker-checkboxes" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    <div id="worker-readonly-table" class="hidden overflow-x-auto"><table class="mobile-table w-full text-xs text-left"><thead class="hidden md:table-header-group"><tr><th>Name</th><th>Gender</th><th>Age</th><th>Contractor</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>

                <div class="glass" id="hazards-section"><h3 class="section-title">3. Hazards</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4" id="hazards-container"></div><div id="other-hazard-div" class="hidden mb-2"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div></div>

                <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500"><h3 class="section-title text-yellow-700">4. Reviewer</h3><div class="mb-4 hidden" id="iocl-reviewer-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label><div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div><button type="button" id="btn-add-rev-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div><div class="mb-2 font-bold text-sm text-gray-600">PPE Required:</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4" id="ppe-container"></div><textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea><textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea></div>
                <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                    <h3 class="section-title text-green-700">5. Approval</h3>
                    <div class="mb-4 hidden" id="iocl-approver-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors (Verify/Edit)</label><div id="iocl-sup-container-app" class="space-y-2 mt-2"></div><button type="button" id="btn-add-app-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div>
                    <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2"></textarea>
                    <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer"><input type="checkbox" id="RequireRenewalPhotos" class="w-5 h-5 accent-green-600"><span class="text-sm font-bold text-green-800">Require Photos for Renewals (Starting 2nd)</span></label>
                    <div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div>
                </div>

                <div id="iocl-sup-display-section" class="glass hidden"><h3 class="section-title">Authorized Supervisors (IOCL)</h3><table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit</th></tr></thead><tbody></tbody></table></div>

                <div id="renewals-section" class="glass hidden">
                    <h3 class="section-title">Renewals</h3>
                    <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse"><h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Request Action</h4><p class="text-sm text-gray-600 mb-2">This permit includes a request for the 1st renewal. Please decide on this renewal now.</p><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer font-bold text-green-700"><input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Recommend / Approve Renewal</label><label class="flex items-center gap-2 cursor-pointer font-bold text-red-700"><input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal Only</label></div></div>
                    <div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 text-sm uppercase">‚ö†Ô∏è Pending Renewal</h4>
                        <div class="text-sm grid grid-cols-1 gap-2 mt-2"><div class="flex justify-between border-b pb-1"><span>From:</span> <span id="disp-ren-from" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>To:</span> <span id="disp-ren-to" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>Gas:</span> <span id="disp-ren-gas" class="font-mono"></span></div><div><span>Prec:</span> <span id="disp-ren-prec"></span></div></div>
                        <div id="odd-hour-approval-controls" class="hidden mt-3 pt-3 border-t border-yellow-300"><div class="flex items-center gap-2 mb-2"><span class="bg-indigo-900 text-white text-xs px-2 py-1 rounded font-bold">NIGHT SHIFT</span><span id="odd-hour-req-status" class="text-xs font-bold text-gray-600"></span></div><label class="flex items-center gap-2 cursor-pointer p-2 bg-white rounded border border-indigo-200"><input type="checkbox" id="odd-hour-allow-check" class="w-5 h-5 accent-indigo-600"><span class="text-sm font-bold text-indigo-800">I allow work during Odd Hours</span></label></div>
                    </div>
                    <div class="overflow-x-auto mb-4"><table class="mobile-table w-full text-xs text-left" id="table-renewals"><thead class="hidden md:table-header-group"><tr><th>Period</th><th>Gas & Precautions</th><th>Workers</th><th>Photo</th><th>Requester</th><th>Reviewer</th><th>Approver</th><th>Status</th></tr></thead><tbody id="renewals-list" class="divide-y"></tbody></table></div>
                    <div id="form-renewal" class="hidden p-4 bg-blue-50 mt-2 rounded-lg border border-blue-100">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-2"><input type="datetime-local" id="RenewalValidFrom"><input type="datetime-local" id="RenewalValidTo"><div class="flex gap-2"><input id="RenewalHC" placeholder="HC %"><input id="RenewalToxic" placeholder="Toxic"><input id="RenewalOxygen" placeholder="O2 %"></div></div>
                        <div id="odd-hour-agreement" class="hidden mb-2 p-2 bg-indigo-100 border border-indigo-300 rounded"><label class="flex items-start gap-2 cursor-pointer"><input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-800"><span class="text-xs font-bold text-indigo-900 text-justify">I agree to take all precautions to execute the work during odd hours, ensuring proper lighting, safety against weather conditions, and active (non-sleepy) workers.</span></label></div>
                        <div class="mt-3 border-t border-blue-200 pt-2 bg-white p-2 rounded"><label class="text-xs font-bold text-gray-500 block mb-1">Workers for this Renewal (Optional - Select from Approved)</label><div id="renewal-worker-select" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div></div>
                        <input id="RenewalPrec" placeholder="Precautions" class="w-full mb-2 mt-3">
                        <div id="renewal-photo-container" class="mt-2 bg-white p-2 rounded border border-red-200 hidden"><label class="text-xs font-bold text-red-600 uppercase block mb-1">Photo (Mandatory if required)</label><input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="text-sm w-full"><p id="photo-mandate-msg" class="text-[10px] text-gray-500 mt-1"></p></div>
                        <button type="button" id="btn-submit-renewal" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow mt-2">Submit Renewal</button>
                    </div>
                    <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded-lg border border-yellow-100"><textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea><div class="grid grid-cols-2 gap-2"><button type="button" id="btn-approve-renewal" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow">Approve</button><button type="button" id="btn-reject-renewal" class="bg-red-600 text-white py-3 rounded-lg font-bold shadow">Reject</button></div></div>
                </div>

                <div id="closure-section" class="glass hidden"><h3 class="section-title">Closure</h3><label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-2 bg-red-50 rounded" id="lbl-site-restored"><input type="checkbox" id="Site_Restored_Check" class="w-5 h-5"> Site Restored & Cleaned</label><div id="div-closure-req" class="hidden space-y-2"><label class="text-xs font-bold text-gray-500">Requester Remarks</label><textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-req" class="text-xs text-gray-400 block text-right"></span></div><div id="div-closure-rev" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Reviewer Remarks</label><textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-rev" class="text-xs text-gray-400 block text-right"></span></div><div id="div-closure-app" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Approver Remarks</label><textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-app" class="text-xs text-gray-400 block text-right"></span></div></div>

                <div id="signature-history" class="glass hidden"><h3 class="section-title">History</h3><div class="grid grid-cols-1 gap-2 text-xs"><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div></div></div>

                <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden"><label class="flex items-start gap-3 p-2 cursor-pointer"><input type="checkbox" id="gsr-check" class="mt-1 w-6 h-6 text-orange-600 rounded"> <span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules. I shall ensure all workers are complied to all these rules and in case of any violation, penalty will be imposed by IOCL and I shall accept such penalties without any further challenge.</span></label></div>

                <div id="actions" class="mt-4 flex flex-col md:flex-row justify-end gap-2 sticky bottom-0 bg-white p-4 shadow-top z-50 border-t"></div>
            </form>
        </div>
        
        <div id="view-map" class="hidden fixed inset-0 z-50 bg-white flex flex-col md:flex-row">
            <div id="map-list" class="bg-white border-r relative z-10 shadow-xl overflow-y-auto">
                <div class="p-3 bg-orange-600 text-white font-bold flex justify-between items-center sticky top-0"><span>Active Permits</span><button id="btn-back-map" class="bg-white text-orange-600 px-2 rounded text-xs font-bold shadow">‚Üê Back</button></div>
                <div id="map-list-content"></div>
            </div>
            <div id="map-container" class="relative"><div id="map" class="w-full h-full"></div></div>
        </div>
    </div>

    <script nonce="NONCE_PLACEHOLDER">
        const API = "/api";
        let authToken = null;
        let currentUser = null;
        let usersData = {};
        let mapInstance = null;
        let chartS = null; 
        let chartT = null;
        let currentPermitId = null;
        let currentPermitWorkers = [];
        let currentRenewalCount = 0;
        let permitRequirePhoto = false;
        let currentPermitIOCLData = [];

        const CL_DATA = { 
            A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test.", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."], 
            B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."], 
            C: ["1. PESO spark elimination."], 
            D: ["1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban."] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        // --- DOM LOADED ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
            renderUI();

            // Event Listeners - Secure Attachment
            document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            document.getElementById('login-role').addEventListener('change', loadUserNames);
            
            document.getElementById('btn-nav-worker')?.addEventListener('click', toggleWorkerMode);
            document.getElementById('btn-nav-map')?.addEventListener('click', showMap);
            document.getElementById('btn-nav-logout')?.addEventListener('click', () => location.reload());
            document.getElementById('btn-back-form')?.addEventListener('click', showDashboard);
            document.getElementById('btn-back-map')?.addEventListener('click', showDashboard);
            document.getElementById('btn-new-permit')?.addEventListener('click', showNewPermit);
            document.getElementById('btn-get-geo')?.addEventListener('click', getGeo);
            
            document.getElementById('btn-back-worker')?.addEventListener('click', toggleWorkerMode);
            document.getElementById('btn-add-worker')?.addEventListener('click', () => openWorkerForm('create'));
            document.getElementById('worker-form')?.addEventListener('submit', (e) => { e.preventDefault(); saveWorker(window.currentWorkerAction); });
            document.getElementById('w-id-type')?.addEventListener('change', toggleOtherID);

            document.getElementById('btn-view-map')?.addEventListener('click', showMap);
            document.getElementById('btn-add-user')?.addEventListener('click', showAddUser);
            document.getElementById('btn-download-excel')?.addEventListener('click', downloadSecureExcel);
            document.getElementById('btn-close-adduser')?.addEventListener('click', () => document.getElementById('view-add-user').classList.add('hidden'));
            document.getElementById('adduser-form')?.addEventListener('submit', (e) => { e.preventDefault(); submitNewUser(); });
            
            document.getElementById('chk-init-renewal')?.addEventListener('change', (e) => {
                 document.getElementById('div-init-renewal').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('RenewalValidFrom')?.addEventListener('change', checkRenewalTime);
            document.getElementById('RenewalValidTo')?.addEventListener('change', checkRenewalTime);
            document.getElementById('odd-hour-allow-check')?.addEventListener('change', toggleRenewalApproveBtn);
            
            document.getElementById('btn-submit-renewal')?.addEventListener('click', () => submitRenewal('approve'));
            document.getElementById('btn-approve-renewal')?.addEventListener('click', () => submitRenewal('approve'));
            document.getElementById('btn-reject-renewal')?.addEventListener('click', () => submitRenewal('reject'));

            // Supervisors Add
            document.getElementById('btn-add-rev-sup')?.addEventListener('click', () => addIOCLRow('iocl-sup-container-rev'));
            document.getElementById('btn-add-app-sup')?.addEventListener('click', () => addIOCLRow('iocl-sup-container-app'));
            
            // Check Dates
            document.getElementById('ValidFrom')?.addEventListener('change', checkDate);
            document.getElementById('ValidTo')?.addEventListener('change', checkDate);
        });

        // --- HELPERS ---
        function escapeHtml(text) {
            if (!text) return text;
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function getNow() { return new Date().toLocaleString("en-GB").replace(',',''); }

        // --- API ---
        async function apiCall(ep, meth="GET", body=null) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const headers = {'Content-Type':'application/json'};
                if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
                const opts={method:meth, headers:headers};
                if(body)opts.body=JSON.stringify(body);
                const res = await fetch(API+ep,opts); 
                if (res.status === 401 || res.status === 403) {
                    alert("Session expired."); location.reload(); return;
                }
                return await res.json();
            } finally { document.getElementById('loader').style.display = 'none'; }
        }

        // --- CORE LOGIC ---
        async function loadUsers() {
            try { const u = await apiCall('/users'); usersData = u; loadUserNames(); } catch(e){}
        }

        function loadUserNames() {
            const role = document.getElementById("login-role").value; 
            const names = usersData[role+'s'] || []; 
            const sel = document.getElementById("login-name"); 
            sel.innerHTML = names.map(u => `<option value="${u.email}">${escapeHtml(u.name)}</option>`).join(''); 
            sel.disabled = false; 
        }

        async function handleLogin() {
            const r=document.getElementById("login-role").value; 
            const n=document.getElementById("login-name").options[document.getElementById("login-name").selectedIndex].text; 
            const e=document.getElementById("login-name").value; 
            const p=document.getElementById("login-password").value; 
            
            const res = await apiCall('/login','POST',{role:r,name:e,password:p}); 
            if(res.success){ 
                currentUser={...res.user, name:n}; 
                authToken = res.token; 
                document.getElementById("view-login").classList.add('hidden'); 
                document.getElementById("app-container").classList.remove('hidden'); 
                document.getElementById("user-info").innerText=`${n} (${r})`; 
                updateRoleUI(); 
                loadDashboard(); 
            } else alert("Invalid Login"); 
        }

        function updateRoleUI() {
            if(currentUser.Role==='Requester') { 
                document.getElementById("btn-new-permit").classList.remove('hidden');
                document.getElementById("btn-add-worker").classList.remove('hidden');
            }
            if(currentUser.Role!=='Requester') { 
                document.getElementById("btn-view-map").classList.remove('hidden'); 
                document.getElementById("btn-header-map").classList.remove('hidden');
                document.getElementById("btn-download-excel").classList.remove('hidden');
                document.getElementById("charts-container").classList.remove('hidden');
                loadStats(); 
                if(currentUser.Role==='Approver') document.getElementById("btn-add-user").classList.remove('hidden');
            }
        }

        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email});
            const tP = document.querySelector('#table-pending tbody');
            const tA = document.querySelector('#table-active tbody');
            const tO = document.querySelector('#table-other tbody');
            tP.innerHTML=""; tA.innerHTML=""; tO.innerHTML="";

            res.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "cursor-pointer hover:bg-orange-50 transition border-b";
                
                // Action Button Logic
                let actionBtn = document.createElement('span');
                actionBtn.className = "bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold";
                actionBtn.innerText = "OPEN";
                
                if (p.Status === 'Closed') {
                    actionBtn = document.createElement('button');
                    actionBtn.className = "btn-pdf";
                    actionBtn.innerText = "Download PDF";
                    actionBtn.onclick = (e) => { e.stopPropagation(); downloadSecurePDF(p.PermitID); };
                }

                // Status Color
                let statusClass = p.Status.includes('Pending') ? 'text-red-600' : (p.Status==='Active' ? 'text-green-600' : 'text-gray-600');
                
                tr.innerHTML = `
                    <td class="font-bold text-blue-600 text-lg">${p.PermitID}</td>
                    <td class="font-medium">${escapeHtml(p.WorkType||'-')}</td>
                    <td class="text-gray-600">${escapeHtml(p.LocationUnit||'-')}</td>
                    <td class="font-bold ${statusClass}">${p.Status}</td>
                    <td class="text-sm text-gray-500">${escapeHtml(p.ReviewerEmail || p.ApproverEmail || '-')}</td>
                    <td></td>
                `;
                tr.lastElementChild.appendChild(actionBtn);

                if(p.Status !== 'Closed') {
                    tr.addEventListener('click', () => openPermit(p.PermitID));
                }

                let isAction = false;
                if(currentUser.Role === 'Reviewer' && p.Status.includes('Review')) isAction = true;
                if(currentUser.Role === 'Approver' && p.Status.includes('Approval')) isAction = true;
                if(currentUser.Role === 'Requester' && p.Status.includes('Pending')) isAction = true;

                if(isAction) tP.appendChild(tr);
                else if(p.Status === 'Active') tA.appendChild(tr);
                else tO.appendChild(tr);
            });
        }

        // --- RENDER UTILS ---
        function renderUI() {
            let h = '';
            ['A','B','C','D'].forEach(sec => {
                h += `<div class="glass p-3"><div class="flex justify-between items-center border-b pb-1 mb-2"><div class="font-bold text-orange-700">SECTION ${sec}</div><div class="flex gap-2 text-xs items-center bg-orange-50 p-1 rounded"><span class="font-bold text-gray-600">Applicability:</span><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="Yes" checked class="sec-toggle" data-sec="${sec}"> Yes</label><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="NA" class="sec-toggle" data-sec="${sec}"> NA</label><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="No" class="sec-toggle" data-sec="${sec}"> No</label></div></div>`;
                h += CL_DATA[sec].map((t, i) => {
                    return `<div class="mb-4 pb-2 border-b border-gray-100"><div class="text-sm font-medium mb-2">${t}</div><div class="flex gap-4 bg-gray-50 p-2 rounded"><label><input type="radio" name="${sec}_Q${i+1}" value="Yes" checked> Yes</label><label><input type="radio" name="${sec}_Q${i+1}" value="NA"> NA</label><label><input type="radio" name="${sec}_Q${i+1}" value="No"> No</label></div>${(sec==='A' && i===11) ? `<div class="flex gap-1 mt-2"><input name="GP_Q12_HC" placeholder="HC%"><input name="GP_Q12_ToxicGas" placeholder="Tox"><input name="GP_Q12_Oxygen" placeholder="O2%"></div>` : `<input name="${sec}_Q${i+1}_Detail" placeholder="Remarks" class="text-sm mt-2 w-full">`}</div>`;
                }).join('');
                h += `</div>`;
            });
            document.getElementById('checklists-wrapper').innerHTML = h;
            // Attach toggle listeners
            document.querySelectorAll('.sec-toggle').forEach(r => r.addEventListener('change', (e) => {
                const val = e.target.value; const sec = e.target.dataset.sec;
                document.querySelectorAll(`input[name^="${sec}_Q"][value="${val}"]`).forEach(rn => rn.checked = true);
            }));

            document.getElementById('hazards-container').innerHTML = HAZARDS.map(z => {
               const id = `H_${z.replace(/ /g,'')}`;
               return `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="${id}" value="Y" ${z==='Others'?'id="chk-haz-others"':''} class="w-5 h-5 text-orange-600"> <span class="text-sm font-medium">${z}</span></label>`;
            }).join('');
            document.getElementById('chk-haz-others')?.addEventListener('change', (e) => document.getElementById('other-hazard-div').classList.toggle('hidden', !e.target.checked));

            document.getElementById('ppe-container').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50 hover:bg-blue-50 transition"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="w-5 h-5 text-blue-600"> <span class="text-sm font-medium">${p}</span></label>`).join('');
        }

        // --- MAP & GEO ---
        function getGeo() {
            if (!navigator.geolocation) return alert("Geolocation not supported");
            const btn = document.getElementById("btn-get-geo");
            btn.innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    safeSet("ExactLocation", `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`);
                    safeSet("Latitude", p.coords.latitude);
                    safeSet("Longitude", p.coords.longitude);
                    btn.innerText = "üìç GPS Set";
                },
                () => { btn.innerText = "üìç Retry"; alert("GPS Failed"); }
            );
        }
        async function loadMapData() { 
            const p = await apiCall('/map-data', 'POST'); 
            if(!mapInstance) mapInstance=new google.maps.Map(document.getElementById("map"),{center:{lat:22.57,lng:88.36},zoom:5}); 
            const listEl = document.getElementById("map-list-content"); listEl.innerHTML = ""; const infoWindow = new google.maps.InfoWindow(); 
            p.forEach(x => { 
                const marker = new google.maps.Marker({position:{lat:x.lat,lng:x.lng}, map:mapInstance}); 
                const item = document.createElement("div"); 
                item.className = "p-3 border-b cursor-pointer hover:bg-orange-50 text-sm"; 
                item.innerText = `${x.PermitID} - ${x.WorkType}`; 
                item.addEventListener('click', () => { mapInstance.setCenter({lat:x.lat,lng:x.lng}); mapInstance.setZoom(12); }); 
                listEl.appendChild(item); 
            }); 
        }
        function showMap() { document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-map").classList.remove('hidden'); loadMapData(); }
        
        // --- WORKER FUNCTIONS ---
        function toggleWorkerMode() {
            const dash = document.getElementById("view-dashboard");
            const work = document.getElementById("view-worker-management");
            if(dash.classList.contains('hidden')) { dash.classList.remove('hidden'); work.classList.add('hidden'); }
            else { dash.classList.add('hidden'); work.classList.remove('hidden'); loadWorkers('dashboard'); }
        }
        function openWorkerForm(act) {
            window.currentWorkerAction = act;
            document.getElementById('worker-form-container').classList.remove('hidden');
            if(act === 'create') document.getElementById('worker-form').reset();
        }
        async function saveWorker(act) {
            const idTypeRaw = document.getElementById("w-id-type").value;
            const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw;
            const body = { 
                Action: act, 
                Role: currentUser.Role, 
                RequestorEmail: currentUser.Email,
                WorkerID: document.getElementById('w-id').value,
                RequestorName: currentUser.name,
                Details: { 
                    Name: document.getElementById("w-name").value,
                    Age: document.getElementById("w-age").value,
                    Father: document.getElementById("w-father").value,
                    Address: document.getElementById("w-address").value,
                    Contact: document.getElementById("w-contact").value,
                    ID: document.getElementById("w-idcard").value,
                    Gender: document.getElementById("w-gender").value,
                    IDType: idTypeFinal
                }
            };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { alert("Saved"); loadWorkers('dashboard'); document.getElementById('worker-form-container').classList.add('hidden'); }
        }
        
        async function loadWorkers(context) { 
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); 
            if(context === 'permit_dropdown') { 
                const con = document.getElementById('worker-checkboxes'); 
                con.innerHTML = res.map(w => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5"> <span class="font-bold">${escapeHtml(w.Name)}</span></label>`).join(''); 
            } else { 
                const t = document.querySelector('#table-workers tbody'); 
                t.innerHTML = "";
                res.forEach(w => {
                    const row = document.createElement('tr');
                    let actionBtns = '';
                    if(currentUser.Role !== 'Requester' && w.Status.includes('Pending')) actionBtns = `<button class="text-green-600 font-bold border p-1 rounded mr-2 btn-w-app" data-id="${w.WorkerID}">Approve</button><button class="text-red-600 font-bold border p-1 rounded btn-w-rej" data-id="${w.WorkerID}">Reject</button>`;
                    if(currentUser.Role === 'Requester' && w.Status === 'Approved') actionBtns = `<button class="text-red-600 font-bold btn-w-del" data-id="${w.WorkerID}">Del</button>`;
                    
                    row.innerHTML = `<td>${escapeHtml(w.Name)}</td><td>${escapeHtml(w.Father)}</td><td>${w.IDType}: ${w.ID}</td><td>${w.Contact}</td><td>${w.RequestorName}</td><td>${w.Status}</td><td>${actionBtns}</td>`;
                    t.appendChild(row);
                });
                // Attach dynamic listeners for workers table
                document.querySelectorAll('.btn-w-app').forEach(b => b.addEventListener('click', () => workerAction(b.dataset.id, 'approve')));
                document.querySelectorAll('.btn-w-rej').forEach(b => b.addEventListener('click', () => workerAction(b.dataset.id, 'reject')));
                document.querySelectorAll('.btn-w-del').forEach(b => b.addEventListener('click', () => workerAction(b.dataset.id, 'delete')));
            } 
        }
        async function workerAction(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.name}); loadWorkers('dashboard'); }
        function toggleOtherID() { const val = document.getElementById("w-id-type").value; document.getElementById("w-id-type-other").classList.toggle("hidden", val !== "Other"); }

        // --- OPEN PERMIT (Simplified) ---
        async function openPermit(id) {
             const p = await apiCall('/permit-data', 'POST', {permitId:id});
             currentPermitId = id; currentPermitIOCLData = p.IOCLSupervisors || []; permitRequirePhoto = (p.RequireRenewalPhotos === 'Y');
             
             document.getElementById("permit-header-display").innerText = `${id} | ${p.Status}`;
             document.getElementById("permit-worker-audit-display").classList.remove("hidden");
             document.getElementById("assigned-worker-audit").innerHTML = `<table class="mobile-table w-full text-xs"><thead><tr><th>Name</th><th>ID</th></tr></thead><tbody>${p.SelectedWorkers.map(w=>`<tr><td>${w.Name}</td><td>${w.ID}</td></tr>`).join('')}</tbody></table>`;

             const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
             rS.innerHTML=""; aS.innerHTML=""; 
             if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); }

             // Populate Form
             document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => {
                if(e.type==='radio'){ if(e.value===p[e.name]) e.checked=true; } 
                else if(e.type==='checkbox'){ e.checked=(p[e.name]==='Y'); } 
                else { e.value=p[e.name]||''; }
                e.disabled=true; 
             });

             await loadWorkers('permit_dropdown'); // Just to clear checkboxes
             const workersArr = p.SelectedWorkers;
             currentPermitWorkers = workersArr;
             
             // Renewals
             const rens = JSON.parse(p.RenewalsJSON || "[]");
             currentRenewalCount = rens.length;
             document.querySelector("#table-renewals tbody").innerHTML = rens.map(r => `<tr><td>Start: ${r.valid_from}</td><td>${r.status}</td></tr>`).join('');
             if(rens.length > 0) document.getElementById("renewals-section").classList.remove('hidden');
             
             // Supervisors
             renderIOCLTable();

             // Logic for Buttons
             const actionsDiv = document.getElementById("actions");
             actionsDiv.innerHTML = "";
             
             if(currentUser.Role === 'Requester' && p.Status === 'New') {
                  const btn = document.createElement("button"); btn.className = "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg"; btn.innerText = "Submit Permit"; btn.addEventListener('click', savePermit); actionsDiv.appendChild(btn);
                  document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false);
             }
             // Add other role logic here following pattern: create button -> addEventListener -> append

             document.getElementById("view-dashboard").classList.add('hidden');
             document.getElementById("view-form").classList.remove('hidden');
        }

        async function savePermit() {
             if(!document.getElementById('gsr-check').checked) return alert("Accept GSR");
             const fd = new FormData(document.getElementById("pf"));
             document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(c.name) fd.set(c.name, c.checked ? "Y" : "N"); });
             fd.set("GSR_Accepted", "Y");
             
             // Gather Workers
             const selectedWorkers = [];
             document.querySelectorAll('#worker-checkboxes input:checked').forEach(c => selectedWorkers.push(JSON.parse(c.value)));
             fd.append("SelectedWorkers", JSON.stringify(selectedWorkers));
             if(currentUser) fd.append("RequesterEmail", currentUser.Email);

             const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
             const json = await res.json();
             if(json.success) { alert("Saved: "+json.permitId); showDashboard(); } else alert(json.error);
        }

        function showNewPermit() {
             document.getElementById("pf").reset();
             currentPermitId = null;
             document.getElementById("view-dashboard").classList.add('hidden');
             document.getElementById("view-form").classList.remove('hidden');
             loadWorkers('permit_dropdown');
             document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false);
             
             const actionsDiv = document.getElementById("actions");
             actionsDiv.innerHTML = "";
             const btn = document.createElement("button");
             btn.className = "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg";
             btn.innerText = "Submit Permit";
             btn.addEventListener('click', savePermit);
             actionsDiv.appendChild(btn);
        }
        
        // IOCL Rows Logic
        function addIOCLRow(containerId, data={}) {
            const div = document.createElement('div'); div.className = "flex gap-1 iocl-row items-center mb-1";
            div.innerHTML = `<input class="iocl-name border p-1" placeholder="Name" value="${data.name||''}"><button type="button" class="text-red-500 font-bold px-2">x</button>`;
            div.querySelector('button').addEventListener('click', function() { this.parentElement.remove(); });
            document.getElementById(containerId).appendChild(div);
        }
        function getIOCLData(containerId) {
            const rows = document.querySelectorAll(`#${containerId} .iocl-row`);
            const results = [];
            rows.forEach(r => { results.push({name: r.querySelector('.iocl-name').value, added_by: currentUser.name, added_at: getNow()}); });
            return results;
        }
        function renderIOCLTable() {
            const t = document.querySelector('#table-iocl-display tbody');
            t.innerHTML = currentPermitIOCLData.map(x => `<tr><td>${x.name}</td><td>${x.added_by}</td></tr>`).join('');
            if(currentPermitIOCLData.length) document.getElementById("iocl-sup-display-section").classList.remove('hidden');
        }

        // --- DOWNLOADS & VIEW PHOTO ---
        async function downloadSecurePDF(id) {
             try {
                 const headers = {}; if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                 const res = await fetch(`${API}/download-pdf/${id}`, { headers });
                 if(!res.ok) throw new Error("Err");
                 const blob = await res.blob();
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a'); a.href = url; a.download = `${id}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
             } catch(e) { alert("Download Failed"); }
        }
        async function downloadSecureExcel() {
             try {
                 const headers = {}; if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
                 const res = await fetch(`${API}/download-excel`, { headers });
                 if(!res.ok) throw new Error("Err");
                 const blob = await res.blob();
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a'); a.href = url; a.download = "Permits.xlsx"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
             } catch(e) { alert("Download Failed"); }
        }
        window.viewSecurePhoto = async function(fullUrl) {
            // ... (Same secure photo logic) ...
        }

        // Logic functions like checkDate, checkRenewalTime etc remain same
        function checkDate() { /* ... */ }
        function checkRenewalTime() { /* ... */ }
        function toggleRenewalApproveBtn() { /* ... */ }
        async function submitRenewal(act) { /* ... same logic using FormData ... */ }
        function showAddUser() { document.getElementById("view-add-user").classList.remove('hidden'); }
        async function submitNewUser() { /* ... api call ... */ }
        function showDashboard() { document.getElementById("view-form").classList.add('hidden'); document.getElementById("view-map").classList.add('hidden'); document.getElementById("view-dashboard").classList.remove('hidden'); loadDashboard(); }
        async function loadStats() { const res=await apiCall('/stats','POST'); if(chartS)chartS.destroy(); chartS=new Chart(document.getElementById('chartStatus'),{type:'doughnut',data:{labels:Object.keys(res.statusCounts),datasets:[{data:Object.values(res.statusCounts)}]}}); }

    </script>
</body>
</html>
