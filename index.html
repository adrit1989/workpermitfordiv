<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    
    <style>
        /* --- GLOBAL STYLES ---- */
        body { background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .glass { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        input, select, textarea { width: 100%; border: 1px solid #d1d5db; padding: 10px 12px; border-radius: 8px; font-size: 1rem; background: #fff; margin-bottom: 0.5rem; }
        input:focus, select:focus, textarea:focus { border-color: #ea580c; outline: none; ring: 2px solid #fdba74; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb; }
        button { touch-action: manipulation; transition: transform 0.1s; }
        button:active { transform: scale(0.98); }
        .section-title { font-weight: 800; color: #c2410c; margin: 1.5rem 0 1rem 0; border-bottom: 2px solid #fdba74; padding-bottom: 0.5rem; font-size: 1.1rem; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5rem; color: #ea580c; font-weight: bold; flex-direction: column; gap: 10px; }
        
        .btn-pdf { display: inline-block; padding: 8px 12px; background-color: #dc2626; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.8rem; text-align: center; cursor: pointer; }
        .btn-pdf:hover { background-color: #b91c1c; }

        /* MOBILE TABLE */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tr { display: block; margin-bottom: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f3f4f6; padding: 0.75rem 0; text-align: right; }
            .mobile-table td:last-child { border-bottom: none; padding-bottom: 0; }
            .mobile-table td::before { content: attr(data-label); font-weight: 600; color: #6b7280; text-align: left; margin-right: 1rem; flex-shrink: 0; }
            .checklist-row { flex-direction: column; align-items: flex-start; }
            .checklist-options { width: 100%; display: flex; justify-content: space-between; margin-top: 0.5rem; }
            #actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; padding: 1rem; box-shadow: 0 -4px 6px rgba(0,0,0,0.05); z-index: 100; flex-direction: column; gap: 0.5rem; }
            #actions button, #actions a { width: 100%; display: block; text-align: center; padding: 12px; font-size: 1.1rem; }
            #view-map { flex-direction: column; }
            #map-list { height: 35%; order: 2; width: 100%; border-top: 2px solid #ccc; }
            #map-container { height: 65%; order: 1; width: 100%; }
        }
        /* DESKTOP */
        @media (min-width: 769px) {
            .desktop-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
            table.mobile-table { width: 100%; border-collapse: collapse; display: table; }
            table.mobile-table thead { display: table-header-group; background: #ea580c; color: white; }
            table.mobile-table tr { display: table-row; border: none; box-shadow: none; background: transparent; }
            table.mobile-table th { background: #ea580c; color: white; padding: 12px; text-align: left; border-bottom: 2px solid #c2410c; }
            table.mobile-table td { display: table-cell; border-bottom: 1px solid #e5e7eb; padding: 12px; text-align: left; vertical-align: top; }
            table.mobile-table td::before { content: none; }
            #view-map { flex-direction: row; }
            #map-list { width: 350px; height: 100%; border-right: 1px solid #ddd; overflow-y: auto; position: static; }
            #map-container { flex: 1; height: 100%; position: static; }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-600 mx-auto mb-2"></div>
        <div class="font-bold text-orange-600">Processing...</div>
    </div>

    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 bg-orange-50">
        <div class="glass w-full max-w-md text-center shadow-xl border-t-4 border-orange-600">
           <div class="flex justify-center items-center gap-4 mb-4">
    <img src="logo.png" alt="IOCL Logo" class="h-24 object-contain">
    <img src="rhino.png" alt="Rhino Logo" class="h-24 object-contain">
</div>
            <h1 class="text-3xl font-extrabold text-orange-600 mb-2">IndianOil</h1>
            <p class="text-gray-500 mb-6 font-semibold"> Mainline Work Permit System (By ERPL)</p>
            <form onsubmit="event.preventDefault(); window.handleLogin();" class="space-y-4 text-left">
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Role</label><select id="login-role" class="w-full bg-gray-50 h-12" onchange="window.loadUserNames()"><option value="Requester">Requester</option><option value="Reviewer">Reviewer</option><option value="Approver">Approver</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">User</label><select id="login-name" class="w-full bg-gray-50 h-12" disabled><option>Loading Users...</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-50 h-12"></div>
                <button class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg hover:bg-orange-700 active:bg-orange-800">Sign In</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-2 pb-24 hidden desktop-container">
        
        <div class="mb-4">
            <img src="safety_banner.png" alt="Golden Safety Rules" class="w-full h-auto rounded-xl shadow-lg border-2 border-orange-600 object-cover">
        </div>
        <div class="flex justify-between items-center mb-4 bg-orange-600 p-4 rounded-xl shadow-lg text-white sticky top-2 z-40">
           <div class="flex items-center gap-3">
    <img src="logo.png" alt="Logo" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
    <img src="rhino.png" alt="Rhino" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
    <div class="flex flex-col"><h1 class="text-lg font-bold leading-tight">Mainline Permit System </h1><span id="user-info" class="text-xs text-orange-100 font-medium"></span></div>
</div>
            <div class="flex gap-2"><button onclick="window.toggleWorkerMode()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Workers">üë∑</button><button onclick="window.showMap()" id="btn-header-map" class="bg-white/20 p-2 rounded-lg hover:bg-white/30 hidden" title="Map">üó∫Ô∏è</button><button onclick="location.reload()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Logout">üö™</button></div>
        </div>

        <div id="view-worker-management" class="hidden">
             <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Worker Management</h2><button onclick="window.toggleWorkerMode()" class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded">‚Üê Back</button></div>
             <div id="worker-form-container" class="glass hidden border-l-4 border-blue-500 animate-fade-in"><h3 class="font-bold mb-3 text-lg">Add/Edit Worker</h3><form onsubmit="event.preventDefault(); window.saveWorker(window.currentWorkerAction);" class="grid grid-cols-1 md:grid-cols-2 gap-3"><input type="hidden" id="w-id"><input id="w-name" placeholder="Full Name" required><input id="w-father" placeholder="Father's Name" required><input id="w-address" placeholder="Address"><input id="w-contact" placeholder="Contact No" type="tel">
             <div><select id="w-id-type" onchange="window.toggleOtherID()"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Any Other</option></select><input id="w-id-type-other" placeholder="Specify ID Type" class="hidden bg-yellow-50 mt-1"></div>
             <input id="w-idcard" placeholder="ID Number (No Aadhar)" required><select id="w-gender"><option>Male</option><option>Female</option></select><input id="w-age" type="number" placeholder="Age (Must be 18+)" min="18" required><button class="bg-green-600 text-white py-3 rounded-lg font-bold mt-2 shadow md:col-span-2">Save Worker</button></form></div>
             <button onclick="window.openWorkerForm('create')" id="btn-add-worker" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold mb-4 shadow hidden">+ Add New Worker</button>
             <table class="mobile-table w-full text-left text-sm" id="table-workers"><thead class="hidden md:table-header-group bg-gray-100 text-gray-700"><tr><th>Name</th><th>Father Name</th><th>ID Details</th><th>Address & Contact</th><th>Requestor</th><th>Status</th><th>Action</th></tr></thead><tbody class="divide-y divide-gray-200"></tbody></table>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Dashboard</h2><button onclick="window.showNewPermit()" id="btn-new-permit" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow hidden">+ New</button></div>
            <div class="grid grid-cols-3 gap-2 mb-4"><button onclick="window.showAddUser()" id="btn-add-user" class="bg-purple-100 text-purple-700 py-2 rounded font-bold text-sm hidden">Users</button><button onclick="window.showMap()" id="btn-view-map" class="bg-blue-100 text-blue-700 py-2 rounded font-bold text-sm hidden">Map</button><button onclick="window.open('/api/download-excel')" id="btn-download-excel" class="bg-green-100 text-green-700 py-2 rounded font-bold text-sm hidden">Excel</button></div>
            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden"><div class="glass h-64"><canvas id="chartStatus"></canvas></div><div class="glass h-64"><canvas id="chartType"></canvas></div></div>
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Action Required</h3><div class="mb-6"><table class="mobile-table w-full text-left text-sm" id="table-pending"><thead class="bg-red-50 text-red-900"><tr><th class="p-2">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Pending With</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Active Permits</h3><div class="mb-6"><table class="mobile-table w-full text-left text-sm" id="table-active"><thead class="bg-green-50 text-green-900"><tr><th class="p-2">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Closed / Other</h3><div><table class="mobile-table w-full text-left text-sm" id="table-other"><thead class="bg-gray-50 text-gray-700"><tr><th class="p-2">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="view-add-user" class="hidden flex justify-center fixed inset-0 z-50 bg-black/50 items-center p-4"><div class="glass w-full max-w-sm relative animate-scale-up"><button onclick="window.showDashboard()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-800 text-xl font-bold px-2">‚úï</button><h3 class="font-bold mb-4 text-lg">Add New User</h3><form onsubmit="event.preventDefault(); window.submitNewUser();" class="space-y-3"><input id="new-user-name" placeholder="Full Name" required><input id="new-user-email" placeholder="Email Address" required><select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select><input id="new-user-pass" type="password" placeholder="Set Password" required><button class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button></form></div></div>

        <div id="view-map" class="hidden fixed inset-0 z-50 bg-white flex flex-col md:flex-row"><div id="map-list" class="bg-white border-r relative z-10 shadow-xl overflow-y-auto"><div class="p-3 bg-orange-600 text-white font-bold flex justify-between items-center sticky top-0"><span>Active Permits</span><button onclick="window.showDashboard()" class="bg-white text-orange-600 px-2 rounded text-xs font-bold shadow">‚Üê Back</button></div><div id="map-list-content"></div></div><div id="map-container" class="relative"><div id="map" class="w-full h-full"></div></div></div>

        <div id="view-form" class="hidden">
            <div class="flex items-center gap-2 mb-2"><button onclick="window.showDashboard()" class="bg-white border text-gray-600 px-3 py-2 rounded-lg font-bold shadow-sm">‚Üê Back</button><div id="permit-header-display" class="flex-1 p-2 bg-blue-100 text-blue-800 rounded-lg font-bold text-center text-sm truncate"></div></div>
            <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden"><h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers & Approval Status</h3><div id="assigned-worker-audit" class="overflow-x-auto"></div></div>

            <form id="pf" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" id="PermitID" name="PermitID"><input type="hidden" id="Status" name="Status">
                <div class="glass"><h3 class="section-title">1. Permit Details</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div><div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div><div><label class="text-xs font-bold text-gray-500">Location (GPS) - Optional</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coords (Optional)"><button type="button" onclick="window.getGeo()" class="bg-orange-100 text-orange-600 px-4 rounded-lg font-bold border border-orange-200" id="btn-get-geo">üìç GPS</button></div></div><input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude"><div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div><div><label class="text-xs font-bold text-gray-500">Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div><div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom" onchange="window.checkDate()"></div><div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo" onchange="window.checkDate()"></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName"></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div><div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div><div><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div><div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly></div><div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div><div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div><div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div><div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div></div></div>
                
                <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50 hidden">
                    <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                        <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5" onchange="document.getElementById('div-init-renewal').classList.toggle('hidden', !this.checked)">
                        Request 1st Renewal with Permit
                    </label>
                    <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                        <div class="text-xs font-bold text-gray-500 mb-2">Renewal Details</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                            <input type="datetime-local" name="InitRenFrom" placeholder="From">
                            <input type="datetime-local" name="InitRenTo" placeholder="To">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input name="InitRenHC" placeholder="HC %">
                            <input name="InitRenTox" placeholder="Tox">
                            <input name="InitRenO2" placeholder="O2 %">
                        </div>
                        <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                         <div class="mt-2 border-t pt-2">
                            <label class="text-xs font-bold text-red-600 uppercase block mb-1">Mandatory Photo (1st Renewal)</label>
                            <input type="file" id="ren-cam-1" name="InitRenImage" accept="image/*" capture="environment" class="text-sm">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* Applied to all selected workers</p>
                    </div>
                </div>

                <div class="glass" id="section-e">
                    <h3 class="section-title">E. References</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No">
                        <input name="JsaNo" id="JsaNo" placeholder="JSA No">
                        <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip">
                        <input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                        <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No">
                        <input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"> 
                    </div>
                </div>

                <div class="glass"><h3 class="section-title">2. Checklists</h3><div id="checklists-wrapper" class="space-y-4"></div></div>
                
                <div class="glass" id="worker-select-section">
                    <h3 class="section-title">Workers (Approved)</h3>
                    <div id="worker-checkboxes" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    <div id="worker-readonly-table" class="hidden overflow-x-auto">
                        <table class="mobile-table w-full text-xs text-left">
                            <thead class="hidden md:table-header-group">
                                <tr><th>Name</th><th>Gender</th><th>Age</th><th>Contractor</th></tr>
                            </thead>
                            <tbody class="divide-y"></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass" id="hazards-section"><h3 class="section-title">3. Hazards</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4" id="hazards-container"></div><div id="other-hazard-div" class="hidden mb-2"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div></div>

                <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500"><h3 class="section-title text-yellow-700">4. Reviewer</h3><div class="mb-4 hidden" id="iocl-reviewer-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label><div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div><button type="button" onclick="window.addIOCLRow('iocl-sup-container-rev')" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div><div class="mb-2 font-bold text-sm text-gray-600">PPE Required:</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4" id="ppe-container"></div><textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea><textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea></div>
                <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                    <h3 class="section-title text-green-700">5. Approval</h3>
                    <div class="mb-4 hidden" id="iocl-approver-wrapper"><label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors (Verify/Edit)</label><div id="iocl-sup-container-app" class="space-y-2 mt-2"></div><button type="button" onclick="window.addIOCLRow('iocl-sup-container-app')" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button></div>
                    <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2"></textarea>
                    
                    <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer">
                        <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600">
                        <span class="text-sm font-bold text-green-800">Require Photos for Renewals (Starting 2nd)</span>
                    </label>

                    <div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div>
                </div>

                <div id="iocl-sup-display-section" class="glass hidden"><h3 class="section-title">Authorized Supervisors (IOCL)</h3><table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit</th></tr></thead><tbody></tbody></table></div>

                <div id="renewals-section" class="glass hidden">
                    <h3 class="section-title">Renewals</h3>
                    
                    <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse">
                        <h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Request Action</h4>
                        <p class="text-sm text-gray-600 mb-2">This permit includes a request for the 1st renewal. Please decide on this renewal now.</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-green-700">
                                <input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Recommend / Approve Renewal
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700">
                                <input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal Only
                            </label>
                        </div>
                    </div>

                    <div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 text-sm uppercase">‚ö†Ô∏è Pending Renewal</h4>
                        <div class="text-sm grid grid-cols-1 gap-2 mt-2">
                            <div class="flex justify-between border-b pb-1"><span>From:</span> <span id="disp-ren-from" class="font-mono"></span></div>
                            <div class="flex justify-between border-b pb-1"><span>To:</span> <span id="disp-ren-to" class="font-mono"></span></div>
                            <div class="flex justify-between border-b pb-1"><span>Gas:</span> <span id="disp-ren-gas" class="font-mono"></span></div>
                            <div><span>Prec:</span> <span id="disp-ren-prec"></span></div>
                        </div>
                        
                        <div id="odd-hour-approval-controls" class="hidden mt-3 pt-3 border-t border-yellow-300">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-indigo-900 text-white text-xs px-2 py-1 rounded font-bold">NIGHT SHIFT</span>
                                <span id="odd-hour-req-status" class="text-xs font-bold text-gray-600"></span>
                            </div>
                            <label class="flex items-center gap-2 cursor-pointer p-2 bg-white rounded border border-indigo-200">
                                <input type="checkbox" id="odd-hour-allow-check" onchange="window.toggleRenewalApproveBtn()" class="w-5 h-5 accent-indigo-600">
                                <span class="text-sm font-bold text-indigo-800">I allow work during Odd Hours</span>
                            </label>
                        </div>

                    </div>

                    <div class="overflow-x-auto mb-4"><table class="mobile-table w-full text-xs text-left" id="table-renewals"><thead class="hidden md:table-header-group"><tr><th>Period</th><th>Gas & Precautions</th><th>Workers</th><th>Photo</th><th>Requester</th><th>Reviewer</th><th>Approver</th><th>Status</th></tr></thead><tbody id="renewals-list" class="divide-y"></tbody></table></div>
                    
                    <div id="form-renewal" class="hidden p-4 bg-blue-50 mt-2 rounded-lg border border-blue-100">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-2">
                            <input type="datetime-local" id="RenewalValidFrom" onchange="window.checkRenewalTime()"> 
                            <input type="datetime-local" id="RenewalValidTo" onchange="window.checkRenewalTime()">
                            <div class="flex gap-2"><input id="RenewalHC" placeholder="HC %"> <input id="RenewalToxic" placeholder="Toxic"> <input id="RenewalOxygen" placeholder="O2 %"></div>
                        </div>
                        
                        <div id="odd-hour-agreement" class="hidden mb-2 p-2 bg-indigo-100 border border-indigo-300 rounded">
                            <label class="flex items-start gap-2 cursor-pointer">
                                <input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-800">
                                <span class="text-xs font-bold text-indigo-900 text-justify">I agree to take all precautions to execute the work during odd hours, ensuring proper lighting, safety against weather conditions, and active (non-sleepy) workers.</span>
                            </label>
                        </div>

                        <div class="mt-3 border-t border-blue-200 pt-2 bg-white p-2 rounded"><label class="text-xs font-bold text-gray-500 block mb-1">Workers for this Renewal (Optional - Select from Approved)</label><div id="renewal-worker-select" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div></div><input id="RenewalPrec" placeholder="Precautions" class="w-full mb-2 mt-3">
                        
                        <div id="renewal-photo-container" class="mt-2 bg-white p-2 rounded border border-red-200 hidden">
                            <label class="text-xs font-bold text-red-600 uppercase block mb-1">Photo (Mandatory if required)</label>
                            <input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="text-sm w-full">
                            <p id="photo-mandate-msg" class="text-[10px] text-gray-500 mt-1"></p>
                        </div>

                        <button type="button" onclick="window.submitRenewal('approve')" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow mt-2">Submit Renewal</button>
                    </div>

                    <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded-lg border border-yellow-100">
                        <textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" id="btn-approve-renewal" onclick="window.submitRenewal('approve')" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow disabled:bg-gray-400 disabled:cursor-not-allowed">Approve</button>
                            <button type="button" onclick="window.submitRenewal('reject')" class="bg-red-600 text-white py-3 rounded-lg font-bold shadow">Reject</button>
                        </div>
                    </div>
                </div>
                
                <div id="closure-section" class="glass hidden">
                    <h3 class="section-title">Closure</h3>
                    <label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-2 bg-red-50 rounded" id="lbl-site-restored"><input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5"> Site Restored & Cleaned</label>
                    <div id="div-closure-req" class="hidden space-y-2"><label class="text-xs font-bold text-gray-500">Requester Remarks</label><textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-req" class="text-xs text-gray-400 block text-right"></span></div>
                    <div id="div-closure-rev" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Reviewer Remarks</label><textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-rev" class="text-xs text-gray-400 block text-right"></span></div>
                    <div id="div-closure-app" class="hidden mt-4 space-y-2"><label class="text-xs font-bold text-gray-500">Approver Remarks</label><textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea><span id="ts-clos-app" class="text-xs text-gray-400 block text-right"></span></div>
                </div>

                <div id="signature-history" class="glass hidden"><h3 class="section-title">History</h3><div class="grid grid-cols-1 gap-2 text-xs"><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div></div></div>
                
                <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden">
                    <label class="flex items-start gap-3 p-2 cursor-pointer">
                        <input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500">
                        <span class="text-sm font-bold text-gray-800 text-justify">
                            I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules. I shall ensure all workers are complied to all these rules and in case of any violation, penalty will be imposed by IOCL and I shall accept such penalties without any further challenge.
                        </span>
                    </label>
                </div>

                <div id="actions" class="mt-4 flex flex-col md:flex-row justify-end gap-2 sticky bottom-0 bg-white p-4 shadow-top z-50 border-t"></div>
            </form>
        </div>
    </div>

    <script>
        const API = "/api";
        let currentUser = null; 
        let usersData = {}; 
        let mapInstance = null; 
        let chartS = null; 
        let chartT = null;
        let currentPermitWorkers = []; 
        let currentPermitId = null; 
        let currentRenewalCount = 0; 
        let permitRequirePhoto = false; 
        const loader = document.getElementById('loader');
        
        // --- SECURITY VARIABLES ---
        let authToken = null;

        // --- XSS PROTECTION ---
        function escapeHtml(text) {
            if (!text) return text;
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const CL_DATA = { 
            A: [ "1. Equipment / Work Area inspected.", "2. Surrounding area checked, cleaned and covered. Oil/RAGS/Grass Etc removed.", "3. Manholes, Sewers, CBD etc. and hot nearby surface covered.", "4. Considered hazards from other routine, non-routine operations and concerned person alerted.", "5. Equipment blinded/ disconnected/ closed/ isolated/ wedge opened.", "6. Equipment properly drained and depressurized.", "7. Equipment properly steamed/purged.", "8. Equipment water flushed.", "9. Access for Free approach of Fire Tender.", "10. Iron Sulfide removed/ Kept wet.", "11. Equipment electrically isolated and tagged vide Permit no.", "12. Gas Test: HC / Toxic / O2 checked.", "13. Running water hose / Fire extinguisher provided. Fire water system available.", "14. Area cordoned off and Precautionary tag/Board provided.", "15. CCTV monitoring facility available at site.", "16. Proper ventilation and Lighting provided." ], 
            B: [ "1. Proper means of exit / escape provided.", "2. Standby personnel provided from Mainline/ Maint. / Contractor/HSE.", "3. Checked for oil and Gas trapped behind the lining in equipment.", "4. Shield provided against spark.", "5. Portable equipment / nozzle properly grounded.", "6. Standby persons provided for entry to confined space.", "7. Adequate Communication Provided to Stand by Person.", "8. Attendant Trained Provided With Rescue Equipment/SCABA.", "9. Space Adequately Cooled for Safe Entry Of Person.", "10. Continuous Inert Gas Flow Arranged.", "11. Check For Earthing/ELCB of all Temporary Electrical Connections being used for welding.", "12. Gas Cylinders are kept outside the confined Space.", "13. Spark arrestor Checked on mobile Equipments.", "14. Welding Machine Checked for Safe Location.", "15. Permit taken for working at height Vide Permit No." ], 
            C: ["1. PESO approved spark elimination system provided on the mobile equipment/ vehicle provided."], 
            D: [ "1. For excavated trench/ pit proper slop/ shoring/ shuttering provided to prevent soil collapse.", "2. Excavated soil kept at safe distance from trench/pit edge (min. pit depth).", "3. Safe means of access provided inside trench/pit.", "4. Movement of heavy vehicle prohibited." ] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        document.addEventListener("DOMContentLoaded", () => { window.loadUsers(); renderUI(); });

        // --- SECURE API CALL ---
        async function apiCall(ep, meth="GET", body=null) {
            loader.style.display = 'flex';
            try {
                const headers = {'Content-Type':'application/json'};
                // Attach Token if it exists
                if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
                
                const opts={method:meth, headers:headers};
                if(body)opts.body=JSON.stringify(body);
                
                const res=await fetch(API+ep,opts); 
                
                if (res.status === 401 || res.status === 403) {
                    alert("Session expired or unauthorized. Please log in again.");
                    location.reload();
                    return { error: "Auth Error" };
                }
                
                return await res.json();
            } finally { loader.style.display = 'none'; }
        }

        // Master Toggle Logic
        window.toggleSection = function(sec, val) {
            const radios = document.querySelectorAll(`input[name^="${sec}_Q"][value="${val}"]`);
            radios.forEach(r => r.checked = true);
        }

        function renderUI() {
            let h = '';
            ['A','B','C','D'].forEach(sec => {
                h += `<div class="glass p-3">
                        <div class="flex justify-between items-center border-b pb-1 mb-2">
                            <div class="font-bold text-orange-700">SECTION ${sec}</div>
                            <div class="flex gap-2 text-xs items-center bg-orange-50 p-1 rounded">
                                <span class="font-bold text-gray-600">Applicability:</span>
                                <label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="Yes" checked onchange="window.toggleSection('${sec}', 'Yes')"> Yes</label>
                                <label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="NA" onchange="window.toggleSection('${sec}', 'NA')"> NA</label>
                                <label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="No" onchange="window.toggleSection('${sec}', 'No')"> No</label>
                            </div>
                        </div>`;
                
                h += CL_DATA[sec].map((t, i) => {
                    const id = `${sec}_Q${i+1}`;
                    let remInput = `<input name="${id}_Detail" placeholder="Rem" class="text-sm mt-2 w-full border-gray-200">`;
                    if(sec==='A' && i===11) {
                          remInput = `<div class="flex gap-1 mt-2"><input name="GP_Q12_HC" placeholder="HC % LEL" class="w-1/3"><input name="GP_Q12_ToxicGas" placeholder="Tox PPM" class="w-1/3"><input name="GP_Q12_Oxygen" placeholder="O2 %" class="w-1/3"></div>`;
                    }
                    return `<div class="mb-4 pb-2 border-b border-gray-100 last:border-0"><div class="text-sm font-medium text-gray-800 mb-2">${t}</div><div class="flex justify-between items-center bg-gray-50 p-2 rounded"><div class="flex gap-4"><label class="flex items-center gap-1"><input type="radio" name="${id}" value="Yes" checked class="w-5 h-5"> <span class="text-sm">Yes</span></label><label class="flex items-center gap-1"><input type="radio" name="${id}" value="NA" class="w-5 h-5"> <span class="text-sm">NA</span></label><label class="flex items-center gap-1"><input type="radio" name="${id}" value="No" class="w-5 h-5"> <span class="text-sm">No</span></label></div></div>${remInput}</div>`;
                }).join('');
                h += `</div>`;
            });
            document.getElementById('checklists-wrapper').innerHTML = h;
            document.getElementById('hazards-container').innerHTML = HAZARDS.map(z => {
                const v = z.replace(/ /g,'');
                const ch = z==='Others' ? `onchange="document.getElementById('other-hazard-div').classList.toggle('hidden',!this.checked)"` : '';
                return `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50 hover:bg-orange-50 transition"><input type="checkbox" name="H_${v}" value="Y" ${ch} class="w-5 h-5 text-orange-600"> <span class="text-sm font-medium">${z}</span></label>`;
            }).join('');
            document.getElementById('ppe-container').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50 hover:bg-blue-50 transition"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="w-5 h-5 text-blue-600"> <span class="text-sm font-medium">${p}</span></label>`).join('');
        }

        window.loadUsers = async function() { try { const u = await apiCall('/users'); usersData = u; document.getElementById("login-role").value = "Requester"; loadUserNames(); } catch (e) { console.error("Failed", e); } }
        window.loadUserNames = function() { const role = document.getElementById("login-role").value; const names = usersData[role+'s'] || []; const sel = document.getElementById("login-name"); sel.innerHTML = names.map(u => `<option value="${u.email}">${escapeHtml(u.name)}</option>`).join(''); sel.disabled = false; }
        
        window.handleLogin = async function() { 
            const r=document.getElementById("login-role").value; 
            const n=document.getElementById("login-name").options[document.getElementById("login-name").selectedIndex].text; 
            const e=document.getElementById("login-name").value; 
            const p=document.getElementById("login-password").value; 
            
            const res=await apiCall('/login','POST',{role:r,name:e,password:p}); 
            if(res.success){ 
                currentUser={...res.user, name:n}; 
                authToken = res.token; // SAVE TOKEN
                document.getElementById("view-login").classList.add('hidden'); 
                document.getElementById("app-container").classList.remove('hidden'); 
                document.getElementById("user-info").innerText=`${n} (${r})`; 
                updateRoleUI(); 
                loadDashboard(); 
            } else alert("Invalid Login"); 
        }
        
        function updateRoleUI() { if(currentUser.Role==='Requester') { document.getElementById("btn-new-permit").classList.remove('hidden'); document.getElementById("btn-add-worker").classList.remove('hidden'); document.getElementById("btn-header-map").classList.add('hidden'); } if(currentUser.Role!=='Requester') { document.getElementById("btn-view-map").classList.remove('hidden'); document.getElementById("btn-download-excel").classList.remove('hidden'); document.getElementById("charts-container").classList.remove('hidden'); document.getElementById("btn-header-map").classList.remove('hidden'); loadStats(); if(currentUser.Role==='Approver') document.getElementById("btn-add-user").classList.remove('hidden'); } }
        async function loadStats() { const res=await apiCall('/stats','POST'); if(chartS)chartS.destroy(); if(chartT)chartT.destroy(); chartS=new Chart(document.getElementById('chartStatus'),{type:'doughnut',data:{labels:Object.keys(res.statusCounts),datasets:[{data:Object.values(res.statusCounts)}]}}); chartT=new Chart(document.getElementById('chartType'),{type:'bar',data:{labels:Object.keys(res.typeCounts),datasets:[{label:'Types',data:Object.values(res.typeCounts)}]}}); }
        window.toggleOtherID = function() { const val = document.getElementById("w-id-type").value; const otherInput = document.getElementById("w-id-type-other"); if(val === "Other") otherInput.classList.remove("hidden"); else otherInput.classList.add("hidden"); }
        window.toggleWorkerMode = function() { const dash = document.getElementById("view-dashboard"); const work = document.getElementById("view-worker-management"); document.getElementById("view-map").classList.add('hidden'); if(dash.classList.contains('hidden')) { dash.classList.remove('hidden'); work.classList.add('hidden'); } else { dash.classList.add('hidden'); work.classList.remove('hidden'); loadWorkers('dashboard'); } }
        
        window.openWorkerForm = function(act, data=null) { 
            window.currentWorkerAction = act; const form = document.getElementById('worker-form-container'); form.classList.remove('hidden'); 
            if(act === 'create') { document.getElementById('w-id').value = ''; document.querySelectorAll('#worker-form-container input').forEach(i => i.value = ''); } 
            else if (act === 'edit_request' && data) { 
                document.getElementById('w-id').value = data.WorkerID; document.getElementById('w-name').value = data.Name; document.getElementById('w-father').value = data.Father; document.getElementById('w-address').value = data.Address; document.getElementById('w-contact').value = data.Contact; document.getElementById('w-idcard').value = data.ID; document.getElementById('w-gender').value = data.Gender; document.getElementById('w-age').value = data.Age; 
                const idType = data.IDType || "Voter Card"; const isStandard = ["Voter Card", "PAN Card"].includes(idType); document.getElementById("w-id-type").value = isStandard ? idType : "Other"; window.toggleOtherID(); if(!isStandard) document.getElementById("w-id-type-other").value = idType; 
            } 
        }
        
        window.saveWorker = async function(act) { 
            const idTypeRaw = document.getElementById("w-id-type").value; const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw; 
            if(parseInt(document.getElementById("w-age").value) < 18) { alert("Worker must be 18+"); return; }
            const body = { Action: act, Role: currentUser.Role, RequestorEmail: currentUser.Email, WorkerID: document.getElementById('w-id').value, ApproverName: currentUser.name, RequestorName: currentUser.name, Details: { Name:document.getElementById("w-name").value, Father:document.getElementById("w-father").value, Address:document.getElementById("w-address").value, Contact:document.getElementById("w-contact").value, ID:document.getElementById("w-idcard").value, Gender:document.getElementById("w-gender").value, Age:document.getElementById("w-age").value, IDType: idTypeFinal } }; 
            const res = await apiCall('/save-worker', 'POST', body); if(res.success) { alert("Saved"); loadWorkers('dashboard'); document.getElementById('worker-form-container').classList.add('hidden'); } else alert(res.error); 
        }

        async function loadWorkers(context) { 
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); 
            if(context === 'permit_dropdown') { 
                const con = document.getElementById('worker-checkboxes'); 
                con.innerHTML = res.map(w => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5"> <span class="font-bold">${escapeHtml(w.Name)}</span> <span class="text-xs text-gray-500">(${w.Age})</span></label>`).join(''); 
            } else { 
                const t = document.querySelector('#table-workers tbody'); 
                t.innerHTML = res.map(w => `<tr><td data-label="Name" class="font-bold text-blue-600">${escapeHtml(w.Name)}</td><td data-label="Father">${escapeHtml(w.Father)}</td><td data-label="ID Details">${w.IDType || 'ID'}: ${escapeHtml(w.ID)}</td><td data-label="Address/Contact">${escapeHtml(w.Address)}<br><span class="text-xs text-blue-600">${escapeHtml(w.Contact)}</span></td><td data-label="Requestor" class="font-bold text-indigo-600">${escapeHtml(w.RequestorName) || 'Unknown'}</td> <td data-label="Status"><span class="px-2 py-1 rounded text-xs font-bold ${w.Status==='Approved'?'bg-green-100 text-green-800':(w.Status==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800')}">${w.Status}</span>${w.ApprovedBy ? `<div class="text-[10px] mt-1 text-green-700">App: ${escapeHtml(w.ApprovedBy)}<br>${w.ApprovedAt}</div>` : ''}</td><td data-label="Action">${(currentUser.Role !== 'Requester' && w.Status.includes('Pending')) ? `<button onclick="window.workerAction('${w.WorkerID}','approve')" class="text-green-600 font-bold border p-1 rounded hover:bg-green-50">Approve</button> <button onclick="window.workerAction('${w.WorkerID}','reject')" class="text-red-600 font-bold border p-1 rounded hover:bg-red-50 ml-2">Reject</button>` : ''}${(currentUser.Role==='Requester' && w.Status==='Approved') ? `<button onclick='window.openWorkerForm("edit_request", ${JSON.stringify(w)})' class="text-blue-600 font-bold mr-2">Edit</button> <button onclick="window.workerAction('${w.WorkerID}','delete')" class="text-red-600 font-bold">Del</button>` : ''}</td></tr>`).join(''); 
            } 
        }
        window.workerAction = async function(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.name}); loadWorkers('dashboard'); }
        
        async function loadDashboard() { 
            const res = await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email}); 
            const tP=document.querySelector('#table-pending tbody'), tA=document.querySelector('#table-active tbody'), tO=document.querySelector('#table-other tbody'); tP.innerHTML=""; tA.innerHTML=""; tO.innerHTML=""; 
            res.forEach(p => { 
                let pendingWith = "-"; if(p.Status.includes('Review')) pendingWith = p.ReviewerEmail ? p.ReviewerEmail.split('@')[0] : '-'; if(p.Status.includes('Approval')) pendingWith = p.ApproverEmail ? p.ApproverEmail.split('@')[0] : '-'; const statusColor = p.Status.includes('Pending') ? 'text-red-600' : (p.Status==='Active' ? 'text-green-600' : 'text-gray-600'); 
                
                // --- FIX 1: Secure Download Button ---
                let actionHtml = `<span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">OPEN</span>`;
                if (p.Status === 'Closed') {
                    // Use JavaScript function instead of direct link
                    actionHtml = `<button onclick="window.downloadSecurePDF('${p.PermitID}')" class="btn-pdf">Download PDF</button>`;
                }

                const row = `<tr class="cursor-pointer hover:bg-orange-50 transition" onclick="if('${p.Status}' !== 'Closed') window.openPermit('${p.PermitID}')"><td data-label="ID" class="font-bold text-blue-600 text-lg">${p.PermitID}</td><td data-label="Type" class="font-medium">${escapeHtml(p.WorkType||'-')}</td><td data-label="Loc" class="text-gray-600">${escapeHtml(p.LocationUnit||'-')}</td><td data-label="Status" class="font-bold ${statusColor}">${p.Status}</td><td data-label="With" class="text-sm text-gray-500">${escapeHtml(pendingWith)}</td><td data-label="Action">${actionHtml}</td></tr>`; let isAction = false; const s = p.Status; if(currentUser.Role === 'Reviewer') { if((s === 'Pending Review' || s === 'Renewal Pending Review' || s === 'Closure Pending Review') && p.ReviewerEmail === currentUser.Email) isAction = true; } else if(currentUser.Role === 'Approver') { if((s === 'Pending Approval' || s === 'Renewal Pending Approval' || s === 'Closure Pending Approval') && p.ApproverEmail === currentUser.Email) isAction = true; } else if (currentUser.Role === 'Requester') { if (s.includes('Pending')) isAction = true; } if(isAction) tP.innerHTML += row; else if(s === 'Active') tA.innerHTML += row; else tO.innerHTML += row; }); 
        }

        const getNow = () => new Date().toLocaleString("en-GB").replace(',','');
        window.addIOCLRow = function(containerId, data = {}) { if(data.is_deleted) return; const div = document.createElement('div'); div.className = "flex gap-1 iocl-row items-center"; const auditData = `<input type="hidden" class="iocl-added-by" value="${data.added_by || currentUser.name}"><input type="hidden" class="iocl-added-at" value="${data.added_at || getNow()}">`; div.innerHTML = `${auditData}<input placeholder="Name" value="${data.name||''}" class="iocl-name w-1/3 text-xs border border-gray-300 rounded p-1"><input placeholder="Desig" value="${data.desig||''}" class="iocl-desig w-1/3 text-xs border border-gray-300 rounded p-1"><input placeholder="Contact" value="${data.contact||''}" class="iocl-contact w-1/3 text-xs border border-gray-300 rounded p-1"><button type="button" onclick="window.markIOCLDeleted(this)" class="text-red-500 font-bold px-2 hover:bg-red-50 rounded">x</button>`; document.getElementById(containerId).appendChild(div); }
        window.markIOCLDeleted = function(btn) { const row = btn.parentElement; row.classList.add('hidden', 'marked-deleted'); }
        window.getIOCLData = function(containerId) { const rows = document.querySelectorAll(`#${containerId} .iocl-row`); const results = []; rows.forEach(r => { const name = r.querySelector('.iocl-name').value; if(!name) return; const isDel = r.classList.contains('marked-deleted'); const obj = { name: name, desig: r.querySelector('.iocl-desig').value, contact: r.querySelector('.iocl-contact').value, added_by: r.querySelector('.iocl-added-by').value, added_at: r.querySelector('.iocl-added-at').value, is_deleted: isDel }; if(isDel) { obj.deleted_by = currentUser.name; obj.deleted_at = getNow(); } results.push(obj); }); if(window.currentPermitIOCLData) { const alreadyDeleted = window.currentPermitIOCLData.filter(x => x.is_deleted); alreadyDeleted.forEach(d => results.push(d)); } return results; }

        window.openPermit = async function(id) {
            const p = await apiCall('/permit-data', 'POST', {permitId:id});
            currentPermitId = id;
            window.currentPermitIOCLData = p.IOCLSupervisors || []; 
            permitRequirePhoto = (p.RequireRenewalPhotos === 'Y'); // Load flag

            document.getElementById("permit-header-display").innerText = `${id} | ${p.Status}`;
            document.getElementById("permit-worker-audit-display").classList.remove("hidden");
            
            if(document.getElementById("assigned-worker-audit")) {
                document.getElementById("assigned-worker-audit").innerHTML = `<table class="mobile-table w-full text-xs"><thead><tr><th>Name</th><th>ID Details</th><th>Father</th><th>Requestor</th><th>Approval Trail</th></tr></thead><tbody>${p.SelectedWorkers.map(w=>`<tr><td data-label="Name">${escapeHtml(w.Name)} (${w.Age})</td><td data-label="ID">${w.IDType || 'ID'}: ${escapeHtml(w.ID)}</td><td data-label="Father">${escapeHtml(w.Father)}</td><td data-label="Requestor">${escapeHtml(w.RequestorName) || '-'}</td><td data-label="Approval"><span class="text-green-700 font-bold">Approved by ${escapeHtml(w.ApprovedBy)||'Admin'} on ${w.ApprovedAt||p.CreatedDate}</span></td></tr>`).join('')}</tbody></table>`;
            }

            const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
            rS.innerHTML=""; aS.innerHTML=""; 
            if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); }

            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };

            // 1. DISABLE EVERYTHING INITIALLY
            document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => {
                if(e.type==='radio'){ if(e.value===p[e.name]) e.checked=true; } else if(e.type==='checkbox'){ e.checked=(p[e.name]==='Y'); } else { e.value=p[e.name]||''; }
                e.disabled=true; 
            });
            
            safeSet("Closure_Requestor_Remarks", p.Closure_Requestor_Remarks || "");
            safeSet("Closure_Reviewer_Remarks", p.Closure_Reviewer_Remarks || "");
            safeSet("Closure_Approver_Remarks", p.Closure_Approver_Remarks || "");

            await loadWorkers('permit_dropdown');
            let workersArr = [];
            if(p.SelectedWorkers) { if(Array.isArray(p.SelectedWorkers)) workersArr = p.SelectedWorkers; else if(typeof p.SelectedWorkers === 'string') { try { workersArr = JSON.parse(p.SelectedWorkers); } catch(e){} } }
            currentPermitWorkers = workersArr;

            const r=currentUser.Role, s=p.Status;
            
            // Update Renewals Table
            const rens = JSON.parse(p.RenewalsJSON || "[]");
            currentRenewalCount = rens.length; // Set count for Features B & C

            document.querySelector("#table-renewals tbody").innerHTML = rens.map(r => {
                const isOddHour = (r.odd_hour_req === true);
                const nightBadge = isOddHour ? '<br><span class="bg-indigo-900 text-white px-1 text-[10px] rounded">NIGHT</span>' : '';
                return `<tr><td data-label="Period" class="font-mono text-xs">Start: ${r.valid_from.replace('T',' ')}<br>End: &nbsp;&nbsp;${r.valid_till.replace('T',' ')}${nightBadge}</td><td data-label="Gas & Prec"><strong>Gas:</strong> HC:${escapeHtml(r.hc)}, O2:${escapeHtml(r.oxygen)}, Tox:${escapeHtml(r.toxic)}<br><strong>Prec:</strong> ${escapeHtml(r.precautions) || '-'}</td><td data-label="Workers" class="text-xs text-gray-600">${r.worker_list ? r.worker_list.join(', ') : 'All'}</td><td data-label="Photo">${r.photoUrl ? `<a href="${r.photoUrl}" target="_blank" class="text-blue-600 font-bold underline text-xs">View Photo</a>` : 'N/A'}</td><td data-label="Req">${escapeHtml(r.req_name)}<br><span class="text-[10px] text-gray-500">${r.req_at}</span></td><td data-label="Rev">${escapeHtml(r.rev_name)||'-'}<br><span class="text-[10px] text-gray-500">${r.rev_at||''}</span></td><td data-label="App">${escapeHtml(r.app_name)||'-'}<br><span class="text-[10px] text-gray-500">${r.app_at||''}</span></td><td data-label="Status"><span class="font-bold ${r.status==='rejected'?'text-red-600':'text-green-600'}">${r.status}</span></td></tr>`;
            }).join('');
            
            if (rens.length > 0) {
                document.getElementById("renewals-section").classList.remove('hidden');
            }

            document.getElementById("first-renewal-decision").classList.add('hidden');
            document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.checked = false);

            if (rens.length === 1) {
                if (r === 'Reviewer' && s === 'Pending Review' && rens[0].status === 'pending_review') {
                    document.getElementById("first-renewal-decision").classList.remove('hidden');
                    document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.disabled = false);
                }
                if (r === 'Approver' && s === 'Pending Approval' && rens[0].status === 'pending_approval') {
                    document.getElementById("first-renewal-decision").classList.remove('hidden');
                    document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.disabled = false);
                }
            }

            // --- FIX A: FORCE UNHIDE RENEWALS/CLOSURE FOR REQUESTOR ---
            if(r==='Requester' && (!last || (last.status!=='pending_review' && last.status!=='pending_approval'))) {
               // 1. Force Parent Container Visible
               document.getElementById("renewals-section").classList.remove('hidden');
               
               // 2. Unhide Closure Section
               document.getElementById("closure-section").classList.remove('hidden'); 
               document.getElementById("div-closure-req").classList.remove('hidden');
               document.getElementById("Closure_Requestor_Remarks").disabled = false; 
               document.getElementById("Site_Restored_Check").disabled = false;

               // 3. Unhide Renewal Form
               document.getElementById("form-renewal").classList.remove('hidden'); 
               document.querySelectorAll('#form-renewal input').forEach(e => e.disabled = false);
               
               // 4. Populate Renewal Workers
               const renSel = document.getElementById('renewal-worker-select'); 
               renSel.innerHTML = currentPermitWorkers.map(w => `<label class="flex items-center gap-1 text-xs bg-white p-1 rounded border"><input type="checkbox" value="${escapeHtml(w.Name)}" checked class="ren-worker-cb"> ${escapeHtml(w.Name)}</label>`).join('');

               // 5. Handle Photo Logic
               const showPhotoBox = (currentRenewalCount > 0 && permitRequirePhoto);
               const photoDiv = document.getElementById("renewal-photo-container");
               const msgEl = document.getElementById("photo-mandate-msg");

               if(showPhotoBox) {
                     photoDiv.classList.remove('hidden');
                     msgEl.innerText = "* Photo Upload is MANDATORY.";
                     msgEl.classList.add("text-red-600", "font-bold");
               } else {
                     photoDiv.classList.add('hidden');
               }

               // 6. Show Job Complete Button
               btns += `<button type="button" onclick="window.upd('initiate_closure')" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow flex-1">Job Complete</button>`;
            }
            // -------------------------------------------------------------
            
            if(last && (last.status==='pending_review' || last.status==='pending_approval')) {
                if(r!=='Requester') { 
                    document.getElementById("pending-renewal-display").classList.remove('hidden'); 
                    setText("disp-ren-from", last.valid_from.replace('T', ' ')); 
                    setText("disp-ren-to", last.valid_till.replace('T', ' ')); 
                    setText("disp-ren-gas", `${escapeHtml(last.hc)}/${escapeHtml(last.toxic)}/${escapeHtml(last.oxygen)}`); 
                    setText("disp-ren-prec", escapeHtml(last.precautions)); 
                    
                    // FEATURE A: Odd Hour Check for Approver/Reviewer
                    if(last.odd_hour_req) {
                        document.getElementById("odd-hour-approval-controls").classList.remove('hidden');
                        setText("odd-hour-req-status", "Requester Agreed to Safety Precautions");
                        
                        const chk = document.getElementById("odd-hour-allow-check");
                        chk.checked = false;
                        
                        chk.disabled = false; 

                        document.getElementById("btn-approve-renewal").disabled = true;
                    } else {
                        document.getElementById("odd-hour-approval-controls").classList.add('hidden');
                        document.getElementById("btn-approve-renewal").disabled = false;
                    }
                }
            }
            if(r==='Reviewer' && last && last.status==='pending_review') { document.getElementById("action-renewal").classList.remove('hidden'); document.getElementById("RenewalRemark").disabled = false; btns=""; } 
            else if(r==='Approver' && last && last.status==='pending_approval') { document.getElementById("action-renewal").classList.remove('hidden'); document.getElementById("RenewalRemark").disabled = false; btns=""; } 
            else {
                if(r==='Approver' && s==='Active') { 
                     btns += `<button type="button" onclick="window.upd('approve')" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow flex-1 text-center">Update Supervisors</button>`;
                     document.getElementById("pdf-color-select").classList.remove('hidden');
                }
                // --- FIX 2: Secure Download Button ---
                btns += `<button type="button" onclick="window.downloadSecurePDF('${id}')" class="bg-gray-700 text-white px-6 py-3 rounded-lg font-bold shadow flex-1 text-center">Download PDF</button>`;
            }
        }
        
        if(s.includes('Closure') || s === 'Closed') {
            document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-req").classList.remove('hidden');
            setText("ts-clos-req", p.Closure_Requestor_Date);
            
            document.getElementById("Site_Restored_Check").checked = (p.Site_Restored_Check === 'Y');
            document.getElementById("Site_Restored_Check").disabled = true;
            
            if(s!=='Closure Pending Review') { document.getElementById("div-closure-rev").classList.remove('hidden'); setText("ts-clos-rev", p.Closure_Reviewer_Date); }
            if(s==='Closed') { document.getElementById("div-closure-app").classList.remove('hidden'); setText("ts-clos-app", p.Closure_Approver_Date); }
            
            if(s==='Closure Pending Review' && r==='Reviewer') { 
                  document.getElementById("div-closure-rev").classList.remove('hidden'); 
                  document.getElementById("Closure_Reviewer_Remarks").disabled=false;
                  btns=`<button type="button" onclick="window.upd('reject_closure')" class="bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve_closure')" class="bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Verify</button>`; 
            }
            if(s==='Closure Pending Approval' && r==='Approver') { 
                  document.getElementById("div-closure-app").classList.remove('hidden'); 
                  document.getElementById("Closure_Approver_Remarks").disabled=false;
                  btns=`<button type="button" onclick="window.upd('reject_closure')" class="bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve')" class="bg-black text-white px-4 py-3 rounded-lg font-bold flex-1">Close Permit</button>`; 
            }
            
            if(s==='Closed') { 
                // --- FIX 3: Secure Download Button ---
                btns = `<button type="button" onclick="window.downloadSecurePDF('${id}')" class="bg-gray-700 text-white px-6 py-3 rounded-lg font-bold shadow flex-1 text-center">Download PDF</button>`; 
            }
        }

        document.getElementById("signature-history").classList.remove('hidden');
        setText("sig-app", p.Approver_Sig || 'Pending');
        const lastRenEntry = JSON.parse(p.RenewalsJSON||"[]").pop();
        setText("sig-ren", (lastRenEntry && lastRenEntry.app_name) ? `${escapeHtml(lastRenEntry.app_name)} on ${lastRenEntry.app_at}` : 'None');
        setText("sig-clos", p.Closure_Approver_Sig || 'Pending');
        
        const gsrEl = document.getElementById("gsr-check");
        gsrEl.checked = (p.GSR_Accepted === 'Y');
        gsrEl.disabled = true;
        document.getElementById("gsr-container").classList.remove('hidden');

        document.getElementById("actions").innerHTML = btns;
        document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-form").classList.remove('hidden');
    }

    window.upd = async function(act) {
        if(act === 'initiate_closure') {
            if(!document.getElementById("Site_Restored_Check").checked) { alert("You must certify that the Site is Restored & Cleaned."); return; }
        }

        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
        
        let ioclData = [];
        const isReviewerEditing = (currentUser.Role === 'Reviewer' && !document.getElementById('iocl-sup-container-rev').parentElement.classList.contains('hidden'));
        const isApproverEditing = (currentUser.Role === 'Approver' && !document.getElementById('iocl-sup-container-app').parentElement.classList.contains('hidden'));

        if (isReviewerEditing) {
            ioclData = window.getIOCLData('iocl-sup-container-rev');
        } else if (isApproverEditing) {
            ioclData = window.getIOCLData('iocl-sup-container-app');
        } else {
            ioclData = window.currentPermitIOCLData || [];
        }

        let firstRenewalAction = null;
        if(!document.getElementById('first-renewal-decision').classList.contains('hidden')) {
            const radios = document.getElementsByName('FirstRenewalAction');
            for (const r of radios) { if (r.checked) firstRenewalAction = r.value; }
            if (!firstRenewalAction && (act === 'review' || act === 'approve')) {
                alert("‚ö†Ô∏è Action Required: Please Approve or Reject the attached 1st Renewal Request.");
                return;
            }
        }

        const body = { 
            PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.name,
            comment: (currentUser.Role==='Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks")),
            Closure_Requestor_Remarks: getVal("Closure_Requestor_Remarks"), 
            Closure_Reviewer_Remarks: getVal("Closure_Reviewer_Remarks"), 
            Closure_Approver_Remarks: getVal("Closure_Approver_Remarks"),
            bgColor: getVal("PdfBgColor"), IOCLSupervisors: ioclData,
            Site_Restored_Check: document.getElementById("Site_Restored_Check").checked ? 'Y' : 'N',
            FirstRenewalAction: firstRenewalAction
        };
        
        if(currentUser.Role === 'Reviewer' && act === 'review') {
                const fd = new FormData(document.getElementById("pf"));
                document.querySelectorAll('#hazards-section input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                document.querySelectorAll('#ppe-container input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                body.Reviewer_Remarks = getVal("Reviewer_Remarks"); body.AdditionalPrecautions = getVal("AdditionalPrecautions");
                if(document.getElementById("H_Others_Detail")) { body.H_Others_Detail = document.getElementById("H_Others_Detail").value; }
        }
        if(currentUser.Role === 'Approver' && act === 'approve') { 
            body.Approver_Remarks = getVal("Approver_Remarks"); 
            // Save Photo Requirement Preference
            body.RequireRenewalPhotos = document.getElementById("RequireRenewalPhotos").checked ? 'Y' : 'N';
        }
        
        const res = await apiCall('/update-status', 'POST', body);
        if(res.success) showDashboard(); else alert(res.error);
    }

    // Helper to check odd hours (18:00 - 06:00)
    window.isOddHour = function(dateObj) {
        const h = dateObj.getHours();
        return (h >= 18 || h < 6);
    }

    window.checkRenewalTime = function() {
        const fVal = document.getElementById("RenewalValidFrom").value;
        const tVal = document.getElementById("RenewalValidTo").value;
        const div = document.getElementById("odd-hour-agreement");
        const chk = document.getElementById("OddHourSafetyCheck");
        
        if(fVal && tVal) {
            const d1 = new Date(fVal);
            const d2 = new Date(tVal);
            if(window.isOddHour(d1) || window.isOddHour(d2)) {
                div.classList.remove('hidden');
            } else {
                div.classList.add('hidden');
                chk.checked = false; 
            }
        }
    }
    
    // Toggle Approval Button
    window.toggleRenewalApproveBtn = function() {
         const chk = document.getElementById("odd-hour-allow-check");
         const btn = document.getElementById("btn-approve-renewal");
         btn.disabled = !chk.checked;
    }

    window.submitRenewal = async function(act) { 
        if(currentUser.Role === 'Requester') {
            const fVal = document.getElementById("RenewalValidFrom").value;
            const tVal = document.getElementById("RenewalValidTo").value;
            
            // Feature B Validation
            if(!document.getElementById("odd-hour-agreement").classList.contains("hidden")) {
                if(!document.getElementById("OddHourSafetyCheck").checked) {
                    alert("For Odd Hours (6 PM - 6 AM), you must agree to the safety precautions checkbox.");
                    return;
                }
            }

            // Feature B & C Validation
            const fileInput = document.getElementById("ren-cam-sub");
            // Rule: NEVER mandate for 1st (index 0). ONLY mandate for 2nd+ (index > 0) IF flag is set.
            const isPhotoMandatory = (currentRenewalCount > 0 && permitRequirePhoto);

            if(isPhotoMandatory) {
                  if(!fileInput.files || fileInput.files.length === 0) {
                       alert("MANDATORY: You must capture a photo for this renewal.");
                       return;
                  }
            }
        }
        const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; }; 
        const vf = new Date(getVal("RenewalValidFrom")); const vt = new Date(getVal("RenewalValidTo")); 
        if (vt <= vf) { alert("End time must be greater than Start time"); return; } 
        
        const selWorkers = []; 
        document.querySelectorAll('.ren-worker-cb:checked').forEach(c => selWorkers.push(c.value)); 
        
        const fd = new FormData();
        fd.append('PermitID', currentPermitId);
        fd.append('userRole', currentUser.Role);
        fd.append('userName', currentUser.name);
        fd.append('action', act);
        fd.append('RenewalValidFrom', getVal("RenewalValidFrom"));
        fd.append('RenewalValidTo', getVal("RenewalValidTo"));
        fd.append('hc', getVal("RenewalHC"));
        fd.append('toxic', getVal("RenewalToxic"));
        fd.append('oxygen', getVal("RenewalOxygen"));
        fd.append('precautions', getVal("RenewalPrec"));
        fd.append('rejectionReason', getVal("RenewalRemark"));
        fd.append('renewalWorkers', JSON.stringify(selWorkers));
        
        // Send odd hour flag
        const oddHourAgree = document.getElementById("OddHourSafetyCheck").checked;
        fd.append('oddHourReq', oddHourAgree ? 'Y' : 'N');

        if(currentUser.Role === 'Requester') {
            fd.append('RenewalImage', document.getElementById("ren-cam-sub").files[0]);
        }

        loader.style.display = 'flex';
        try {
             // Token handled by apiCall, but for FormData we use fetch manually.
             // Need to attach token here too!
             const headers = {};
             if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
             
             const res = await fetch(API+'/renewal', {method:'POST', body:fd, headers: headers});
             const json = await res.json();
             if(json.success) { alert("Done"); showDashboard(); } else alert(json.error); 
        } catch(e) { console.error(e); alert("Failed: " + e.message); }
        finally { loader.style.display = 'none'; }
    }
    
    window.showNewPermit = async function() { 
        document.getElementById("pf").reset(); currentPermitId=null; 
        document.getElementById("Status").value="New"; document.getElementById("permit-header-display").innerText = "New Permit"; 
        document.getElementById("permit-worker-audit-display").classList.add("hidden"); 
        document.getElementById("iocl-sup-display-section").classList.add('hidden'); 
        document.getElementById("iocl-reviewer-wrapper").classList.add('hidden'); 
        document.getElementById("iocl-approver-wrapper").classList.add('hidden'); 
        document.getElementById("first-renewal-decision").classList.add('hidden'); 
        
        const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
        if(rS && aS) { rS.innerHTML=""; aS.innerHTML=""; if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); } } 
        document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false); 
        
        const safeSet = (id, val) => { const el = document.getElementById(id); if(el) { el.value = val; } }; 
        safeSet("RequesterName", currentUser.name); safeSet("Vendor", currentUser.name); document.getElementById("Vendor").readOnly=true; document.getElementById("RequesterName").disabled=false; 
        await loadWorkers('permit_dropdown'); document.querySelectorAll('#worker-checkboxes input').forEach(c => c.disabled = false); document.getElementById('worker-checkboxes').classList.remove('hidden'); document.getElementById('worker-readonly-table').classList.add('hidden'); document.getElementById("fs-reviewer-section").classList.add('hidden'); document.getElementById("fs-approver-section").classList.add('hidden'); document.getElementById("renewals-section").classList.add('hidden'); document.getElementById("closure-section").classList.add('hidden'); 
        
        const gsrEl = document.getElementById("gsr-check");
        gsrEl.checked = false;
        gsrEl.disabled = false;
        document.getElementById("gsr-container").classList.remove('hidden');

        document.getElementById("chk-init-renewal").checked = false;
        document.getElementById("div-init-renewal").classList.add('hidden');
        document.getElementById("init-renewal-wrapper").classList.remove('hidden'); 
        
        document.getElementById("actions").innerHTML = `<button type="button" onclick="window.savePermit()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg">Submit Permit</button>`; 
        document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-form").classList.remove('hidden'); 
    }

    window.savePermit = async function() { 
        if(!document.getElementById('gsr-check').checked) {
            alert("You must accept the Golden Safety Rules terms to proceed.");
            document.getElementById('gsr-container').classList.add('ring-2', 'ring-red-500');
            setTimeout(()=>document.getElementById('gsr-container').classList.remove('ring-2', 'ring-red-500'), 2000);
            return;
        }

        if (document.getElementById("chk-init-renewal").checked) {
            const pStart = new Date(document.getElementById("ValidFrom").value);
            const pEnd = new Date(document.getElementById("ValidTo").value);
            const rStartInput = document.querySelector('input[name="InitRenFrom"]').value;
            const rEndInput = document.querySelector('input[name="InitRenTo"]').value;

            if(!rStartInput || !rEndInput) { alert("Please set 1st Renewal Start/End times."); return; }

            const rStart = new Date(rStartInput);
            const rEnd = new Date(rEndInput);

            if (rEnd <= rStart) { alert("1st Renewal: End time must be greater than Start time."); return; }
            if (rStart.getTime() < pStart.getTime() || rEnd.getTime() > pEnd.getTime()) { alert("1st Renewal must be within the Permit Validity period."); return; }
            if ((rEnd - rStart) > (8 * 60 * 60 * 1000)) { alert("1st Renewal duration cannot exceed 8 hours."); return; }

            const photoInput = document.getElementById('ren-cam-1');
            if (!photoInput.files || photoInput.files.length === 0) {
                  alert("MANDATORY: You must capture a photo for the 1st Renewal.");
                  return;
            }
        }

        document.getElementById('loader').style.display = 'flex'; 
        try { 
            const fd = new FormData(document.getElementById("pf")); 
            document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                if (c.name) {
                    fd.set(c.name, c.checked ? "Y" : "N");
                }
            }); 
            
            fd.set("GSR_Accepted", "Y"); 

            const selectedWorkers = []; 
            document.querySelectorAll('#worker-checkboxes input:checked').forEach(c => { selectedWorkers.push(JSON.parse(c.value)); }); 
            fd.append("SelectedWorkers", JSON.stringify(selectedWorkers)); 
            
            if(currentUser && currentUser.Email) {
                fd.append("RequesterEmail", currentUser.Email); 
            }

            fd.append("Latitude", document.getElementById("Latitude").value || ""); 
            fd.append("Longitude", document.getElementById("Longitude").value || ""); 
            
            if(currentPermitId) fd.set("PermitID", currentPermitId); 
            
            // Add Authorization Header to fetch
            const headers = {};
            if(authToken) headers['Authorization'] = `Bearer ${authToken}`;

            const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers:headers}); 
            
            if (!res.ok) {
                const text = await res.text();
                console.error("Server Error HTML:", text); 
                throw new Error(`Server Error (${res.status}). Check console.`);
            }

            const json = await res.json(); 
            if(json.success){
                alert("Saved successfully: " + json.permitId); 
                showDashboard();
            } else {
                alert("Error: " + json.error); 
            }
        } catch (e) {
            console.error(e);
            alert("Submission Failed: " + e.message);
        } finally { 
            document.getElementById('loader').style.display = 'none'; 
        } 
    };
    
    window.checkDate = function() { const vf=new Date(document.getElementById("ValidFrom").value); const vt=new Date(document.getElementById("ValidTo").value); if(vf && vt) { if(vt <= vf) { alert("End time must be greater than Start time"); document.getElementById("ValidTo").value=""; return; } if((vt-vf)/(1000*60*60*24) > 7) { alert("Max 7 Days"); document.getElementById("ValidTo").value=""; } } }
    window.showDashboard = function() { document.getElementById("view-dashboard").classList.remove('hidden'); document.getElementById("view-form").classList.add('hidden'); document.getElementById("view-add-user").classList.add('hidden'); document.getElementById("view-worker-management").classList.add('hidden'); document.getElementById("view-map").classList.add('hidden'); loadDashboard(); }
    
    window.getGeo = function() {
        if (!navigator.geolocation) { alert("Geolocation is not supported by your browser."); return; }
        const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
        const btn = document.getElementById("btn-get-geo");
        btn.innerText = "Locating...";
        btn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            (p) => {
                document.getElementById("ExactLocation").value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`;
                document.getElementById("Latitude").value = p.coords.latitude;
                document.getElementById("Longitude").value = p.coords.longitude;
                btn.innerText = "üìç GPS Set";
                btn.disabled = false;
            },
            (err) => {
                btn.innerText = "üìç Retry GPS";
                btn.disabled = false;
                let msg = "Error fetching location.";
                if (err.code === 1) msg = "Permission denied.";
                else if (err.code === 2) msg = "Position unavailable.";
                else if (err.code === 3) msg = "Timeout.";
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') { msg += " \nNOTE: GPS requires HTTPS."; }
                alert(msg);
            },
            options
        );
    };

    window.showAddUser = function() { document.getElementById("view-add-user").classList.remove('hidden'); }
    window.submitNewUser = async function() { const n=document.getElementById("new-user-name").value; const e=document.getElementById("new-user-email").value; const r=document.getElementById("new-user-role").value; const p=document.getElementById("new-user-pass").value; const res=await apiCall('/add-user','POST',{name:n,email:e,role:r,password:p}); if(res.success){alert("User Added"); document.getElementById("view-add-user").classList.add('hidden');} else alert(res.error); }
    window.showMap = function() { document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-map").classList.remove('hidden'); loadMapData(); }
    async function loadMapData() { const p = await apiCall('/map-data', 'POST'); if(!mapInstance) mapInstance=new google.maps.Map(document.getElementById("map"),{center:{lat:22.57,lng:88.36},zoom:5}); const listEl = document.getElementById("map-list-content"); listEl.innerHTML = ""; const infoWindow = new google.maps.InfoWindow(); p.forEach(x => { const marker = new google.maps.Marker({position:{lat:x.lat,lng:x.lng}, map:mapInstance, title:x.PermitID}); const content = `<div><b>${escapeHtml(x.PermitID)}</b><br>Loc: ${escapeHtml(x.ExactLocation)}<br>Req: ${escapeHtml(x.RequesterName)}<br>Valid: ${x.ValidTo}</div>`; marker.addListener("click", () => { infoWindow.setContent(content); infoWindow.open(mapInstance, marker); }); const item = document.createElement("div"); item.className = "p-3 border-b cursor-pointer hover:bg-orange-50 text-sm flex justify-between"; item.innerHTML = `<div><b>${escapeHtml(x.PermitID)}</b><div class="text-xs text-gray-500">${escapeHtml(x.ExactLocation)}</div></div><div class="text-xs font-bold text-orange-600">${escapeHtml(x.WorkType)}</div>`; item.onclick = () => { mapInstance.setCenter({lat:x.lat,lng:x.lng}); mapInstance.setZoom(12); infoWindow.setContent(`<b>${escapeHtml(x.PermitID)}</b><br>${escapeHtml(x.WorkType)}`); infoWindow.open(mapInstance, marker); }; listEl.appendChild(item); }); }
    
    // --- NEW SECURE PDF DOWNLOAD FUNCTION ---
    window.downloadSecurePDF = async function(id) {
        loader.style.display = 'flex';
        try {
            const headers = {};
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            
            const res = await fetch(`${API}/download-pdf/${id}`, {
                method: 'GET',
                headers: headers
            });

            if (res.status === 401 || res.status === 403) {
                alert("Session expired. Please login again.");
                location.reload();
                return;
            }

            if (!res.ok) throw new Error("Download failed");

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${id}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (e) {
            console.error(e);
            alert("Failed to download PDF. You might not have permission.");
        } finally {
            loader.style.display = 'none';
        }
    };

</script>
</body>
</html>

