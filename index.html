<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>IOCL e-Permit System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    
    <style>
        /* --- GLOBAL STYLES --- */
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 14px; color: #1e293b; }
        
        /* Glass Effect */
        .glass { 
            background: #ffffff; 
            padding: 1rem; 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            border: 1px solid #e2e8f0; 
            margin-bottom: 0.75rem; 
        }
        
        /* Inputs */
        input, select, textarea { 
            width: 100%; 
            border: 1px solid #cbd5e1; 
            padding: 6px 10px; 
            border-radius: 6px; 
            font-size: 0.9rem; 
            background: #f8fafc; 
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #f97316; 
            background: #fff; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1); 
        }
        input:disabled, select:disabled, textarea:disabled { 
            background-color: #f1f5f9; 
            color: #94a3b8; 
            border-color: #e2e8f0; 
            cursor: not-allowed;
        }
        
        label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 3px; display: block; }

        /* Custom Header Gradient */
        .iocl-gradient { background: linear-gradient(135deg, #003399 0%, #0044cc 50%, #ea580c 100%); }

        /* Tab Buttons */
        .tab-btn {
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab-btn.active { background-color: white; color: #003399; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-btn.inactive { background-color: transparent; color: rgba(255,255,255,0.8); hover:bg-white/10; }

        /* Section Titles */
        .section-title { 
            font-size: 1rem; 
            font-weight: 800; 
            color: #c2410c; 
            border-bottom: 2px solid #ffedd5; 
            padding-bottom: 0.5rem; 
            margin-bottom: 1rem; 
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Checklists Grid (2 columns on desktop) */
        .checklist-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 0.75rem; }
        @media (min-width: 1024px) { .checklist-grid { grid-template-columns: repeat(2, 1fr); gap: 1.5rem; } }

        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; gap: 10px; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tr { display: block; margin-bottom: 0.75rem; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
            .mobile-table td { display: flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; padding: 0.5rem 0; font-size: 0.85rem; align-items: center; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: 700; color: #64748b; margin-right: 1rem; text-align: left; }
            #view-map { flex-direction: column; }
            #map-list { height: 35vh; width: 100%; }
            #map-container { height: 65vh; width: 100%; }
        }
        
        @media (min-width: 769px) {
            .desktop-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
            table.mobile-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
            table.mobile-table thead { display: table-header-group; background: #ea580c; color: white; }
            table.mobile-table th, table.mobile-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; vertical-align: top; }
            #view-map { flex-direction: row; }
            #map-list { width: 320px; height: 100%; border-right: 1px solid #ddd; }
            #map-container { flex: 1; height: 100%; }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-800 mx-auto mb-2"></div>
        <div class="font-bold text-blue-800 tracking-wider">PROCESSING...</div>
    </div>

    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 bg-slate-100">
        <div class="bg-white w-full max-w-sm text-center shadow-xl rounded-2xl overflow-hidden border border-gray-200">
            <div class="bg-orange-50 p-8 border-b border-orange-100">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <img src="logo.png" alt="IOCL" class="h-16 object-contain">
                    <img src="rhino.png" alt="Rhino" class="h-16 object-contain">
                </div>
                <h1 class="text-2xl font-extrabold text-blue-900 mb-1">IndianOil</h1>
                <p class="text-orange-600 font-bold text-sm tracking-wide uppercase">e-Permit System (ERPL)</p>
            </div>
            <form onsubmit="event.preventDefault(); window.handleLogin();" class="p-8 space-y-5 text-left">
                <div><label>Select Role</label><select id="login-role" class="h-10" onchange="window.loadUserNames()"><option value="Requester">Requester</option><option value="Reviewer">Reviewer</option><option value="Approver">Approver</option></select></div>
                <div><label>User Name</label><select id="login-name" class="h-10" disabled><option>Loading...</option></select></div>
                <div><label>Password</label><input type="password" id="login-password" class="h-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transform transition active:scale-95">SECURE LOGIN</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden desktop-container pb-24">
        
        <div class="mb-5 iocl-gradient p-4 rounded-xl shadow-lg text-white sticky top-2 z-50">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-white p-1 rounded-full"><img src="logo.png" alt="Logo" class="h-8 w-8 object-contain"></div>
                    <div class="bg-white p-1 rounded-full"><img src="rhino.png" alt="Rhino" class="h-8 w-8 object-contain"></div>
                    <div class="leading-tight">
                        <h1 class="text-lg font-bold">Mainline Permit System</h1>
                        <span id="user-info" class="text-xs text-orange-100 font-medium tracking-wide bg-black/20 px-2 py-0.5 rounded"></span>
                    </div>
                </div>
                
                <nav class="flex bg-black/20 p-1 rounded-lg">
                    <button onclick="window.switchTab('dashboard')" id="tab-dash" class="tab-btn active">Dashboard</button>
                    <button onclick="window.switchTab('workers')" id="tab-work" class="tab-btn inactive">Worker Portal</button>
                </nav>

                <div class="flex gap-2">
                    <button onclick="window.showMap()" id="btn-header-map" class="bg-white/20 hover:bg-white/30 p-2 rounded-lg text-sm hidden transition" title="Map View">üó∫Ô∏è Map</button>
                    <button onclick="location.reload()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-bold shadow transition" title="Logout">Logout</button>
                </div>
            </div>
        </div>

        <div id="view-worker-management" class="hidden animate-fade-in">
             <div class="glass flex flex-col md:flex-row justify-between items-center gap-4">
                 <div>
                     <h2 class="text-xl font-bold text-blue-900 flex items-center gap-2"><span>üë∑</span> Worker Database</h2>
                     <p class="text-sm text-gray-500">Register and manage worker details for permits.</p>
                 </div>
                 <button onclick="window.openWorkerForm('create')" id="btn-add-worker" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2.5 rounded-lg font-bold shadow hidden transition">+ Register New Worker</button>
             </div>

             <div id="worker-form-container" class="glass hidden border-l-4 border-blue-500 bg-blue-50">
                 <div class="flex justify-between mb-4 border-b border-blue-200 pb-2">
                     <h3 class="font-bold text-lg text-blue-800">Worker Entry Form</h3>
                     <button onclick="document.getElementById('worker-form-container').classList.add('hidden')" class="text-gray-400 hover:text-red-500 font-bold px-2">‚úï Close</button>
                 </div>
                 <form onsubmit="event.preventDefault(); window.saveWorker(window.currentWorkerAction);" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                     <input type="hidden" id="w-id">
                     <div class="md:col-span-2"><label>Full Name</label><input id="w-name" required placeholder="Enter full name"></div>
                     <div class="md:col-span-2"><label>Father's Name</label><input id="w-father" required placeholder="Enter father's name"></div>
                     
                     <div class="md:col-span-1"><label>Age (18+)</label><input id="w-age" type="number" min="18" required></div>
                     <div class="md:col-span-1"><label>Gender</label><select id="w-gender"><option>Male</option><option>Female</option></select></div>
                     <div class="md:col-span-2"><label>Contact No</label><input id="w-contact" type="tel" placeholder="Mobile Number"></div>

                     <div class="md:col-span-4"><label>Address</label><input id="w-address" placeholder="Full residential address"></div>
                     
                     <div class="md:col-span-1">
                         <label>ID Type</label>
                         <select id="w-id-type" onchange="window.toggleOtherID()"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Any Other</option></select>
                         <input id="w-id-type-other" placeholder="Specify ID Name" class="hidden mt-2 text-xs bg-yellow-50 border-yellow-300">
                     </div>
                     <div class="md:col-span-3"><label>ID Number</label><input id="w-idcard" required placeholder="Enter ID number"></div>
                     
                     <button class="bg-green-600 text-white py-3 rounded-lg font-bold shadow hover:bg-green-700 md:col-span-4 mt-2">Save Worker Record</button>
                 </form>
             </div>
             
             <div class="overflow-hidden rounded-xl border border-gray-200 shadow-sm bg-white">
                <table class="mobile-table w-full text-left" id="table-workers"><thead class="bg-gray-100 text-gray-700"><tr><th>Name</th><th>Father Name</th><th>ID Details</th><th>Address & Contact</th><th>Requestor</th><th>Status</th><th>Action</th></tr></thead><tbody class="divide-y divide-gray-200"></tbody></table>
             </div>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3">Dashboard Overview</h2>
                <button onclick="window.showNewPermit()" id="btn-new-permit" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-bold shadow hidden transition">+ Create New Permit</button>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button onclick="window.showAddUser()" id="btn-add-user" class="glass bg-purple-50 text-purple-800 hover:bg-purple-100 border-purple-200 font-bold text-sm hidden transition py-3">Manage Users</button>
                <button onclick="window.showMap()" id="btn-view-map" class="glass bg-blue-50 text-blue-800 hover:bg-blue-100 border-blue-200 font-bold text-sm hidden transition py-3">Live Map View</button>
                <button onclick="window.open('/api/download-excel')" id="btn-download-excel" class="glass bg-green-50 text-green-800 hover:bg-green-100 border-green-200 font-bold text-sm hidden transition py-3">Download Excel Report</button>
            </div>
            
            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden">
                <div class="glass h-64 flex justify-center items-center"><canvas id="chartStatus"></canvas></div>
                <div class="glass h-64 flex justify-center items-center"><canvas id="chartType"></canvas></div>
            </div>

            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-red-600 text-sm uppercase mb-2 tracking-wider border-b-2 border-red-100 pb-1 flex items-center gap-2"><span>‚ö†Ô∏è</span> Action Required</h3>
                    <div class="overflow-hidden rounded-lg shadow-sm border border-gray-200">
                        <table class="mobile-table w-full text-sm bg-white" id="table-pending"><thead class="bg-red-50 text-red-900"><tr><th class="w-24">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Pending With</th><th class="w-24">Action</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-green-600 text-sm uppercase mb-2 tracking-wider border-b-2 border-green-100 pb-1 flex items-center gap-2"><span>‚úÖ</span> Active Permits</h3>
                    <div class="overflow-hidden rounded-lg shadow-sm border border-gray-200">
                        <table class="mobile-table w-full text-sm bg-white" id="table-active"><thead class="bg-green-50 text-green-900"><tr><th class="w-24">ID</th><th>Type</th><th>Location</th><th>Status</th><th class="w-24">Action</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-500 text-sm uppercase mb-2 tracking-wider border-b-2 border-gray-200 pb-1 flex items-center gap-2"><span>üìú</span> History / Closed</h3>
                    <div class="overflow-hidden rounded-lg shadow-sm border border-gray-200">
                        <table class="mobile-table w-full text-sm bg-white" id="table-other"><thead class="bg-gray-50 text-gray-700"><tr><th class="w-24">ID</th><th>Type</th><th>Location</th><th>Status</th><th class="w-24">View</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-form" class="hidden">
            <div class="flex items-center gap-3 mb-4 sticky top-20 z-40 bg-[#f1f5f9] pb-3 pt-2 border-b border-gray-200 shadow-sm">
                <button onclick="window.switchTab('dashboard')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow-sm font-bold text-sm hover:bg-gray-50 transition">‚Üê Back to Dashboard</button>
                <div id="permit-header-display" class="flex-1 p-2 bg-blue-50 border border-blue-200 text-blue-900 rounded-lg shadow-inner font-bold text-center text-sm truncate"></div>
            </div>

            <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden bg-orange-50/50">
                <h3 class="font-bold text-xs text-orange-800 uppercase mb-2">Deployed Workers & Approval Status</h3>
                <div id="assigned-worker-audit" class="overflow-x-auto max-h-40 overflow-y-auto bg-white border rounded"></div>
            </div>

            <form id="pf" class="space-y-4">
                <input type="hidden" id="PermitID" name="PermitID"><input type="hidden" id="Status" name="Status">
                
                <div class="glass">
                    <h3 class="section-title">1. Permit Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label>Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                        <div><label>Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                        <div><label>GPS Location</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" placeholder="Lat, Long"><button type="button" onclick="window.getGeo()" class="bg-orange-100 text-orange-700 px-3 rounded border border-orange-300 font-bold" id="btn-get-geo">üìç</button></div></div>
                        <input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude">

                        <div class="md:col-span-2"><label>Location Description</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                        <div><label>Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div>
                        
                        <div><label>Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom" onchange="window.checkDate()"></div>
                        <div><label>Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo" onchange="window.checkDate()"></div>
                        <div><label>Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                        
                        <div class="md:col-span-3"><label>Vendor / Contractor</label><input name="Vendor" id="Vendor" readonly class="bg-gray-100"></div>

                        <div><label>Requester Name</label><input name="RequesterName" id="RequesterName"></div>
                        <div><label>Select Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                        <div><label>Select Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                        
                        <div><label>Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                        <div><label>Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                        <div><label>Nearest Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div>
                        
                        <div class="md:col-span-3"><label>Description of Work</label><textarea name="Desc" id="Desc" rows="2"></textarea></div>
                    </div>
                </div>

                <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50 hidden">
                    <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800 text-sm">
                        <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5 accent-purple-600" onchange="document.getElementById('div-init-renewal').classList.toggle('hidden', !this.checked)">
                        Request 1st Renewal along with Permit
                    </label>
                    <div id="div-init-renewal" class="hidden mt-3 pt-3 border-t border-purple-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label>Renewal From</label><input type="datetime-local" name="InitRenFrom"></div>
                            <div><label>Renewal To</label><input type="datetime-local" name="InitRenTo"></div>
                            <div><label>Precautions</label><input name="InitRenPrec" placeholder="Specific precautions"></div>
                            
                            <div class="md:col-span-3 grid grid-cols-3 gap-3 bg-white p-3 rounded border border-purple-100">
                                <div><label>HC %</label><input name="InitRenHC"></div>
                                <div><label>Toxic PPM</label><input name="InitRenTox"></div>
                                <div><label>O2 %</label><input name="InitRenO2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass" id="section-e">
                    <h3 class="section-title">E. References</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input name="SopNo" id="SopNo" placeholder="SOP/SWP No">
                        <input name="JsaNo" id="JsaNo" placeholder="JSA No">
                        <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equipment">
                        <input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                        <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No">
                        <input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="TBT Ref"> 
                    </div>
                </div>

                <div class="glass"><h3 class="section-title">2. Checklists</h3><div id="checklists-wrapper" class="checklist-grid"></div></div>
                
                <div class="glass" id="worker-select-section">
                    <h3 class="section-title">Workers (Approved)</h3>
                    <div id="worker-checkboxes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    <div id="worker-readonly-table" class="hidden overflow-x-auto">
                        <table class="mobile-table w-full text-xs text-left"><tbody class="divide-y"></tbody></table>
                    </div>
                </div>

                <div class="glass" id="hazards-section">
                    <h3 class="section-title">3. Hazards</h3>
                    <div class="flex flex-wrap gap-3 mb-2" id="hazards-container"></div>
                    <div id="other-hazard-div" class="hidden"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div>
                </div>

                <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500">
                    <h3 class="section-title text-yellow-700">4. Reviewer</h3>
                    <div class="mb-3 hidden" id="iocl-reviewer-wrapper">
                        <label>Authorized IOCL Supervisors</label><div id="iocl-sup-container-rev" class="space-y-2 mt-1"></div>
                        <button type="button" onclick="window.addIOCLRow('iocl-sup-container-rev')" class="mt-2 text-xs bg-gray-200 px-3 py-1 rounded font-bold hover:bg-gray-300">+ Add Supervisor</button>
                    </div>
                    <div class="mb-2 font-bold text-xs text-gray-600">PPE Required:</div>
                    <div class="flex flex-wrap gap-2 mb-3" id="ppe-container"></div>
                    <div class="grid grid-cols-1 gap-2">
                        <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks"></textarea>
                        <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions"></textarea>
                    </div>
                </div>

                <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                    <h3 class="section-title text-green-700">5. Approval</h3>
                    <div class="mb-3 hidden" id="iocl-approver-wrapper">
                        <label>Authorized IOCL Supervisors (Verify/Edit)</label><div id="iocl-sup-container-app" class="space-y-2 mt-1"></div>
                        <button type="button" onclick="window.addIOCLRow('iocl-sup-container-app')" class="mt-2 text-xs bg-gray-200 px-3 py-1 rounded font-bold hover:bg-gray-300">+ Add Supervisor</button>
                    </div>
                    <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks"></textarea>
                    <div id="pdf-color-select" class="mt-3 hidden flex items-center gap-3">
                        <label>PDF Background:</label><select id="PdfBgColor" class="w-48"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select>
                    </div>
                </div>

                <div id="iocl-sup-display-section" class="glass hidden"><h3 class="section-title">Authorized Supervisors</h3><table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit</th></tr></thead><tbody></tbody></table></div>

                <div id="renewals-section" class="glass hidden">
                    <h3 class="section-title">Renewals</h3>
                    
                    <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse">
                        <h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Action</h4>
                        <p class="text-xs text-gray-600 mb-2">Decide on the attached 1st renewal request.</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-green-700"><input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Recommend / Approve</label>
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700"><input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal Only</label>
                        </div>
                    </div>

                    <div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                        <h4 class="font-bold text-yellow-800 text-sm">‚ö†Ô∏è Pending Renewal</h4>
                        <div class="flex flex-wrap gap-4 mt-2 font-mono text-xs">
                            <span>From: <b id="disp-ren-from"></b></span><span>To: <b id="disp-ren-to"></b></span><span>Gas: <b id="disp-ren-gas"></b></span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto mb-4"><table class="mobile-table w-full text-xs text-left" id="table-renewals"><thead class="hidden md:table-header-group"><tr><th>Period</th><th>Gas/Prec</th><th>Workers</th><th>Req</th><th>Rev</th><th>App</th><th>Status</th></tr></thead><tbody id="renewals-list" class="divide-y"></tbody></table></div>
                    
                    <div id="form-renewal" class="hidden p-4 bg-blue-50 mt-2 rounded border border-blue-100">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-3">
                            <input type="datetime-local" id="RenewalValidFrom"> <input type="datetime-local" id="RenewalValidTo">
                            <input id="RenewalHC" placeholder="HC %"> <input id="RenewalToxic" placeholder="Toxic"> <input id="RenewalOxygen" placeholder="O2 %">
                        </div>
                        <div class="mt-2 border-t border-blue-200 pt-2"><label>Select Workers</label><div id="renewal-worker-select" class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-32 overflow-y-auto text-xs"></div></div>
                        <input id="RenewalPrec" placeholder="Precautions" class="mt-3"><button type="button" onclick="window.submitRenewal('approve')" class="w-full bg-blue-600 text-white py-2 rounded font-bold shadow mt-3">Submit Renewal Request</button>
                    </div>
                    
                    <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded border border-yellow-100">
                        <textarea id="RenewalRemark" placeholder="Rejection Reason" class="mb-3"></textarea>
                        <div class="grid grid-cols-2 gap-3"><button type="button" onclick="window.submitRenewal('approve')" class="bg-green-600 text-white py-2 rounded font-bold">Approve</button><button type="button" onclick="window.submitRenewal('reject')" class="bg-red-600 text-white py-2 rounded font-bold">Reject</button></div>
                    </div>
                </div>
                
                <div id="closure-section" class="glass hidden">
                    <h3 class="section-title">Closure</h3>
                    <label class="flex items-center gap-3 mb-3 font-bold text-red-600 p-2 bg-red-50 rounded border border-red-100 text-sm"><input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5 accent-red-600"> Site Restored & Cleaned</label>
                    <div id="div-closure-req" class="hidden mb-2"><label>Requester Remarks</label><textarea id="Closure_Requestor_Remarks"></textarea><span id="ts-clos-req" class="text-xs text-right block text-gray-400"></span></div>
                    <div id="div-closure-rev" class="hidden mb-2"><label>Reviewer Remarks</label><textarea id="Closure_Reviewer_Remarks"></textarea><span id="ts-clos-rev" class="text-xs text-right block text-gray-400"></span></div>
                    <div id="div-closure-app" class="hidden"><label>Approver Remarks</label><textarea id="Closure_Approver_Remarks"></textarea><span id="ts-clos-app" class="text-xs text-right block text-gray-400"></span></div>
                </div>

                <div id="signature-history" class="glass hidden"><h3 class="section-title">History</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs"><div class="border p-2 rounded bg-gray-50">App: <span id="sig-app" class="font-bold"></span></div><div class="border p-2 rounded bg-gray-50">Ren: <span id="sig-ren" class="font-bold"></span></div><div class="border p-2 rounded bg-gray-50">Close: <span id="sig-clos" class="font-bold"></span></div></div></div>
                
                <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden">
                    <label class="flex items-start gap-3 p-2 cursor-pointer">
                        <input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded">
                        <span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules.</span>
                    </label>
                </div>

                <div id="actions" class="mt-6 flex flex-col md:flex-row justify-end gap-3 sticky bottom-0 bg-white/95 backdrop-blur border-t p-4 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]"></div>
            </form>
        </div>
    </div>

    <div id="view-add-user" class="hidden flex justify-center fixed inset-0 z-50 bg-black/50 items-center p-4"><div class="glass w-full max-w-sm relative animate-scale-up"><button onclick="window.showDashboard()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-800 font-bold px-2">‚úï</button><h3 class="font-bold mb-4">Add New User</h3><form onsubmit="event.preventDefault(); window.submitNewUser();" class="space-y-3"><input id="new-user-name" placeholder="Full Name" required><input id="new-user-email" placeholder="Email" required><select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select><input id="new-user-pass" type="password" placeholder="Password" required><button class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow">Create User</button></form></div></div>

    <script>
        const API = "/api";
        let currentUser = null; 
        let usersData = {}; 
        let mapInstance = null; 
        let chartS = null; 
        let chartT = null;
        let currentPermitWorkers = []; 
        let currentPermitId = null; 
        const loader = document.getElementById('loader');

        // Initialize
        document.addEventListener("DOMContentLoaded", () => { window.loadUsers(); renderUI(); });

        // --- NEW TAB SWITCHING LOGIC (ROBUST) ---
        window.switchTab = function(tabName) {
            const dashView = document.getElementById("view-dashboard");
            const workView = document.getElementById("view-worker-management");
            const dashTab = document.getElementById("tab-dash");
            const workTab = document.getElementById("tab-work");
            
            // Safety check for null elements
            if(!dashView || !workView) return;

            // Hide Form & Map if open
            const formView = document.getElementById("view-form");
            const mapView = document.getElementById("view-map");
            if(formView) formView.classList.add("hidden");
            if(mapView) mapView.classList.add("hidden");

            if (tabName === 'dashboard') {
                dashView.classList.remove("hidden");
                workView.classList.add("hidden");
                if(dashTab) { dashTab.classList.add("active"); dashTab.classList.remove("inactive"); }
                if(workTab) { workTab.classList.remove("active"); workTab.classList.add("inactive"); }
                loadDashboard();
            } else {
                dashView.classList.add("hidden");
                workView.classList.remove("hidden");
                if(workTab) { workTab.classList.add("active"); workTab.classList.remove("inactive"); }
                if(dashTab) { dashTab.classList.remove("active"); dashTab.classList.add("inactive"); }
                loadWorkers('dashboard');
            }
        };

        // --- RENDER UI (COMPACT GRID) ---
        const CL_DATA = { 
            A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked, cleaned and covered.", "3. Manholes, Sewers, CBD covered.", "4. Hazards considered & alerted.", "5. Equipment blinded/disconnected/isolated.", "6. Drained and depressurized.", "7. Steamed/purged.", "8. Water flushed.", "9. Fire Tender approach free.", "10. Iron Sulfide removed/wet.", "11. Electrical isolation tagged.", "12. Gas Test: HC / Toxic / O2 checked.", "13. Fire water/extinguisher available.", "14. Cordoned off & Tagged.", "15. CCTV monitoring.", "16. Ventilation/Lighting."], 
            B: ["1. Exit/escape provided.", "2. Standby personnel provided.", "3. Checked for trapped oil/gas.", "4. Spark shield provided.", "5. Equipment grounded.", "6. Standby for confined space.", "7. Communication provided.", "8. Rescue Equipment/SCABA.", "9. Space Cooled.", "10. Inert Gas Flow.", "11. ELCB/Earthing checked.", "12. Cylinders outside.", "13. Spark arrestor checked.", "14. Welding Machine safe.", "15. Height Permit taken."], 
            C: ["1. PESO spark elimination system provided."], 
            D: ["1. Shoring/shuttering provided.", "2. Soil at safe distance.", "3. Safe access provided.", "4. Heavy vehicle prohibited."] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        async function apiCall(ep, meth="GET", body=null) {
            loader.style.display = 'flex';
            try {
                const opts={method:meth,headers:{'Content-Type':'application/json'}};
                if(body)opts.body=JSON.stringify(body);
                const res=await fetch(API+ep,opts); return await res.json();
            } finally { loader.style.display = 'none'; }
        }

        window.toggleSection = function(sec, val) {
            document.querySelectorAll(`input[name^="${sec}_Q"][value="${val}"]`).forEach(r => r.checked = true);
        }

        function renderUI() {
            let h = '';
            ['A','B','C','D'].forEach(sec => {
                h += `<div class="glass p-2">
                        <div class="flex justify-between items-center border-b pb-1 mb-1">
                            <div class="font-bold text-orange-700 text-xs">SECTION ${sec}</div>
                            <div class="flex gap-2 text-[10px] items-center bg-orange-50 p-1 rounded">
                                <span class="font-bold text-gray-600">ALL:</span>
                                <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="Master_${sec}" value="Yes" checked onchange="window.toggleSection('${sec}', 'Yes')"> Yes</label>
                                <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="Master_${sec}" value="NA" onchange="window.toggleSection('${sec}', 'NA')"> NA</label>
                                <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="Master_${sec}" value="No" onchange="window.toggleSection('${sec}', 'No')"> No</label>
                            </div>
                        </div>`;
                
                h += CL_DATA[sec].map((t, i) => {
                    const id = `${sec}_Q${i+1}`;
                    let remInput = `<input name="${id}_Detail" placeholder="Rem" class="w-full mt-1 border-gray-100 bg-white text-xs">`;
                    if(sec==='A' && i===11) remInput = `<div class="flex gap-1 mt-1"><input name="GP_Q12_HC" placeholder="HC%" class="w-1/3 text-xs"><input name="GP_Q12_ToxicGas" placeholder="Tox" class="w-1/3 text-xs"><input name="GP_Q12_Oxygen" placeholder="O2%" class="w-1/3 text-xs"></div>`;
                    
                    return `<div class="mb-1 p-1 border rounded bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div class="text-[11px] font-medium text-gray-800 leading-tight w-2/3">${t}</div>
                                    <div class="flex gap-2 ml-1">
                                        <label class="flex items-center gap-0.5 text-[10px]"><input type="radio" name="${id}" value="Yes" checked> Y</label>
                                        <label class="flex items-center gap-0.5 text-[10px]"><input type="radio" name="${id}" value="NA"> NA</label>
                                        <label class="flex items-center gap-0.5 text-[10px]"><input type="radio" name="${id}" value="No"> N</label>
                                    </div>
                                </div>
                                ${remInput}
                            </div>`;
                }).join('');
                h += `</div>`;
            });
            document.getElementById('checklists-wrapper').innerHTML = h;
            
            document.getElementById('hazards-container').innerHTML = HAZARDS.map(z => {
                const v = z.replace(/ /g,'');
                const ch = z==='Others' ? `onchange="document.getElementById('other-hazard-div').classList.toggle('hidden',!this.checked)"` : '';
                return `<label class="flex items-center gap-1 border px-2 py-1 rounded bg-white hover:bg-orange-50 transition text-xs cursor-pointer"><input type="checkbox" name="H_${v}" value="Y" ${ch} class="w-3 h-3 text-orange-600"> ${z}</label>`;
            }).join('');
            
            document.getElementById('ppe-container').innerHTML = PPE.map(p => `<label class="flex items-center gap-1 border px-2 py-1 rounded bg-white hover:bg-blue-50 transition text-xs cursor-pointer"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="w-3 h-3 text-blue-600"> ${p}</label>`).join('');
        }

        window.loadUsers = async function() { try { const u = await apiCall('/users'); usersData = u; document.getElementById("login-role").value = "Requester"; loadUserNames(); } catch (e) { console.error("Failed", e); } }
        window.loadUserNames = function() { const role = document.getElementById("login-role").value; const names = usersData[role+'s'] || []; const sel = document.getElementById("login-name"); sel.innerHTML = names.map(u => `<option value="${u.email}">${u.name}</option>`).join(''); sel.disabled = false; }
        
        window.handleLogin = async function() { 
            const r=document.getElementById("login-role").value; const n=document.getElementById("login-name").options[document.getElementById("login-name").selectedIndex].text; const e=document.getElementById("login-name").value; const p=document.getElementById("login-password").value; 
            const res=await apiCall('/login','POST',{role:r,name:e,password:p}); 
            if(res.success){ 
                currentUser={...res.user, name:n}; 
                document.getElementById("view-login").classList.add('hidden'); document.getElementById("app-container").classList.remove('hidden'); document.getElementById("user-info").innerText=`${n} (${r})`; updateRoleUI(); loadDashboard(); 
            } else alert("Invalid Login"); 
        }
        
        window.doLogout = function() { location.reload(); }

        function updateRoleUI() { 
            if(currentUser.Role==='Requester') { 
                document.getElementById("btn-new-permit").classList.remove('hidden'); 
                // Fix: Properly unhide the add worker button
                const addWorkerBtn = document.getElementById("btn-add-worker");
                if(addWorkerBtn) addWorkerBtn.classList.remove('hidden'); 
                document.getElementById("btn-header-map").classList.add('hidden'); 
            } 
            if(currentUser.Role!=='Requester') { 
                document.getElementById("btn-view-map").classList.remove('hidden'); 
                document.getElementById("btn-download-excel").classList.remove('hidden'); 
                document.getElementById("charts-container").classList.remove('hidden'); 
                document.getElementById("btn-header-map").classList.remove('hidden'); 
                loadStats(); 
                if(currentUser.Role==='Approver') document.getElementById("btn-add-user").classList.remove('hidden'); 
            } 
        }

        async function loadStats() { const res=await apiCall('/stats','POST'); if(chartS)chartS.destroy(); if(chartT)chartT.destroy(); chartS=new Chart(document.getElementById('chartStatus'),{type:'doughnut',data:{labels:Object.keys(res.statusCounts),datasets:[{data:Object.values(res.statusCounts)}]}}); chartT=new Chart(document.getElementById('chartType'),{type:'bar',data:{labels:Object.keys(res.typeCounts),datasets:[{label:'Types',data:Object.values(res.typeCounts)}]}}); }
        
        window.toggleOtherID = function() { const val = document.getElementById("w-id-type").value; const otherInput = document.getElementById("w-id-type-other"); if(val === "Other") otherInput.classList.remove("hidden"); else otherInput.classList.add("hidden"); }
        // Worker Toggle Button now just switches tabs
        window.toggleWorkerMode = function() { window.switchTab('workers'); }
        
        window.openWorkerForm = function(act, data=null) { 
            window.currentWorkerAction = act; const form = document.getElementById('worker-form-container'); form.classList.remove('hidden'); 
            if(act === 'create') { document.getElementById('w-id').value = ''; document.querySelectorAll('#worker-form-container input').forEach(i => i.value = ''); } 
            else if (act === 'edit_request' && data) { 
                document.getElementById('w-id').value = data.WorkerID; document.getElementById('w-name').value = data.Name; document.getElementById('w-father').value = data.Father; document.getElementById('w-address').value = data.Address; document.getElementById('w-contact').value = data.Contact; document.getElementById('w-idcard').value = data.ID; document.getElementById('w-gender').value = data.Gender; document.getElementById('w-age').value = data.Age; 
                const idType = data.IDType || "Voter Card"; const isStandard = ["Voter Card", "PAN Card"].includes(idType); document.getElementById("w-id-type").value = isStandard ? idType : "Other"; window.toggleOtherID(); if(!isStandard) document.getElementById("w-id-type-other").value = idType; 
            } 
        }
        
        window.saveWorker = async function(act) { 
            const idTypeRaw = document.getElementById("w-id-type").value; const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw; 
            if(parseInt(document.getElementById("w-age").value) < 18) { alert("Worker must be 18+"); return; }
            const body = { Action: act, Role: currentUser.Role, RequestorEmail: currentUser.Email, WorkerID: document.getElementById('w-id').value, ApproverName: currentUser.name, RequestorName: currentUser.name, Details: { Name:document.getElementById("w-name").value, Father:document.getElementById("w-father").value, Address:document.getElementById("w-address").value, Contact:document.getElementById("w-contact").value, ID:document.getElementById("w-idcard").value, Gender:document.getElementById("w-gender").value, Age:document.getElementById("w-age").value, IDType: idTypeFinal } }; 
            const res = await apiCall('/save-worker', 'POST', body); if(res.success) { alert("Saved"); loadWorkers('dashboard'); document.getElementById('worker-form-container').classList.add('hidden'); } else alert(res.error); 
        }

        async function loadWorkers(context) { const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); if(context === 'permit_dropdown') { const con = document.getElementById('worker-checkboxes'); con.innerHTML = res.map(w => `<label class="flex items-center gap-1 border p-1 rounded bg-gray-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-4 h-4"> <span class="font-bold">${w.Name}</span> <span class="text-xs text-gray-500">(${w.Age})</span></label>`).join(''); } else { const t = document.querySelector('#table-workers tbody'); t.innerHTML = res.map(w => `<tr><td data-label="Name" class="font-bold text-blue-600">${w.Name}</td><td data-label="Father">${w.Father}</td><td data-label="ID Details">${w.IDType || 'ID'}: ${w.ID}</td><td data-label="Address/Contact">${w.Address}<br><span class="text-xs text-blue-600">${w.Contact}</span></td><td data-label="Requestor" class="font-bold text-indigo-600">${w.RequestorName || 'Unknown'}</td> <td data-label="Status"><span class="px-2 py-1 rounded text-xs font-bold ${w.Status==='Approved'?'bg-green-100 text-green-800':(w.Status==='Rejected'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800')}">${w.Status}</span>${w.ApprovedBy ? `<div class="text-[10px] mt-1 text-green-700">App: ${w.ApprovedBy}<br>${w.ApprovedAt}</div>` : ''}</td><td data-label="Action">${(currentUser.Role !== 'Requester' && w.Status.includes('Pending')) ? `<button onclick="window.workerAction('${w.WorkerID}','approve')" class="text-green-600 font-bold border p-1 rounded hover:bg-green-50">Approve</button> <button onclick="window.workerAction('${w.WorkerID}','reject')" class="text-red-600 font-bold border p-1 rounded hover:bg-red-50 ml-2">Reject</button>` : ''}${(currentUser.Role==='Requester' && w.Status==='Approved') ? `<button onclick='window.openWorkerForm("edit_request", ${JSON.stringify(w)})' class="text-blue-600 font-bold mr-2">Edit</button> <button onclick="window.workerAction('${w.WorkerID}','delete')" class="text-red-600 font-bold">Del</button>` : ''}</td></tr>`).join(''); } }
        window.workerAction = async function(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.name}); loadWorkers('dashboard'); }
        async function loadDashboard() { const res = await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email}); const tP=document.querySelector('#table-pending tbody'), tA=document.querySelector('#table-active tbody'), tO=document.querySelector('#table-other tbody'); tP.innerHTML=""; tA.innerHTML=""; tO.innerHTML=""; res.forEach(p => { let pendingWith = "-"; if(p.Status.includes('Review')) pendingWith = p.ReviewerEmail ? p.ReviewerEmail.split('@')[0] : '-'; if(p.Status.includes('Approval')) pendingWith = p.ApproverEmail ? p.ApproverEmail.split('@')[0] : '-'; const statusColor = p.Status.includes('Pending') ? 'text-red-600' : (p.Status==='Active' ? 'text-green-600' : 'text-gray-600'); const row = `<tr class="cursor-pointer hover:bg-orange-50 transition" onclick="window.openPermit('${p.PermitID}')"><td data-label="ID" class="font-bold text-blue-600 text-lg">${p.PermitID}</td><td data-label="Type" class="font-medium">${p.WorkType}</td><td data-label="Loc" class="text-gray-600">${p.LocationUnit}</td><td data-label="Status" class="font-bold ${statusColor}">${p.Status}</td><td data-label="With" class="text-sm text-gray-500">${pendingWith}</td><td data-label="Action"><span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">OPEN</span></td></tr>`; let isAction = false; const s = p.Status; if(currentUser.Role === 'Reviewer') { if((s === 'Pending Review' || s === 'Renewal Pending Review' || s === 'Closure Pending Review') && p.ReviewerEmail === currentUser.Email) isAction = true; } else if(currentUser.Role === 'Approver') { if((s === 'Pending Approval' || s === 'Renewal Pending Approval' || s === 'Closure Pending Approval') && p.ApproverEmail === currentUser.Email) isAction = true; } else if (currentUser.Role === 'Requester') { if (s.includes('Pending')) isAction = true; } if(isAction) tP.innerHTML += row; else if(s === 'Active') tA.innerHTML += row; else tO.innerHTML += row; }); }

        const getNow = () => new Date().toLocaleString("en-GB").replace(',','');
        window.addIOCLRow = function(containerId, data = {}) { if(data.is_deleted) return; const div = document.createElement('div'); div.className = "flex gap-1 iocl-row items-center"; const auditData = `<input type="hidden" class="iocl-added-by" value="${data.added_by || currentUser.name}"><input type="hidden" class="iocl-added-at" value="${data.added_at || getNow()}">`; div.innerHTML = `${auditData}<input placeholder="Name" value="${data.name||''}" class="iocl-name w-1/3 text-xs border border-gray-300 rounded p-1"><input placeholder="Desig" value="${data.desig||''}" class="iocl-desig w-1/3 text-xs border border-gray-300 rounded p-1"><input placeholder="Contact" value="${data.contact||''}" class="iocl-contact w-1/3 text-xs border border-gray-300 rounded p-1"><button type="button" onclick="window.markIOCLDeleted(this)" class="text-red-500 font-bold px-2 hover:bg-red-50 rounded">x</button>`; document.getElementById(containerId).appendChild(div); }
        window.markIOCLDeleted = function(btn) { const row = btn.parentElement; row.classList.add('hidden', 'marked-deleted'); }
        window.getIOCLData = function(containerId) { const rows = document.querySelectorAll(`#${containerId} .iocl-row`); const results = []; rows.forEach(r => { const name = r.querySelector('.iocl-name').value; if(!name) return; const isDel = r.classList.contains('marked-deleted'); const obj = { name: name, desig: r.querySelector('.iocl-desig').value, contact: r.querySelector('.iocl-contact').value, added_by: r.querySelector('.iocl-added-by').value, added_at: r.querySelector('.iocl-added-at').value, is_deleted: isDel }; if(isDel) { obj.deleted_by = currentUser.name; obj.deleted_at = getNow(); } results.push(obj); }); if(window.currentPermitIOCLData) { const alreadyDeleted = window.currentPermitIOCLData.filter(x => x.is_deleted); alreadyDeleted.forEach(d => results.push(d)); } return results; }

        window.openPermit = async function(id) {
            const p = await apiCall('/permit-data', 'POST', {permitId:id});
            currentPermitId = id;
            window.currentPermitIOCLData = p.IOCLSupervisors || []; 

            document.getElementById("permit-header-display").innerText = `${id} | ${p.Status}`;
            document.getElementById("permit-worker-audit-display").classList.remove("hidden");
            
            if(document.getElementById("assigned-worker-audit")) {
                document.getElementById("assigned-worker-audit").innerHTML = `<table class="mobile-table w-full text-xs"><thead><tr><th>Name</th><th>ID Details</th><th>Father</th><th>Requestor</th><th>Approval Trail</th></tr></thead><tbody>${p.SelectedWorkers.map(w=>`<tr><td data-label="Name">${w.Name} (${w.Age})</td><td data-label="ID">${w.IDType || 'ID'}: ${w.ID}</td><td data-label="Father">${w.Father}</td><td data-label="Requestor">${w.RequestorName || '-'}</td><td data-label="Approval"><span class="text-green-700 font-bold">Approved by ${w.ApprovedBy||'Admin'} on ${w.ApprovedAt||p.CreatedDate}</span></td></tr>`).join('')}</tbody></table>`;
            }

            const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
            rS.innerHTML=""; aS.innerHTML=""; 
            if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); }

            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };

            // 1. DISABLE EVERYTHING INITIALLY
            document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => {
                if(e.type==='radio'){ if(e.value===p[e.name]) e.checked=true; } else if(e.type==='checkbox'){ e.checked=(p[e.name]==='Y'); } else { e.value=p[e.name]||''; }
                e.disabled=true; 
            });
            
            safeSet("Closure_Requestor_Remarks", p.Closure_Requestor_Remarks || "");
            safeSet("Closure_Reviewer_Remarks", p.Closure_Reviewer_Remarks || "");
            safeSet("Closure_Approver_Remarks", p.Closure_Approver_Remarks || "");

            await loadWorkers('permit_dropdown');
            let workersArr = [];
            if(p.SelectedWorkers) { if(Array.isArray(p.SelectedWorkers)) workersArr = p.SelectedWorkers; else if(typeof p.SelectedWorkers === 'string') { try { workersArr = JSON.parse(p.SelectedWorkers); } catch(e){} } }
            currentPermitWorkers = workersArr;

            const r=currentUser.Role, s=p.Status;
            
            // Update Renewals Table
            const rens = JSON.parse(p.RenewalsJSON || "[]");
            document.querySelector("#table-renewals tbody").innerHTML = rens.map(r => `<tr><td data-label="Period" class="font-mono text-[10px] leading-tight">Start: ${r.valid_from.replace('T',' ')}<br>End: ${r.valid_till.replace('T',' ')}</td><td data-label="Gas & Prec" class="text-[10px]">HC:${r.hc} | O2:${r.oxygen} | Tox:${r.toxic}<br>Prec: ${r.precautions || '-'}</td><td data-label="Workers" class="text-[10px]">${r.worker_list ? r.worker_list.join(', ') : 'All'}</td><td data-label="Req" class="text-[10px]">${r.req_name}<br>${r.req_at}</td><td data-label="Rev" class="text-[10px]">${r.rev_name||'-'}</td><td data-label="App" class="text-[10px]">${r.app_name||'-'}</td><td data-label="Status"><span class="font-bold ${r.status==='rejected'?'text-red-600':'text-green-600'}">${r.status}</span></td></tr>`).join('');
            
            if (rens.length > 0) {
                document.getElementById("renewals-section").classList.remove('hidden');
            }

            // --- 2. FIX: ENABLE RENEWAL RADIO BUTTONS ---
            document.getElementById("first-renewal-decision").classList.add('hidden');
            document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.checked = false);

            if (rens.length === 1) {
                if (r === 'Reviewer' && s === 'Pending Review' && rens[0].status === 'pending_review') {
                    document.getElementById("first-renewal-decision").classList.remove('hidden');
                    document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.disabled = false);
                }
                if (r === 'Approver' && s === 'Pending Approval' && rens[0].status === 'pending_approval') {
                    document.getElementById("first-renewal-decision").classList.remove('hidden');
                    document.querySelectorAll('input[name="FirstRenewalAction"]').forEach(el => el.disabled = false);
                }
            }

            if(s==='Pending Review' && r==='Requester') {
               document.getElementById('worker-checkboxes').classList.remove('hidden');
               document.getElementById('worker-readonly-table').classList.add('hidden');
               document.querySelectorAll('#worker-checkboxes input').forEach(c => {
                   const wData = JSON.parse(c.value);
                   if(workersArr.find(sw => sw.WorkerID === wData.WorkerID)) c.checked = true;
                   c.disabled = false;
               });
            } else {
               document.getElementById('worker-checkboxes').classList.add('hidden');
               const wTable = document.querySelector('#worker-readonly-table tbody');
               wTable.innerHTML = workersArr.map(w => `<tr><td data-label="Name" class="font-bold">${w.Name}</td><td data-label="Gender">${w.Gender||'-'}</td><td data-label="Age">${w.Age}</td><td data-label="Cont">${p.RequesterName}</td></tr>`).join('');
               document.getElementById('worker-readonly-table').classList.remove('hidden');
            }
            
            if(r === 'Requester' && (s === 'New' || s === 'Pending Review')) {
                document.getElementById("ExactLocation").disabled = false; document.getElementById("btn-get-geo").disabled = false; document.getElementById("Latitude").disabled = false; document.getElementById("Longitude").disabled = false;
            } else {
                document.getElementById("ExactLocation").disabled = true; document.getElementById("btn-get-geo").disabled = true; document.getElementById("Latitude").disabled = true; document.getElementById("Longitude").disabled = true;
            }

            if(p.H_Others==='Y') document.getElementById('other-hazard-div').classList.remove('hidden');

            ['fs-reviewer-section', 'fs-approver-section', 'closure-section', 'pending-renewal-display', 'action-renewal', 'signature-history', 'iocl-sup-display-section', 'iocl-reviewer-wrapper', 'iocl-approver-wrapper'].forEach(id => document.getElementById(id).classList.add('hidden'));
            
            document.getElementById("init-renewal-wrapper").classList.add('hidden');

            const ioclData = p.IOCLSupervisors || [];
            document.getElementById("iocl-sup-container-rev").innerHTML = ""; document.getElementById("iocl-sup-container-app").innerHTML = "";
            ioclData.forEach(d => { window.addIOCLRow('iocl-sup-container-rev', d); window.addIOCLRow('iocl-sup-container-app', d); });
            
            const dispTable = document.querySelector('#table-iocl-display tbody');
            let dispHTML = ioclData.length === 0 ? '<tr><td colspan="4" class="text-gray-400">No Supervisors Added</td></tr>' : ioclData.map(x => {
                let style = x.is_deleted ? 'style="text-decoration: line-through; color: red;"' : '';
                let audit = `Added by ${x.added_by} on ${x.added_at}` + (x.is_deleted ? `<br><span class="text-red-600 font-bold">Deleted by ${x.deleted_by} on ${x.deleted_at}</span>` : '');
                return `<tr ${style}><td>${x.name}</td><td>${x.desig}</td><td>${x.contact}</td><td class="text-[10px]">${audit}</td></tr>`;
            }).join('');
            dispTable.innerHTML = dispHTML;

            const isDataView = (s === 'Active' || s === 'Closed' || s.includes('Renewal') || s.includes('Closure'));
            if (isDataView) {
                document.getElementById("iocl-sup-display-section").classList.remove('hidden');
            }

            if (r === 'Reviewer' && s === 'Pending Review') {
                 document.getElementById("iocl-reviewer-wrapper").classList.remove('hidden');
            }
            if (r === 'Approver') {
                if (s === 'Pending Approval' || s === 'Active' || s.includes('Renewal')) {
                     document.getElementById("iocl-approver-wrapper").classList.remove('hidden');
                }
            }

            let btns = "";

            if(s === 'Pending Review') {
                if(r==='Requester') { 
                   document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e=>e.disabled=false); 
                   document.getElementById("Vendor").value = currentUser.name; document.getElementById("Vendor").readOnly=true; 
                   document.getElementById("RequesterName").disabled=false; 
                   btns=`<button type="button" onclick="window.savePermit()" class="w-full bg-blue-600 text-white px-3 rounded-lg font-bold shadow-lg">Update Permit</button>`; 
                }
                if(r==='Reviewer') { 
                   document.getElementById("fs-reviewer-section").classList.remove('hidden');
                   document.querySelectorAll('#fs-reviewer-section *, #hazards-section input').forEach(e=>e.disabled=false);
                   btns=`<button type="button" onclick="window.upd('reject')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('review')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Submit Review</button>`; 
                }
            }
            if(s === 'Pending Approval') {
                document.getElementById("fs-reviewer-section").classList.remove('hidden');
                if(r==='Approver') { 
                   document.getElementById("fs-approver-section").classList.remove('hidden');
                   document.getElementById("Approver_Remarks").disabled=false; 
                   btns=`<button type="button" onclick="window.upd('reject')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Approve</button>`; 
                }
            }
            if(s==='Active' || s.includes('Renewal') || s.includes('Closure') || s==='Closed') {
                document.getElementById("fs-reviewer-section").classList.remove('hidden'); document.getElementById("fs-approver-section").classList.remove('hidden'); document.getElementById("renewals-section").classList.remove('hidden');
                
                const last = rens[rens.length-1];
                
                if(r==='Requester' && (!last || (last.status!=='pending_review' && last.status!=='pending_approval'))) {
                        document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-req").classList.remove('hidden');
                        document.getElementById("Closure_Requestor_Remarks").disabled = false; document.getElementById("Site_Restored_Check").disabled = false;
                        
                        document.getElementById("form-renewal").classList.remove('hidden'); document.querySelectorAll('#form-renewal input').forEach(e => e.disabled = false);
                        const renSel = document.getElementById('renewal-worker-select'); renSel.innerHTML = currentPermitWorkers.map(w => `<label class="flex items-center gap-1 text-xs bg-white p-1 rounded border"><input type="checkbox" value="${w.Name}" checked class="ren-worker-cb"> ${w.Name}</label>`).join('');
                        btns += `<button type="button" onclick="window.upd('initiate_closure')" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold shadow flex-1">Job Complete</button>`;
                }
                
                if(last && (last.status==='pending_review' || last.status==='pending_approval')) {
                    if(r!=='Requester') { document.getElementById("pending-renewal-display").classList.remove('hidden'); setText("disp-ren-from", last.valid_from.replace('T', ' ')); setText("disp-ren-to", last.valid_till.replace('T', ' ')); setText("disp-ren-gas", `${last.hc}/${last.toxic}/${last.oxygen}`); setText("disp-ren-prec", last.precautions); }
                }
                if(r==='Reviewer' && last && last.status==='pending_review') { document.getElementById("action-renewal").classList.remove('hidden'); document.getElementById("RenewalRemark").disabled = false; btns=""; } 
                else if(r==='Approver' && last && last.status==='pending_approval') { document.getElementById("action-renewal").classList.remove('hidden'); document.getElementById("RenewalRemark").disabled = false; btns=""; } 
                else {
                    if(r==='Approver' && s==='Active') { 
                         btns += `<button type="button" onclick="window.upd('approve')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow flex-1 text-center">Update Supervisors</button>`;
                         document.getElementById("pdf-color-select").classList.remove('hidden');
                    }
                    btns += `<a href="${API}/download-pdf/${id}" target="_blank" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-bold shadow flex-1 text-center">Download PDF</a>`;
                }
            }
            
            if(s.includes('Closure') || s === 'Closed') {
                document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-req").classList.remove('hidden');
                setText("ts-clos-req", p.Closure_Requestor_Date);
                
                document.getElementById("Site_Restored_Check").checked = (p.Site_Restored_Check === 'Y');
                document.getElementById("Site_Restored_Check").disabled = true;
                
                if(s!=='Closure Pending Review') { document.getElementById("div-closure-rev").classList.remove('hidden'); setText("ts-clos-rev", p.Closure_Reviewer_Date); }
                if(s==='Closed') { document.getElementById("div-closure-app").classList.remove('hidden'); setText("ts-clos-app", p.Closure_Approver_Date); }
                
                if(s==='Closure Pending Review' && r==='Reviewer') { 
                      document.getElementById("div-closure-rev").classList.remove('hidden'); 
                      document.getElementById("Closure_Reviewer_Remarks").disabled=false;
                      btns=`<button type="button" onclick="window.upd('reject_closure')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve_closure')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Verify</button>`; 
                }
                if(s==='Closure Pending Approval' && r==='Approver') { 
                      document.getElementById("div-closure-app").classList.remove('hidden'); 
                      document.getElementById("Closure_Approver_Remarks").disabled=false;
                      btns=`<button type="button" onclick="window.upd('reject_closure')" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold flex-1">Reject</button><button type="button" onclick="window.upd('approve')" class="bg-black text-white px-4 py-2 rounded-lg font-bold flex-1">Close Permit</button>`; 
                }
                
                if(s==='Closed') { btns = `<a href="${API}/download-pdf/${id}" target="_blank" class="bg-gray-700 text-white px-4 py-2 rounded-lg font-bold shadow flex-1 text-center">Download PDF</a>`; }
            }

            document.getElementById("signature-history").classList.remove('hidden');
            setText("sig-app", p.Approver_Sig || 'Pending');
            const lastRenEntry = JSON.parse(p.RenewalsJSON||"[]").pop();
            setText("sig-ren", (lastRenEntry && lastRenEntry.app_name) ? `${lastRenEntry.app_name} on ${lastRenEntry.app_at}` : 'None');
            setText("sig-clos", p.Closure_Approver_Sig || 'Pending');
            
            const gsrEl = document.getElementById("gsr-check");
            gsrEl.checked = (p.GSR_Accepted === 'Y');
            gsrEl.disabled = true;
            document.getElementById("gsr-container").classList.remove('hidden');

            document.getElementById("actions").innerHTML = btns;
            // When opening a permit, switch to Dashboard tab and show form
            window.switchTab('dashboard');
            document.getElementById("view-dashboard").classList.add('hidden'); // Hide dashboard lists
            document.getElementById("view-form").classList.remove('hidden'); // Show form
        }

        window.upd = async function(act) {
            if(act === 'initiate_closure') {
                if(!document.getElementById("Site_Restored_Check").checked) { alert("You must certify that the Site is Restored & Cleaned."); return; }
            }

            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
            
            let ioclData = [];
            const isReviewerEditing = (currentUser.Role === 'Reviewer' && !document.getElementById('iocl-sup-container-rev').parentElement.classList.contains('hidden'));
            const isApproverEditing = (currentUser.Role === 'Approver' && !document.getElementById('iocl-sup-container-app').parentElement.classList.contains('hidden'));

            if (isReviewerEditing) {
                ioclData = window.getIOCLData('iocl-sup-container-rev');
            } else if (isApproverEditing) {
                ioclData = window.getIOCLData('iocl-sup-container-app');
            } else {
                ioclData = window.currentPermitIOCLData || [];
            }

            // --- CHECK FOR 1ST RENEWAL ACTION ---
            let firstRenewalAction = null;
            if(!document.getElementById('first-renewal-decision').classList.contains('hidden')) {
                const radios = document.getElementsByName('FirstRenewalAction');
                for (const r of radios) { if (r.checked) firstRenewalAction = r.value; }
                if (!firstRenewalAction && (act === 'review' || act === 'approve')) {
                    alert("‚ö†Ô∏è Action Required: Please Approve or Reject the attached 1st Renewal Request.");
                    return;
                }
            }

            const body = { 
                PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.name,
                comment: (currentUser.Role==='Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks")),
                Closure_Requestor_Remarks: getVal("Closure_Requestor_Remarks"), 
                Closure_Reviewer_Remarks: getVal("Closure_Reviewer_Remarks"), 
                Closure_Approver_Remarks: getVal("Closure_Approver_Remarks"),
                bgColor: getVal("PdfBgColor"), IOCLSupervisors: ioclData,
                Site_Restored_Check: document.getElementById("Site_Restored_Check").checked ? 'Y' : 'N',
                FirstRenewalAction: firstRenewalAction
            };
            
            if(currentUser.Role === 'Reviewer' && act === 'review') {
                    const fd = new FormData(document.getElementById("pf"));
                    document.querySelectorAll('#hazards-section input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                    document.querySelectorAll('#ppe-container input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                    body.Reviewer_Remarks = getVal("Reviewer_Remarks"); body.AdditionalPrecautions = getVal("AdditionalPrecautions");
                    if(document.getElementById("H_Others_Detail")) { body.H_Others_Detail = document.getElementById("H_Others_Detail").value; }
            }
            if(currentUser.Role === 'Approver' && act === 'approve') { body.Approver_Remarks = getVal("Approver_Remarks"); }
            
            const res = await apiCall('/update-status', 'POST', body);
            if(res.success) showDashboard(); else alert(res.error);
        }

        window.submitRenewal = async function(act) { 
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; }; 
            const vf = new Date(getVal("RenewalValidFrom")); const vt = new Date(getVal("RenewalValidTo")); 
            if (vt <= vf) { alert("End time must be greater than Start time"); return; } 
            const selWorkers = []; 
            document.querySelectorAll('.ren-worker-cb:checked').forEach(c => selWorkers.push(c.value)); 
            const body = { 
                PermitID: currentPermitId, userRole: currentUser.Role, userName: currentUser.name, action: act, 
                RenewalValidFrom: getVal("RenewalValidFrom"), RenewalValidTo: getVal("RenewalValidTo"), 
                hc: getVal("RenewalHC"), toxic: getVal("RenewalToxic"), oxygen: getVal("RenewalOxygen"), 
                precautions: getVal("RenewalPrec"), rejectionReason: getVal("RenewalRemark"), 
                renewalWorkers: selWorkers 
            }; 
            const res = await apiCall('/renewal', 'POST', body); 
            if(res.success) { alert("Done"); showDashboard(); } else alert(res.error); 
        }
        
        window.showNewPermit = async function() { 
            document.getElementById("pf").reset(); currentPermitId=null; 
            document.getElementById("Status").value="New"; document.getElementById("permit-header-display").innerText = "New Permit"; 
            document.getElementById("permit-worker-audit-display").classList.add("hidden"); 
            document.getElementById("iocl-sup-display-section").classList.add('hidden'); 
            document.getElementById("iocl-reviewer-wrapper").classList.add('hidden'); 
            document.getElementById("iocl-approver-wrapper").classList.add('hidden'); 
            document.getElementById("first-renewal-decision").classList.add('hidden'); // Reset decision box
            
            const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
            if(rS && aS) { rS.innerHTML=""; aS.innerHTML=""; if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${u.name}</option>`); } } 
            document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false); 
            
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) { el.value = val; } }; 
            safeSet("RequesterName", currentUser.name); safeSet("Vendor", currentUser.name); document.getElementById("Vendor").readOnly=true; document.getElementById("RequesterName").disabled=false; 
            await loadWorkers('permit_dropdown'); document.querySelectorAll('#worker-checkboxes input').forEach(c => c.disabled = false); document.getElementById('worker-checkboxes').classList.remove('hidden'); document.getElementById('worker-readonly-table').classList.add('hidden'); document.getElementById("fs-reviewer-section").classList.add('hidden'); document.getElementById("fs-approver-section").classList.add('hidden'); document.getElementById("renewals-section").classList.add('hidden'); document.getElementById("closure-section").classList.add('hidden'); 
            
            const gsrEl = document.getElementById("gsr-check");
            gsrEl.checked = false;
            gsrEl.disabled = false;
            document.getElementById("gsr-container").classList.remove('hidden');

            document.getElementById("chk-init-renewal").checked = false;
            document.getElementById("div-init-renewal").classList.add('hidden');
            document.getElementById("init-renewal-wrapper").classList.remove('hidden'); 
            
            document.getElementById("actions").innerHTML = `<button type="button" onclick="window.savePermit()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg">Submit Permit</button>`; 
            document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-form").classList.remove('hidden'); 
        }

        // --- FIXED SUBMIT LOGIC ---
        window.savePermit = async function() { 
            if(!document.getElementById('gsr-check').checked) {
                alert("You must accept the Golden Safety Rules terms to proceed.");
                document.getElementById('gsr-container').classList.add('ring-2', 'ring-red-500');
                setTimeout(()=>document.getElementById('gsr-container').classList.remove('ring-2', 'ring-red-500'), 2000);
                return;
            }

            // --- NEW: VALIDATE 1ST RENEWAL ---
            if (document.getElementById("chk-init-renewal").checked) {
                const pStart = new Date(document.getElementById("ValidFrom").value);
                const pEnd = new Date(document.getElementById("ValidTo").value);
                const rStartInput = document.querySelector('input[name="InitRenFrom"]').value;
                const rEndInput = document.querySelector('input[name="InitRenTo"]').value;

                if(!rStartInput || !rEndInput) { alert("Please set 1st Renewal Start/End times."); return; }

                const rStart = new Date(rStartInput);
                const rEnd = new Date(rEndInput);

                if (rEnd <= rStart) { alert("1st Renewal: End time must be greater than Start time."); return; }
                // Use getTime() for safer comparisons
                if (rStart.getTime() < pStart.getTime() || rEnd.getTime() > pEnd.getTime()) { alert("1st Renewal must be within the Permit Validity period."); return; }
                if ((rEnd - rStart) > (8 * 60 * 60 * 1000)) { alert("1st Renewal duration cannot exceed 8 hours."); return; }
            }

            document.getElementById('loader').style.display = 'flex'; 
            try { 
                const fd = new FormData(document.getElementById("pf")); 
                document.querySelectorAll('input[type="checkbox"]').forEach(c => {
                    if (c.name) {
                        fd.set(c.name, c.checked ? "Y" : "N");
                    }
                }); 
                
                fd.set("GSR_Accepted", "Y"); 

                const selectedWorkers = []; 
                document.querySelectorAll('#worker-checkboxes input:checked').forEach(c => { selectedWorkers.push(JSON.parse(c.value)); }); 
                fd.append("SelectedWorkers", JSON.stringify(selectedWorkers)); 
                
                if(currentUser && currentUser.Email) {
                    fd.append("RequesterEmail", currentUser.Email); 
                }

                // Handle potentially empty lat/long to prevent null errors
                fd.append("Latitude", document.getElementById("Latitude").value || ""); 
                fd.append("Longitude", document.getElementById("Longitude").value || ""); 
                
                if(currentPermitId) fd.set("PermitID", currentPermitId); 
                
                const res = await fetch(API+'/save-permit', {method:'POST', body:fd}); 
                
                // CRITICAL FIX: Handle Server Errors (Status 500) gracefully
                if (!res.ok) {
                    const text = await res.text();
                    console.error("Server Error HTML:", text); 
                    throw new Error(`Server Error (${res.status}). Check console.`);
                }

                const json = await res.json(); 
                if(json.success){
                    alert("Saved successfully: " + json.permitId); 
                    showDashboard();
                } else {
                    alert("Error: " + json.error); 
                }
            } catch (e) {
                console.error(e);
                alert("Submission Failed: " + e.message);
            } finally { 
                document.getElementById('loader').style.display = 'none'; 
            } 
        };
        
        window.checkDate = function() { const vf=new Date(document.getElementById("ValidFrom").value); const vt=new Date(document.getElementById("ValidTo").value); if(vf && vt) { if(vt <= vf) { alert("End time must be greater than Start time"); document.getElementById("ValidTo").value=""; return; } if((vt-vf)/(1000*60*60*24) > 7) { alert("Max 7 Days"); document.getElementById("ValidTo").value=""; } } }
        window.showDashboard = function() { window.switchTab('dashboard'); }
        
        // --- FIXED GPS LOGIC ---
        window.getGeo = function() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }

            const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
            const btn = document.getElementById("btn-get-geo");
            
            btn.innerText = "Locating...";
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (p) => {
                    document.getElementById("ExactLocation").value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`;
                    document.getElementById("Latitude").value = p.coords.latitude;
                    document.getElementById("Longitude").value = p.coords.longitude;
                    btn.innerText = "üìç GPS Set";
                    btn.disabled = false;
                },
                (err) => {
                    btn.innerText = "üìç Retry GPS";
                    btn.disabled = false;
                    
                    let msg = "Error fetching location.";
                    if (err.code === 1) msg = "Permission denied.";
                    else if (err.code === 2) msg = "Position unavailable.";
                    else if (err.code === 3) msg = "Timeout.";
                    
                    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                        msg += " \nNOTE: GPS requires HTTPS.";
                    }
                    alert(msg);
                },
                options
            );
        };

        window.showAddUser = function() { document.getElementById("view-add-user").classList.remove('hidden'); }
        window.submitNewUser = async function() { const n=document.getElementById("new-user-name").value; const e=document.getElementById("new-user-email").value; const r=document.getElementById("new-user-role").value; const p=document.getElementById("new-user-pass").value; const res=await apiCall('/add-user','POST',{name:n,email:e,role:r,password:p}); if(res.success){alert("User Added"); document.getElementById("view-add-user").classList.add('hidden');} else alert(res.error); }
        window.showMap = function() { 
            // Hide Dashboard and Workers, Show Map
            document.getElementById("view-dashboard").classList.add('hidden'); 
            document.getElementById("view-worker-management").classList.add('hidden');
            document.getElementById("view-form").classList.add('hidden');
            document.getElementById("view-map").classList.remove('hidden'); 
            loadMapData(); 
        }
        async function loadMapData() { const p = await apiCall('/map-data', 'POST'); if(!mapInstance) mapInstance=new google.maps.Map(document.getElementById("map"),{center:{lat:22.57,lng:88.36},zoom:5}); const listEl = document.getElementById("map-list-content"); listEl.innerHTML = ""; const infoWindow = new google.maps.InfoWindow(); p.forEach(x => { const marker = new google.maps.Marker({position:{lat:x.lat,lng:x.lng}, map:mapInstance, title:x.PermitID}); const content = `<div><b>${x.PermitID}</b><br>Loc: ${x.ExactLocation}<br>Req: ${x.RequesterName}<br>Valid: ${x.ValidTo}</div>`; marker.addListener("click", () => { infoWindow.setContent(content); infoWindow.open(mapInstance, marker); }); const item = document.createElement("div"); item.className = "p-3 border-b cursor-pointer hover:bg-orange-50 text-sm flex justify-between"; item.innerHTML = `<div><b>${x.PermitID}</b><div class="text-xs text-gray-500">${x.ExactLocation}</div></div><div class="text-xs font-bold text-orange-600">${x.WorkType}</div>`; item.onclick = () => { mapInstance.setCenter({lat:x.lat,lng:x.lng}); mapInstance.setZoom(12); infoWindow.setContent(`<b>${x.PermitID}</b><br>${x.WorkType}`); infoWindow.open(mapInstance, marker); }; listEl.appendChild(item); }); }
    </script>
</body>
</html>
