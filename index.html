<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Work Permit System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU"></script>
    <style>
      body { background: linear-gradient(135deg, #0f172a 0%, #312e81 50%, #4c1d95 100%); color: #1e293b; font-family: sans-serif; font-size: 0.85rem; }
      .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
      input, select, textarea { width: 100%; border: 1px solid #cbd5e1; padding: 0.4rem; border-radius: 0.375rem; font-size: 0.85rem; }
      /* Strict Read-Only Styling */
      input:disabled, select:disabled, textarea:disabled { 
          background-color: #f1f5f9; 
          color: #0f172a; 
          cursor: not-allowed; 
          border-color: #cbd5e1;
          opacity: 1; /* Ensure text is readable */
          font-weight: 500;
      }
      .status-badge { padding: 2px 8px; border-radius: 99px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; }
      #map { height: 500px; width: 100%; border-radius: 0.75rem; }
    </style>
  </head>
  <body class="antialiased min-h-screen">
    
    <div id="view-login" class="flex items-center justify-center min-h-screen p-4">
      <div class="glass-panel w-96">
        <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Permit System</h2>
        <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
          <select id="login-role"><option>Loading...</option></select>
          <select id="login-name" disabled><option>Select Role First</option></select>
          <input type="password" id="login-password" placeholder="Password">
          <button class="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700">Sign In</button>
        </form>
      </div>
    </div>

    <div id="app-container" style="display: none;">
      <nav class="fixed w-full z-50 bg-slate-900 text-white h-14 flex items-center px-4 justify-between shadow-lg">
        <div class="font-bold text-lg">üõ°Ô∏è Permit System</div>
        <div class="flex items-center gap-4 text-xs">
          <div class="text-right"><span id="user-info"></span><br><span id="user-role-badge" class="text-indigo-300"></span></div>
          <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded">Logout</button>
        </div>
      </nav>
      
      <main class="max-w-7xl mx-auto px-2 pt-20 pb-12">
        <div id="view-dashboard">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-white">Dashboard</h1>
            <div class="flex gap-2">
              <button id="btn-view-map" onclick="showMap()" class="bg-amber-500 text-white px-4 py-1.5 rounded font-bold text-xs hidden shadow">Map</button>
              <button id="btn-download-excel" onclick="window.open('/api/download-excel')" class="bg-blue-600 text-white px-4 py-1.5 rounded font-bold text-xs hidden shadow">Download Excel</button>
              <button id="btn-new-permit" onclick="showNewPermit()" class="bg-emerald-600 text-white px-4 py-1.5 rounded font-bold text-xs hidden shadow">+ New Permit</button>
            </div>
          </div>

          <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
              <div class="glass-panel h-64"><canvas id="chartStatus"></canvas></div>
              <div class="glass-panel h-64"><canvas id="chartType"></canvas></div>
          </div>

          <div class="glass-panel overflow-x-auto">
             <table class="w-full text-xs text-left"><thead class="bg-slate-100"><tr><th class="p-2">ID</th><th>Work</th><th>Vendor</th><th>Req</th><th>Status</th><th>Action</th></tr></thead><tbody id="permit-list-body" class="divide-y"></tbody></table>
          </div>
        </div>

        <div id="view-map-container" style="display: none;">
           <button onclick="showDashboard()" class="bg-white px-3 py-1 rounded mb-2 shadow font-bold text-xs">‚Üê Back</button>
           <div id="map"></div>
        </div>

        <div id="view-form" style="display: none;">
           <button onclick="showDashboard()" class="bg-white/20 text-white px-3 py-1 rounded mb-3 font-bold text-xs">‚Üê Back</button>
           <form id="permit-form" class="space-y-3">
              <input type="hidden" id="PermitID" name="PermitID"><input type="hidden" id="Status" name="Status">
              
              <div class="glass-panel">
                 <h3 class="font-bold text-indigo-700 mb-3 border-b pb-1">1. Main Permit Details</h3>
                 <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <div class="col-span-2"><label>Work Type</label><select id="WorkType" name="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Height Work</option><option>Excavation Work</option><option>Vehicle Entry</option><option>Any Other</option></select></div>
                    <div class="col-span-2"><label>Specify Other</label><input id="WorkTypeOther" name="WorkTypeOther"></div>
                    <div class="col-span-2"><label>Requester Name</label><input id="RequesterName" name="RequesterName"></div>
                    <div class="col-span-2"><label>Applicant (Official)</label><input id="OfficialName" name="OfficialName" readonly class="bg-gray-100"></div>
                    <div class="col-span-6"><label>Description</label><textarea id="Desc" name="Desc" rows="1"></textarea></div>
                    <div class="col-span-2"><label>Location</label><input id="ExactLocation" name="ExactLocation"></div>
                    <div><label>Unit</label><input id="LocationUnit" name="LocationUnit" value="Pipeline"></div>
                    <div><label>Issued Dept</label><input id="IssuedToDept" name="IssuedToDept"></div>
                    <div class="col-span-2"><label>Vendor</label><input id="Vendor" name="Vendor"></div>
                    <div><label>Loc Permit S/N</label><input id="LocationPermitSno" name="LocationPermitSno"></div>
                    <div><label>Isolation Cert</label><input id="RefIsolationCert" name="RefIsolationCert"></div>
                    <div><label>Cross Ref</label><input id="CrossRefPermits" name="CrossRefPermits"></div>
                    <div><label>JSA Ref</label><input id="JsaRef" name="JsaRef"></div>
                    <div><label>MOC Req</label><select id="MocRequired" name="MocRequired"><option>No</option><option>Yes</option></select></div>
                    <div><label>MOC Ref</label><input id="MocRef" name="MocRef"></div>
                    <div><label>CCTV Avail</label><select id="CctvAvailable" name="CctvAvailable"><option>No</option><option>Yes</option></select></div>
                    <div><label>CCTV Detail</label><input id="CctvDetail" name="CctvDetail"></div>
                    <div><label>Valid From</label><input type="datetime-local" id="ValidFrom" name="ValidFrom"></div>
                    <div><label>Valid To</label><input type="datetime-local" id="ValidTo" name="ValidTo"></div>
                    <div class="col-span-2 border p-1 rounded flex gap-2 items-center bg-slate-50">
                        <div class="flex-1"><label>Lat</label><input id="Latitude" name="Latitude"></div>
                        <div class="flex-1"><label>Long</label><input id="Longitude" name="Longitude"></div>
                        <button type="button" onclick="getGeo()" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs mt-4">üìç</button>
                    </div>
                    <div class="col-span-2"><label>Assign Reviewer</label><select id="ReviewerEmail" name="ReviewerEmail"></select></div>
                    <div class="col-span-2"><label>Assign Approver</label><select id="ApproverEmail" name="ApproverEmail"></select></div>
                 </div>
              </div>

              <div class="glass-panel">
                  <h3 class="font-bold text-indigo-700 mb-3 border-b pb-1">2. Safety Checklists</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs" id="checklist-container"></div>
                  <h4 class="font-bold text-indigo-700 mt-4 mb-2">Specific Checks</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs" id="specific-container"></div>
              </div>
              
              <div id="fs-reviewer-section" class="glass-panel border-l-4 border-yellow-500 hidden">
                 <h3 class="font-bold text-yellow-700 mb-2">3. Reviewer Assessment</h3>
                 <div class="mb-2"><span class="font-bold text-xs block mb-1">Hazards:</span><div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs" id="hazards-container"></div></div>
                 <div class="mb-2"><span class="font-bold text-xs block mb-1">PPE:</span><div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs" id="ppe-container"></div></div>
                 <div class="grid grid-cols-1 gap-2 mt-2">
                    <textarea id="AdditionalPrecautions" name="AdditionalPrecautions" placeholder="Additional Precautions" rows="1"></textarea>
                    <textarea id="Reviewer_Remarks" name="Reviewer_Remarks" placeholder="Reviewer Remarks" rows="1" class="bg-yellow-50"></textarea>
                 </div>
              </div>

              <div id="fs-approver-section" class="glass-panel border-l-4 border-green-500 hidden">
                 <h3 class="font-bold text-green-700 mb-2">4. Final Approval</h3>
                 <select id="ForceBackgroundColor" name="ForceBackgroundColor" class="mb-2 w-48"><option value="">Auto Color</option><option value="Red">Red</option><option value="Green">Green</option><option value="Yellow">Yellow</option></select>
                 <textarea id="Approver_Remarks" name="Approver_Remarks" placeholder="Approver Remarks" rows="1" class="bg-green-50"></textarea>
              </div>

              <div id="renewals-section" class="glass-panel hidden">
                 <h3 class="font-bold text-slate-700 mb-2">Clearance Renewal History</h3>
                 <div class="overflow-x-auto mb-4 border rounded">
                     <table class="w-full text-xs text-left">
                         <thead class="bg-gray-100 border-b">
                             <tr><th class="p-2">Period</th><th class="p-2">Readings</th><th class="p-2">Status</th><th class="p-2">Req By</th><th class="p-2">Rev By</th><th class="p-2">App By</th></tr>
                         </thead>
                         <tbody id="renewals-table-body" class="divide-y"></tbody>
                     </table>
                 </div>
                 
                 <div id="form-renewal" class="hidden bg-indigo-50 p-3 rounded border border-indigo-100">
                    <h4 class="font-bold text-indigo-800 text-xs mb-2">Renewal Details</h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-2">
                       <div><label>Valid From</label><input type="datetime-local" id="RenewalValidFrom"></div>
                       <div><label>Valid To</label><input type="datetime-local" id="RenewalValidTill"></div>
                       <div><label>HC %</label><input id="RenewalHC"></div>
                       <div><label>Toxic</label><input id="RenewalToxic"></div>
                       <div><label>Oxygen %</label><input id="RenewalOxygen"></div>
                       <div class="col-span-2 md:col-span-5"><label>Precautions</label><input id="RenewalPrecautions"></div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="btn-submit-renewal" onclick="submitRenewal('approve')" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs font-bold">Submit</button>
                        <button type="button" id="btn-reject-renewal" onclick="rejectRenewal()" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hidden">Reject</button>
                    </div>
                 </div>
              </div>

              <div id="closure-section" class="glass-panel hidden">
                 <h3 class="font-bold text-slate-700 mb-2">Closure</h3>
                 <div class="mb-3 p-2 bg-red-50 border border-red-200 rounded">
                     <label class="flex items-center gap-2 font-bold text-red-800 cursor-pointer">
                         <input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check">
                         I confirm that the Job Site is cleared and restored to Original condition.
                     </label>
                 </div>
                 <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="border p-2 rounded"><strong>Receiver:</strong> <span id="Closure_Receiver_Sig"></span></div>
                    <div class="border p-2 rounded"><strong>Reviewer:</strong> <span id="Closure_Reviewer_Display"></span></div>
                    <div class="border p-2 rounded"><strong>Issuer:</strong> <span id="Closure_Issuer_Sig"></span><br><textarea id="Closure_Issuer_Remarks" placeholder="Final Remarks" class="mt-1"></textarea></div>
                 </div>
              </div>

              <div id="action-buttons" class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur p-3 shadow-top z-40 flex justify-end gap-2 border-t"></div>
              <div class="h-16"></div>
           </form>
        </div>
      </main>
    </div>

    <script>
      const API = "/api";
      let currentUser = null, currentPermitId = null, chartS = null, chartT = null, mapInstance = null;
      
      const questions = [{id:"GP_Q1", t:"Equip Inspected"}, {id:"GP_Q2", t:"Area Cleaned"}, {id:"GP_Q3", t:"Sewers Covered"}, {id:"GP_Q4", t:"Hazards Considered"}, {id:"GP_Q5", t:"Blinded", d:"GP_Q5_Detail"}, {id:"GP_Q6", t:"Depressurized"}, {id:"GP_Q7", t:"Steamed"}, {id:"GP_Q8", t:"Water Flushed"}, {id:"GP_Q9", t:"Fire Access"}, {id:"GP_Q10", t:"FeS Removed"}, {id:"GP_Q11", t:"Elec Isolated", d:"GP_Q11_Detail"}, {id:"GP_Q12", t:"Gas Test", gas:true}, {id:"GP_Q13", t:"Fire Extinguisher"}, {id:"GP_Q14", t:"Cordoned"}];
      const specific = [{id:"HW_Q1", t:"Ventilation"}, {id:"HW_Q2", t:"Exit Means"}, {id:"HW_Q3", t:"Standby"}, {id:"HW_Q4", t:"Trapped Gas"}, {id:"HW_Q5", t:"Spark Shield"}, {id:"HW_Q6", t:"Grounded"}, {id:"HW_Q16", t:"Height Permit", d:"HW_Q16_Detail"}, {id:"VE_Q1", t:"Spark Arrestor (Veh)"}, {id:"EX_Q1", t:"Excavation Clear"}];
      const hazards = ["H_H2S", "H_LackOxygen", "H_Corrosive", "H_ToxicGas", "H_Combustible", "H_Steam", "H_PyroIron", "H_N2Gas", "H_Height", "H_LooseEarth", "H_HighNoise", "H_Radiation", "H_Other"];
      const ppe = ["P_FaceShield", "P_FreshAirMask", "P_CompressedBA", "P_Goggles", "P_DustRespirator", "P_Earmuff", "P_LifeLine", "P_Apron", "P_SafetyHarness", "P_SafetyNet", "P_Airline", "P_GasResponder", "P_CottonCoverall"];

      document.addEventListener("DOMContentLoaded", () => { loadUsers(); buildUI(); });

      async function apiCall(ep, meth="GET", body=null) { const opts = { method:meth, headers:{'Content-Type':'application/json'} }; if(body) opts.body = JSON.stringify(body); const res = await fetch(API+ep, opts); return await res.json(); }
      async function loadUsers() { const u = await apiCall('/users'); window.users = u; const sel = document.getElementById("login-role"); sel.innerHTML='<option value="">Select Role</option><option>Requester</option><option>Reviewer</option><option>Approver</option>'; sel.onchange=()=>{ const list=u[sel.value+'s']; const n=document.getElementById("login-name"); n.disabled=false; n.innerHTML=""; list.forEach(x=>n.innerHTML+=`<option value="${x.email}">${x.name}</option>`); }; }
      async function handleLogin() { const role=document.getElementById("login-role").value; const name=document.getElementById("login-name").selectedOptions[0].text; const email=document.getElementById("login-name").value; const pass=document.getElementById("login-password").value; const res=await apiCall('/login', 'POST', {role, name:email, password:pass}); if(res.success) { currentUser={...res.user, name}; document.getElementById("view-login").style.display='none'; document.getElementById("app-container").style.display='block'; document.getElementById("user-info").innerText=`${name} (${role})`; updateRoleUI(); loadDashboard(); } else alert(res.message); }

      function updateRoleUI() {
          const r = currentUser.Role;
          if(r==='Requester') document.getElementById("btn-new-permit").classList.remove('hidden');
          if(r==='Reviewer'||r==='Approver') {
              document.getElementById("btn-view-map").classList.remove('hidden');
              document.getElementById("btn-download-excel").classList.remove('hidden');
              document.getElementById("charts-container").classList.remove('hidden');
              loadStats();
          }
      }

      async function loadStats() {
          const res = await apiCall('/stats', 'POST');
          if(chartS) chartS.destroy(); if(chartT) chartT.destroy();
          chartS = new Chart(document.getElementById('chartStatus'), {type:'doughnut', data:{labels:Object.keys(res.statusCounts), datasets:[{data:Object.values(res.statusCounts), backgroundColor:['#3b82f6','#ef4444','#10b981','#f59e0b']}]}});
          chartT = new Chart(document.getElementById('chartType'), {type:'bar', data:{labels:Object.keys(res.typeCounts), datasets:[{label:'Work Type', data:Object.values(res.typeCounts), backgroundColor:'#6366f1'}]}});
      }

      async function loadDashboard() { const res=await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email}); const list=document.getElementById("permit-list-body"); list.innerHTML=""; res.forEach(p=>{ list.innerHTML+=`<tr class="hover:bg-slate-50 cursor-pointer border-b" onclick="openPermit('${p.PermitID}')"><td class="p-2 font-bold text-indigo-600">${p.PermitID}</td><td>${p.WorkType}</td><td>${p.Vendor||'-'}</td><td>${p.RequesterName}</td><td><span class="bg-indigo-100 text-indigo-800 px-2 rounded font-bold">${p.Status}</span></td><td class="text-blue-600 font-bold">Open</td></tr>`; }); }

      function showNewPermit() {
          document.getElementById("permit-form").reset(); currentPermitId=null; document.getElementById("Status").value="New";
          document.getElementById("RequesterName").value=currentUser.name; document.getElementById("OfficialName").value=currentUser.name;
          const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); rS.innerHTML=""; aS.innerHTML="";
          window.users.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          window.users.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${u.name}</option>`);
          document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false);
          document.getElementById("OfficialName").disabled=true;
          
          document.querySelectorAll('input[type="radio"][value="Yes"]').forEach(r => r.checked = true);
          document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true);

          document.getElementById("action-buttons").innerHTML = `<button type="button" onclick="submitNewPermit()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-blue-700">Submit Permit</button>`;
          showForm();
      }

      async function submitNewPermit() { 
          const vf = document.getElementById("ValidFrom").value; const vt = document.getElementById("ValidTo").value;
          if(!vf || !vt) return alert("Please select dates");
          const diff = new Date(vt) - new Date(vf);
          if(diff > 7 * 24 * 60 * 60 * 1000) return alert("Error: Permit duration cannot exceed 7 days.");
          if(diff <= 0) return alert("Error: End time must be after Start time.");
          const fd=new FormData(document.getElementById("permit-form")); document.querySelectorAll('input[type="checkbox"]').forEach(c=>fd.set(c.name, c.checked?"Y":"N")); fd.append("RequesterEmail", currentUser.Email); 
          const res=await fetch(API+'/save-permit', {method:'POST', body:fd}); const json=await res.json(); if(json.success){alert("Created: "+json.permitId); showDashboard();} else alert(json.error); 
      }

      async function openPermit(id) {
          const p = await apiCall('/permit-data', 'POST', {permitId:id});
          currentPermitId=id;
          
          // Lock all fields by default
          document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=true);
          
          Object.keys(p).forEach(k=>{ const el=document.getElementById(k); if(el){if(el.type==='checkbox')el.checked=(p[k]==='Y'); else el.value=p[k];} });
          document.querySelectorAll('input[type="checkbox"]').forEach(c=>{ if(p[c.name]==='Y') c.checked=true; });

          document.getElementById("fs-reviewer-section").classList.add('hidden'); document.getElementById("fs-approver-section").classList.add('hidden');
          document.getElementById("renewals-section").classList.add('hidden'); document.getElementById("closure-section").classList.add('hidden');
          document.getElementById("btn-reject-renewal").classList.add('hidden');
          
          const btns = document.getElementById("action-buttons"); btns.innerHTML="";
          const r=currentUser.Role; const s=p.Status;

          if(s.includes('Pending Review') && r==='Reviewer') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden');
              document.getElementById("WorkType").disabled=false;
              document.getElementById("Reviewer_Remarks").disabled=false;
              document.querySelectorAll('#fs-reviewer-section input, #fs-reviewer-section textarea').forEach(e=>e.disabled=false);
              btns.innerHTML = `<button onclick="upd('reject')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button onclick="upd('review')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Submit Review</button>`;
          }
          if(s.includes('Pending Approval') && r==='Approver') {
              document.getElementById("fs-reviewer-section").classList.remove('hidden'); document.getElementById("fs-approver-section").classList.remove('hidden');
              document.getElementById("WorkType").disabled=false;
              document.getElementById("Approver_Remarks").disabled=false; document.getElementById("ForceBackgroundColor").disabled=false;
              btns.innerHTML = `<button onclick="upd('reject')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button onclick="upd('approve')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Approve</button>`;
          }
          if(s==='Active' || s.includes('Renewal')) {
              document.getElementById("renewals-section").classList.remove('hidden'); document.getElementById("closure-section").classList.remove('hidden');
              let html = `<a href="${API}/download-pdf/${currentPermitId}" target="_blank" class="bg-gray-800 text-white px-4 py-2 rounded font-bold">Download PDF</a>`;
              
              if(r==='Requester' && s === 'Active') {
                  document.getElementById("form-renewal").classList.remove('hidden');
                  document.querySelectorAll("#form-renewal input").forEach(e=>e.disabled=false);
                  document.getElementById("btn-submit-renewal").innerText = "Submit Renewal";
                  html += `<button onclick="upd('initiate_closure')" class="bg-amber-500 text-white px-4 py-2 rounded font-bold ml-2">Job Complete</button>`;
              }
              btns.innerHTML = html;
              
              const rens=JSON.parse(p.RenewalsJSON||"[]"); const tbody=document.getElementById("renewals-table-body"); tbody.innerHTML=""; 
              const lastRen = rens[rens.length - 1];

              // Reviewer/Approver Renewal Action
              if(s === 'Renewal Pending Review' && r === 'Reviewer' && lastRen) {
                  document.getElementById("form-renewal").classList.remove('hidden');
                  populateRenewalForm(lastRen);
                  document.querySelectorAll("#form-renewal input").forEach(e=>e.disabled=false); // Reviewer can edit details
                  document.getElementById("btn-submit-renewal").innerText = "Verify & Forward";
                  document.getElementById("btn-reject-renewal").classList.remove('hidden');
              }
              if(s === 'Renewal Pending Approval' && r === 'Approver' && lastRen) {
                  document.getElementById("form-renewal").classList.remove('hidden');
                  populateRenewalForm(lastRen); // Locked for Approver
                  document.getElementById("btn-submit-renewal").innerText = "Approve Renewal";
                  document.getElementById("btn-reject-renewal").classList.remove('hidden');
              }

              rens.forEach(x=>{
                  tbody.innerHTML+=`
                  <tr class="border-b">
                      <td>${x.valid_from.replace('T',' ')}<br>${x.valid_till.replace('T',' ')}</td>
                      <td>HC:${x.hc} Tox:${x.toxic} O2:${x.oxygen}</td>
                      <td class="font-bold text-blue-600 uppercase">${x.status}</td>
                      <td>${x.req_name}<br><span class="text-[9px]">${x.req_at}</span></td>
                      <td>${x.rev_name||'-'}<br><span class="text-[9px]">${x.rev_at||''}</span></td>
                      <td>${x.app_name||'-'}<br><span class="text-[9px]">${x.app_at||''}</span></td>
                  </tr>`;
              });
          }
          if(s.includes('Closure')) {
              document.getElementById("closure-section").classList.remove('hidden');
              document.getElementById("Site_Restored_Check").checked = (p.Site_Restored_Check === 'Yes');
              
              if(s === 'Closure Pending Review' && r === 'Reviewer') {
                  document.getElementById("Reviewer_Remarks").disabled = false;
                  btns.innerHTML = `<button onclick="upd('reject_closure')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button onclick="upd('approve')" class="bg-emerald-600 text-white px-4 py-2 rounded font-bold">Verify Closure</button>`;
              }
              if(s === 'Closure Pending Approval' && r === 'Approver') {
                  document.getElementById("Closure_Issuer_Remarks").disabled = false;
                  btns.innerHTML = `<button onclick="upd('reject_closure')" class="bg-red-500 text-white px-4 py-2 rounded font-bold">Reject</button><button onclick="upd('approve')" class="bg-black text-white px-4 py-2 rounded font-bold">Final Close</button>`;
              }
          }
          showForm();
      }

      function populateRenewalForm(data) {
          document.getElementById("RenewalValidFrom").value = data.valid_from;
          document.getElementById("RenewalValidTill").value = data.valid_till;
          document.getElementById("RenewalHC").value = data.hc;
          document.getElementById("RenewalToxic").value = data.toxic;
          document.getElementById("RenewalOxygen").value = data.oxygen;
          document.getElementById("RenewalPrecautions").value = data.precautions;
      }

      async function upd(act) {
          if(act === 'initiate_closure') {
              if(!document.getElementById("Site_Restored_Check").checked) return alert("You must confirm the site is cleared and restored.");
          }
          const body={PermitID:currentPermitId, action:act, role:currentUser.Role, user:currentUser.name, comment:currentUser.Role==='Reviewer'?document.getElementById("Reviewer_Remarks").value:document.getElementById("Approver_Remarks").value, ForceBackgroundColor:document.getElementById("ForceBackgroundColor").value, WorkType:document.getElementById("WorkType").value, Closure_Issuer_Remarks:document.getElementById("Closure_Issuer_Remarks").value};
          if(currentUser.Role==='Reviewer' && !act.includes('closure')) { document.querySelectorAll('#hazards-container input, #ppe-container input').forEach(c=>body[c.name]=c.checked?"Y":"N"); body.AdditionalPrecautions=document.getElementById("AdditionalPrecautions").value; }
          const res=await apiCall('/update-status', 'POST', body); if(res.success) showDashboard(); else alert(res.error);
      }
      
      async function submitRenewal(act) {
          const vf = document.getElementById("RenewalValidFrom").value; const vt = document.getElementById("RenewalValidTill").value;
          if(currentUser.Role === 'Requester') {
              if(!vf || !vt) return alert("Select dates");
              const diff = (new Date(vt) - new Date(vf)) / (1000 * 60 * 60);
              if(diff > 8) return alert("Renewal cannot exceed 8 hours");
              if(diff <= 0) return alert("Invalid Time Range");
          }
          const body={PermitID:currentPermitId, action:act, userRole:currentUser.Role, userName:currentUser.name, RenewalValidFrom:vf, RenewalValidTill:vt, RenewalHC:document.getElementById("RenewalHC").value, RenewalToxic:document.getElementById("RenewalToxic").value, RenewalOxygen:document.getElementById("RenewalOxygen").value, RenewalPrecautions:document.getElementById("RenewalPrecautions").value};
          const res=await apiCall('/renewal', 'POST', body); if(res.success){alert("Renewal Processed"); showDashboard();} else alert(res.error);
      }

      async function rejectRenewal() {
          const reason = prompt("Enter Rejection Reason:");
          if(!reason) return;
          const body={PermitID:currentPermitId, action:'reject', userRole:currentUser.Role, userName:currentUser.name, rejectionReason: reason};
          const res=await apiCall('/renewal', 'POST', body); if(res.success){alert("Renewal Rejected"); showDashboard();} else alert(res.error);
      }

      function getGeo() { navigator.geolocation.getCurrentPosition(p=>{document.getElementById("Latitude").value=p.coords.latitude;document.getElementById("Longitude").value=p.coords.longitude;}); }
      function buildUI() { const c=document.getElementById("checklist-container"); c.innerHTML=""; questions.forEach(q=>c.innerHTML+=q.gas?`<div class="border p-2 rounded bg-white col-span-1 md:col-span-2"><label class="font-bold">${q.t}</label><div class="grid grid-cols-3 gap-1 mt-1"><input name="${q.id}_ToxicGas" placeholder="Tox"><input name="${q.id}_HC" placeholder="HC"><input name="${q.id}_Oxygen" placeholder="O2"></div></div>`:`<div class="border p-2 rounded bg-white"><label class="font-bold">${q.t}</label><div class="flex gap-2 mt-1"><label><input type="radio" name="${q.id}" value="Yes"> Yes</label><label><input type="radio" name="${q.id}" value="NA"> NA</label></div>${q.d?`<input name="${q.d}" placeholder="Details..." class="mt-1">`:''}</div>`); specific.forEach(q=>document.getElementById("specific-container").innerHTML+=`<div class="border p-2 rounded bg-white"><label class="font-bold">${q.t}</label><div class="flex gap-2 mt-1"><label><input type="radio" name="${q.id}" value="Yes"> Yes</label><label><input type="radio" name="${q.id}" value="NA"> NA</label></div>${q.d?`<input name="${q.d}" placeholder="Permit No..." class="mt-1">`:''}</div>`); document.getElementById("hazards-container").innerHTML=hazards.map(h=>`<label class="flex items-center gap-1 border p-1 rounded bg-white"><input type="checkbox" name="${h}" value="Y"> ${h.replace('H_','')}</label>`).join(''); document.getElementById("ppe-container").innerHTML=ppe.map(p=>`<label class="flex items-center gap-1 border p-1 rounded bg-white"><input type="checkbox" name="${p}" value="Y"> ${p.replace('P_','')}</label>`).join(''); }
      function showForm() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-form").style.display='block'; window.scrollTo(0,0); }
      function showDashboard() { document.getElementById("view-dashboard").style.display='block'; document.getElementById("view-form").style.display='none'; document.getElementById("view-map-container").style.display='none'; loadDashboard(); }
      function showMap() { document.getElementById("view-dashboard").style.display='none'; document.getElementById("view-map-container").style.display='block'; }
    </script>
  </body>
</html>
