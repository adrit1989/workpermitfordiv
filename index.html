<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU" async></script>
 
    <style nonce="NONCE_PLACEHOLDER">
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; margin: 0; padding: 0; }
        .hidden { display: none !important; }
        .glass { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        input, select, textarea { width: 100%; border: 1px solid #d1d5db !important; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; background: #fff; margin-bottom: 0.5rem; }
        input:focus, select:focus, textarea:focus { border-color: #ea580c !important; outline: none; box-shadow: 0 0 0 2px #fdba74; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb !important; cursor: not-allowed; }
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #ea580c; border-radius: 50%; width: 60px; height: 60px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #main-wrapper { display: flex; height: 100vh; width: 100vw; }
        .sidebar-left { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 40; }
        .sidebar-right { display: none !important; }
        .content-area { flex-grow: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; position: relative; scroll-behavior: smooth; }
        .checklist-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        @media(max-width: 1280px) { .checklist-grid { grid-template-columns: repeat(2, 1fr); } }
        @media(max-width: 1024px) { .sidebar-right { display: none; } .checklist-grid { grid-template-columns: 1fr; } }
        @media(max-width: 768px) { .sidebar-left { position: absolute; left: -260px; height: 100%; } .sidebar-left.open { left: 0; } .checklist-grid { grid-template-columns: 1fr; } .mobile-table th { display: none; } .mobile-table td { display: block; width: 100%; border: none; padding: 4px 8px; } .mobile-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); } }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 700; padding: 0.75rem; text-align: left; font-size: 0.8rem; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; vertical-align: middle; }
        .data-table tr:hover { background: #f8fafc; cursor: pointer; }
        .nav-item { padding: 1rem 1.25rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #94a3b8; transition: all 0.2s; border-left: 4px solid transparent; font-weight: 500; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #0f172a; color: white; border-left-color: #ea580c; }
        .btn-pdf { background-color: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; border: 1px solid #bfdbfe; transition: 0.2s; }
        .btn-pdf:hover { background-color: #2563eb; color: white; }
        .chart-wrapper {position: relative;height: 300px; width: 100%;}
    </style>
</head>
<body>
 
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="mt-6 font-bold text-orange-600 animate-pulse text-xl">Processing...</div>
    </div>
 
    <div id="view-login" class="fixed inset-0 bg-orange-50 z-50 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md shadow-2xl border-t-4 border-orange-600 p-8">
            <div class="text-center mb-6">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <img src="/public/logo.png" class="h-16 object-contain" alt="Logo">
                    <img src="/public/rhino.png" class="h-16 object-contain" alt="Rhino">
                </div>
                <h1 class="text-3xl font-extrabold text-orange-600">IndianOil</h1>
                <p class="text-gray-500 font-semibold mt-2">Mainline Permit System</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">1. Region</label>
                        <select id="login-region" class="w-full"><option value="">Loading Regions...</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">2. Unit</label>
                        <select id="login-unit" class="w-full" disabled><option value="">Select Region First</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">3. Location</label>
                        <select id="login-loc" class="w-full" disabled><option value="">Select Unit First</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">4. Role</label>
                        <select id="login-role" class="w-full">
                            <option value="Requester">Requester</option>
                            <option value="Reviewer">Reviewer</option>
                            <option value="Approver">Approver</option>
                            <option value="MasterAdmin">MasterAdmin</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">5. User</label>
                        <select id="login-user" class="w-full" disabled><option value="">Select Location & Role</option></select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Password</label>
                    <input type="password" id="login-pass" class="w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg hover:bg-orange-700">Secure Login</button>
            </form>
        </div>
    </div>
 
    <div id="view-pwd-change" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center hidden">
        <div class="glass w-full max-w-sm border-l-8 border-red-600 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-red-600">Password Update</h3>
                <button onclick="document.getElementById('view-pwd-change').classList.add('hidden')" class="text-gray-500 font-bold" id="btn-close-pwd-modal">‚úï</button>
            </div>
            <input type="password" id="new-pwd-1" placeholder="New Password" class="mb-4">
            <input type="password" id="new-pwd-2" placeholder="Confirm Password" class="mb-6">
            <button id="btn-force-pwd" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-md">Update</button>
        </div>
    </div>
 
    <div id="app-container" class="hidden">
        <div id="main-wrapper">
              
            <div class="sidebar-left" id="sidebar">
                <div class="p-6 font-bold text-xl text-orange-500 border-b border-gray-700 flex items-center gap-3 bg-gray-900">
                    <img src="/public/rhino.png" class="h-8 w-8 bg-white rounded-full p-1" alt="Icon"> <span>ERPL Permit</span>
                </div>
                <div id="user-display" class="p-5 text-xs text-gray-300 bg-gray-800 border-b border-gray-700 font-mono leading-relaxed"></div>
                <nav class="flex-1 overflow-y-auto mt-4 space-y-1 px-3">
                    <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard"><span>üìä</span> Dashboard</div>
                    <div class="nav-item hidden" onclick="switchView('new-permit')" id="nav-new-permit"><span>üìù</span> Create Permit</div>
                    <div class="nav-item" onclick="switchView('workers')" id="nav-workers"><span>üë∑</span> Workers</div>
                    <div class="nav-item hidden" id="nav-users" onclick="switchView('users')"><span>üë•</span> User Mgmt</div>
                    <div class="nav-item hidden" onclick="switchView('map')" id="nav-map"><span>üó∫Ô∏è</span> Map View</div>
                    <div class="nav-item" onclick="switchView('stats')" id="nav-stats"><span>üìà</span> Live Stats</div>
                    <div class="nav-item" onclick="switchView('jsa')" id="nav-jsa"><span>üìã</span> JSA Portal</div>
                    <div class="nav-item hidden" id="nav-admin" onclick="switchView('admin')"><span>üîê</span> Admin Console</div>
                </nav>
                <div class="p-4 border-t border-gray-700 bg-gray-900 flex flex-col gap-2">
                    <div class="nav-item text-blue-400 hover:bg-blue-900/30 rounded justify-center" onclick="showChangePassword()"><span>üîë</span> Change Pwd</div>
                    <div class="nav-item text-red-400 hover:bg-red-900/30 rounded justify-center" onclick="logout()"><span>üö™</span> Sign Out</div>
                </div>
            </div>
 
            <div class="content-area">
                <button class="md:hidden mb-4 text-gray-600 bg-white p-2 rounded shadow" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞ Menu</button>
                 
                <div id="view-jsa" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Job Safety Analysis (JSA)</h2>
                        <button onclick="openNewJsaForm()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-bold">+ Create New JSA</button>
                    </div>
                    <div class="glass overflow-x-auto">
                        <table class="w-full text-sm text-left data-table" id="table-jsa">
                            <thead class="bg-gray-100">
                                <tr><th>JSA Ref</th><th>Job Title</th><th>Location</th><th>Status</th><th>Requestor</th><th>Action</th></tr>
                            </thead>
                            <tbody class="divide-y" id="tbody-jsa"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-jsa-form" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 py-2 border-b bg-white z-20">
                        <button onclick="switchView('jsa')" class="text-blue-600 font-bold">‚Üê Back to List</button>
                        <h2 class="text-xl font-bold text-gray-800" id="jsa-form-title">New JSA</h2>
                    </div>

                    <div class="flex-1 overflow-y-auto pb-20">
                        <form id="jsa-form" class="max-w-6xl mx-auto space-y-4">
                            <input type="hidden" id="JSAID" name="JSAID">
                            
                            <div class="glass border-t-4 border-blue-500">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="text-xs font-bold text-gray-500">Region</label><input id="jsa-region" readonly class="bg-gray-100"></div>
                                    <div><label class="text-xs font-bold text-gray-500">Unit</label><input id="jsa-unit" readonly class="bg-gray-100"></div>
                                    <div><label class="text-xs font-bold text-gray-500">Location</label><input id="jsa-loc" readonly class="bg-gray-100"></div>
                                    <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Job Title</label><input id="jsa-job-title" name="JobTitle" required placeholder="Description of Job"></div>
                                    <div><label class="text-xs font-bold text-gray-500">Job Executed By (Dept/Contractor)</label><input id="jsa-executed-by" name="ExecutedBy" required placeholder="e.g. Mechanical / Contractor"></div>
                                </div>
                            </div>

                            <div class="glass border-t-4 border-indigo-500">
                                <div class="flex justify-between items-center border-b pb-2 mb-2">
                                    <h3 class="font-bold text-indigo-700">JSA Done By (Team)</h3>
                                    <button type="button" onclick="addJsaPersonRow()" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">+ Add Person</button>
                                </div>
                                <table class="w-full text-xs text-left" id="table-jsa-team">
                                    <thead class="bg-gray-50"><tr><th>Name</th><th>Designation</th><th>Department</th><th>Action</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>

                            <div class="glass border-t-4 border-orange-500">
                                <div class="flex justify-between items-center border-b pb-2 mb-2">
                                    <h3 class="font-bold text-orange-700">Risk Assessment</h3>
                                    <button type="button" onclick="addJsaRiskRow()" class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">+ Add Step</button>
                                </div>
                                <table class="w-full text-xs text-left" id="table-jsa-risk">
                                    <thead class="bg-gray-50"><tr><th width="5%">#</th><th width="25%">Activities</th><th width="25%">Hazards</th><th width="40%">Recommended Actions / Controls</th><th width="5%">Del</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                                <div class="mt-4">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Additional Precautions (General)</label>
                                    <textarea id="jsa-additional-prec" name="AdditionalPrecautions" rows="3" class="w-full border p-2 rounded text-sm" placeholder="e.g. Only qualified welders... Ensure tools availability..."></textarea>
                                </div>
                            </div>

                            <div class="glass border-t-4 border-green-500">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="text-xs font-bold text-gray-500">JSA Reviewed By</label><select id="jsa-reviewer" name="ReviewerEmail" class="w-full"></select></div>
                                    <div><label class="text-xs font-bold text-gray-500">JSA Approved By</label><select id="jsa-approver" name="ApproverEmail" class="w-full"></select></div>
                                </div>
                                <div id="jsa-workflow-actions" class="mt-4 pt-4 border-t hidden">
                                    <textarea id="jsa-remarks" placeholder="Remarks" class="w-full mb-2"></textarea>
                                    <div class="flex gap-2 justify-end">
                                        <button type="button" id="btn-jsa-reject" class="bg-red-600 text-white px-4 py-2 rounded font-bold">Reject</button>
                                        <button type="button" id="btn-jsa-approve" class="bg-green-600 text-white px-4 py-2 rounded font-bold">Approve</button>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end pt-4" id="jsa-submit-bar">
                                <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg w-full md:w-auto">Submit JSA Request</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="view-dashboard">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <div class="flex gap-3">
                            <button id="btn-export-excel" onclick="downloadSecureExcel()" class="hidden bg-green-100 text-green-800 px-4 py-2 rounded shadow font-bold text-sm border border-green-200 hover:bg-green-200">üì• Export Excel</button>
                            <button id="dash-btn-new" onclick="switchView('new-permit')" class="hidden bg-orange-600 text-white px-4 py-2 rounded shadow font-bold">+ New Permit</button>
                        </div>
                    </div>
                    <div id="dashboard-content" class="space-y-6"></div>
                </div>
 
                <div id="view-stats" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">Live Statistics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass">
                            <h3 class="font-bold text-gray-500 mb-4 uppercase text-sm">Permit Status Distribution</h3>
                            <div class="chart-wrapper">
                                <canvas id="chartStatus"></canvas>
                            </div>
                        </div>
                        <div class="glass">
                            <h3 class="font-bold text-gray-500 mb-4 uppercase text-sm">Work Type Distribution</h3>
                             <div class="chart-wrapper">
                                <canvas id="chartType"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
 
                <div id="view-form" class="hidden">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50/95 backdrop-blur z-20 py-2 border-b">
                        <button onclick="switchView('dashboard')" class="text-blue-600 font-bold">‚Üê Back</button>
                        <div class="text-right">
                            <h2 class="text-xl font-bold text-gray-800" id="permit-title">New Permit</h2>
                            <div id="permit-header-display" class="text-xs text-blue-600 font-bold"></div>
                        </div>
                    </div>
 
                    <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden">
                        <h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers</h3>
                        <div id="assigned-worker-audit" class="overflow-x-auto"></div>
                    </div>
 
                    <form id="pf" class="max-w-7xl mx-auto space-y-4 pb-20">
                        <input type="hidden" id="PermitID" name="PermitID">
                        <input type="hidden" id="Status" name="Status">
                          
                        <div class="glass border-t-4 border-orange-500">
                            <h3 class="font-bold text-orange-600 border-b pb-2 mb-4">1. Basic Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                                <div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Location (GPS)</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coords"><button type="button" id="btn-get-geo" class="bg-blue-100 text-blue-700 px-3 rounded font-bold">üìç GPS</button></div><input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude"></div>
                                <div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                                <div><label class="text-xs font-bold text-gray-500">Region/Unit/Location</label><input name="LocationUnit" id="LocationUnit" readonly class="bg-gray-100"></div>
                                <div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom"></div>
                                <div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo"></div>
                                <div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly class="bg-gray-100"></div>
                                <div><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName" class="bg-white"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                                <div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                                <div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                                <div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                                
                                <div class="md:col-span-4 p-3 bg-red-50 border border-red-200 rounded mt-2">
                                    <label class="font-bold text-red-700 text-sm block">Is this Critical Work?</label>
                                    <div class="flex gap-4 mt-1 mb-2">
                                        <label class="flex items-center gap-1 cursor-pointer font-bold"><input type="radio" name="IsCritical" value="Y" onchange="toggleCritical(true)"> Yes</label>
                                        <label class="flex items-center gap-1 cursor-pointer font-bold"><input type="radio" name="IsCritical" value="N" onchange="toggleCritical(false)" checked> No</label>
                                    </div>
                                    <div id="critical-options" class="hidden">
                                        <label class="text-xs font-bold text-gray-600">Select Critical Activity:</label>
                                        <select name="CriticalActivityType" id="CriticalActivityType" class="w-full text-sm mt-1 border-red-300"></select>
                                    </div>
                                </div>

                              <div class="md:col-span-4 mt-2 flex items-center justify-between p-3 bg-blue-50 rounded border border-blue-200">
     <label class="flex items-center gap-2 cursor-pointer">
         <input type="checkbox" name="TBT_Permit" value="Y" id="chk-tbt-permit" class="w-5 h-5 accent-blue-600"> 
         <span class="font-bold text-blue-800 text-sm">Tool Box Talk Conducted & Recorded?</span>
     </label>
     
     <div id="tbt-link-area" class="hidden flex items-center gap-2">
         <span class="text-xs font-bold bg-white border px-2 py-1 rounded text-gray-600">TBT No: <span id="disp-tbt-no" class="text-blue-700"></span></span>
         <button type="button" id="btn-view-tbt" class="bg-blue-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-blue-700">üìÑ View Record</button>
     </div>
</div>
                            </div>
                        </div>
 
                        <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50">
                            <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                                <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5"> Request 1st Renewal with Permit
                            </label>
                            <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                                    <label class="block text-xs font-bold">Renewal From <input type="datetime-local" name="InitRenFrom" id="InitRenFrom"></label>
                                    <label class="block text-xs font-bold">Renewal To <input type="datetime-local" name="InitRenTo" id="InitRenTo"></label>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="InitRenHC" id="InitRenHC" placeholder="HC % (Auto)" readonly class="bg-gray-100">
                                    <input name="InitRenTox" id="InitRenTox" placeholder="Tox (Auto)" readonly class="bg-gray-100">
                                    <input name="InitRenO2" id="InitRenO2" placeholder="O2 % (Auto)" readonly class="bg-gray-100">
                                </div>
                                <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                                <p class="text-[10px] text-gray-500 mt-1">*Gas values auto-sync from Section A. 12</p>
                            </div>
                        </div>
 
                        <div id="checklists-container" class="space-y-4"></div>
 
                        <div class="glass border-t-4 border-blue-500">
                            <h3 class="font-bold text-blue-600 border-b pb-2 mb-4">3. Workers</h3>
                            <div id="worker-select-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2"></div>
                            <div id="worker-display-table" class="hidden overflow-x-auto mt-2">
                                <table class="mobile-table w-full text-xs text-left"><thead class="bg-gray-100"><tr><th>Name</th><th>ID</th><th>Contact</th></tr></thead><tbody id="worker-display-body"></tbody></table>
                            </div>
                        </div>
 
                        <div class="glass border-t-4 border-red-500">
                            <h3 class="font-bold text-red-600 border-b pb-2 mb-4">4. Hazards & PPE</h3>
                            <div id="hazards-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                            <div id="other-hazard-div" class="hidden mb-2">
                                <input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full">
                            </div>
                            <div id="ppe-section-wrapper" class="hidden">
                                <h4 class="font-bold text-gray-500 text-xs uppercase mb-2">PPE Required (Reviewer/Approver)</h4>
                                <div id="ppe-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2"></div>
                                <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional PPE / Precautions..." class="w-full text-sm p-2 border rounded" rows="2"></textarea>
                            </div>
                        </div>
 
                  <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500">
    <h3 class="font-bold text-yellow-700 border-b pb-2 mb-4">4. Reviewer</h3>
    
    <div id="rev-renewal-decision" class="mb-4 hidden p-4 bg-yellow-50 border border-yellow-200 rounded">
        <h4 class="font-bold text-sm text-yellow-900 mb-2">1st Renewal: Accept and forward?</h4>
        <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer font-bold text-gray-700">
                <input type="radio" name="RevRenAction" value="recommend" class="w-5 h-5 accent-green-600"> Yes
            </label>
            <label class="flex items-center gap-2 cursor-pointer font-bold text-gray-700">
                <input type="radio" name="RevRenAction" value="reject" class="w-5 h-5 accent-red-600"> No
            </label>
        </div>
    </div>

    <div class="mb-4 hidden" id="iocl-reviewer-wrapper">
        <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
        <div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div>
        <button type="button" id="btn-add-rev-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
    </div>

    <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea>
</div>

<div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
    <h3 class="font-bold text-green-700 border-b pb-2 mb-4">5. Approval</h3>
    
    <div id="app-renewal-decision" class="mb-4 hidden p-4 bg-green-50 border border-green-200 rounded">
        <h4 class="font-bold text-sm text-green-900 mb-2">Reviewer has accepted the 1st renewal. Please log your decision:</h4>
        <div class="flex gap-6">
            <label class="flex items-center gap-2 cursor-pointer font-bold text-gray-700"><input type="radio" name="AppRenAction" value="approve" class="w-5 h-5 accent-green-600"> Accept</label>
            <label class="flex items-center gap-2 cursor-pointer font-bold text-gray-700"><input type="radio" name="AppRenAction" value="reject" class="w-5 h-5 accent-red-600"> Reject</label>
        </div>
    </div>

    <div class="mb-4 hidden" id="iocl-approver-wrapper">
        <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
        <div id="iocl-sup-container-app" class="space-y-2 mt-2"></div>
        <button type="button" id="btn-add-app-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
    </div>

    <div class="mt-2 mb-2 p-2 bg-indigo-50 border border-indigo-200 rounded">
        <label class="block text-xs font-bold text-indigo-800 mb-1">Optional: Upload TBT Record</label>
        <div class="flex gap-2">
            <input type="text" id="TBT_Ref_No" placeholder="TBT No..." class="text-xs flex-1 border p-1 rounded">
            <input type="file" id="TBT_PDF_File" accept="application/pdf" class="text-xs flex-1 border p-1 rounded bg-white">
        </div>
    </div>

    <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2 p-2 border rounded"></textarea>

    <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer">
        <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600">
        <span class="text-sm font-bold text-green-800">Require Photo Evidence for ALL Renewals?</span>
    </label>
    
    <div id="pdf-color-select" class="mt-2 hidden">
        <label>PDF Background:</label>
        <select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select>
    </div>
</div>
 
                        <div id="iocl-sup-display-section" class="glass hidden">
                            <h3 class="font-bold border-b pb-2 mb-2">Authorized Supervisors (IOCL)</h3>
                            <table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit Trail</th></tr></thead><tbody></tbody></table>
                        </div>
 
                        <div id="renewals-section" class="glass hidden border-l-4 border-purple-500 bg-purple-50/20">
                            <h3 class="font-bold text-purple-700 border-b pb-2 mb-4">üìÖ Renewal History</h3>
                            <div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200">
                                <h4 class="font-bold text-yellow-800 text-sm uppercase">‚ö†Ô∏è Pending Renewal Action</h4>
                                <div id="odd-hour-approval-controls" class="hidden mt-3 pt-3 border-t border-yellow-300">
                                    <div class="flex items-center gap-2 mb-2"><span class="bg-indigo-900 text-white text-xs px-2 py-1 rounded font-bold">NIGHT SHIFT REQUEST</span></div>
                                    <div id="rev-agreed-badge-container"></div>
                                    <label class="flex items-center gap-2 cursor-pointer p-2 bg-white rounded border border-indigo-200">
                                            <input type="checkbox" id="odd-hour-allow-check" onchange="toggleRenewalApproveBtn()" class="w-5 h-5 accent-indigo-600">
                                            <span class="text-sm font-bold text-indigo-800">I allow work during Odd Hours</span>
                                    </label>
                                </div>
                            </div>
                            <div class="overflow-x-auto mb-4 bg-white rounded shadow-sm border">
                                <table class="mobile-table w-full text-xs text-left data-table" id="table-renewals">
                                    <thead class="bg-purple-100">
    <tr>
        <th>Validity</th>
        <th>Gas (HC/Tox/O2)</th>
        <th>TBT Checks</th> <th>Precautions</th>
        <th>Workers</th> 
        <th>Requester</th>
        <th>Reviewer</th>
        <th>Approver</th>
        <th>Photo</th>
    </tr>
</thead>
                                    <tbody id="renewal-history-body"></tbody>
                                </table>
                            </div>
                            <div id="form-renewal" class="hidden bg-white p-4 rounded border border-purple-200 shadow-sm">
                                <h4 class="font-bold text-sm mb-2 text-purple-800">New Renewal Request</h4>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-2">
                                    <input type="datetime-local" id="RenewalValidFrom">
                                    <input type="datetime-local" id="RenewalValidTo">
                                    <input id="RenewalHC" placeholder="HC %">
                                    <input id="RenewalToxic" placeholder="Toxic PPM">
                                    <input id="RenewalOxygen" placeholder="O2 %">
                                </div>
                                <input id="RenewalPrec" placeholder="Specific Precautions for this shift" class="mb-2">
                                <label class="flex items-center gap-2 mb-2 p-2 bg-blue-50 border border-blue-200 rounded cursor-pointer w-full">
                                    <input type="checkbox" id="TBT_Renewal" value="Y" class="w-5 h-5 accent-blue-600">
                                    <span class="font-bold text-blue-800 text-xs">Tool Box Talk Conducted for Renewal?</span>
                                </label>
                                <div id="odd-hour-agreement" class="hidden mb-2 p-2 bg-indigo-50 border border-indigo-200 rounded">
                                    <label class="flex items-start gap-2 cursor-pointer">
                                            <input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-600">
                                            <span class="text-xs font-bold text-indigo-900">I agree to ensure proper lighting and safety for odd-hour work.</span>
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Select Workers</label>
                                    <div class="bg-gray-50 p-2 rounded border max-h-32 overflow-y-auto grid grid-cols-2 gap-2" id="renewal-worker-select"></div>
                                </div>
                                <div id="renewal-photo-wrapper" class="hidden mb-2 p-2 bg-red-50 border border-red-200 rounded">
                                    <label class="block text-xs font-bold text-red-700 uppercase mb-1">üì∏ Mandatory Site Photo</label>
                                    <input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="w-full text-sm bg-white border p-1 rounded">
                                    <p class="text-[10px] text-red-500 mt-1" id="photo-mandate-msg">Required by Approver.</p>
                                </div>
                                <button type="button" onclick="submitRenewal('pending_review')" class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow hover:bg-purple-700">Submit Request</button>
                            </div>
<div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded border border-yellow-200">
    <div id="ren-tbt-container" class="mb-2">
        <label id="lbl-rev-ren-tbt" class="hidden flex items-center gap-2 p-2 bg-white border border-blue-200 rounded cursor-pointer mb-2">
            <input type="checkbox" id="Rev_Ren_TBT" class="w-4 h-4 accent-blue-600"> 
            <span class="text-xs font-bold text-blue-800">Reviewer: Confirm TBT Conducted for Renewal</span>
        </label>
        
        <label id="lbl-app-ren-tbt" class="hidden flex items-center gap-2 p-2 bg-white border border-blue-200 rounded cursor-pointer mb-2">
            <input type="checkbox" id="App_Ren_TBT" class="w-4 h-4 accent-blue-600"> 
            <span class="text-xs font-bold text-blue-800">Approver: Confirm TBT Conducted for Renewal</span>
        </label>
    </div>
    <textarea id="RenewalRemark" placeholder="Remarks (Mandatory for Rejection)" class="w-full mb-2"></textarea>
    <div class="grid grid-cols-2 gap-2">
        <button type="button" id="btn-approve-renewal" class="bg-green-600 text-white py-2 rounded font-bold shadow disabled:opacity-50 disabled:cursor-not-allowed">Submit Renewal Decision</button>
        <button type="button" id="btn-reject-renewal" class="bg-red-600 text-white py-2 rounded font-bold shadow">Reject Renewal</button>
    </div>
</div>
                        </div>
 
                        <div id="closure-section" class="glass hidden border-l-4 border-gray-600">
                            <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">Closure Checklist</h3>
                            <div id="closure-checks-container" class="space-y-2 mb-4">
                                </div>
                            <div id="closure-deviation-box" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded">
                                <label class="text-xs font-bold text-red-700 block mb-1">Reason for Deviation (Mandatory if checklist incomplete):</label>
                                <textarea id="Closure_Deviation_Reason" class="w-full border-red-300 focus:ring-red-500" placeholder="Explain why conditions are not met..."></textarea>
                            </div>
                            
               <div id="div-closure-req" class="hidden space-y-2">
    <label class="text-xs font-bold text-gray-500">Requester Remarks</label>
    <textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea>
    
    <label id="lbl-site-restore" class="flex items-center gap-2 mt-2 font-bold text-gray-700 cursor-pointer p-2 bg-green-50 border border-green-200 rounded hidden">
        <input type="checkbox" id="Site_Restored_Check" class="w-5 h-5 accent-green-600">
        I confirm Site is Restored.
    </label>

    <span id="ts-clos-req" class="text-xs text-gray-400 block text-right font-mono"></span>
</div>
                            <div id="div-closure-rev" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Reviewer Remarks</label>
                                <textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-rev" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-app" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Approver Remarks</label>
                                <textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-app" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                        </div>
 
                        <div class="glass" id="section-e">
                            <h3 class="font-bold text-gray-600 border-b pb-2 mb-4">E. References</h3>
                            
                            <div id="jsa-audit-line" class="text-sm font-mono text-blue-700 mb-4 bg-blue-50 p-2 rounded hidden border border-blue-200"></div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No">

                                <div class="md:col-span-2 p-2 border rounded bg-gray-50">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Job Safety Analysis (JSA)</label>
                                    <div class="flex gap-4 mb-2">
                                        <label class="flex items-center gap-1 text-xs cursor-pointer">
                                            <input type="radio" name="jsa_mode" value="upload" checked onclick="toggleJsaMode('upload')"> Upload PDF
                                        </label>
                                        <label class="flex items-center gap-1 text-xs cursor-pointer">
                                            <input type="radio" name="jsa_mode" value="link" onclick="toggleJsaMode('link')"> Link Approved JSA
                                        </label>
                                    </div>
                                    
                                    <div id="jsa-mode-upload">
                                        <input type="file" id="JsaFile" accept="application/pdf" class="text-xs">
                                        <div id="jsa-existing-file-display" class="hidden text-xs mt-1 text-blue-600">
                                            <a href="#" target="_blank" id="jsa-file-link" class="underline font-bold">View Attached JSA</a>
                                            <button type="button" id="btn-del-jsa" class="ml-2 text-red-500 font-bold" onclick="removeAttachedJsa()">[Remove]</button>
                                        </div>
                                    </div>

                                    <div id="jsa-mode-link" class="hidden">
                                        <select id="JsaLinkedId" class="text-xs w-full bg-white border">
                                            <option value="">Select Approved JSA...</option>
                                        </select>
                                        <input type="hidden" name="JsaNo" id="JsaNo"> 
                                    </div>
                                </div>

                                <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip">
                                <input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                                <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No">
                                <input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref">
                            </div>
                        </div>

                        <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50">
                            <label class="flex items-start gap-3 p-2 cursor-pointer">
                                <input type="checkbox" id="gsr-check" name="GSR_Accepted" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500 shrink-0">
                                <span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules.</span>
                            </label>
                        </div>
                          
                        <div id="signature-history" class="glass hidden">
                            <h3 class="font-bold mb-2">History</h3>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div>
                            </div>
                        </div>
 
                        <div id="actions-bar" class="flex flex-col md:flex-row justify-end gap-3 bg-white p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] border-t sticky bottom-0 z-40 rounded-t-lg"></div>
                    </form>
                </div>
 
                <div id="view-workers" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Worker Management</h2>
                        <button id="btn-add-worker-main" onclick="openWorkerModal()" class="hidden bg-blue-600 text-white px-4 py-2 rounded shadow font-bold">+ Add Worker</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-workers"><thead class="bg-gray-100"><tr><th>Name</th><th>Age / Gender</th><th>Contact</th><th>ID Proof</th><th>Approved By</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>
 
                <div id="view-users" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                        <button type="button" onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="bg-purple-600 text-white px-4 py-2 rounded shadow font-bold">+ Add User</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-manage-users"><thead class="bg-gray-100"><tr><th>Name</th><th>Email</th><th>Role</th><th>Location</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>
 
                <div id="view-admin" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Master Admin Console</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass border-t-4 border-green-600">
                             <h3 class="font-bold text-lg mb-2 text-green-800">üë§ Add Single User</h3>
                             <p class="text-xs text-gray-500 mb-4 bg-green-50 p-2 rounded">Create a single user manually.</p>
                             <button type="button" onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">+ Create User</button>
                        </div>
                        <div class="glass border-t-4 border-purple-600">
                            <h3 class="font-bold text-lg mb-2 text-purple-800">üìÇ Bulk User Upload</h3>
                            <p class="text-xs text-gray-500 mb-4 bg-purple-50 p-2 rounded">Upload Excel (.xlsx).</p>
                            <input type="file" id="bulk-excel" accept=".xlsx" class="mb-4 w-full">
                            <button onclick="uploadBulkUsers()" class="w-full bg-purple-600 text-white py-2 rounded font-bold">Upload & Map</button>
                        </div>
                        <div class="glass border-t-4 border-red-600">
                            <h3 class="font-bold text-lg mb-2 text-red-800">üîë Global Reset Password</h3>
                            <input id="reset-email" placeholder="User Email" class="mb-2 w-full">
                            <input id="reset-temp-pass" placeholder="Temp Password" class="mb-2 w-full">
                            <button onclick="resetUserPassword()" class="w-full bg-red-600 text-white py-2 rounded font-bold">Reset Password</button>
                        </div>
                    </div>
                </div>
 
                <div id="view-map" class="hidden h-full">
                    <h2 class="text-2xl font-bold mb-4">Live Permit Map</h2>
                    <div class="glass h-[600px] w-full p-0 overflow-hidden shadow-inner border-2 border-gray-200 relative"><div id="map" class="w-full h-full"></div></div>
                </div>
            </div>
 
        </div>
    </div>
 
    <div id="modal-worker" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg relative animate-scale-up">
            <button onclick="document.getElementById('modal-worker').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold text-lg mb-4">Worker Details</h3>
            <form id="worker-form-real" class="grid grid-cols-2 gap-3">
                <input id="w-id" type="hidden">
                <input id="w-name" placeholder="Full Name" class="col-span-2" required>
                <input id="w-father" placeholder="Father Name" class="col-span-2" required>
                <input id="w-address" placeholder="Address" class="col-span-2">
                <input id="w-age" placeholder="Age" type="number" required>
                <select id="w-gender"><option>Male</option><option>Female</option></select>
                <input id="w-contact" placeholder="Contact No">
                <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Other</option></select>
                <input id="w-id-type-other" placeholder="Specify ID" class="hidden col-span-2 bg-yellow-50">
                <input id="w-idcard" placeholder="ID Number" class="col-span-2">
                <button type="submit" class="col-span-2 bg-blue-600 text-white py-3 rounded-lg font-bold shadow">Save Worker</button>
            </form>
        </div>
    </div>
 
    <div id="view-add-user" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-sm relative animate-scale-up">
            <button onclick="document.getElementById('view-add-user').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold mb-4 text-lg">Add New User</h3>
            <form id="adduser-form" class="space-y-3">
                <input id="new-user-name" placeholder="Full Name" required>
                <input id="new-user-email" placeholder="Email Address" required>
                <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                <input id="new-user-region" placeholder="Region (e.g. ERPL)" required>
                <input id="new-user-unit" placeholder="Unit (e.g. BKPL)" required>
                <input id="new-user-location" placeholder="Location (e.g. Barauni)" required>
                <input id="new-user-pass" type="password" placeholder="Initial Password" required>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button>
            </form>
        </div>
    </div>
 
  <script nonce="NONCE_PLACEHOLDER">
        /* 1. CONSTANTS */
        const API = "/api";
        let authToken = null, currentUser = null;
        let mapInstance = null, chartS = null, chartT = null;
        let currentPermitId = null, currentPermitWorkers = [], permitRequirePhoto = false, currentPermitIOCLData = [];
        let currentJsaData = null;

        const CL_DATA = {
            A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test: HC / Toxic / O2 checked.", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."],
            B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."],
            C: ["1. PESO spark elimination."],
            D: [ "1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban." ]
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];
        
        const CRITICAL_ACTIVITIES = [
            "1. Any kind of excavation in ROW/ CROW of depth more than 300 mm",
            "2. Any kind of excavation in RoW at any depth having any foreign crossings",
            "3. Integrity Test of Mainline Valves",
            "4. Repair/ Rectification work on pipeline (coating, welding, etc)",
            "5. All job carried out in trench having depth more than 1.5 M",
            "6. Pipeline Rerouting, Lowering, Hot tapping, etc.",
            "7. Washout rectification work.",
            "8. HDPE duct/ OFC repair, laying, splicing, etc.",
            "9. TLP/RFID installation/relocation.",
            "10. Magnetic marker installation for ILI",
            "11. Flaring /venting/ Draining operation in Mainline",
            "12. Additional pipeline or OFC laying work",
            "13. Crossing works by external agency",
            "14. Any HOT work on operating /charged line",
            "15. Any other job identified as critical by site"
        ];

        /* 2. UTILS */
        async function apiCall(ep, meth="GET", body=null) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const opts = {method:meth, headers:{'Content-Type':'application/json'}, credentials:'include'};
                if(authToken) opts.headers['Authorization'] = `Bearer ${authToken}`;
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(API+ep, opts);
                if(res.status === 401) { location.reload(); return; }
                return await res.json();
            } catch(e) { console.warn("Network Error:", e.message); return { aborted: true }; }
            finally { document.getElementById('loader').style.display = 'none'; }
        }
        function logout() {location.reload();        }
        function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function getNow() { return new Date().toLocaleString("en-GB").replace(',',''); }

        function attachFileValidators() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    const file = this.files[0];
                    if(file) {
                        const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
                        if (!validTypes.includes(file.type)) {
                            alert("Invalid format. Only JPG, PNG, or PDF allowed.");
                            this.value = '';
                        }
                    }
                });
            });
        }
        
        /* 3. INIT & LOGIN */
        async function initLogin() {
            try {
                // Populate Critical Dropdown
                const cSelect = document.getElementById('CriticalActivityType');
                CRITICAL_ACTIVITIES.forEach(a => { const o = document.createElement('option'); o.text = a; o.value = a; cSelect.add(o); });

                const regions = await apiCall('/get-hierarchy', 'POST', {});
                const rSel = document.getElementById('login-region');
                if (Array.isArray(regions)) rSel.innerHTML = `<option value="">Select Region</option>` + regions.map(r => `<option>${r}</option>`).join('');
                
                rSel.addEventListener('change', async (e) => {
                    const uSel = document.getElementById('login-unit'); uSel.disabled=true; uSel.innerHTML='<option>Loading...</option>';
                    const units = await apiCall('/get-hierarchy', 'POST', {region: e.target.value});
                    if(Array.isArray(units)) { uSel.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option>${u}</option>`).join(''); uSel.disabled = false; }
                });

                document.getElementById('login-unit').addEventListener('change', async (e) => {
                    const lSel = document.getElementById('login-loc'); lSel.disabled=true; lSel.innerHTML='<option>Loading...</option>';
                    const locs = await apiCall('/get-hierarchy', 'POST', {region: document.getElementById('login-region').value, unit: e.target.value});
                    if(Array.isArray(locs)) { lSel.innerHTML = `<option value="">Select Location</option>` + locs.map(l=>`<option>${l}</option>`).join(''); lSel.disabled = false; }
                });

                const loadUsers = async () => {
                    const reg = document.getElementById('login-region').value;
                    const unit = document.getElementById('login-unit').value;
                    const loc = document.getElementById('login-loc').value;
                    const role = document.getElementById('login-role').value;
                    if(reg && unit && loc && role) {
                        const uSel = document.getElementById('login-user'); uSel.innerHTML='<option>Loading...</option>';
                        const users = await apiCall('/get-users-by-loc', 'POST', {region:reg, unit:unit, location:loc, role:role});
                        if(Array.isArray(users)) { uSel.innerHTML = users.map(u=>`<option value="${u.Email}">${u.Name}</option>`).join(''); uSel.disabled = false; }
                    }
                }
                document.getElementById('login-loc').addEventListener('change', loadUsers);
                document.getElementById('login-role').addEventListener('change', loadUsers);
                
                document.getElementById('chk-init-renewal').addEventListener('change', (e) => {
                    document.getElementById('div-init-renewal').classList.toggle('hidden', !e.target.checked);
                });
                
                const rFrom = document.getElementById('RenewalValidFrom');
                const rTo = document.getElementById('RenewalValidTo');
                if(rFrom) rFrom.addEventListener('change', checkRenewalTime);
                if(rTo) rTo.addEventListener('change', checkRenewalTime);

            } catch(e) { console.error(e); }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await apiCall('/login', 'POST', {email: document.getElementById('login-user').value, password: document.getElementById('login-pass').value});
            if(res.forceChange) {
                document.getElementById('view-pwd-change').classList.remove('hidden');
                document.getElementById('view-pwd-change').dataset.email = res.email;
            } else if(res.success) {
                authToken = res.token; currentUser = res.user; enterApp();
            } else alert(res.msg);
        });

        function showChangePassword() {
            document.getElementById('view-pwd-change').classList.remove('hidden');
            document.getElementById('view-pwd-change').dataset.email = currentUser.Email;
        }
        document.getElementById('btn-force-pwd').addEventListener('click', async () => {
            const p1 = document.getElementById('new-pwd-1').value;
            const p2 = document.getElementById('new-pwd-2').value;
            const email = document.getElementById('view-pwd-change').dataset.email;
            if(p1 !== p2) return alert("Passwords do not match");
            const res = await apiCall('/force-password-change', 'POST', {email, newPassword: p1});
            if(res.success) { alert("Updated. Please login."); location.reload(); }
        });

        function enterApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').innerHTML = `<div class="font-bold text-white text-lg">${currentUser.Name}</div><div class="text-orange-400 font-bold uppercase text-xs">${currentUser.Role}</div><div class="text-xs mt-1 text-gray-500 font-mono">${currentUser.Location}</div>`;
            
            if(currentUser.Role === 'Requester') document.getElementById('nav-new-permit').classList.remove('hidden');
            else document.getElementById('btn-export-excel').classList.remove('hidden');

            if(currentUser.Role === 'MasterAdmin') document.getElementById('nav-admin').classList.remove('hidden');
            if(currentUser.Role === 'Approver' || currentUser.Role === 'MasterAdmin') document.getElementById('nav-users').classList.remove('hidden');
            if(currentUser.Role !== 'Requester') document.getElementById('nav-map').classList.remove('hidden');
            
            // Render UI Components
            try { renderChecklists(); } catch(e){ console.error(e); }
            try { renderHazards(); } catch(e){ console.error(e); }
            
            switchView('dashboard');
        }

        function switchView(viewName) {
            document.querySelectorAll('.content-area > div').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const viewMap = {'dashboard': 'view-dashboard', 'new-permit': 'view-form', 'workers': 'view-workers', 'users': 'view-users', 'map': 'view-map', 'admin': 'view-admin', 'stats': 'view-stats', 'jsa': 'view-jsa', 'jsa-form': 'view-jsa-form'};
            
            if(document.getElementById(viewMap[viewName])) {
                document.getElementById(viewMap[viewName]).classList.remove('hidden');
                let navId = (viewName === 'dashboard') ? 'nav-dashboard' : (viewName === 'stats' ? 'nav-stats' : (viewName === 'jsa' || viewName === 'jsa-form' ? 'nav-jsa' : 'nav-' + viewName));
                const navItem = document.getElementById(navId);
                if(navItem) navItem.classList.add('active');
            }
            
            if(viewName === 'dashboard') loadDashboard();
            if(viewName === 'new-permit') { showNewPermit(); loadMappedApprovers(); }
            if(viewName === 'users') loadManageUsers();
            if(viewName === 'workers') loadWorkers('mgmt');
            if(viewName === 'map') { setTimeout(initMap, 200); }
            if(viewName === 'stats') { setTimeout(() => loadStats(null), 100);}
            if(viewName === 'jsa') { loadJsaDashboard(); }
            if(viewName === 'jsa-form') { /* Handled by openNewJsaForm */ }
        }

        // --- GLOBAL FUNCTIONS DEFINITIONS ---

        async function initMap() {
            try {
                const mapData = await apiCall('/map-data', 'POST', {});
                const mapEl = document.getElementById('map');
                if (!mapEl || !window.google) return;
                let validPoints = mapData.filter(p => p.lat && p.lng && isFinite(parseFloat(p.lat)) && isFinite(parseFloat(p.lng)));
                const center = validPoints.length > 0 ? { lat: parseFloat(validPoints[0].lat), lng: parseFloat(validPoints[0].lng) } : { lat: 20.5937, lng: 78.9629 };
                mapInstance = new google.maps.Map(mapEl, { zoom: 5, center: center });
                validPoints.forEach(p => {
                    const marker = new google.maps.Marker({ position: { lat: parseFloat(p.lat), lng: parseFloat(p.lng) }, map: mapInstance, title: p.PermitID });
                    const infoWindow = new google.maps.InfoWindow({ content: `<div class="p-2"><h3 class="font-bold text-orange-600">${p.PermitID}</h3><p class="text-xs"><b>Status:</b> ${p.Status}</p><button onclick="openPermit('${p.PermitID}')" class="text-blue-600 text-xs font-bold underline mt-1">View Details</button></div>` });
                    marker.addListener('click', () => infoWindow.open(mapInstance, marker));
                });
            } catch(e) { console.error("Map Error", e); }
        }

        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
            if(!Array.isArray(res)) return; 
            const container = document.getElementById('dashboard-content');
            container.innerHTML = '';
            
            const pending = res.filter(p => {
                const s = p.Status;
                if (currentUser.Role === 'MasterAdmin') return s.includes('Pending') || s === 'Submitted';
                if (currentUser.Role === 'Reviewer') return s === 'Pending Review' || s === 'Renewal Pending Review' || s === 'Closure Pending Review';
                if (currentUser.Role === 'Approver') return s === 'Pending Approval' || s === 'Renewal Pending Approval' || s === 'Closure Pending Approval';
                return (s.includes('Pending') || s === 'Submitted') && p.RequesterEmail === currentUser.Email;
            });
            const active = res.filter(p => p.Status === 'Active' || (p.Status.includes('Renewal') && !p.Status.includes('Pending')));
            const closed = res.filter(p => p.Status === 'Closed' || p.Status === 'Rejected');

            const renderTable = (title, items, color) => {
                let rowsHtml = items.length === 0 ? `<tr><td colspan="6" class="p-4 text-center text-gray-400 italic bg-gray-50">No permits found.</td></tr>` : items.map(p => {
                    let action = (p.Status === 'Closed' || p.Status === 'Active' || p.Status.includes('Renewal')) ? `<button class="btn-pdf" onclick="event.stopPropagation(); downloadPDFWithChoice('${p.PermitID}')">üì• PDF</button>` : '';
                    return `<tr onclick="openPermit('${p.PermitID}')" class="hover:bg-gray-50 transition cursor-pointer">
                        <td class="p-3 font-bold text-blue-600">${p.PermitID}</td>
                        <td>${p.WorkType || '-'}</td>
                        <td>${p.LocationUnit || '-'}</td>
                        <td><span class="px-2 py-0.5 rounded border bg-gray-50 text-[10px] uppercase font-bold text-gray-600">${p.Status}</span></td>
                        <td class="font-mono text-xs">${p.ValidFrom ? p.ValidFrom.split('T')[0] : '-'}</td>
                        <td>${action}</td>
                    </tr>`;
                }).join('');

                return `<div class="glass border-l-4 border-${color}-500 mb-6">
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h3 class="font-bold text-${color}-700 uppercase text-sm">${title}</h3>
                        <span class="bg-${color}-100 text-${color}-800 text-xs font-bold px-3 py-1 rounded-full">${items.length}</span>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-xs data-table"><thead><tr class="bg-gray-50 border-b border-gray-200 text-gray-500 uppercase"><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th><th>Action</th></tr></thead><tbody class="divide-y divide-gray-100">${rowsHtml}</tbody></table></div>
                </div>`;
            };
            container.innerHTML += renderTable('Action Required', pending, 'orange');
            container.innerHTML += renderTable('Active Permits', active, 'green');
            container.innerHTML += renderTable('Closed / Archive', closed, 'gray');
            loadStats(res);
        }

        async function loadStats(data) {
            if(document.getElementById('view-stats').classList.contains('hidden')) return;
            
            if (!data) {
                 try {
                     const fetchedData = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
                     if(!fetchedData) return;
                     data = fetchedData;
                 } catch(e) { console.error("Stats fetch failed", e); return; }
            }
            
            const counts = {}; const types = {};
            data.forEach(d => {
                counts[d.Status] = (counts[d.Status]||0)+1;
                types[d.WorkType] = (types[d.WorkType]||0)+1;
            });

            if(chartS) { chartS.destroy(); chartS = null; }
            if(chartT) { chartT.destroy(); chartT = null; }

            const ctxS = document.getElementById('chartStatus');
            const ctxT = document.getElementById('chartType');

            if(ctxS && Object.keys(counts).length > 0) {
                chartS = new Chart(ctxS.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{ data: Object.values(counts), backgroundColor: ['#f87171', '#4ade80', '#94a3b8', '#fbbf24', '#60a5fa'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }

            if(ctxT && Object.keys(types).length > 0) {
                chartT = new Chart(ctxT.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(types),
                        datasets: [{ label: 'Work Types', data: Object.values(types), backgroundColor: '#60a5fa' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        function toggleJsaMode(mode) {
            const uploadDiv = document.getElementById('jsa-mode-upload');
            const linkDiv = document.getElementById('jsa-mode-link');
            
            if(uploadDiv && linkDiv) {
                uploadDiv.classList.toggle('hidden', mode !== 'upload');
                linkDiv.classList.toggle('hidden', mode !== 'link');
                if(mode === 'link') loadApprovedJsas();
            }
        }
        
        window.toggleCritical = function(isCrit) {
            document.getElementById('critical-options').classList.toggle('hidden', !isCrit);
        }

   async function openPermit(id) {
            try {
                // 1. Fetch Data
                const p = await apiCall('/permit-data', 'POST', { permitId: id });
                console.log("Opening Permit:", id);

                if (!p || p.Status === 'Closed' || !p.WorkType) {
                    alert("üìÇ Permit Archived. Downloading PDF...");
                    return downloadSecurePDF(id);
                }

                currentPermitId = id;

                // Parse IOCL Supervisors safely
                let rawIOCL = p.IOCLSupervisors;
                if (typeof rawIOCL === 'string') { try { rawIOCL = JSON.parse(rawIOCL); } catch(e) { rawIOCL = []; } }
                currentPermitIOCLData = Array.isArray(rawIOCL) ? rawIOCL : [];
                permitRequirePhoto = (p.RequireRenewalPhotos === 'Y');

                // 2. Setup View
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-form').classList.remove('hidden');
                document.getElementById('permit-title').innerText = `Permit: ${id}`;
                document.getElementById('permit-header-display').innerText = `Status: ${p.Status}`;

                // 3. Reset Sections
                ['fs-reviewer-section', 'fs-approver-section', 'rev-renewal-decision', 'app-renewal-decision', 'action-renewal', 'pending-renewal-display', 'odd-hour-approval-controls', 'renewals-section', 'closure-section', 'div-closure-rev', 'div-closure-app'].forEach(sid => { document.getElementById(sid).classList.add('hidden'); });
                
                const actionsDiv = document.getElementById("actions-bar"); actionsDiv.innerHTML = "";

                // 4. Determine State and Permissions
                const statusClean = p.Status ? p.Status.trim() : '';
                const isMainPending = (statusClean === 'Pending Review' || statusClean === 'Pending Approval');
                const isAuthority = (currentUser.Role === 'Reviewer' || currentUser.Role === 'Approver');

                // 5. Populate Fields & Handle Read-Only Logic
                document.querySelectorAll('#pf input, #pf textarea, #pf select').forEach(el => {
                    let shouldDisable = true;

                    // --- Permission Logic ---
                    // Allow Authority to edit Hazards/PPE/Critical during approval
                    if (isAuthority && isMainPending && (el.name && (el.name.startsWith('H_') || el.name.startsWith('P_')) || el.id === 'H_Others_Detail')) shouldDisable = false;
                    if (isAuthority && isMainPending && (el.name === 'IsCritical' || el.name === 'CriticalActivityType')) shouldDisable = false;
                    
                    // Allow Authority to edit their specific remarks
                    if (isMainPending && currentUser.Role === 'Reviewer' && (el.id === 'Reviewer_Remarks' || el.id === 'AdditionalPrecautions' || el.name === 'RevRenAction')) shouldDisable = false;
                    if ((isMainPending || statusClean === 'Active') && currentUser.Role === 'Approver' && (el.id === 'Approver_Remarks' || el.name === 'AppRenAction')) shouldDisable = false;
                    
                    // Allow Approver to toggle Photo Requirement
                    if (currentUser.Role === 'Approver' && el.id === 'RequireRenewalPhotos') shouldDisable = (statusClean === 'Active');

                    // Allow Requester to edit Deviation Reason during Closure
                    if (currentUser.Role === 'Requester' && statusClean === 'Active' && el.id === 'Closure_Deviation_Reason') shouldDisable = false;

                    // --- Data Population Logic (The Fix) ---
                    if (el.type === 'checkbox') {
                        el.checked = (p[el.name] === 'Y');
                    }
                    else if (el.type === 'radio') {
                         // FIX: Check if the saved value matches this radio button's value
                         // This ensures A_Q1, B_Q2, etc. get populated correctly
                         if (p[el.name]) {
                             el.checked = (p[el.name] === el.value);
                         } else {
                             // Default fallback for critical if missing
                             if(el.name === 'IsCritical' && el.value === 'N') el.checked = true; 
                             else el.checked = false;
                         }
                    }
                    else if (el.type !== 'file') {
                        el.value = p[el.name] || '';
                    }

                    // Apply Read-Only state
                    el.disabled = shouldDisable;
                });
                
    const tbtArea = document.getElementById('tbt-link-area');
    if (p.TBT_File_Url) {
        tbtArea.classList.remove('hidden');
        document.getElementById('disp-tbt-no').innerText = p.TBT_Ref_No || 'N/A';
        document.getElementById('btn-view-tbt').onclick = (e) => { e.preventDefault(); viewSecureFile(p.TBT_File_Url); };
    } else {
        tbtArea.classList.add('hidden');
    }

    // Handle Approver Inputs
    if (currentUser.Role === 'Approver' && statusClean === 'Pending Approval') {
        document.getElementById('TBT_Ref_No').value = p.TBT_Ref_No || '';
        document.getElementById('TBT_Ref_No').disabled = false;
        document.getElementById('TBT_PDF_File').disabled = false;
    } else {
        // Read-only for others
        document.getElementById('TBT_Ref_No').value = p.TBT_Ref_No || '';
        document.getElementById('TBT_Ref_No').disabled = true;
        document.getElementById('TBT_PDF_File').disabled = true;
    }

                // 6. UI Logic Triggers
                toggleCritical(p.IsCritical === 'Y');

                if (currentUser.Role === 'Requester') document.getElementById('ppe-section-wrapper').classList.add('hidden');
                else document.getElementById('ppe-section-wrapper').classList.remove('hidden');

                // 7. JSA Display Logic
                const existDisplay = document.getElementById('jsa-existing-file-display');
                const jsaFileInp = document.getElementById('JsaFile');
                const jsaLinkSel = document.getElementById('JsaLinkedId');
                existDisplay.classList.add('hidden'); jsaFileInp.value = '';
                
                window.clearJsaSelection = function() {
                    if(!confirm("Remove current JSA? You will need to select or upload a new one.")) return;
                    p.JsaLinkedId = null; p.JsaFileUrl = null;
                    jsaLinkSel.value = ""; jsaFileInp.value = "";
                    existDisplay.classList.add('hidden');
                    document.querySelector('input[name="jsa_mode"][value="upload"]').checked = true;
                    toggleJsaMode('upload');
                    if(document.getElementById('btn-view-linked-jsa')) document.getElementById('btn-view-linked-jsa').classList.add('hidden');
                };

                const auditLine = document.getElementById('jsa-audit-line');
                auditLine.classList.add('hidden');
                
                if(p.JsaLinkedId) {
                    document.querySelector('input[name="jsa_mode"][value="link"]').checked = true; toggleJsaMode('link');
                    jsaLinkSel.innerHTML = `<option value="${p.JsaLinkedId}" selected>${p.JsaLinkedId}</option>`;
                    let viewBtn = document.getElementById('btn-view-linked-jsa');
                    if(!viewBtn) {
                        viewBtn = document.createElement('button'); viewBtn.id = 'btn-view-linked-jsa'; viewBtn.type = 'button';
                        viewBtn.className = "ml-2 text-blue-600 font-bold underline text-xs"; viewBtn.innerText = "View Details";
                        jsaLinkSel.parentNode.appendChild(viewBtn);
                    }
                    viewBtn.onclick = (e) => { e.preventDefault(); openNewJsaForm(null, p.JsaLinkedId); };
                    viewBtn.classList.remove('hidden');
                    auditLine.innerText = `JSA Done: ${p.JsaLinkedId}`; auditLine.classList.remove('hidden');

                } else if (p.JsaFileUrl) {
                    document.querySelector('input[name="jsa_mode"][value="upload"]').checked = true; toggleJsaMode('upload');
                    const link = document.getElementById('jsa-file-link'); link.href = '#'; 
                    link.onclick = (e) => { e.preventDefault(); viewSecureFile(p.JsaFileUrl); };
                    existDisplay.classList.remove('hidden');
                    if(document.getElementById('btn-view-linked-jsa')) document.getElementById('btn-view-linked-jsa').classList.add('hidden');
                    auditLine.innerText = `JSA Done: Uploaded PDF`; auditLine.classList.remove('hidden');
                }

                // JSA Edit Permissions
                let canEditJsa = false;
                if (currentUser.Role === 'Requester' && (statusClean === 'Draft' || statusClean.includes('Rejected'))) canEditJsa = true;
                if (currentUser.Role === 'Reviewer' && statusClean === 'Pending Review') canEditJsa = true;
                if (currentUser.Role === 'Approver' && statusClean === 'Pending Approval') canEditJsa = true;

                if (canEditJsa) {
                    jsaFileInp.disabled = false; jsaLinkSel.disabled = false; 
                    document.querySelectorAll('input[name="jsa_mode"]').forEach(r => r.disabled = false);
                    document.getElementById('btn-del-jsa').classList.remove('hidden');
                    document.getElementById('btn-del-jsa').onclick = window.clearJsaSelection;
                    if(p.JsaLinkedId) {
                        let removeLinkBtn = document.getElementById('btn-del-link-jsa');
                        if(!removeLinkBtn) {
                            removeLinkBtn = document.createElement('button'); removeLinkBtn.id = 'btn-del-link-jsa'; removeLinkBtn.type = 'button';
                            removeLinkBtn.className = "ml-2 text-red-500 font-bold text-xs"; removeLinkBtn.innerText = "[Change]";
                            removeLinkBtn.onclick = window.clearJsaSelection;
                            jsaLinkSel.parentNode.appendChild(removeLinkBtn);
                        }
                        removeLinkBtn.classList.remove('hidden');
                    }
                    loadApprovedJsas(); 
                } else {
                    jsaFileInp.disabled = true; jsaLinkSel.disabled = true; 
                    document.querySelectorAll('input[name="jsa_mode"]').forEach(r => r.disabled = true);
                    document.getElementById('btn-del-jsa').classList.add('hidden');
                    if(document.getElementById('btn-del-link-jsa')) document.getElementById('btn-del-link-jsa').classList.add('hidden');
                }

                // 8. Load Sub-Tables (Workers, Supervisors, Renewals, Closure)
                let wData = p.SelectedWorkers;
                if (typeof wData === 'string') { try { wData = JSON.parse(wData); } catch (e) { wData = []; } }
                currentPermitWorkers = Array.isArray(wData) ? wData : [];
                const wTbody = document.getElementById('worker-display-body');
                document.getElementById('worker-display-table').classList.toggle('hidden', currentPermitWorkers.length === 0);
                if (wTbody) wTbody.innerHTML = currentPermitWorkers.map(w => `<tr><td class="p-2 font-bold">${escapeHtml(w.Name)}</td><td class="p-2">${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td><td class="p-2 font-mono">${escapeHtml(w.Contact)}</td></tr>`).join('');
                
                renderIOCLTable(p.Status);

                const rens = JSON.parse(p.RenewalsJSON || "[]");
                const lastRen = rens.length > 0 ? rens[rens.length - 1] : null;
                const isFirstRenRequest = (rens.length === 1 && p.InitRen === 'Y');

                if (rens.length > 0 || (currentUser.Role === 'Requester' && statusClean === 'Active')) {
                    document.getElementById('renewals-section').classList.remove('hidden');
                   // --- FIX B: Add Remarks to History Table ---
                   // Inside openPermit(), replace the renewal table generation map:
document.getElementById('renewal-history-body').innerHTML = rens.map(r => {
    // Helper to visualize checks
    const chk = (role, val) => val === 'Y' 
        ? `<div class="text-[9px] text-green-700 border border-green-200 bg-green-50 px-1 rounded mb-1">‚úÖ ${role}</div>` 
        : `<div class="text-[9px] text-gray-400 border border-gray-100 bg-gray-50 px-1 rounded mb-1">‚¨ú ${role}</div>`;

    return `<tr class="border-b text-[10px]">
        <td class="p-2">${r.valid_from}<br>to ${r.valid_to}</td>
        <td class="p-2">${r.hc}/${r.toxic}/${r.oxygen}</td>
        
        <td class="p-2">
            ${chk('Req', r.tbt_done)}
            ${chk('Rev', r.rev_tbt)}
            ${chk('App', r.app_tbt)}
        </td>

        <td class="p-2 italic">${r.precautions || '-'}</td>
        <td class="p-2">${escapeHtml((r.workers || []).join(', '))}</td>
        <td class="p-2"><b>${r.req_name}</b><br><span class="text-gray-500">${r.req_at||''}</span></td>
        <td class="p-2"><b>${r.rev_name||'-'}</b><br><span class="text-gray-500">${r.rev_at||''}</span>${r.rev_rem ? `<br><span class="text-blue-600 italic">"${r.rev_rem}"</span>` : ''}</td>
        <td class="p-2"><b>${r.app_name||'-'}</b><br><span class="text-gray-500">${r.app_at||''}</span>${r.app_rem ? `<br><span class="text-blue-600 italic">"${r.app_rem}"</span>` : ''}</td>
        <td class="p-2">${r.photoUrl ? `<button type="button" class="text-blue-600 underline" onclick="viewSecureFile('${r.photoUrl.replace(/\\/g, '/')}')">View</button>` : 'NO'}</td>
    </tr>`;
}).join('');
                        
                    const showRenForm = (currentUser.Role === 'Requester' && statusClean === 'Active' && (!lastRen || !lastRen.status.includes('pending')));
                    document.getElementById('form-renewal').classList.toggle('hidden', !showRenForm);
                    if(showRenForm) {
                        document.querySelectorAll('#form-renewal input').forEach(inp => inp.disabled = false);
                        document.getElementById('renewal-worker-select').innerHTML = currentPermitWorkers.map(w => `<label class="flex items-center gap-1 text-xs bg-white p-1 rounded border"><input type="checkbox" value="${escapeHtml(w.Name)}" checked class="ren-worker-cb"> ${escapeHtml(w.Name)}</label>`).join('');
                        document.getElementById('renewal-photo-wrapper').classList.toggle('hidden', !permitRequirePhoto);
                    }
                }
                
                handleClosureUI(p, actionsDiv);

                // 9. Show Action Buttons based on Role & Status
                if (statusClean === 'Pending Review' && currentUser.Role === 'Reviewer') {
                    document.getElementById('fs-reviewer-section').classList.remove('hidden');
                    const b1 = document.createElement("button"); b1.type="button"; b1.className = "bg-red-600 text-white px-4 py-2 rounded font-bold mr-2"; b1.innerText = "Reject Permit"; b1.onclick = () => upd('reject');
                    const b2 = document.createElement("button"); b2.type="button"; b2.className = "bg-green-600 text-white px-4 py-2 rounded font-bold"; b2.innerText = "Review & Forward"; b2.onclick = () => upd('review');
                    actionsDiv.append(b1, b2);
                }

                if (statusClean === 'Pending Approval' && (currentUser.Role === 'Approver' || currentUser.Role === 'MasterAdmin')) {
                    document.getElementById('fs-approver-section').classList.remove('hidden');
                    document.getElementById('app-renewal-decision').classList.add('hidden'); 
                    const b1 = document.createElement("button"); b1.type="button"; b1.className = "bg-red-600 text-white px-4 py-2 rounded font-bold mr-2"; b1.innerText = "Reject Permit"; b1.onclick = () => upd('reject');
                    const b2 = document.createElement("button"); b2.type="button"; b2.className = "bg-green-600 text-white px-4 py-2 rounded font-bold"; b2.innerText = "Final Approve"; b2.onclick = () => upd('approve');
                    actionsDiv.append(b1, b2);
                }

                if (!isFirstRenRequest && lastRen && lastRen.status.includes('pending')) {
                    if (currentUser.Role !== 'Requester') document.getElementById('pending-renewal-display').classList.remove('hidden');
                    const isRevTurn = (currentUser.Role === 'Reviewer' && statusClean.includes('Renewal Pending Review'));
                    const isAppTurn = (currentUser.Role === 'Approver' && statusClean.includes('Renewal Pending Approval'));

if (isRevTurn || isAppTurn) {
                        // Unhide main sections for context
                        if(isRevTurn) document.getElementById('fs-reviewer-section').classList.remove('hidden');
                        if(isAppTurn) document.getElementById('fs-approver-section').classList.remove('hidden');
                        document.getElementById('action-renewal').classList.remove('hidden');
                        document.getElementById('lbl-rev-ren-tbt').classList.add('hidden'); // Reset Reviewer Lbl
                        document.getElementById('lbl-app-ren-tbt').classList.add('hidden'); // Reset Approver Lbl
                        if(isRevTurn) document.getElementById('lbl-rev-ren-tbt').classList.remove('hidden');
                        if(isAppTurn) document.getElementById('lbl-app-ren-tbt').classList.remove('hidden');
                        document.getElementById('RenewalRemark').disabled = false;
                        if (isRevTurn) {
                            document.querySelectorAll('#Rev_Ren_TBT').forEach(el => el.disabled = false);
                        }
                        if (isAppTurn) {
                            document.querySelectorAll('#App_Ren_TBT').forEach(el => el.disabled = false);
                        }
                        const btnApprove = document.getElementById('btn-approve-renewal');
                        const btnReject = document.getElementById('btn-reject-renewal');
                        btnApprove.onclick = () => submitRenewal('approve');
                        btnReject.onclick = () => submitRenewal('reject');

                        if (lastRen && lastRen.oddHourReq === 'Y') {
                            document.getElementById('odd-hour-approval-controls').classList.remove('hidden');
                            const chk = document.getElementById('odd-hour-allow-check');
                            chk.checked = false; chk.disabled = false; 
                            btnApprove.disabled = true; btnApprove.classList.add('opacity-50', 'cursor-not-allowed');
                            window.toggleRenewalApproveBtn = () => { 
                                btnApprove.disabled = !chk.checked;
                                if(!chk.checked) btnApprove.classList.add('opacity-50', 'cursor-not-allowed');
                                else btnApprove.classList.remove('opacity-50', 'cursor-not-allowed');
                            };
                        } else {
                            document.getElementById('odd-hour-approval-controls').classList.add('hidden');
                            btnApprove.disabled = false; btnApprove.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }

                if (isFirstRenRequest && (statusClean === 'Pending Review' || statusClean === 'Pending Approval')) {
                    // Reviewer Logic: Always show decision box if it's their turn
                    if (currentUser.Role === 'Reviewer' && statusClean === 'Pending Review') {
                        document.getElementById('rev-renewal-decision').classList.remove('hidden');
                    }
                    
                    // Approver Logic: Only show the "Renewal Decision" box if the renewal IS NOT already rejected
                    if (currentUser.Role === 'Approver' && statusClean === 'Pending Approval') {
                        // Check if the last renewal (the 1st one) is already rejected
                        const isRenewalRejected = (lastRen && lastRen.status === 'rejected');
                        
                        if (!isRenewalRejected) {
                            document.getElementById('app-renewal-decision').classList.remove('hidden');
                        } else {
                            // 1. Unhide the container so we can show a message
                            const decisionBox = document.getElementById('app-renewal-decision');
                            decisionBox.classList.remove('hidden');
                            
                            // 2. Replace the Radio Buttons with a Red Warning Message
                            decisionBox.innerHTML = `
                                <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">üö´</span>
                                        <div>
                                            <p class="font-bold text-xs text-red-800 uppercase">Renewal Already Rejected</p>
                                            <p class="text-xs text-red-600">The Reviewer has rejected the 1st renewal request. You are processing the Main Permit only.</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }

                if (statusClean === 'Active' && currentUser.Role === 'Approver') {
                    document.getElementById('fs-approver-section').classList.remove('hidden');
                    const b = document.createElement("button"); b.type="button"; b.className = "bg-blue-600 text-white px-4 py-2 rounded font-bold shadow"; b.innerText = "üíæ Update Supervisors"; b.onclick = () => upd('update_data');
                    actionsDiv.appendChild(b);
                }

            } catch (e) {
                console.error("Critical Error in openPermit:", e);
                alert("System Error: Check Console");
            }
        }

        function renderClosureSection(data = {}) {
            const div = document.getElementById('closure-checks-container');
            const items = [
                {id: 'Closure_WorkCompleted', label: 'Work Completed'}, {id: 'Closure_SiteRestored', label: 'Site Restoration'},
                {id: 'Closure_Withdrawal', label: 'Withdrawal of Men/Material'}, {id: 'Closure_Normalization', label: 'Normalization of Isolations'},
                {id: 'Closure_Housekeeping', label: 'Housekeeping'}
            ];
            
            div.innerHTML = items.map(i => `
                <label class="flex items-center gap-2 cursor-pointer bg-white p-2 rounded border hover:bg-gray-50">
                    <input type="checkbox" name="${i.id}" value="Y" class="clos-chk w-4 h-4 accent-green-600" 
                    ${data[i.id] !== 'N' ? 'checked' : ''} onchange="checkClosureDeviation()"> 
                    <span class="text-sm font-semibold">${i.label}</span>
                </label>
            `).join('');
            checkClosureDeviation();
        }

        window.checkClosureDeviation = function() {
            const allChecked = Array.from(document.querySelectorAll('.clos-chk')).every(c => c.checked);
            document.getElementById('closure-deviation-box').classList.toggle('hidden', allChecked);
        }

function handleClosureUI(p, actionsDiv) {
            const isClosable = (p.Status === 'Active');
            const siteRestoredLabel = document.getElementById('lbl-site-restore');
            const siteRestoredCheck = document.getElementById('Site_Restored_Check');

            // 1. Requester Mode (Active Permit)
            if (currentUser.Role === 'Requester' && isClosable) {
                document.getElementById('closure-section').classList.remove('hidden');
                document.getElementById('div-closure-req').classList.remove('hidden');
                
                renderClosureSection({}); // Render checklist
                document.getElementById('Closure_Requestor_Remarks').disabled = false;
                
                // FIX A: Unhide and Enable Site Restoration Checkbox
                siteRestoredLabel.classList.remove('hidden'); 
                siteRestoredCheck.disabled = false;
                siteRestoredCheck.checked = false;

                const b = document.createElement("button"); b.type = "button"; 
                b.className = "bg-red-600 text-white px-4 py-2 rounded font-bold"; 
                b.innerText = "Submit Closure"; 
                b.onclick = () => upd('initiate_closure');
                actionsDiv.appendChild(b);
            }

            // 2. View/Approval Mode (Closure Pending or Closed)
            if (p.Status.includes('Closure')) {
                document.getElementById('closure-section').classList.remove('hidden');
                renderClosureSection(p); 
                
                document.querySelectorAll('.clos-chk').forEach(c => c.disabled = true);
                document.getElementById('Closure_Deviation_Reason').value = p.Closure_Deviation_Reason || '';
                document.getElementById('Closure_Deviation_Reason').disabled = true;

                document.getElementById('div-closure-req').classList.remove('hidden');
                safeSet("Closure_Requestor_Remarks", p.Closure_Requestor_Remarks || "");
                
                // Show Site Restoration Status (Read-Only)
                siteRestoredLabel.classList.remove('hidden');
                siteRestoredCheck.checked = (p.Site_Restored_Check === 'Y');
                siteRestoredCheck.disabled = true;

                if (p.Status === 'Closure Pending Review' && currentUser.Role === 'Reviewer') {
                    document.getElementById('div-closure-rev').classList.remove('hidden');
                    document.getElementById('Closure_Reviewer_Remarks').disabled = false;
                    const bR = document.createElement("button"); bR.type="button"; bR.className="bg-red-600 text-white px-4 py-2 rounded font-bold mr-2"; bR.innerText="Reject Closure"; bR.onclick=()=>upd('reject_closure');
                    const bA = document.createElement("button"); bA.type="button"; bA.className="bg-green-600 text-white px-4 py-2 rounded font-bold"; bA.innerText="Verify Closure"; bA.onclick=()=>upd('approve_closure');
                    actionsDiv.append(bR, bA);
                }
                if (p.Status === 'Closure Pending Approval' && currentUser.Role === 'Approver') {
                    document.getElementById('div-closure-rev').classList.remove('hidden');
                    document.getElementById('div-closure-app').classList.remove('hidden');
                    document.getElementById('Closure_Approver_Remarks').disabled = false;
                    safeSet("Closure_Reviewer_Remarks", p.Closure_Reviewer_Remarks || "");
                    const bR = document.createElement("button"); bR.type="button"; bR.className="bg-red-600 text-white px-4 py-2 rounded font-bold mr-2"; bR.innerText="Reject Closure"; bR.onclick=()=>upd('reject_closure');
                    const bA = document.createElement("button"); bA.type="button"; bA.className="bg-black text-white px-4 py-2 rounded font-bold"; bA.innerText="Final Permit Close"; bA.onclick=()=>upd('approve');
                    actionsDiv.append(bR, bA);
                    // --- FIX A: Add Dynamic Closure Summary ---
const reqName = safeText(p.RequesterName || 'Requester');
const checks = [
    {id: 'Closure_WorkCompleted', label: 'Work Completed'}, {id: 'Closure_SiteRestored', label: 'Site Restoration'},
    {id: 'Closure_Withdrawal', label: 'Withdrawal of Men/Material'}, {id: 'Closure_Normalization', label: 'Normalization of Isolations'},
    {id: 'Closure_Housekeeping', label: 'Housekeeping'}
];

// Determine which were checked
const doneList = checks.filter(c => p[c.id] === 'Y').map(c => c.label);
const notDoneList = checks.filter(c => p[c.id] !== 'Y').map(c => c.label);

let summary = `<div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded text-xs text-gray-700 italic">
    <strong>Closure Summary:</strong> ${reqName} confirmed that: `;

if(doneList.length > 0) summary += `<b>${doneList.join(', ')}</b> have been complied. `;
if(notDoneList.length > 0) {
    summary += `For <b>${notDoneList.join(', ')}</b>, the reason provided is: "<b>${p.Closure_Deviation_Reason || 'No Reason Given'}</b>". `;
}

if(p.Status === 'Closed') {
    summary += `<br><span class="text-green-700 font-bold">Reviewer and Approver have agreed and closed the permit.</span>`;
}

summary += `</div>`;

// Append this summary to the closure section if not already there
if(!document.getElementById('closure-summary-box')) {
    const summaryDiv = document.createElement('div');
    summaryDiv.id = 'closure-summary-box';
    summaryDiv.innerHTML = summary;
    document.getElementById('closure-section').appendChild(summaryDiv);
}

                }
            }
        }

        async function upd(act) {
            if (act === 'initiate_closure') {
                if(!document.getElementById("Site_Restored_Check").checked) return alert("Please confirm site restoration checkbox.");
                const devReason = document.getElementById('Closure_Deviation_Reason').value;
                const anyUnchecked = Array.from(document.querySelectorAll('.clos-chk')).some(c => !c.checked);
                if (anyUnchecked && !devReason) return alert("You must provide a Reason for Deviation since some closure items are unchecked.");
            }
            
            const fd = new FormData();
            fd.append('PermitID', currentPermitId);
            fd.append('action', act);
            fd.append('role', currentUser.Role);
            fd.append('user', currentUser.Name);

            const comments = (currentUser.Role === 'Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks"));
            fd.append('comment', comments);
            fd.append('AdditionalPrecautions', getVal("AdditionalPrecautions"));
            fd.append('RequireRenewalPhotos', document.getElementById('RequireRenewalPhotos').checked ? 'Y' : 'N');
            fd.append('PdfBgColor', getVal('PdfBgColor'));
            fd.append('Closure_Requestor_Remarks', getVal("Closure_Requestor_Remarks"));
            fd.append('Closure_Reviewer_Remarks', getVal("Closure_Reviewer_Remarks"));
            fd.append('Closure_Approver_Remarks', getVal("Closure_Approver_Remarks"));
            fd.append('Site_Restored_Check', document.getElementById("Site_Restored_Check").checked ? 'Y' : 'N');
            
            const isCrit = document.querySelector('input[name="IsCritical"]:checked');
            if(isCrit) fd.append('IsCritical', isCrit.value);
            fd.append('CriticalActivityType', getVal('CriticalActivityType'));

            document.querySelectorAll('.clos-chk').forEach(c => fd.append(c.name, c.checked ? 'Y' : 'N'));
            fd.append('Closure_Deviation_Reason', getVal('Closure_Deviation_Reason'));
            // Inside upd(act) function...
¬† ¬† if (currentUser.Role === 'Approver') {
¬† ¬† ¬† ¬† ¬†fd.append('TBT_Ref_No', document.getElementById('TBT_Ref_No').value);
¬† ¬† ¬† ¬† ¬†const tbtFile = document.getElementById('TBT_PDF_File').files[0];
¬† ¬† ¬† ¬† ¬†if(tbtFile) fd.append('TBT_PDF_File', tbtFile);
¬† ¬† }

            let ioclData = [];
            if (currentUser.Role === 'Reviewer') ioclData = getIOCLData('iocl-sup-container-rev');
            if (currentUser.Role === 'Approver') {
                 const newOnes = getIOCLData('iocl-sup-container-app');
                 ioclData = [...currentPermitIOCLData, ...newOnes];
            }
            fd.append('IOCLSupervisors', JSON.stringify(ioclData));

            const jsaMode = document.querySelector('input[name="jsa_mode"]:checked').value;
            if (jsaMode === 'upload') {
                const f = document.getElementById('JsaFile').files[0];
                if(f) fd.append('JsaFile', f); 
            } else {
                fd.append('JsaLinkedId', document.getElementById('JsaLinkedId').value);
            }

            if (act === 'review' || act === 'approve') {
                // Check if Reviewer made a choice
                const revDec = document.querySelector('input[name="RevRenAction"]:checked');
                if (currentUser.Role === 'Reviewer' && revDec) {
                    fd.append('FirstRenewalAction', revDec.value);
                    // Critical: Change action to tell server to process the renewal AND the permit move
                    fd.set('action', 'approve_1st_ren'); 
                }

                // Check if Approver made a choice
                const appDec = document.querySelector('input[name="AppRenAction"]:checked');
                if (currentUser.Role === 'Approver' && appDec) {
                    fd.append('FirstRenewalAction', appDec.value);
                    fd.set('action', 'approve_1st_ren'); 
                }
            }
            
            if (currentUser.Role === 'Reviewer' || currentUser.Role === 'Approver') {
                document.querySelectorAll('#hazards-grid input, #ppe-grid input').forEach(c => { 
                    if (c.name) fd.append(c.name, c.checked ? 'Y' : 'N'); 
                });
            }

            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(API+'/update-status', {
                    method: 'POST', body: fd, headers: {'Authorization': `Bearer ${authToken}`} 
                });
                const json = await res.json();
                if (json.success) { alert("Success"); switchView('dashboard'); } 
                else { alert(json.error || "Update Failed"); }
            } catch(e) { console.error(e); alert("Network Error"); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

async function submitRenewal(act) {
            // 1. APPROVE / REJECT LOGIC (Reviewer & Approver)
            if(act === 'approve' || act === 'reject') {
                const remark = document.getElementById('RenewalRemark').value;
                if (act === 'reject' && !remark) return alert("Please provide remarks for rejection.");
                
                // Capture TBT Checkbox values
                let tbtVal = 'N';
                if(currentUser.Role === 'Reviewer') {
                    const el = document.getElementById('Rev_Ren_TBT');
                    tbtVal = (el && el.checked) ? 'Y' : 'N';
                }
                if(currentUser.Role === 'Approver') {
                    const el = document.getElementById('App_Ren_TBT');
                    tbtVal = (el && el.checked) ? 'Y' : 'N';
                }

                // Determine Action Type
                let actionType = act;
                if (currentUser.Role === 'Reviewer' && act === 'approve') actionType = 'forward_to_approver';
                
                // Send API Request
                const res = await apiCall('/renewal', 'POST', {
                    PermitID: currentPermitId, 
                    action: actionType, 
                    comment: remark, 
                    rejectionReason: remark, 
                    role: currentUser.Role,
                    tbt_check: tbtVal 
                });
                
                if(res.success) { 
                    alert("Renewal Decision Submitted!"); 
                    switchView('dashboard'); 
                } else { 
                    alert("Error: " + res.error); 
                }
                return;
            }

            // 2. INITIATE RENEWAL LOGIC (Requester)
            if(!document.getElementById('TBT_Renewal').checked) return alert("Tool Box Talk must be conducted for Renewal.");

            const fd = new FormData();
            fd.append('PermitID', currentPermitId);
            fd.append('action', 'initiate');
            fd.append('RenewalValidFrom', getVal("RenewalValidFrom"));
            fd.append('RenewalValidTo', getVal("RenewalValidTo"));
            fd.append('hc', getVal("RenewalHC"));
            fd.append('toxic', getVal("RenewalToxic"));
            fd.append('oxygen', getVal("RenewalOxygen"));
            fd.append('precautions', getVal("RenewalPrec"));
            fd.append('TBT_Renewal', 'Y');

            const selWorkers = [];
            document.querySelectorAll('.ren-worker-cb:checked').forEach(c => selWorkers.push(c.value));
            fd.append('renewalWorkers', JSON.stringify(selWorkers));
            
            if(!document.getElementById("odd-hour-agreement").classList.contains("hidden")) {
                if(!document.getElementById("OddHourSafetyCheck").checked) return alert("Accept Odd Hour safety terms.");
                fd.append('oddHourReq', 'Y');
            }
            
            const fileInput = document.getElementById("ren-cam-sub");
            if(!document.getElementById('renewal-photo-wrapper').classList.contains('hidden') && fileInput.files.length === 0) return alert("‚õî Site photo is mandatory.");
            if(fileInput.files.length > 0) fd.append('RenewalImage', fileInput.files[0]);

            const res = await fetch(API+'/renewal', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Renewal Request Submitted!"); switchView('dashboard'); } else { alert(json.error || "Submission failed: " + json.error); }
        }

        window.viewSecureFile = async function(fullUrl) {
            if (!fullUrl) return alert("No file linked");
            let blobName = fullUrl;
            if(fullUrl.includes('/permit-attachments/')) { blobName = fullUrl.split('/permit-attachments/')[1]; }
            else if (fullUrl.includes('/permit-jsa/')) { blobName = 'permit-jsa/' + fullUrl.split('/permit-jsa/')[1]; }
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(`${API}/view-blob?name=${encodeURIComponent(blobName)}`, { method: 'GET', headers: {'Authorization': `Bearer ${authToken}`} });
                if (!res.ok) throw new Error("File retrieval failed (404)");
                const blob = await res.blob();
                const localUrl = window.URL.createObjectURL(blob);
                window.open(localUrl, '_blank');
            } catch (e) { alert("Error opening file: " + e.message); } finally { document.getElementById('loader').style.display = 'none'; }
        }
          
        function checkRenewalTime() {
            const fVal = document.getElementById("RenewalValidFrom").value; const tVal = document.getElementById("RenewalValidTo").value;
            const div = document.getElementById("odd-hour-agreement");
            if(fVal && tVal) {
                const h1 = new Date(fVal).getHours(); const h2 = new Date(tVal).getHours();
                if((h1 >= 18 || h1 < 6) || (h2 >= 18 || h2 < 6)) div.classList.remove('hidden');
                else { div.classList.add('hidden'); document.getElementById("OddHourSafetyCheck").checked = false; }
            }
        }
          
        function getIOCLData(id) {
            return Array.from(document.querySelectorAll(`#${id} .iocl-row`)).map(r => ({
                name: r.querySelector('.iocl-name').value,
                desig: r.querySelector('.iocl-desig').value,
                contact: r.querySelector('.iocl-contact').value,
                added_by: currentUser.Name,
                added_at: getNow(),
                status: 'active'
            })).filter(x => x.name.trim() !== '');
        }

        function addIOCLRow(id) {
            const d=document.createElement('div'); d.className="flex gap-2 mb-2 iocl-row";
            d.innerHTML=`<input class="iocl-name border p-1 w-1/3 text-xs" placeholder="Name"><input class="iocl-desig border p-1 w-1/3 text-xs" placeholder="Desig"><input class="iocl-contact border p-1 w-1/3 text-xs" placeholder="Contact"><button type="button" class="text-red-500" onclick="this.parentElement.remove()">x</button>`;
            document.getElementById(id).appendChild(d);
        }
          
        function renderIOCLTable(status) {
            const t = document.querySelector('#table-iocl-display tbody'); t.innerHTML = '';
            if(!currentPermitIOCLData || currentPermitIOCLData.length === 0) {
                t.innerHTML = '<tr><td colspan="4">None</td></tr>';
            } else {
                currentPermitIOCLData.forEach((x, idx) => {
                    const isDeleted = x.status === 'inactive';
                    const rowClass = isDeleted ? "bg-red-50 text-gray-400 line-through" : "";
                    let auditText = `Added by ${x.added_by} on ${x.added_at}`;
                    if(x.deleted_by) auditText += `<br><span class="text-red-600 font-bold no-underline">Deleted by ${x.deleted_by} on ${x.deleted_at}</span>`;
                    let actionBtn = '';
                    if(currentUser.Role === 'Approver' && status === 'Active' && !isDeleted) {
                        actionBtn = `<button type="button" class="text-red-500 text-[10px] font-bold ml-2" onclick="deleteIOCLSup(${idx}, '${status}')">üóëÔ∏è</button>`;
                    }
                    t.innerHTML += `<tr class="${rowClass}"><td class="p-2">${x.name}</td><td class="p-2">${x.desig}</td><td class="p-2">${x.contact}</td><td class="p-2 text-xs text-gray-500">${auditText} ${actionBtn}</td></tr>`;
                });
            }
            document.getElementById('iocl-sup-display-section').classList.remove('hidden');
            document.getElementById('btn-add-rev-sup').parentElement.classList.add('hidden');
            document.getElementById('btn-add-app-sup').parentElement.classList.add('hidden');
            if (status.includes('Renewal') || status.includes('Closure')) return;
            if(currentUser.Role === 'Reviewer' && status === 'Pending Review') document.getElementById('btn-add-rev-sup').parentElement.classList.remove('hidden');
            if(currentUser.Role === 'Approver' && (status === 'Pending Approval' || status === 'Active')) document.getElementById('btn-add-app-sup').parentElement.classList.remove('hidden');
        }
          
        function deleteIOCLSup(index, status) {
            if(!confirm("Remove this supervisor from active list?")) return;
            currentPermitIOCLData[index].status = 'inactive';
            currentPermitIOCLData[index].deleted_by = currentUser.Name;
            currentPermitIOCLData[index].deleted_at = getNow();
            renderIOCLTable(status);
        }

  // --- FIX B: Robust visibility check for Requester ---
        async function loadWorkers(context) {
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context});
            
            // Explicitly unhide button for Requester
            const addBtn = document.getElementById('btn-add-worker-main');
            if(currentUser.Role === 'Requester') addBtn.classList.remove('hidden');
            else addBtn.classList.add('hidden');

            if(context === 'permit_dropdown') {
                const con = document.getElementById('worker-select-area');
                con.innerHTML = res.map(w => `<label class="flex items-center gap-3 border p-3 rounded-lg bg-white shadow-sm cursor-pointer hover:bg-blue-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5 accent-blue-600 rounded"><div><div class="font-bold text-gray-800 text-sm">${escapeHtml(w.Name)}</div><div class="text-xs text-gray-500">${w.IDType}: ${w.ID}</div></div></label>`).join('');
            } else {
                const t = document.querySelector('#table-workers tbody'); t.innerHTML = "";
                res.forEach(w => {
                    let actions = '';
                    if(currentUser.Role === 'Requester') actions = `<button class="text-blue-600 font-bold text-xs mr-2" onclick="editWorker('${w.WorkerID}')">Edit</button><button class="text-red-600 font-bold text-xs" onclick="workerAction('${w.WorkerID}', 'delete')">Delete</button>`;
                    else if(w.Status.includes('Pending')) actions = `<button class="text-green-600 font-bold text-xs mr-2" onclick="workerAction('${w.WorkerID}', 'approve')">Approve</button><button class="text-red-600 font-bold text-xs" onclick="workerAction('${w.WorkerID}', 'reject')">Reject</button>`;
                    let approvedInfo = w.ApprovedBy ? `${w.ApprovedBy}<br><span class="text-[9px]">${w.ApprovedAt}</span>` : '-';
                    t.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="p-3 font-bold">${escapeHtml(w.Name)}</td><td class="p-3 text-xs">${escapeHtml(w.Age)} / ${escapeHtml(w.Gender)}</td><td class="p-3 text-xs font-mono">${escapeHtml(w.Contact)}</td><td class="p-3 font-mono text-xs">${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td><td class="p-3 text-xs text-gray-500">${approvedInfo}</td><td class="p-3">${actions}</td></tr>`;
                });
            }
        }
        
        async function workerAction(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.Name}); loadWorkers('mgmt'); }
        function openWorkerModal() { document.getElementById('worker-form-real').reset(); window.currentWorkerAction = 'create'; document.getElementById('modal-worker').classList.remove('hidden'); }
        
        document.getElementById('worker-form-real').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idTypeFinal = document.getElementById("w-id-type").value === "Other" ? document.getElementById("w-id-type-other").value : document.getElementById("w-id-type").value;
            const body = { Action: window.currentWorkerAction, Role: currentUser.Role, RequestorEmail: currentUser.Email, RequestorName: currentUser.Name, WorkerID: document.getElementById('w-id').value, Details: { Name: document.getElementById("w-name").value, Age: document.getElementById("w-age").value, Father: document.getElementById("w-father").value, Address: document.getElementById("w-address").value, Contact: document.getElementById("w-contact").value, ID: document.getElementById("w-idcard").value, Gender: document.getElementById("w-gender").value, IDType: idTypeFinal } };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { alert("Worker Saved"); document.getElementById('modal-worker').classList.add('hidden'); loadWorkers('mgmt'); } else alert(res.error);
        });

      // --- FIX A: Prevent Duplicate Remarks ---
        function renderChecklists() {
            const container = document.getElementById('checklists-container'); 
            if (!container) return; // Safety check
            container.innerHTML = ''; // 1. CLEAR CONTAINER FIRST

            Object.keys(CL_DATA).forEach(sec => {
                let itemsHtml = CL_DATA[sec].map((item, i) => {
                    // Unique name for text input remarks
                    let extra = `<input class="w-full text-xs border-b mt-1" placeholder="Remarks" name="${sec}_Q${i+1}_Rem">`;
                    
                    // Special case for Gas Test (Section A, Item 12)
                    if(sec==='A' && i===11) {
                        extra = `<div class="grid grid-cols-3 gap-2 mt-2">
                            <input name="GP_Q12_HC" id="GP_Q12_HC" placeholder="HC % LEL" onkeyup="syncGasToRenewal()">
                            <input name="GP_Q12_ToxicGas" id="GP_Q12_ToxicGas" placeholder="Toxic PPM" onkeyup="syncGasToRenewal()">
                            <input name="GP_Q12_Oxygen" id="GP_Q12_Oxygen" placeholder="O2 %" onkeyup="syncGasToRenewal()">
                        </div>`;
                    }

                    return `<div class="p-3 border rounded-lg bg-gray-50 text-xs hover:shadow-md">
                        <p class="mb-2 font-semibold text-gray-700 min-h-[30px]">${item}</p>
                        <div class="flex gap-2 justify-center">
                            <label class="cursor-pointer flex items-center gap-1">
                                <input type="radio" name="${sec}_Q${i+1}" value="Y" checked class="accent-green-600"> Y
                            </label>
                            <label class="cursor-pointer flex items-center gap-1">
                                <input type="radio" name="${sec}_Q${i+1}" value="N" class="accent-red-600"> N
                            </label>
                            <label class="cursor-pointer flex items-center gap-1">
                                <input type="radio" name="${sec}_Q${i+1}" value="NA" class="accent-gray-600"> NA
                            </label>
                        </div>
                        ${extra}
                    </div>`;
                });

                container.innerHTML += `
                <div class="glass border-t-4 border-gray-400">
                    <div class="flex justify-between items-center border-b pb-2 mb-4 bg-gray-50 p-2 rounded">
                        <h4 class="font-bold text-gray-700">Section ${sec} Checks</h4>
                        <div class="flex gap-2 text-xs">
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="Y" class="sec-toggle" data-sec="${sec}"> All Yes</label>
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="N" class="sec-toggle" data-sec="${sec}"> All No</label>
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="NA" class="sec-toggle" data-sec="${sec}"> All NA</label>
                        </div>
                    </div>
                    <div class="checklist-grid">${itemsHtml.join('')}</div>
                </div>`;
            });

            // Re-attach "Select All" listeners
            document.querySelectorAll('.sec-toggle').forEach(el => { 
                el.addEventListener('change', (e) => { 
                    document.querySelectorAll(`input[name^="${e.target.dataset.sec}_"]`).forEach(rb => { 
                        if(rb.value === e.target.value) rb.checked = true; 
                    }); 
                }); 
            });
        }
        function renderHazards() {
            document.getElementById('hazards-grid').innerHTML = HAZARDS.map(h => `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-orange-100 font-bold"><input type="checkbox" name="H_${h.replace(/ /g,'')}" value="Y" ${h==='Others'?'id="chk-haz-others"':''} class="accent-orange-600 w-4 h-4"> ${h}</label>`).join('');
            const otherChk = document.getElementById('chk-haz-others');
            if(otherChk) otherChk.addEventListener('change', (e) => document.getElementById('other-hazard-div').classList.toggle('hidden', !e.target.checked));
            document.getElementById('ppe-grid').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-blue-100 font-bold"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="accent-blue-600 w-4 h-4"> ${p}</label>`).join('');
            const idTypeEl = document.getElementById('w-id-type');
            if(idTypeEl) idTypeEl.addEventListener('change', (e) => document.getElementById('w-id-type-other').classList.toggle('hidden', e.target.value !== 'Other'));
        }

        function showNewPermit() {
            document.getElementById("pf").reset();
            currentPermitId = null;
            document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => e.disabled = false);
            if(currentUser) {
                safeSet("RequesterName", currentUser.Name); safeSet("Vendor", currentUser.Name); safeSet("LocationUnit", `${currentUser.Region}/${currentUser.Unit}/${currentUser.Location}`);
            }
            const vendorInput = document.getElementById("Vendor");
            if(vendorInput) vendorInput.readOnly = true;
            document.getElementById("init-renewal-wrapper").classList.remove('hidden');
            document.getElementById("actions-bar").innerHTML = `<button type="button" onclick="savePermit()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg">Submit Application</button>`;
            loadWorkers('permit_dropdown');
        }

        async function savePermit() {
            if(!document.getElementById('gsr-check').checked) return alert("Accept GSR.");
            if(!getVal('WorkType') || !getVal('ValidFrom') || !getVal('ValidTo')) return alert("Missing Mandatory Fields: Work Type, Valid From, or Valid To.");
            const fd = new FormData(document.getElementById("pf"));
            document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(c.name) fd.set(c.name, c.checked ? "Y" : "N"); });
            const selectedWorkers = [];
            document.querySelectorAll('#worker-select-area input:checked').forEach(c => { try { selectedWorkers.push(JSON.parse(c.value)); } catch(e){} });
            fd.append("SelectedWorkers", JSON.stringify(selectedWorkers));
            if(currentUser) fd.append("RequesterEmail", currentUser.Email);
            const hcEl = document.getElementById('GP_Q12_HC'); const toxEl = document.getElementById('GP_Q12_ToxicGas'); const o2El = document.getElementById('GP_Q12_Oxygen');
            fd.append("GP_Q12_HC", hcEl ? hcEl.value : ""); fd.append("GP_Q12_ToxicGas", toxEl ? toxEl.value : ""); fd.append("GP_Q12_Oxygen", o2El ? o2El.value : "");
     
            const jsaMode = document.querySelector('input[name="jsa_mode"]:checked').value;
            if (jsaMode === 'upload') { const jsaFile = document.getElementById('JsaFile').files[0]; if(jsaFile) fd.append('JsaFile', jsaFile); } 
            else { fd.append('JsaLinkedId', document.getElementById('JsaLinkedId').value); }
            const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Permit Created: "+json.permitId); switchView('dashboard'); } else alert(json.error);
        }

        async function loadMappedApprovers() {
             const reviewers = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: 'Reviewer' });
             const approvers = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: 'Approver' });
             document.getElementById("ReviewerEmail").innerHTML = reviewers.map(u => `<option value="${u.Email}">${u.Name}</option>`).join('');
             document.getElementById("ApproverEmail").innerHTML = approvers.map(u => `<option value="${u.Email}">${u.Name}</option>`).join('');
        }

        async function loadApprovedJsas() {
            const res = await apiCall('/jsa/list-approved', 'POST', { region: currentUser.Region, unit: currentUser.Unit });
            const sel = document.getElementById('JsaLinkedId');
            sel.innerHTML = '<option value="">Select Approved JSA...</option>' + res.map(j => `<option value="${j.RefNumber}">${j.RefNumber} - ${j.JobTitle}</option>`).join('');
            sel.onchange = (e) => document.getElementById('JsaNo').value = e.target.value;
        }

        async function loadJsaDashboard() {
            const res = await apiCall('/jsa/list-my', 'POST', { email: currentUser.Email, role: currentUser.Role });
            const tbody = document.getElementById('tbody-jsa');
            tbody.innerHTML = res.map(j => {
                const downloadBtn = j.Status === 'Approved' ? `<button onclick="downloadJsaPdf('${j.JSAID}')" class="text-blue-600 underline text-xs font-bold mr-2">PDF</button>` : '';
                return `<tr class="hover:bg-gray-50 border-b"><td class="p-3 font-bold text-blue-600 cursor-pointer" onclick="openNewJsaForm('${j.JSAID}')">${j.RefNumber || 'DRAFT'}</td><td class="p-3">${j.JobTitle}</td><td class="p-3">${j.Location}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold bg-gray-200">${j.Status}</span></td><td class="p-3 text-xs">${j.RequesterName}</td><td class="p-3">${downloadBtn}</td></tr>`;
            }).join('');
        }

        async function openNewJsaForm(jsaId = null, refNumber = null) {
            switchView('jsa-form');
            document.getElementById('jsa-form').reset();
            document.querySelector('#table-jsa-team tbody').innerHTML = '';
            document.querySelector('#table-jsa-risk tbody').innerHTML = '';
            const backBtn = document.querySelector('#view-jsa-form button');
            if(refNumber) { backBtn.innerText = "‚Üê Back to Permit"; backBtn.onclick = () => { document.getElementById('view-jsa-form').classList.add('hidden'); document.getElementById('view-form').classList.remove('hidden'); }; } 
            else { backBtn.innerText = "‚Üê Back to List"; backBtn.onclick = () => switchView('jsa'); }
            await loadMappedApprovers(); 
            document.getElementById('jsa-reviewer').innerHTML = document.getElementById('ReviewerEmail').innerHTML;
            document.getElementById('jsa-approver').innerHTML = document.getElementById('ApproverEmail').innerHTML;
            safeSet('jsa-region', currentUser.Region); safeSet('jsa-unit', currentUser.Unit); safeSet('jsa-loc', currentUser.Location);
            if(jsaId || refNumber) {
                const payload = jsaId ? { id: jsaId } : { ref: refNumber };
                const j = await apiCall('/jsa/get', 'POST', payload);
                if(!j) { alert("JSA Details not found."); return switchView('jsa'); }
                currentJsaData = j;
                safeSet('JSAID', j.JSAID); safeSet('jsa-job-title', j.JobTitle); safeSet('jsa-executed-by', j.ExecutedBy);
                safeSet('jsa-reviewer', j.ReviewerEmail); safeSet('jsa-approver', j.ApproverEmail);
                const data = JSON.parse(j.DataJSON || '{}');
                (data.team || []).forEach(p => addJsaPersonRow(p));
                (data.steps || []).forEach(s => addJsaRiskRow(s));
                safeSet('jsa-additional-prec', data.additionalPrecautions);
                const isRev = currentUser.Role === 'Reviewer' && j.Status === 'Pending Review';
                const isApp = currentUser.Role === 'Approver' && j.Status === 'Pending Approval';
                if (isRev || isApp) {
                    document.getElementById('jsa-workflow-actions').classList.remove('hidden');
                    document.getElementById('jsa-submit-bar').classList.add('hidden');
                    document.getElementById('btn-jsa-approve').onclick = () => processJsaAction(j.JSAID, 'approve');
                    document.getElementById('btn-jsa-reject').onclick = () => processJsaAction(j.JSAID, 'reject');
                } else {
                    document.getElementById('jsa-workflow-actions').classList.add('hidden');
                    document.getElementById('jsa-submit-bar').classList.add('hidden');
                    document.querySelectorAll('#jsa-form input, #jsa-form textarea, #jsa-form select').forEach(e => e.disabled = true);
                    document.querySelectorAll('#jsa-form button.text-red-500').forEach(b => b.classList.add('hidden'));
                }
            } else {
                addJsaPersonRow({name: currentUser.Name, dept: 'Operations'}); 
                addJsaRiskRow();
                document.getElementById('jsa-workflow-actions').classList.add('hidden');
                document.getElementById('jsa-submit-bar').classList.remove('hidden');
            }
        }
        function addJsaPersonRow(data = {}) {
            const tbody = document.querySelector('#table-jsa-team tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input class="w-full border-none bg-transparent" placeholder="Name" value="${data.name||''}"></td><td><input class="w-full border-none bg-transparent" placeholder="Designation" value="${data.desig||''}"></td><td><input class="w-full border-none bg-transparent" placeholder="Department" value="${data.dept||''}"></td><td><button type="button" class="text-red-500 font-bold" onclick="this.closest('tr').remove()">x</button></td>`;
            tbody.appendChild(tr);
        }
        function addJsaRiskRow(data = {}) {
            const tbody = document.querySelector('#table-jsa-risk tbody');
            const idx = tbody.children.length + 1;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="p-2 text-center text-gray-500">${idx}</td><td><textarea class="w-full text-xs p-1 h-16" placeholder="Activity Step">${data.activity||''}</textarea></td><td><textarea class="w-full text-xs p-1 h-16" placeholder="Potential Hazards">${data.hazard||''}</textarea></td><td><textarea class="w-full text-xs p-1 h-16" placeholder="Controls / Actions">${data.control||''}</textarea></td><td><button type="button" class="text-red-500 font-bold" onclick="this.closest('tr').remove()">x</button></td>`;
            tbody.appendChild(tr);
        }
        document.getElementById('jsa-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const team = [];
            document.querySelectorAll('#table-jsa-team tbody tr').forEach(tr => { const ins = tr.querySelectorAll('input'); if(ins[0].value) team.push({ name: ins[0].value, desig: ins[1].value, dept: ins[2].value }); });
            const steps = [];
            document.querySelectorAll('#table-jsa-risk tbody tr').forEach(tr => { const txts = tr.querySelectorAll('textarea'); if(txts[0].value) steps.push({ activity: txts[0].value, hazard: txts[1].value, control: txts[2].value }); });
            const body = {
                JSAID: fd.get('JSAID'), JobTitle: fd.get('JobTitle'), ExecutedBy: fd.get('ExecutedBy'), ReviewerEmail: fd.get('ReviewerEmail'), ApproverEmail: fd.get('ApproverEmail'),
                Region: currentUser.Region, Unit: currentUser.Unit, Location: currentUser.Location, RequesterEmail: currentUser.Email, RequesterName: currentUser.Name,
                DataJSON: JSON.stringify({ team, steps, additionalPrecautions: document.getElementById('jsa-additional-prec').value })
            };
            const res = await apiCall('/jsa/save', 'POST', body);
            if(res.success) { alert("JSA Saved"); switchView('jsa'); } else alert(res.error);
        });
        async function processJsaAction(id, action) {
            const rem = document.getElementById('jsa-remarks').value;
            if(action === 'reject' && !rem) return alert("Remarks mandatory for rejection");
            const team = [];
            document.querySelectorAll('#table-jsa-team tbody tr').forEach(tr => { const ins = tr.querySelectorAll('input'); if(ins[0].value) team.push({ name: ins[0].value, desig: ins[1].value, dept: ins[2].value }); });
            const steps = [];
            document.querySelectorAll('#table-jsa-risk tbody tr').forEach(tr => { const txts = tr.querySelectorAll('textarea'); if(txts[0].value) steps.push({ activity: txts[0].value, hazard: txts[1].value, control: txts[2].value }); });
            const res = await apiCall('/jsa/action', 'POST', { id, action, remarks: rem, role: currentUser.Role, user: currentUser.Name, updatedData: JSON.stringify({ team, steps, additionalPrecautions: document.getElementById('jsa-additional-prec').value }) });
            if(res.success) { alert("Action Completed"); switchView('jsa'); } else alert(res.error);
        }
       /* =====================================================
¬† ¬†NEW: PDF SELECTION LOGIC
===================================================== */

// 1. Function to show the selection modal
function downloadPDFWithChoice(id) {
¬† ¬† // Check if a modal already exists to prevent duplicates
¬† ¬† if (document.getElementById('pdf-modal')) return;

¬† ¬† const modal = document.createElement('div');
¬† ¬† modal.id = 'pdf-modal';
¬† ¬† modal.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;justify-content:center;align-items:center;backdrop-filter:blur(2px);";
¬† ¬†¬†
¬† ¬† modal.innerHTML = `
¬† ¬† ¬† ¬† <div class="bg-white p-6 rounded-xl shadow-2xl text-center max-w-sm w-full border-t-4 border-blue-600 animate-scale-up">
¬† ¬† ¬† ¬† ¬† ¬† <h3 class="font-bold text-xl mb-2 text-gray-800">üìÑ Download Permit PDF</h3>
¬† ¬† ¬† ¬† ¬† ¬† <p class="text-sm text-gray-500 mb-6">Please select the preferred document format:</p>
¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† <div class="space-y-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button id="btn-fmt-main" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition flex items-center justify-center gap-2">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <span>üè¢</span> Mainline Format (New)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </button>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button id="btn-fmt-std" class="w-full bg-gray-100 text-gray-700 px-4 py-3 rounded-lg font-bold hover:bg-gray-200 border border-gray-300 transition flex items-center justify-center gap-2">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <span>üìë</span> Standard Format (Old)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </button>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† <button id="btn-fmt-cancel" class="mt-6 text-xs text-red-500 font-bold hover:underline">Cancel</button>
¬† ¬† ¬† ¬† </div>
¬† ¬† `;
¬† ¬†¬†
¬† ¬† document.body.appendChild(modal);

¬† ¬† // Event Listeners
¬† ¬† document.getElementById('btn-fmt-main').onclick = () => {
¬† ¬† ¬† ¬† downloadSecurePDF(id, 'mainline');
¬† ¬† ¬† ¬† closePdfModal();
¬† ¬† };
¬† ¬† document.getElementById('btn-fmt-std').onclick = () => {
¬† ¬† ¬† ¬† downloadSecurePDF(id, 'default');
¬† ¬† ¬† ¬† closePdfModal();
¬† ¬† };
¬† ¬† document.getElementById('btn-fmt-cancel').onclick = closePdfModal;
¬† ¬†¬†
¬† ¬† // Close on background click
¬† ¬† modal.onclick = (e) => { if(e.target === modal) closePdfModal(); };
}

function closePdfModal() {
¬† ¬† const m = document.getElementById('pdf-modal');
¬† ¬† if(m) document.body.removeChild(m);
}
// Function to handle JSA PDF downloads
async function downloadJsaPdf(id) {
    try {
        // Call the API to get the PDF URL
        const res = await apiCall(`/jsa/download/${id}`);
        
        if(res && res.url) {
            // Use existing file viewer logic
            viewSecureFile(res.url);
        } else {
            alert("PDF not found. It might not be approved yet.");
        }
    } catch(e) {
        console.error("JSA PDF Error:", e);
        alert("Failed to retrieve JSA PDF.");
    }
}
// Function to handle Excel Export
async function downloadSecureExcel() {
    try {
        document.getElementById('loader').style.display = 'flex';
        
        const res = await fetch(`${API}/download-excel`, { 
            method: 'GET', 
            headers: {'Authorization': `Bearer ${authToken}`} 
        });

        if (!res.ok) throw new Error("Export failed");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Permits_Export_${getNow().replace(/[\/, :]/g, '-')}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

    } catch (e) {
        console.error("Excel Export Error:", e);
        alert("Failed to export Excel data.");
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}
// 2. Updated download function to accept 'format' parameter
async function downloadSecurePDF(id, format = 'default') {
¬† ¬† try {
¬† ¬† ¬† ¬† document.getElementById('loader').style.display = 'flex';
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // Pass the format parameter to the API
¬† ¬† ¬† ¬† const res = await fetch(`${API}/download-pdf/${id}?format=${format}`, {¬†
¬† ¬† ¬† ¬† ¬† ¬† method: 'GET',
¬† ¬† ¬† ¬† ¬† ¬† headers: {'Authorization': `Bearer ${authToken}`}¬†
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† if(!res.ok) throw new Error("Server returned " + res.status);

¬† ¬† ¬† ¬† const blob = await res.blob();
¬† ¬† ¬† ¬† const url = window.URL.createObjectURL(blob);
¬† ¬† ¬† ¬† const a = document.createElement('a');
¬† ¬† ¬† ¬† a.href = url;
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // Naming convention
¬† ¬† ¬† ¬† const suffix = format === 'mainline' ? '_Mainline' : '';
¬† ¬† ¬† ¬† a.download = `Permit-${id}${suffix}.pdf`;
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† document.body.appendChild(a);
¬† ¬† ¬† ¬† a.click();
¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† // Cleanup
¬† ¬† ¬† ¬† window.URL.revokeObjectURL(url);
¬† ¬† ¬† ¬† document.body.removeChild(a);

¬† ¬† } catch(e) {
¬† ¬† ¬† ¬† console.error("PDF Download Error:", e);
¬† ¬† ¬† ¬† alert("Failed to download PDF. Please try again.");
¬† ¬† } finally {
¬† ¬† ¬† ¬† document.getElementById('loader').style.display = 'none';
¬† ¬† }
}

        document.getElementById('btn-add-rev-sup').onclick = () => addIOCLRow('iocl-sup-container-rev');
        document.getElementById('btn-add-app-sup').onclick = () => addIOCLRow('iocl-sup-container-app');
       // --- FIX C: GPS Button Logic ---
        document.getElementById('btn-get-geo').onclick = () => {
            if(!navigator.geolocation) return alert("Geolocation is not supported by your browser");
            
            document.getElementById('btn-get-geo').innerText = "‚è≥...";
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(6);
                    const lng = pos.coords.longitude.toFixed(6);
                    document.getElementById('ExactLocation').value = `${lat}, ${lng}`;
                    document.getElementById('Latitude').value = lat;
                    document.getElementById('Longitude').value = lng;
                    document.getElementById('btn-get-geo').innerText = "üìç GPS";
                },
                (err) => {
                    alert("GPS Error: " + err.message);
                    document.getElementById('btn-get-geo').innerText = "üìç GPS";
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        };
        initLogin();
    </script>
</body>
</html>











