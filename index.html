<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit</title>
    
    <link rel="stylesheet" href="/public/app.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU" async></script>
    
    <style nonce="NONCE_PLACEHOLDER">
        /* --- UI RESTORATION --- */
        input, select, textarea { 
            width: 100%; 
            border: 1px solid #d1d5db !important; 
            padding: 10px 12px; 
            border-radius: 8px; 
            font-size: 1rem; 
            background: #fff; 
            margin-bottom: 0.5rem; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #ea580c !important; 
            outline: none; 
            box-shadow: 0 0 0 2px #fdba74; 
        }
        input:disabled, select:disabled, textarea:disabled { 
            background-color: #f9fafb; 
            color: #6b7280; 
            border-color: #e5e7eb !important; 
        }
        
        .hidden { display: none !important; }
        .glass { background: white; padding: 1rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #e5e7eb; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; font-size: 1.5rem; color: #ea580c; font-weight: bold; flex-direction: column; gap: 10px; }
        
        /* Audit Trail Styles */
        .marked-deleted { text-decoration: line-through; opacity: 0.6; background-color: #fee2e2; }
        .audit-text { font-size: 0.65rem; color: #6b7280; line-height: 1; margin-top: 2px; }
        .audit-del { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body>
    <div id="loader" class="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-orange-600 mx-auto mb-2"></div>
        <div>Processing...</div>
    </div>

    <div id="view-login" class="flex items-center justify-center min-h-screen p-4 bg-orange-50">
        <div class="glass w-full max-w-md text-center shadow-xl border-t-4 border-orange-600">
           <div class="flex justify-center items-center gap-4 mb-4">
                <img src="/public/logo.png" alt="IOCL Logo" class="h-24 object-contain">
                <img src="/public/rhino.png" alt="Rhino Logo" class="h-24 object-contain">
            </div>
            <h1 class="text-3xl font-extrabold text-orange-600 mb-2">IndianOil</h1>
            <p class="text-gray-500 mb-6 font-semibold"> Mainline Work Permit System (By ERPL)</p>
            <form id="login-form" class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Role</label>
                    <select id="login-role" class="w-full bg-gray-50 h-12">
                        <option value="Requester">Requester</option>
                        <option value="Reviewer">Reviewer</option>
                        <option value="Approver">Approver</option>
                    </select>
                </div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">User</label><select id="login-name" class="w-full bg-gray-50 h-12" disabled><option>Loading Users...</option></select></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1">Password</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-gray-50 h-12"></div>
                <button type="submit" class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg hover:bg-orange-700">Sign In</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto p-2 pb-24 hidden desktop-container">
        
        <div class="mb-4">
            <img src="/public/safety_banner.png" alt="Golden Safety Rules" class="w-full h-auto rounded-xl shadow-lg border-2 border-orange-600 object-cover">
        </div>
        
        <div class="flex justify-between items-center mb-4 bg-orange-600 p-4 rounded-xl shadow-lg text-white sticky top-2 z-40">
           <div class="flex items-center gap-3">
                <img src="/public/logo.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <img src="/public/rhino.png" class="h-10 w-10 bg-white rounded-full p-1 object-contain">
                <div class="flex flex-col"><h1 class="text-lg font-bold leading-tight">Mainline Permit System </h1><span id="user-info" class="text-xs text-orange-100 font-medium"></span></div>
           </div>
           <div class="flex gap-2">
               <button id="btn-nav-worker" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Workers">üë∑</button>
               <button id="btn-nav-map" class="bg-white/20 p-2 rounded-lg hover:bg-white/30 hidden" title="Map">üó∫Ô∏è</button>
               <button id="btn-nav-logout" class="bg-white/20 p-2 rounded-lg hover:bg-white/30" title="Logout">üö™</button>
            </div>
        </div>

        <div id="view-worker-management" class="hidden">
             <div class="flex justify-between items-center mb-4 px-1"><h2 class="text-xl font-bold text-gray-800">Worker Management</h2><button id="btn-back-worker" class="text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded">‚Üê Back</button></div>
             <div id="worker-form-container" class="glass hidden border-l-4 border-blue-500 animate-fade-in">
                 <h3 class="font-bold mb-3 text-lg">Add/Edit Worker</h3>
                 <form id="worker-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                     <input type="hidden" id="w-id">
                     <input id="w-name" placeholder="Full Name" required>
                     <input id="w-father" placeholder="Father's Name" required>
                     <input id="w-address" placeholder="Address">
                     <input id="w-contact" placeholder="Contact No" type="tel">
                     <div>
                         <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Any Other</option></select>
                         <input id="w-id-type-other" placeholder="Specify ID Type" class="hidden bg-yellow-50 mt-1">
                     </div>
                     <input id="w-idcard" placeholder="ID Number (No Aadhar)" required>
                     <select id="w-gender"><option>Male</option><option>Female</option></select>
                     <input id="w-age" type="number" placeholder="Age (Must be 18+)" min="18" required>
                     <button type="submit" class="bg-green-600 text-white py-3 rounded-lg font-bold mt-2 shadow md:col-span-2">Save Worker</button>
                 </form>
             </div>
             <button id="btn-add-worker" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold mb-4 shadow hidden">+ Add New Worker</button>
             
             <table class="mobile-table w-full text-left text-sm" id="table-workers">
                 <thead class="hidden md:table-header-group bg-gray-100 text-gray-700">
                     <tr>
                         <th>Name</th>
                         <th>Father Name</th>
                         <th>ID Details</th>
                         <th>Address & Contact</th>
                         <th>Requestor</th>
                         <th>Status</th>
                         <th>Approval Info</th>
                         <th>Action</th>
                     </tr>
                 </thead>
                 <tbody class="divide-y divide-gray-200"></tbody>
             </table>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="text-xl font-bold text-gray-800">Dashboard</h2>
                <button id="btn-new-permit" class="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold shadow hidden">+ New</button>
            </div>
            
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button id="btn-add-user" class="bg-purple-100 text-purple-700 py-2 rounded font-bold text-sm hidden">Add User</button>
                <button id="btn-view-map" class="bg-blue-100 text-blue-700 py-2 rounded font-bold text-sm hidden">Map</button>
                <button id="btn-download-excel" class="bg-green-100 text-green-700 py-2 rounded font-bold text-sm hidden">Excel</button>
            </div>

            <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 hidden">
                <div class="glass h-64"><canvas id="chartStatus"></canvas></div>
                <div class="glass h-64"><canvas id="chartType"></canvas></div>
            </div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Action Required</h3>
            <div class="mb-6 overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-pending"><thead class="bg-red-50 text-red-900 border-b-2 border-red-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Active Permits</h3>
            <div class="mb-6 overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-active"><thead class="bg-green-50 text-green-900 border-b-2 border-green-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
            
            <h3 class="font-bold text-gray-500 uppercase text-xs mb-2 tracking-wide">Closed / Other</h3>
            <div class="overflow-x-auto"><table class="mobile-table w-full text-left text-sm" id="table-other"><thead class="bg-gray-50 text-gray-700 border-b-2 border-gray-200"><tr><th class="p-3 w-24">ID</th><th class="p-3 w-24">Type</th><th class="p-3">Location</th><th class="p-3 w-32">Status</th><th class="p-3 w-32">Pending With</th><th class="p-3 w-24">Action</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
        </div>
        
        <div id="view-add-user" class="hidden flex justify-center fixed inset-0 z-50 bg-black/50 items-center p-4">
            <div class="glass w-full max-w-sm relative animate-scale-up">
                <button id="btn-close-adduser" class="absolute top-2 right-2 text-gray-400 hover:text-gray-800 text-xl font-bold px-2">‚úï</button>
                <h3 class="font-bold mb-4 text-lg">Add New User</h3>
                <form id="adduser-form" class="space-y-3">
                    <input id="new-user-name" placeholder="Full Name" required>
                    <input id="new-user-email" placeholder="Email Address" required>
                    <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                    <input id="new-user-pass" type="password" placeholder="Set Password" required>
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button>
                </form>
            </div>
        </div>

        <div id="view-map" class="hidden fixed inset-0 z-50 bg-white flex flex-col md:flex-row">
            <div id="map-list" class="bg-white border-r relative z-10 shadow-xl overflow-y-auto">
                <div class="p-3 bg-orange-600 text-white font-bold flex justify-between items-center sticky top-0"><span>Active Permits</span><button id="btn-back-map" class="bg-white text-orange-600 px-2 rounded text-xs font-bold shadow">‚Üê Back</button></div>
                <div id="map-list-content"></div>
            </div>
            <div id="map-container" class="relative"><div id="map" class="w-full h-full"></div></div>
        </div>

        <div id="view-form" class="hidden">
            <div class="flex items-center gap-2 mb-2">
                <button id="btn-back-form" class="bg-white border text-gray-600 px-3 py-2 rounded-lg font-bold shadow-sm">‚Üê Back</button>
                <div id="permit-header-display" class="flex-1 p-2 bg-blue-100 text-blue-800 rounded-lg font-bold text-center text-sm truncate"></div>
            </div>
            
            <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden">
                 <h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers & Approval Status</h3>
                 <div id="assigned-worker-audit" class="overflow-x-auto"></div>
            </div>

            <form id="pf" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" id="PermitID" name="PermitID">
                <input type="hidden" id="Status" name="Status">
                
                <div class="glass">
                    <h3 class="section-title">1. Permit Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                        <div><label class="text-xs font-bold text-gray-500">Location (GPS) - Optional</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coords (Optional)"><button type="button" id="btn-get-geo" class="bg-orange-100 text-orange-600 px-4 rounded-lg font-bold border border-orange-200">üìç GPS</button></div></div>
                        <input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude">
                        
                        <div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                        <div><label class="text-xs font-bold text-gray-500">Section/Unit</label><input name="LocationUnit" id="LocationUnit" value="Pipeline"></div>
                        <div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom"></div>
                        <div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo"></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName"></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                        <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                        <div><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                        <div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly></div>
                        <div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                        <div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                        <div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div>
                        <div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div>
                    </div>
                </div>
                
                <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50 hidden">
                    <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                        <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5"> Request 1st Renewal with Permit
                    </label>
                    <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                        <div class="text-xs font-bold text-gray-500 mb-2">Renewal Details</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                            <input type="datetime-local" name="InitRenFrom" placeholder="From">
                            <input type="datetime-local" name="InitRenTo" placeholder="To">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <input name="InitRenHC" placeholder="HC %">
                            <input name="InitRenTox" placeholder="Tox">
                            <input name="InitRenO2" placeholder="O2 %">
                        </div>
                        <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                         <div class="mt-2 border-t pt-2">
                            <label class="text-xs font-bold text-red-600 uppercase block mb-1">Mandatory Photo (1st Renewal)</label>
                            <input type="file" id="ren-cam-1" name="InitRenImage" accept="image/*" capture="environment" class="text-sm">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* Applied to all selected workers</p>
                    </div>
                </div>

                <div class="glass" id="section-e">
                    <h3 class="section-title">E. References</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No">
                        <input name="JsaNo" id="JsaNo" placeholder="JSA No">
                        <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip">
                        <input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                        <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No">
                        <input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"> 
                    </div>
                </div>

                <div class="glass"><h3 class="section-title">2. Checklists</h3><div id="checklists-wrapper" class="space-y-4"></div></div>
                <div class="glass" id="worker-select-section">
                    <h3 class="section-title">Workers (Approved)</h3>
                    <div id="worker-checkboxes" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                    <div id="worker-readonly-table" class="hidden overflow-x-auto">
                        <table class="mobile-table w-full text-xs text-left">
                            <thead class="hidden md:table-header-group">
                                <tr><th>Name</th><th>Gender</th><th>Age</th><th>ID Details</th><th>Contact Number</th><th>Added By</th></tr>
                            </thead>
                            <tbody class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
                <div class="glass" id="hazards-section"><h3 class="section-title">3. Hazards</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4" id="hazards-container"></div>
                <div id="other-hazard-div" class="hidden mb-2"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div></div>
                
                <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500">
                    <h3 class="section-title text-yellow-700">4. Reviewer</h3>
                    <div class="mb-4 hidden" id="iocl-reviewer-wrapper">
                        <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
                        <div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div>
                        <button type="button" id="btn-add-rev-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button>
                    </div>
                    <div class="mb-2 font-bold text-sm text-gray-600">PPE Required:</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4" id="ppe-container"></div>
                    <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea>
                    <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea>
                </div>
                
                <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                    <h3 class="section-title text-green-700">5. Approval</h3>
                    <div class="mb-4 hidden" id="iocl-approver-wrapper">
                        <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors (Verify/Edit)</label>
                        <div id="iocl-sup-container-app" class="space-y-2 mt-2"></div>
                        <button type="button" id="btn-add-app-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300 font-bold">+ Add Supervisor</button>
                    </div>
                    <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2"></textarea>
                    
                    <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer">
                        <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600">
                        <span class="text-sm font-bold text-green-800">Require Photos for Renewals (Starting 2nd)</span>
                    </label>

                    <div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div>
                </div>
                
                <div id="iocl-sup-display-section" class="glass hidden"><h3 class="section-title">Authorized Supervisors (IOCL)</h3><table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit</th></tr></thead><tbody></tbody></table></div>
                
                <div id="renewals-section" class="glass hidden">
                    <h3 class="section-title">Renewals</h3>
                    
                    <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse">
                        <h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Request Action</h4>
                        <p class="text-sm text-gray-600 mb-2">This permit includes a request for the 1st renewal. Please decide on this renewal now.</p>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-green-700">
                                <input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Recommend / Approve Renewal
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700">
                                <input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal Only
                            </label>
                        </div>
                    </div>

                    <div id="pending-renewal-display" class="hidden bg-yellow-50 p-4 rounded-lg mb-4 border border-yellow-200"><h4 class="font-bold text-yellow-800 text-sm uppercase">‚ö†Ô∏è Pending Renewal</h4><div class="text-sm grid grid-cols-1 gap-2 mt-2"><div class="flex justify-between border-b pb-1"><span>From:</span> <span id="disp-ren-from" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>To:</span> <span id="disp-ren-to" class="font-mono"></span></div><div class="flex justify-between border-b pb-1"><span>Gas:</span> <span id="disp-ren-gas" class="font-mono"></span></div><div><span>Prec:</span> <span id="disp-ren-prec"></span></div></div><div id="odd-hour-approval-controls" class="hidden mt-3 pt-3 border-t border-yellow-300"><div class="flex items-center gap-2 mb-2"><span class="bg-indigo-900 text-white text-xs px-2 py-1 rounded font-bold">NIGHT SHIFT</span><span id="odd-hour-req-status" class="text-xs font-bold text-gray-600"></span></div><label class="flex items-center gap-2 cursor-pointer p-2 bg-white rounded border border-indigo-200"><input type="checkbox" id="odd-hour-allow-check" onchange="window.toggleRenewalApproveBtn()" class="w-5 h-5 accent-indigo-600"><span class="text-sm font-bold text-indigo-800">I allow work during Odd Hours</span></label></div></div>
                    
                    <div class="overflow-x-auto mb-4">
                        <table class="mobile-table w-full text-xs text-left" id="table-renewals">
                            <thead class="hidden md:table-header-group">
                                <tr>
                                    <th>Period</th>
                                    <th>Gas & Precautions</th>
                                    <th>Workers</th>
                                    <th>Photo</th>
                                    <th>Requester</th>
                                    <th>Reviewer</th>
                                    <th>Approver</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="renewals-list" class="divide-y"></tbody>
                        </table>
                    </div>

                    <div id="form-renewal" class="hidden p-4 bg-blue-50 mt-2 rounded-lg border border-blue-100"><div class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-2"><input type="datetime-local" id="RenewalValidFrom"><input type="datetime-local" id="RenewalValidTo"><div class="flex gap-2"><input id="RenewalHC" placeholder="HC %"> <input id="RenewalToxic" placeholder="Toxic"> <input id="RenewalOxygen" placeholder="O2 %"></div></div><div id="odd-hour-agreement" class="hidden mb-2 p-2 bg-indigo-100 border border-indigo-300 rounded"><label class="flex items-start gap-2 cursor-pointer"><input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-800"><span class="text-xs font-bold text-indigo-900 text-justify">I agree to take all precautions to execute the work during odd hours, ensuring proper lighting, safety against weather conditions, and active (non-sleepy) workers.</span></label></div><div class="mt-3 border-t border-blue-200 pt-2 bg-white p-2 rounded"><label class="text-xs font-bold text-gray-500 block mb-1">Workers for this Renewal (Optional - Select from Approved)</label><div id="renewal-worker-select" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div></div><input id="RenewalPrec" placeholder="Precautions" class="w-full mb-2 mt-3"><div id="renewal-photo-container" class="mt-2 bg-white p-2 rounded border border-red-200 hidden"><label class="text-xs font-bold text-red-600 uppercase block mb-1">Photo (Mandatory if required)</label><input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="text-sm w-full"><p id="photo-mandate-msg" class="text-[10px] text-gray-500 mt-1"></p></div><button type="button" id="btn-submit-renewal" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow mt-2">Submit Renewal</button></div>
                    
                    <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded-lg border border-yellow-100"><textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea><div class="grid grid-cols-2 gap-2"><button type="button" id="btn-approve-renewal" class="bg-green-600 text-white py-3 rounded-lg font-bold shadow disabled:bg-gray-400 disabled:cursor-not-allowed">Approve</button><button type="button" id="btn-reject-renewal" class="bg-red-600 text-white py-3 rounded-lg font-bold shadow">Reject</button></div></div>
                </div>
                
                <div id="closure-section" class="glass hidden"><h3 class="section-title">Closure</h3><label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-2 bg-red-50 rounded" id="lbl-site-restored"><input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5"> Site Restored & Cleaned</label>
                    <div id="div-closure-req" class="hidden space-y-2">
                        <label class="text-xs font-bold text-gray-500">Requester Remarks</label>
                        <textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea>
                        <span id="ts-clos-req" class="text-xs text-gray-400 block text-right font-mono"></span>
                    </div>
                    <div id="div-closure-rev" class="hidden mt-4 space-y-2">
                        <label class="text-xs font-bold text-gray-500">Reviewer Remarks</label>
                        <textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea>
                        <span id="ts-clos-rev" class="text-xs text-gray-400 block text-right font-mono"></span>
                    </div>
                    <div id="div-closure-app" class="hidden mt-4 space-y-2">
                        <label class="text-xs font-bold text-gray-500">Approver Remarks</label>
                        <textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea>
                        <span id="ts-clos-app" class="text-xs text-gray-400 block text-right font-mono"></span>
                    </div>
                </div>
                <div id="signature-history" class="glass hidden"><h3 class="section-title">History</h3><div class="grid grid-cols-1 gap-2 text-xs"><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div><div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div></div></div>
                <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden"><label class="flex items-start gap-3 p-2 cursor-pointer"><input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500"><span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules. I shall ensure all workers are complied to all these rules and in case of any violation, penalty will be imposed by IOCL and I shall accept such penalties without any further challenge.</span></label></div>
                <div id="actions" class="mt-4 flex flex-col md:flex-row justify-end gap-2 sticky bottom-0 bg-white p-4 shadow-top z-50 border-t"></div>
            </form>
        </div>
    </div>

    <script nonce="NONCE_PLACEHOLDER">
        const API = "/api";
        let authToken = null, currentUser = null, usersData = {}, mapInstance = null, chartS = null, chartT = null;
        let currentPermitId = null, currentPermitWorkers = [], currentRenewalCount = 0, permitRequirePhoto = false, currentPermitIOCLData = [];
        const CL_DATA = { A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test.", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."], B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."], C: ["1. PESO spark elimination."], D: ["1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban."] };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        document.addEventListener('DOMContentLoaded', () => {
            loadUsers(); renderUI();
            
            // Event Listeners
            document.getElementById('login-form')?.addEventListener('submit', (e) => { e.preventDefault(); handleLogin(); });
            document.getElementById('login-role')?.addEventListener('change', loadUserNames);
            
            document.getElementById('btn-nav-worker')?.addEventListener('click', toggleWorkerMode);
            document.getElementById('btn-nav-map')?.addEventListener('click', showMap);
            document.getElementById('btn-nav-logout')?.addEventListener('click', () => location.reload());
            document.getElementById('btn-back-form')?.addEventListener('click', showDashboard);
            document.getElementById('btn-back-map')?.addEventListener('click', showDashboard);
            document.getElementById('btn-new-permit')?.addEventListener('click', showNewPermit);
            document.getElementById('btn-get-geo')?.addEventListener('click', getGeo);
            
            document.getElementById('btn-back-worker')?.addEventListener('click', toggleWorkerMode);
            document.getElementById('btn-add-worker')?.addEventListener('click', () => openWorkerForm('create'));
            document.getElementById('worker-form')?.addEventListener('submit', (e) => { e.preventDefault(); saveWorker(window.currentWorkerAction); });
            document.getElementById('w-id-type')?.addEventListener('change', toggleOtherID);

            document.getElementById('btn-view-map')?.addEventListener('click', showMap);
            document.getElementById('btn-add-user')?.addEventListener('click', showAddUser);
            document.getElementById('btn-download-excel')?.addEventListener('click', downloadSecureExcel);
            document.getElementById('btn-close-adduser')?.addEventListener('click', () => document.getElementById('view-add-user').classList.add('hidden'));
            document.getElementById('adduser-form')?.addEventListener('submit', (e) => { e.preventDefault(); submitNewUser(); });
            
            document.getElementById('chk-init-renewal')?.addEventListener('change', (e) => document.getElementById('div-init-renewal').classList.toggle('hidden', !e.target.checked));
            document.getElementById('RenewalValidFrom')?.addEventListener('change', checkRenewalTime);
            document.getElementById('RenewalValidTo')?.addEventListener('change', checkRenewalTime);
            document.getElementById('odd-hour-allow-check')?.addEventListener('change', toggleRenewalApproveBtn);
            
            document.getElementById('btn-submit-renewal')?.addEventListener('click', () => submitRenewal('approve'));
            document.getElementById('btn-approve-renewal')?.addEventListener('click', () => submitRenewal('approve'));
            document.getElementById('btn-reject-renewal')?.addEventListener('click', () => submitRenewal('reject'));

            // Supervisor Buttons
            document.getElementById('btn-add-rev-sup')?.addEventListener('click', () => addIOCLRow('iocl-sup-container-rev'));
            document.getElementById('btn-add-app-sup')?.addEventListener('click', () => addIOCLRow('iocl-sup-container-app'));
            
            document.getElementById('ValidFrom')?.addEventListener('change', checkDate);
            document.getElementById('ValidTo')?.addEventListener('change', checkDate);
        });

        // --- HELPERS ---
        function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function getNow() { return new Date().toLocaleString("en-GB").replace(',',''); }

        async function apiCall(ep, meth="GET", body=null) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const headers = {'Content-Type':'application/json'};
                if(authToken) headers['Authorization'] = `Bearer ${authToken}`;
                const opts={method:meth, headers:headers};
                if(body)opts.body=JSON.stringify(body);
                const res = await fetch(API+ep,opts); 
                if (res.status === 401 || res.status === 403) {
                    if(authToken) { alert("Session expired."); location.reload(); }
                    return { error: "Auth" };
                }
                return await res.json();
            } finally { document.getElementById('loader').style.display = 'none'; }
        }

        async function loadUsers() {
            try { const u = await apiCall('/users'); usersData = u; loadUserNames(); } catch(e){}
        }

        function loadUserNames() {
            const role = document.getElementById("login-role").value; 
            const names = usersData[role+'s'] || []; 
            const sel = document.getElementById("login-name"); 
            sel.innerHTML = names.map(u => `<option value="${u.email}">${escapeHtml(u.name)}</option>`).join(''); 
            sel.disabled = false; 
        }

        async function handleLogin() {
            const r=document.getElementById("login-role").value; 
            const n=document.getElementById("login-name").options[document.getElementById("login-name").selectedIndex].text; 
            const e=document.getElementById("login-name").value; 
            const p=document.getElementById("login-password").value; 
            
            const res = await apiCall('/login','POST',{role:r,name:e,password:p}); 
            if(res.success){ 
                currentUser={...res.user, name:n}; 
                authToken = res.token; 
                document.getElementById("view-login").classList.add('hidden'); 
                document.getElementById("app-container").classList.remove('hidden'); 
                document.getElementById("user-info").innerText=`${n} (${r})`; 
                await loadUsers(); 
                updateRoleUI(); 
                loadDashboard(); 
            } else alert("Invalid Login"); 
        }

        function updateRoleUI() {
            if(currentUser.Role==='Requester') { 
                document.getElementById("btn-new-permit").classList.remove('hidden');
                document.getElementById("btn-add-worker").classList.remove('hidden');
            }
            if(currentUser.Role!=='Requester') { 
                ['btn-view-map', 'btn-header-map', 'btn-download-excel', 'charts-container'].forEach(id => {
                    document.getElementById(id)?.classList.remove('hidden');
                });
                loadStats(); 
                if(currentUser.Role==='Approver') document.getElementById("btn-add-user").classList.remove('hidden');
            }
        }

        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role:currentUser.Role, email:currentUser.Email});
            const tP = document.querySelector('#table-pending tbody');
            const tA = document.querySelector('#table-active tbody');
            const tO = document.querySelector('#table-other tbody');
            tP.innerHTML=""; tA.innerHTML=""; tO.innerHTML="";

            res.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "cursor-pointer hover:bg-orange-50 transition border-b";
                
                let actionBtn = document.createElement('span');
                actionBtn.className = "bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold";
                actionBtn.innerText = "OPEN";
                
                if (p.Status === 'Closed') {
                    actionBtn = document.createElement('button');
                    actionBtn.className = "btn-pdf";
                    actionBtn.innerText = "Download PDF";
                    actionBtn.type="button";
                    actionBtn.onclick = (e) => { e.stopPropagation(); downloadSecurePDF(p.PermitID); };
                } else if (p.Status === 'Active' && !p.Status.includes('Renewal')) {
                    actionBtn = document.createElement('button');
                    actionBtn.className = "btn-pdf";
                    actionBtn.innerText = "Download PDF";
                    actionBtn.type="button";
                    actionBtn.onclick = (e) => { e.stopPropagation(); downloadSecurePDF(p.PermitID); };
                }

                let statusClass = p.Status.includes('Pending') ? 'text-red-600' : (p.Status==='Active' ? 'text-green-600' : 'text-gray-600');
                
                tr.innerHTML = `<td class="font-bold text-blue-600 text-lg">${p.PermitID}</td><td class="font-medium">${escapeHtml(p.WorkType||'-')}</td><td class="text-gray-600">${escapeHtml(p.LocationUnit||'-')}</td><td class="font-bold ${statusClass}">${p.Status}</td><td class="text-sm text-gray-500">${escapeHtml(p.ReviewerEmail || p.ApproverEmail || '-')}</td><td></td>`;
                tr.lastElementChild.appendChild(actionBtn);
                if(p.Status !== 'Closed') tr.addEventListener('click', () => openPermit(p.PermitID));

                let isAction = false;
                if(currentUser.Role === 'Reviewer' && (p.Status === 'Pending Review' || p.Status === 'Renewal Pending Review' || p.Status === 'Closure Pending Review')) isAction = true;
                if(currentUser.Role === 'Approver' && (p.Status === 'Pending Approval' || p.Status === 'Renewal Pending Approval' || p.Status === 'Closure Pending Approval')) isAction = true;
                if(currentUser.Role === 'Requester' && (p.Status.includes('Pending') || p.Status === 'New')) isAction = true;

                if(isAction) tP.appendChild(tr);
                else if(p.Status === 'Active' || p.Status.includes('Renewal')) tA.appendChild(tr);
                else tO.appendChild(tr);
            });
        }

        function renderUI() {
            let h = '';
            ['A','B','C','D'].forEach(sec => {
                h += `<div class="glass p-3"><div class="flex justify-between items-center border-b pb-1 mb-2"><div class="font-bold text-orange-700">SECTION ${sec}</div><div class="flex gap-2 text-xs items-center bg-orange-50 p-1 rounded"><span class="font-bold text-gray-600">Applicability:</span><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="Yes" checked class="sec-toggle" data-sec="${sec}"> Yes</label><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="NA" class="sec-toggle" data-sec="${sec}"> NA</label><label class="cursor-pointer"><input type="radio" name="Master_${sec}" value="No" class="sec-toggle" data-sec="${sec}"> No</label></div></div>`;
                h += CL_DATA[sec].map((t, i) => {
                    return `<div class="mb-4 pb-2 border-b border-gray-100"><div class="text-sm font-medium mb-2">${t}</div><div class="flex gap-4 bg-gray-50 p-2 rounded"><label><input type="radio" name="${sec}_Q${i+1}" value="Yes" checked> Yes</label><label><input type="radio" name="${sec}_Q${i+1}" value="NA"> NA</label><label><input type="radio" name="${sec}_Q${i+1}" value="No"> No</label></div>${(sec==='A' && i===11) ? `<div class="flex gap-1 mt-2"><input name="GP_Q12_HC" placeholder="HC%"><input name="GP_Q12_ToxicGas" placeholder="Tox"><input name="GP_Q12_Oxygen" placeholder="O2%"></div>` : `<input name="${sec}_Q${i+1}_Detail" placeholder="Remarks" class="text-sm mt-2 w-full">`}</div>`;
                }).join('');
                h += `</div>`;
            });
            document.getElementById('checklists-wrapper').innerHTML = h;
            document.querySelectorAll('.sec-toggle').forEach(r => r.addEventListener('change', (e) => {
                const val = e.target.value; const sec = e.target.dataset.sec;
                document.querySelectorAll(`input[name^="${sec}_Q"][value="${val}"]`).forEach(rn => rn.checked = true);
            }));
            document.getElementById('hazards-container').innerHTML = HAZARDS.map(z => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="H_${z.replace(/ /g,'')}" value="Y" ${z==='Others'?'id="chk-haz-others"':''} class="w-5 h-5 text-orange-600"> <span class="text-sm font-medium">${z}</span></label>`).join('');
            document.getElementById('chk-haz-others')?.addEventListener('change', (e) => document.getElementById('other-hazard-div').classList.toggle('hidden', !e.target.checked));
            document.getElementById('ppe-container').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50 hover:bg-blue-50 transition"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="w-5 h-5 text-blue-600"> <span class="text-sm font-medium">${p}</span></label>`).join('');
        }

        function getGeo() {
            if (!navigator.geolocation) return alert("Geolocation not supported");
            const btn = document.getElementById("btn-get-geo"); btn.innerText = "Locating...";
            navigator.geolocation.getCurrentPosition(
                (p) => { safeSet("ExactLocation", `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`); safeSet("Latitude", p.coords.latitude); safeSet("Longitude", p.coords.longitude); btn.innerText = "üìç GPS Set"; },
                () => { btn.innerText = "üìç Retry"; alert("GPS Failed"); }
            );
        }
        async function loadMapData() { 
            const p = await apiCall('/map-data', 'POST'); 
            if(!mapInstance) mapInstance=new google.maps.Map(document.getElementById("map"),{center:{lat:22.57,lng:88.36},zoom:5}); 
            const listEl = document.getElementById("map-list-content"); listEl.innerHTML = ""; const infoWindow = new google.maps.InfoWindow(); 
            p.forEach(x => { 
                const marker = new google.maps.Marker({position:{lat:x.lat,lng:x.lng}, map:mapInstance}); 
                const item = document.createElement("div"); item.className = "p-3 border-b cursor-pointer hover:bg-orange-50 text-sm"; item.innerText = `${x.PermitID} - ${x.WorkType}`; 
                item.addEventListener('click', () => { mapInstance.setCenter({lat:x.lat,lng:x.lng}); mapInstance.setZoom(12); }); listEl.appendChild(item); 
            }); 
        }
        function showMap() { document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-map").classList.remove('hidden'); loadMapData(); }
        
        function toggleWorkerMode() {
            const dash = document.getElementById("view-dashboard"); const work = document.getElementById("view-worker-management");
            if(dash.classList.contains('hidden')) { dash.classList.remove('hidden'); work.classList.add('hidden'); }
            else { dash.classList.add('hidden'); work.classList.remove('hidden'); loadWorkers('dashboard'); }
        }
        function openWorkerForm(act, data=null) {
            window.currentWorkerAction = act; 
            document.getElementById('worker-form-container').classList.remove('hidden');
            if(act === 'create') {
                document.getElementById('worker-form').reset();
            } else if (act === 'edit_request' && data) {
                document.getElementById('w-id').value = data.WorkerID;
                document.getElementById('w-name').value = data.Name;
                document.getElementById('w-father').value = data.Father;
                document.getElementById('w-address').value = data.Address;
                document.getElementById('w-contact').value = data.Contact;
                document.getElementById('w-idcard').value = data.ID;
                document.getElementById('w-gender').value = data.Gender;
                document.getElementById('w-age').value = data.Age;
                const isStd = ["Voter Card", "PAN Card"].includes(data.IDType);
                document.getElementById("w-id-type").value = isStd ? data.IDType : "Other";
                toggleOtherID();
                if(!isStd) document.getElementById("w-id-type-other").value = data.IDType;
            }
        }
        async function saveWorker(act) {
            const idTypeRaw = document.getElementById("w-id-type").value;
            const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw;
            const body = { Action: act, Role: currentUser.Role, RequestorEmail: currentUser.Email, WorkerID: document.getElementById('w-id').value, RequestorName: currentUser.name, Details: { Name: document.getElementById("w-name").value, Age: document.getElementById("w-age").value, Father: document.getElementById("w-father").value, Address: document.getElementById("w-address").value, Contact: document.getElementById("w-contact").value, ID: document.getElementById("w-idcard").value, Gender: document.getElementById("w-gender").value, IDType: idTypeFinal } };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { alert("Saved"); loadWorkers('dashboard'); document.getElementById('worker-form-container').classList.add('hidden'); }
        }
        
        async function loadWorkers(context) { 
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); 
            if(context === 'permit_dropdown') { 
                const con = document.getElementById('worker-checkboxes'); 
                con.innerHTML = res.map(w => `<label class="flex items-center gap-2 border p-3 rounded-lg bg-gray-50"><input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5"> <span class="font-bold">${escapeHtml(w.Name)}</span></label>`).join(''); 
            } else { 
                const t = document.querySelector('#table-workers tbody'); 
                t.innerHTML = "";
                res.forEach(w => {
                    const row = document.createElement('tr');
                    
                    const approvalInfo = w.ApprovedBy ? `<div class="text-xs text-green-700 font-bold">${escapeHtml(w.ApprovedBy)}<br>${w.ApprovedAt}</div>` : '-';

                    row.innerHTML = `<td>${escapeHtml(w.Name)}</td><td>${escapeHtml(w.Father)}</td><td>${w.IDType}: ${w.ID}</td><td>${w.Contact}</td><td>${w.RequestorName}</td><td>${w.Status}</td><td>${approvalInfo}</td><td></td>`;
                    
                    const actionCell = row.lastElementChild;

                    if(currentUser.Role !== 'Requester' && w.Status.includes('Pending')) {
                        const btnApp = document.createElement('button');
                        btnApp.className = "text-green-600 font-bold border p-1 rounded mr-2";
                        btnApp.textContent = "Approve";
                        btnApp.onclick = () => workerAction(w.WorkerID, 'approve');
                        
                        const btnRej = document.createElement('button');
                        btnRej.className = "text-red-600 font-bold border p-1 rounded";
                        btnRej.textContent = "Reject";
                        btnRej.onclick = () => workerAction(w.WorkerID, 'reject');
                        
                        actionCell.appendChild(btnApp);
                        actionCell.appendChild(btnRej);
                    }
                    
                    if(currentUser.Role === 'Requester' && w.Status === 'Approved') {
                        const btnEdit = document.createElement('button');
                        btnEdit.className = "text-blue-600 font-bold mr-2";
                        btnEdit.textContent = "Edit";
                        btnEdit.onclick = () => openWorkerForm("edit_request", w);
                        
                        const btnDel = document.createElement('button');
                        btnDel.className = "text-red-600 font-bold";
                        btnDel.textContent = "Del";
                        btnDel.onclick = () => workerAction(w.WorkerID, 'delete');
                        
                        actionCell.appendChild(btnEdit);
                        actionCell.appendChild(btnDel);
                    }
                    
                    t.appendChild(row);
                });
            } 
        }
        async function workerAction(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.name}); loadWorkers('dashboard'); }
        function toggleOtherID() { const val = document.getElementById("w-id-type").value; document.getElementById("w-id-type-other").classList.toggle("hidden", val !== "Other"); }

        function addIOCLRow(containerId, data = null) {
            if(data && data.is_deleted) return; 
            const div = document.createElement('div'); div.className = "flex gap-1 iocl-row items-center mb-1";
            const addedBy = data ? data.added_by : currentUser.name;
            const addedAt = data ? data.added_at : getNow();
            const hiddenFields = `<input type="hidden" class="iocl-added-by" value="${addedBy}"><input type="hidden" class="iocl-added-at" value="${addedAt}">`;
            div.innerHTML = `${hiddenFields}<input class="iocl-name border p-1 w-1/3" placeholder="Name" value="${data?data.name:''}"><input class="iocl-desig border p-1 w-1/3" placeholder="Desig" value="${data?data.desig:''}"><input class="iocl-contact border p-1 w-1/3" placeholder="Contact" value="${data?data.contact:''}"><button type="button" class="text-red-500 font-bold px-2 btn-del-iocl">x</button>`;
            div.querySelector('.btn-del-iocl').onclick = () => markIOCLDeleted(div);
            document.getElementById(containerId).appendChild(div);
        }

        function markIOCLDeleted(rowElement) {
            rowElement.classList.add('hidden', 'marked-deleted');
        }

        function getIOCLData(containerId) {
            const rows = document.querySelectorAll(`#${containerId} .iocl-row`);
            const results = [];
            
            if(currentPermitIOCLData) {
                currentPermitIOCLData.filter(d => d.is_deleted).forEach(d => results.push(d));
            }
            
            rows.forEach(r => {
                const nameVal = r.querySelector('.iocl-name').value;
                if(!nameVal) return;
                
                const isDel = r.classList.contains('marked-deleted');
                const obj = {
                    name: nameVal,
                    desig: r.querySelector('.iocl-desig').value, 
                    contact: r.querySelector('.iocl-contact').value,
                    added_by: r.querySelector('.iocl-added-by').value,
                    added_at: r.querySelector('.iocl-added-at').value,
                    is_deleted: isDel
                };
                
                if(isDel) {
                    obj.deleted_by = currentUser.name;
                    obj.deleted_at = getNow();
                }
                results.push(obj);
            });
            return results;
        }

        function renderIOCLTable() {
            const t = document.querySelector('#table-iocl-display tbody');
            let h = '';
            if(!currentPermitIOCLData || currentPermitIOCLData.length === 0) {
                h = '<tr><td colspan="4" class="text-gray-400">No Supervisors</td></tr>';
            } else {
                h = currentPermitIOCLData.map(x => {
                    const rowClass = x.is_deleted ? 'marked-deleted' : '';
                    let audit = `Add: ${x.added_by} (${x.added_at})`;
                    if(x.is_deleted) audit += `<br><span class="audit-del">Del: ${x.deleted_by} (${x.deleted_at})</span>`;
                    return `<tr class="${rowClass}"><td>${escapeHtml(x.name)}</td><td>${escapeHtml(x.desig)}</td><td>${escapeHtml(x.contact)}</td><td class="audit-text">${audit}</td></tr>`;
                }).join('');
            }
            t.innerHTML = h;
            if(currentPermitIOCLData.length > 0) document.getElementById("iocl-sup-display-section").classList.remove('hidden');
        }

        async function openPermit(id) {
             const p = await apiCall('/permit-data', 'POST', {permitId:id});
             currentPermitId = id; currentPermitIOCLData = p.IOCLSupervisors || []; permitRequirePhoto = (p.RequireRenewalPhotos === 'Y');
             document.getElementById("permit-header-display").innerText = `${id} | ${p.Status}`;
             document.getElementById("permit-worker-audit-display").classList.remove("hidden");
             
             document.getElementById("assigned-worker-audit").innerHTML = `<table class="mobile-table w-full text-xs"><thead><tr><th>Name</th><th>Gender</th><th>Age</th><th>ID Details</th><th>Contact Number</th><th>Added By</th></tr></thead><tbody>${p.SelectedWorkers.map(w=>`<tr><td>${escapeHtml(w.Name)}</td><td>${escapeHtml(w.Gender)}</td><td>${escapeHtml(w.Age)}</td><td>${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td><td>${escapeHtml(w.Contact)}</td><td>${escapeHtml(w.RequestorName)}</td></tr>`).join('')}</tbody></table>`;

             const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
             rS.innerHTML=""; aS.innerHTML=""; 
             if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); }

             document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => {
                if(e.type==='radio'){ if(e.value===p[e.name]) e.checked=true; } 
                else if(e.type==='checkbox'){ e.checked=(p[e.name]==='Y'); } 
                else { e.value=p[e.name]||''; }
                e.disabled=true; 
             });

             await loadWorkers('permit_dropdown'); 
             currentPermitWorkers = p.SelectedWorkers;
             
             const wDiv = document.getElementById('worker-checkboxes');
             const wTable = document.getElementById('worker-readonly-table');
             if(currentUser.Role === 'Requester' && (p.Status === 'New' || p.Status.includes('Pending Review'))) {
                 wDiv.classList.remove('hidden'); wTable.classList.add('hidden');
             } else {
                 wDiv.classList.add('hidden'); wTable.classList.remove('hidden');
                 wTable.querySelector('tbody').innerHTML = currentPermitWorkers.map(w => `<tr><td>${escapeHtml(w.Name)}</td><td>${escapeHtml(w.Gender)}</td><td>${escapeHtml(w.Age)}</td><td>${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td><td>${escapeHtml(w.Contact)}</td><td>${escapeHtml(p.RequesterName)}</td></tr>`).join('');
             }

             const rens = JSON.parse(p.RenewalsJSON || "[]");
             currentRenewalCount = rens.length;
             
             document.querySelector("#table-renewals tbody").innerHTML = rens.map(r => {
                 const photoHtml = r.photoUrl ? `<button type="button" class="text-blue-600 font-bold underline text-xs btn-view-photo" data-url="${r.photoUrl}">View Photo</button>` : 'N/A';
                 return `<tr>
                    <td>Start: ${r.valid_from}<br>End: ${r.valid_till}</td>
                    <td>${r.hc}/${r.toxic}/${r.oxygen}<br><span class="text-[10px] text-gray-500">${r.precautions||'-'}</span></td>
                    <td>${r.worker_list||'-'}</td>
                    <td>${photoHtml}</td>
                    <td>${escapeHtml(r.req_name)}<br><span class="text-[10px] text-gray-500">${r.req_at}</span></td>
                    <td>${escapeHtml(r.rev_name||'-')}<br><span class="text-[10px] text-gray-500">${r.rev_at||''}</span></td>
                    <td>${escapeHtml(r.app_name||'-')}<br><span class="text-[10px] text-gray-500">${r.app_at||''}</span></td>
                    <td><span class="font-bold ${r.status==='rejected'?'text-red-600':'text-green-600'}">${r.status}</span></td>
                 </tr>`;
             }).join('');
             document.querySelectorAll('.btn-view-photo').forEach(b => b.addEventListener('click', (e) => viewSecurePhoto(e.target.dataset.url)));

             if(rens.length > 0) document.getElementById("renewals-section").classList.remove('hidden');
             
             // FIX B: Renewal Timestamp in History
             const lastApprovedRen = rens.slice().reverse().find(r => r.status === 'approved');
             const renText = lastApprovedRen ? `${lastApprovedRen.app_name} on ${lastApprovedRen.app_at}` : 'None';
             setText("sig-ren", renText);

             ['iocl-sup-container-rev', 'iocl-sup-container-app'].forEach(id => document.getElementById(id).innerHTML = '');
             ['fs-reviewer-section', 'fs-approver-section', 'closure-section', 'iocl-reviewer-wrapper', 'iocl-approver-wrapper'].forEach(id => document.getElementById(id).classList.add('hidden'));

             renderIOCLTable();

             // FIX C: Other Hazards
             if (p.H_Others === 'Y') document.getElementById("other-hazard-div").classList.remove('hidden');
             else document.getElementById("other-hazard-div").classList.add('hidden');

             const actionsDiv = document.getElementById("actions"); actionsDiv.innerHTML = "";
             
             document.getElementById("first-renewal-decision").classList.add('hidden');
             if(rens.length === 1) {
                 if(currentUser.Role === 'Reviewer' && p.Status === 'Pending Review' && rens[0].status === 'pending_review') {
                     document.getElementById("first-renewal-decision").classList.remove('hidden');
                     const rRadios = document.getElementsByName('FirstRenewalAction');
                     for(const r of rRadios) r.disabled = false;
                 }
                 if(currentUser.Role === 'Approver' && p.Status === 'Pending Approval' && rens[0].status === 'pending_approval') {
                     document.getElementById("first-renewal-decision").classList.remove('hidden');
                     const rRadios = document.getElementsByName('FirstRenewalAction');
                     for(const r of rRadios) r.disabled = false;
                 }
             }

             document.getElementById("action-renewal").classList.add('hidden');
             if(rens.length > 0) {
                 const lastRen = rens[rens.length-1];
                 if(lastRen.status.includes('pending')) {
                     if(currentUser.Role === 'Reviewer' && p.Status.includes('Renewal Pending Review')) {
                         document.getElementById("action-renewal").classList.remove('hidden');
                     }
                     if(currentUser.Role === 'Approver' && p.Status.includes('Renewal Pending Approval')) {
                         document.getElementById("action-renewal").classList.remove('hidden');
                     }
                 }
             }

             if(currentUser.Role === 'Requester' && p.Status === 'New') {
                  const btn = document.createElement("button"); btn.className = "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg"; btn.innerText = "Submit Permit"; btn.type = "button"; btn.addEventListener('click', savePermit); actionsDiv.appendChild(btn);
                  document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false);
             }
             if(currentUser.Role === 'Reviewer' && p.Status === 'Pending Review') {
                 document.getElementById("fs-reviewer-section").classList.remove('hidden');
                 document.getElementById("iocl-reviewer-wrapper").classList.remove('hidden');
                 currentPermitIOCLData.forEach(d => addIOCLRow('iocl-sup-container-rev', d));
                 document.querySelectorAll('#fs-reviewer-section *, #hazards-section input').forEach(e=>e.disabled=false);
                 const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1"; b1.innerText = "Reject"; b1.type="button"; b1.addEventListener('click', () => upd('reject'));
                 const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1 ml-2"; b2.innerText = "Review"; b2.type="button"; b2.addEventListener('click', () => upd('review'));
                 actionsDiv.append(b1, b2);
             }
             if(currentUser.Role === 'Approver' && (p.Status === 'Pending Approval' || p.Status === 'Active')) {
                 document.getElementById("fs-approver-section").classList.remove('hidden');
                 document.getElementById("iocl-approver-wrapper").classList.remove('hidden');
                 currentPermitIOCLData.forEach(d => addIOCLRow('iocl-sup-container-app', d));
                 if(p.Status === 'Pending Approval') {
                     document.getElementById("Approver_Remarks").disabled=false; 
                     document.getElementById("RequireRenewalPhotos").disabled = false;
                     const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1"; b1.innerText = "Reject"; b1.type="button"; b1.addEventListener('click', () => upd('reject'));
                     const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1 ml-2"; b2.innerText = "Approve"; b2.type="button"; b2.addEventListener('click', () => upd('approve'));
                     actionsDiv.append(b1, b2);
                 } else if (p.Status === 'Active') {
                     const btnUpd = document.createElement("button"); btnUpd.className = "bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow flex-1"; btnUpd.innerText = "Update Supervisors"; btnUpd.type="button"; btnUpd.onclick = () => upd('approve'); actionsDiv.appendChild(btnUpd);
                 }
             }
             if(currentUser.Role === 'Reviewer' && p.Status === 'Closure Pending Review') {
                 document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-rev").classList.remove('hidden'); document.getElementById("Closure_Reviewer_Remarks").disabled=false;
                 const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1"; b1.innerText = "Reject Closure"; b1.type="button"; b1.addEventListener('click', () => upd('reject_closure'));
                 const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex-1 ml-2"; b2.innerText = "Verify Closure"; b2.type="button"; b2.addEventListener('click', () => upd('approve_closure'));
                 actionsDiv.append(b1, b2);
             }
             if(currentUser.Role === 'Approver' && p.Status === 'Closure Pending Approval') {
                 document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-app").classList.remove('hidden'); document.getElementById("Closure_Approver_Remarks").disabled=false;
                 const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-3 rounded-lg font-bold flex-1"; b1.innerText = "Reject Closure"; b1.type="button"; b1.addEventListener('click', () => upd('reject_closure'));
                 const b2 = document.createElement("button"); b2.className = "bg-black text-white px-4 py-3 rounded-lg font-bold flex-1 ml-2"; b2.innerText = "Close Permit"; b2.type="button"; b2.addEventListener('click', () => upd('approve'));
                 actionsDiv.append(b1, b2);
             }
             
             // FIX A: Closure Visibility Logic
             if (p.Status === 'Closed' || p.Status.includes('Closure')) {
                 document.getElementById("closure-section").classList.remove('hidden');
                 
                 // Requestor Remarks & Timestamp (Always Visible if present)
                 document.getElementById("div-closure-req").classList.remove('hidden');
                 setText("ts-clos-req", p.Closure_Requestor_Date || '');

                 // Reviewer Remarks & Timestamp (Visible if past review stage)
                 if (p.Status !== 'Closure Pending Review') {
                     document.getElementById("div-closure-rev").classList.remove('hidden');
                     setText("ts-clos-rev", p.Closure_Reviewer_Date || '');
                 }

                 // Approver Remarks & Timestamp (Visible if Closed)
                 if (p.Status === 'Closed') {
                     document.getElementById("div-closure-app").classList.remove('hidden');
                     setText("ts-clos-app", p.Closure_Approver_Date || '');
                 }
             }

             const last = rens[rens.length-1];
             if(currentUser.Role === 'Requester' && (p.Status === 'Active' || p.Status.includes('Renewal')) && (!last || !last.status.includes('pending'))) {
                 document.getElementById("closure-section").classList.remove('hidden'); document.getElementById("div-closure-req").classList.remove('hidden');
                 document.getElementById("Closure_Requestor_Remarks").disabled = false; document.getElementById("Site_Restored_Check").disabled = false;
                 document.getElementById("form-renewal").classList.remove('hidden'); document.querySelectorAll('#form-renewal input').forEach(e => e.disabled = false);
                 const renSel = document.getElementById('renewal-worker-select');
                 renSel.innerHTML = currentPermitWorkers.map(w => `<label class="flex items-center gap-1 text-xs bg-white p-1 rounded border"><input type="checkbox" value="${escapeHtml(w.Name)}" checked class="ren-worker-cb"> ${escapeHtml(w.Name)}</label>`).join('');
                 const showPhotoBox = (currentRenewalCount > 0 && permitRequirePhoto);
                 const photoDiv = document.getElementById("renewal-photo-container"); const msgEl = document.getElementById("photo-mandate-msg");
                 if(showPhotoBox) { photoDiv.classList.remove('hidden'); msgEl.innerText = "* Photo Upload is MANDATORY."; msgEl.classList.add("text-red-600", "font-bold"); } else { photoDiv.classList.add('hidden'); }
                 const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow flex-1"; b1.innerText = "Job Complete"; b1.type="button"; b1.addEventListener('click', () => upd('initiate_closure')); actionsDiv.appendChild(b1);
             }

             document.getElementById("signature-history").classList.remove('hidden');
             setText("sig-app", p.Approver_Sig || 'Pending'); setText("sig-clos", p.Closure_Approver_Sig || 'Pending');
             document.getElementById("view-dashboard").classList.add('hidden'); document.getElementById("view-form").classList.remove('hidden');
             
             if (rens.length === 1 && (p.Status.includes('Pending Review') || p.Status.includes('Pending Approval'))) {
                 const rRadios = document.getElementsByName('FirstRenewalAction');
                 for(const r of rRadios) r.disabled = false;
             }
        }

        async function savePermit() {
             if(!document.getElementById('gsr-check').checked) return alert("Accept GSR");
             const fd = new FormData(document.getElementById("pf"));
             document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(c.name) fd.set(c.name, c.checked ? "Y" : "N"); });
             fd.set("GSR_Accepted", "Y");
             const selectedWorkers = [];
             document.querySelectorAll('#worker-checkboxes input:checked').forEach(c => selectedWorkers.push(JSON.parse(c.value)));
             fd.append("SelectedWorkers", JSON.stringify(selectedWorkers));
             if(currentUser) fd.append("RequesterEmail", currentUser.Email);
             const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
             const json = await res.json();
             if(json.success) { alert("Saved: "+json.permitId); showDashboard(); } else alert(json.error);
        }

        function showNewPermit() {
             document.getElementById("pf").reset();
             currentPermitId = null;
             document.getElementById("view-dashboard").classList.add('hidden');
             document.getElementById("view-form").classList.remove('hidden');
             loadWorkers('permit_dropdown');
             document.querySelectorAll('input, textarea, select').forEach(e=>e.disabled=false);
             
             document.getElementById("init-renewal-wrapper").classList.remove('hidden');
             document.getElementById("gsr-container").classList.remove('hidden');
             
             safeSet("RequesterName", currentUser.name);
             safeSet("Vendor", currentUser.name);
             document.getElementById("Vendor").readOnly = true;

             const rS=document.getElementById("ReviewerEmail"), aS=document.getElementById("ApproverEmail"); 
             rS.innerHTML=""; aS.innerHTML=""; 
             if(usersData){ usersData.Reviewers.forEach(u=>rS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); usersData.Approvers.forEach(u=>aS.innerHTML+=`<option value="${u.email}">${escapeHtml(u.name)}</option>`); }

             const actionsDiv = document.getElementById("actions"); actionsDiv.innerHTML = "";
             const btn = document.createElement("button");
             btn.className = "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg";
             btn.innerText = "Submit Permit"; btn.type = "button"; btn.addEventListener('click', savePermit);
             actionsDiv.appendChild(btn);
        }
        
        async function upd(act) {
            if(act === 'initiate_closure') { if(!document.getElementById("Site_Restored_Check").checked) return alert("Confirm Site Restored"); }
            let ioclData = [];
            const isReviewerEditing = (currentUser.Role === 'Reviewer' && !document.getElementById('iocl-reviewer-wrapper').classList.contains('hidden'));
            const isApproverEditing = (currentUser.Role === 'Approver' && !document.getElementById('iocl-approver-wrapper').classList.contains('hidden'));
            if (isReviewerEditing) ioclData = getIOCLData('iocl-sup-container-rev');
            else if (isApproverEditing) ioclData = getIOCLData('iocl-sup-container-app');
            else ioclData = currentPermitIOCLData || [];

            const body = { 
                PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.name,
                comment: (currentUser.Role==='Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks")),
                Closure_Requestor_Remarks: getVal("Closure_Requestor_Remarks"), 
                Closure_Reviewer_Remarks: getVal("Closure_Reviewer_Remarks"), 
                Closure_Approver_Remarks: getVal("Closure_Approver_Remarks"),
                bgColor: getVal("PdfBgColor"), IOCLSupervisors: ioclData,
                Site_Restored_Check: document.getElementById("Site_Restored_Check").checked ? 'Y' : 'N'
            };
            if(currentUser.Role === 'Reviewer' && act === 'review') {
                const fd = new FormData(document.getElementById("pf"));
                document.querySelectorAll('#hazards-section input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                document.querySelectorAll('#ppe-container input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                body.Reviewer_Remarks = getVal("Reviewer_Remarks");
                body.AdditionalPrecautions = getVal("AdditionalPrecautions");
                const rRadios = document.getElementsByName('FirstRenewalAction');
                for(const r of rRadios) { if(r.checked) body.FirstRenewalAction = r.value; }
            }
            if(currentUser.Role === 'Approver' && act === 'approve') { 
                body.Approver_Remarks = getVal("Approver_Remarks"); 
                body.RequireRenewalPhotos = document.getElementById("RequireRenewalPhotos").checked ? 'Y' : 'N';
                const rRadios = document.getElementsByName('FirstRenewalAction');
                for(const r of rRadios) { if(r.checked) body.FirstRenewalAction = r.value; }
            }
            const res = await apiCall('/update-status', 'POST', body);
            if(res.success) showDashboard(); else alert(res.error);
        }

        function addIOCLRow(containerId, data={}) {
            const div = document.createElement('div'); div.className = "flex gap-1 iocl-row items-center mb-1";
            div.innerHTML = `<input class="iocl-name border p-1" placeholder="Name" value="${data.name||''}"><input class="iocl-desig border p-1" placeholder="Desig"><input class="iocl-contact border p-1" placeholder="Contact"><button type="button" class="text-red-500 font-bold px-2">x</button>`;
            div.querySelector('button').addEventListener('click', function() { this.parentElement.remove(); });
            document.getElementById(containerId).appendChild(div);
        }
        function getIOCLData(containerId) {
            const rows = document.querySelectorAll(`#${containerId} .iocl-row`);
            const results = [];
            rows.forEach(r => { results.push({name: r.querySelector('.iocl-name').value, added_by: currentUser.name, added_at: getNow()}); });
            return results;
        }
        function renderIOCLTable() {
            const t = document.querySelector('#table-iocl-display tbody');
            t.innerHTML = currentPermitIOCLData.map(x => `<tr><td>${x.name}</td><td>${x.added_by}</td></tr>`).join('');
            if(currentPermitIOCLData.length) document.getElementById("iocl-sup-display-section").classList.remove('hidden');
        }

        async function downloadSecurePDF(id) {
             try {
                 const res = await fetch(`${API}/download-pdf/${id}`, { headers: {'Authorization': `Bearer ${authToken}`} });
                 if(!res.ok) throw new Error("Err");
                 const blob = await res.blob();
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a'); a.href = url; a.download = `${id}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
             } catch(e) { alert("Download Failed"); }
        }
        async function downloadSecureExcel() {
             try {
                 const res = await fetch(`${API}/download-excel`, { headers: {'Authorization': `Bearer ${authToken}`} });
                 if(!res.ok) throw new Error("Err");
                 const blob = await res.blob();
                 const url = window.URL.createObjectURL(blob);
                 const a = document.createElement('a'); a.href = url; a.download = "Permits.xlsx"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
             } catch(e) { alert("Download Failed"); }
        }
        window.viewSecurePhoto = async function(fullUrl) {
            if (!fullUrl) return alert("No photo URL found");
            const filename = fullUrl.split('/').pop();
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(`${API}/view-photo/${filename}`, { method: 'GET', headers: {'Authorization': `Bearer ${authToken}`} });
                if (res.status === 401) { alert("Session expired."); location.reload(); return; }
                if (!res.ok) throw new Error("Could not load photo");
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
                setTimeout(() => window.URL.revokeObjectURL(url), 60000);
            } catch (e) { alert("Failed to load photo"); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function checkDate() { 
             const vf=new Date(document.getElementById("ValidFrom").value); 
             const vt=new Date(document.getElementById("ValidTo").value); 
             if(vf && vt) { 
                 if(vt <= vf) { alert("End time error"); document.getElementById("ValidTo").value=""; } 
                 if((vt-vf)/(1000*60*60*24) > 7) { alert("Max 7 Days"); document.getElementById("ValidTo").value=""; } 
             } 
        }
        function isOddHour(dateObj) { const h = dateObj.getHours(); return (h >= 18 || h < 6); }
        function checkRenewalTime() {
            const fVal = document.getElementById("RenewalValidFrom").value;
            const tVal = document.getElementById("RenewalValidTo").value;
            const div = document.getElementById("odd-hour-agreement");
            if(fVal && tVal) {
                const d1 = new Date(fVal); const d2 = new Date(tVal);
                if(isOddHour(d1) || isOddHour(d2)) div.classList.remove('hidden');
                else { div.classList.add('hidden'); document.getElementById("OddHourSafetyCheck").checked = false; }
            }
        }
        function toggleRenewalApproveBtn() {
             const chk = document.getElementById("odd-hour-allow-check");
             const btn = document.getElementById("btn-approve-renewal");
             if(btn) btn.disabled = !chk.checked;
        }
        
        async function submitRenewal(act) {
            const getVal = (id) => document.getElementById(id).value;
            const fd = new FormData();
            fd.append('PermitID', currentPermitId);
            fd.append('action', act);
            fd.append('RenewalValidFrom', getVal("RenewalValidFrom"));
            fd.append('RenewalValidTo', getVal("RenewalValidTo"));
            fd.append('hc', getVal("RenewalHC"));
            fd.append('toxic', getVal("RenewalToxic"));
            fd.append('oxygen', getVal("RenewalOxygen"));
            fd.append('precautions', getVal("RenewalPrec"));
            fd.append('rejectionReason', getVal("RenewalRemark"));
            const selWorkers = []; 
            document.querySelectorAll('.ren-worker-cb:checked').forEach(c => selWorkers.push(c.value)); 
            fd.append('renewalWorkers', JSON.stringify(selWorkers));
            if(!document.getElementById("odd-hour-agreement").classList.contains("hidden")) {
                 if(currentUser.Role === 'Requester' && !document.getElementById("OddHourSafetyCheck").checked) return alert("Agree to Odd Hour Safety");
                 fd.append('oddHourReq', 'Y');
            }
            if(currentUser.Role === 'Requester') {
                const fileInput = document.getElementById("ren-cam-sub");
                const isPhotoMandatory = (currentRenewalCount > 0 && permitRequirePhoto);
                if(isPhotoMandatory && fileInput.files.length === 0) return alert("MANDATORY Photo required");
                if(fileInput.files.length > 0) fd.append('RenewalImage', fileInput.files[0]);
            }
            const res = await fetch(API+'/renewal', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Done"); showDashboard(); } else alert(json.error);
        }

        function showAddUser() { document.getElementById("view-add-user").classList.remove('hidden'); }
        async function submitNewUser() {
            const body = {
                name: document.getElementById("new-user-name").value,
                email: document.getElementById("new-user-email").value,
                role: document.getElementById("new-user-role").value,
                password: document.getElementById("new-user-pass").value
            };
            const res = await apiCall('/add-user', 'POST', body);
            if(res.success) { alert("User Added"); document.getElementById("view-add-user").classList.add('hidden'); }
        }

        function showDashboard() {
             document.getElementById("view-form").classList.add('hidden');
             document.getElementById("view-map").classList.add('hidden');
             document.getElementById("view-dashboard").classList.remove('hidden');
             loadDashboard();
        }

        async function loadStats() {
             const res=await apiCall('/stats','POST');
             if(chartS)chartS.destroy();
             chartS=new Chart(document.getElementById('chartStatus'),{type:'doughnut',data:{labels:Object.keys(res.statusCounts),datasets:[{data:Object.values(res.statusCounts)}]}});
             if(chartT)chartT.destroy();
             chartT=new Chart(document.getElementById('chartType'),{type:'bar',data:{labels:Object.keys(res.typeCounts),datasets:[{label:'Types',data:Object.values(res.typeCounts)}]}});
        }
    </script>
</body>
</html>
