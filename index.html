<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU" async></script>

    <style nonce="NONCE_PLACEHOLDER">
        /* --- GLOBAL & LAYOUT STYLES --- */
        body { 
            background-color: #f3f4f6; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; 
            margin: 0; padding: 0;
        }

        /* UTILITIES */
        .hidden { display: none !important; }
        .glass { 
            background: white; padding: 1.5rem; border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1.5rem; 
            border: 1px solid #e5e7eb; 
        }
        
        /* INPUTS */
        input, select, textarea { 
            width: 100%; border: 1px solid #d1d5db !important; padding: 10px 12px; 
            border-radius: 8px; font-size: 0.9rem; background: #fff; margin-bottom: 0.5rem; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #ea580c !important; outline: none; box-shadow: 0 0 0 2px #fdba74; 
        }
        input:disabled, select:disabled, textarea:disabled { 
            background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb !important; 
        }

        /* LOADER */
        .loader-overlay { 
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000; 
            display: none; justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { 
            border: 5px solid #f3f3f3; border-top: 5px solid #ea580c; border-radius: 50%; 
            width: 60px; height: 60px; animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SANDWICH LAYOUT */
        #main-wrapper { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar-left { 
            width: 260px; background: #1e293b; color: white; display: flex; 
            flex-direction: column; flex-shrink: 0; transition: 0.3s; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 40;
        }
        
        .sidebar-right { 
            width: 320px; background: white; border-left: 1px solid #e5e7eb; 
            overflow-y: auto; flex-shrink: 0; padding: 1.5rem; 
            display: flex; flex-direction: column; gap: 20px; z-index: 30;
        } 

        .content-area { 
            flex-grow: 1; overflow-y: auto; padding: 2rem; 
            background: #f8fafc; position: relative; scroll-behavior: smooth;
        }

        /* GRID & TABLES */
        .checklist-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        
        /* Mobile & Responsive */
        @media(max-width: 1280px) { .checklist-grid { grid-template-columns: repeat(2, 1fr); } }
        @media(max-width: 1024px) { 
            .sidebar-right { display: none; } 
            .checklist-grid { grid-template-columns: 1fr; }
        }
        @media(max-width: 768px) { 
            .sidebar-left { position: absolute; left: -260px; height: 100%; }
            .sidebar-left.open { left: 0; }
            .checklist-grid { grid-template-columns: 1fr; }
            .mobile-table th { display: none; }
            .mobile-table td { display: block; width: 100%; border: none; padding: 4px 8px; }
            .mobile-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        }

        /* TABLE STYLES */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 700; padding: 0.75rem; text-align: left; font-size: 0.8rem; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; vertical-align: middle; }
        .data-table tr:hover { background: #f8fafc; cursor: pointer; }

        .marked-deleted { text-decoration: line-through; opacity: 0.6; background-color: #fee2e2; }
        .nav-item { padding: 1rem 1.25rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #94a3b8; transition: all 0.2s; border-left: 4px solid transparent; font-weight: 500; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #0f172a; color: white; border-left-color: #ea580c; }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="mt-6 font-bold text-orange-600 animate-pulse text-xl">Processing...</div>
    </div>

    <div id="view-login" class="fixed inset-0 bg-orange-50 z-50 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md shadow-2xl border-t-4 border-orange-600 p-8">
            <div class="text-center mb-6">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <img src="/public/logo.png" class="h-16 object-contain">
                    <img src="/public/rhino.png" class="h-16 object-contain">
                </div>
                <h1 class="text-3xl font-extrabold text-orange-600">IndianOil</h1>
                <p class="text-gray-500 font-semibold mt-2">Mainline Permit System</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">1. Region</label>
                        <select id="login-region" class="w-full"><option value="">Loading Regions...</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">2. Unit</label>
                        <select id="login-unit" class="w-full" disabled><option value="">Select Region First</option></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">3. Location</label>
                        <select id="login-loc" class="w-full" disabled><option value="">Select Unit First</option></select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">4. Role</label>
                        <select id="login-role" class="w-full">
                            <option value="Requester">Requester</option>
                            <option value="Reviewer">Reviewer</option>
                            <option value="Approver">Approver</option>
                            <option value="MasterAdmin">MasterAdmin</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">5. User</label>
                        <select id="login-user" class="w-full" disabled><option value="">Select Location & Role</option></select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Password</label>
                    <input type="password" id="login-pass" class="w-full" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full bg-orange-600 text-white py-3.5 rounded-lg font-bold text-lg shadow-lg hover:bg-orange-700">Secure Login</button>
            </form>
        </div>
    </div>

    <div id="view-pwd-change" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center hidden">
        <div class="glass w-full max-w-sm border-l-8 border-red-600 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-red-600">Password Update</h3>
                <button onclick="document.getElementById('view-pwd-change').classList.add('hidden')" class="text-gray-500 font-bold" id="btn-close-pwd-modal">‚úï</button>
            </div>
            <input type="password" id="new-pwd-1" placeholder="New Password" class="mb-4">
            <input type="password" id="new-pwd-2" placeholder="Confirm Password" class="mb-6">
            <button id="btn-force-pwd" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-md">Update</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="main-wrapper">
            
            <div class="sidebar-left" id="sidebar">
                <div class="p-6 font-bold text-xl text-orange-500 border-b border-gray-700 flex items-center gap-3 bg-gray-900">
                    <img src="/public/rhino.png" class="h-8 w-8 bg-white rounded-full p-1"> <span>ERPL Permit</span>
                </div>
                <div id="user-display" class="p-5 text-xs text-gray-300 bg-gray-800 border-b border-gray-700 font-mono leading-relaxed"></div>
                <nav class="flex-1 overflow-y-auto mt-4 space-y-1 px-3">
                    <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard"><span>üìä</span> Dashboard</div>
                    <div class="nav-item hidden" onclick="switchView('new-permit')" id="nav-new-permit"><span>üìù</span> Create Permit</div>
                    <div class="nav-item" onclick="switchView('workers')" id="nav-workers"><span>üë∑</span> Workers</div>
                    <div class="nav-item hidden" id="nav-users" onclick="switchView('users')"><span>üë•</span> User Mgmt</div>
                    <div class="nav-item hidden" onclick="switchView('map')" id="nav-map"><span>üó∫Ô∏è</span> Map View</div>
                    <div class="nav-item hidden" id="nav-admin" onclick="switchView('admin')"><span>üîê</span> Admin Console</div>
                </nav>
                <div class="p-4 border-t border-gray-700 bg-gray-900 flex flex-col gap-2">
                    <div class="nav-item text-blue-400 hover:bg-blue-900/30 rounded justify-center" onclick="showChangePassword()"><span>üîë</span> Change Pwd</div>
                    <div class="nav-item text-red-400 hover:bg-red-900/30 rounded justify-center" onclick="logout()"><span>üö™</span> Sign Out</div>
                </div>
            </div>

            <div class="content-area">
                <button class="md:hidden mb-4 text-gray-600 bg-white p-2 rounded shadow" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞ Menu</button>
                
                <div id="view-dashboard">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <button id="dash-btn-new" onclick="switchView('new-permit')" class="hidden bg-orange-600 text-white px-4 py-2 rounded shadow font-bold">+ New Permit</button>
                    </div>
                    <div id="dashboard-content" class="space-y-6">
                        <h3 class="font-bold text-xs uppercase text-gray-500">Action Required</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-pending"><thead class="bg-red-50 text-red-900 border-b border-red-200"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                        
                        <h3 class="font-bold text-xs uppercase text-gray-500">Active Permits</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-active"><thead class="bg-green-50 text-green-900 border-b border-green-200"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                        
                        <h3 class="font-bold text-xs uppercase text-gray-500">Closed / Archive</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-other"><thead class="bg-gray-50 text-gray-700"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                    </div>
                </div>

                <div id="view-form" class="hidden">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50/95 backdrop-blur z-20 py-2 border-b">
                        <button onclick="switchView('dashboard')" class="text-blue-600 font-bold">‚Üê Back</button>
                        <div class="text-right">
                            <h2 class="text-xl font-bold text-gray-800" id="permit-title">New Permit</h2>
                            <div id="permit-header-display" class="text-xs text-blue-600 font-bold"></div>
                        </div>
                    </div>

                    <div id="permit-worker-audit-display" class="glass border-l-4 border-orange-500 mb-4 hidden">
                        <h3 class="font-bold border-b pb-2 mb-2 text-orange-800">Deployed Workers</h3>
                        <div id="assigned-worker-audit" class="overflow-x-auto"></div>
                    </div>

                    <form id="pf" class="max-w-7xl mx-auto space-y-4 pb-20">
                        <input type="hidden" id="PermitID" name="PermitID">
                        <input type="hidden" id="Status" name="Status">
                        
                        <div class="glass border-t-4 border-orange-500">
                            <h3 class="font-bold text-orange-600 border-b pb-2 mb-4">1. Basic Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                                <div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Location (GPS)</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1" placeholder="Coords"><button type="button" id="btn-get-geo" class="bg-blue-100 text-blue-700 px-3 rounded font-bold">üìç GPS</button></div><input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude"></div>
                                <div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail" id="WorkLocationDetail"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Region/Unit/Location</label><input name="LocationUnit" id="LocationUnit" readonly class="bg-gray-100"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom"></div>
                                <div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo"></div>
                                <div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly class="bg-gray-100"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName" class="bg-white"></div>
                                
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept" id="IssuedToDept"></div>
                                <div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard" id="SecurityGuard"></div>
                                <div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact" id="EmergencyContact"></div>
                                <div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation" id="FireStation"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" id="Desc" rows="2"></textarea></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                            </div>
                        </div>

                        <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50">
                            <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                                <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" class="w-5 h-5"> Request 1st Renewal with Permit
                            </label>
                            <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                                    <label class="block text-xs font-bold">Renewal From <input type="datetime-local" name="InitRenFrom" id="InitRenFrom"></label>
                                    <label class="block text-xs font-bold">Renewal To <input type="datetime-local" name="InitRenTo" id="InitRenTo"></label>
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="InitRenHC" id="InitRenHC" placeholder="HC % (Auto)" readonly class="bg-gray-100">
                                    <input name="InitRenTox" id="InitRenTox" placeholder="Tox (Auto)" readonly class="bg-gray-100">
                                    <input name="InitRenO2" id="InitRenO2" placeholder="O2 % (Auto)" readonly class="bg-gray-100">
                                </div>
                                <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                                <p class="text-[10px] text-gray-500 mt-1">*Gas values auto-sync from Section A. 12</p>
                            </div>
                        </div>

                        <div id="checklists-container" class="space-y-4"></div>

                        <div class="glass border-t-4 border-blue-500">
                            <h3 class="font-bold text-blue-600 border-b pb-2 mb-4">3. Workers</h3>
                            <div id="worker-select-area" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2"></div>
                            <div id="worker-display-table" class="hidden overflow-x-auto mt-2">
                                <table class="mobile-table w-full text-xs text-left"><thead class="bg-gray-100"><tr><th>Name</th><th>ID</th><th>Contact</th></tr></thead><tbody id="worker-display-body"></tbody></table>
                            </div>
                        </div>

                        <div class="glass border-t-4 border-red-500">
                            <h3 class="font-bold text-red-600 border-b pb-2 mb-4">4. Hazards & PPE</h3>
                            <div id="hazards-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                            <div id="other-hazard-div" class="hidden mb-2"><input id="H_Others_Detail" name="H_Others_Detail" placeholder="Specify other hazards..." class="w-full"></div>
                            <div id="ppe-section-wrapper" class="hidden">
                                <h4 class="font-bold text-gray-500 text-xs uppercase mb-2">PPE Required (Reviewer)</h4>
                                <div id="ppe-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500">
                            <h3 class="font-bold text-yellow-700 border-b pb-2 mb-4">4. Reviewer</h3>
                            <div class="mb-4 hidden" id="iocl-reviewer-wrapper">
                                <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div>
                                <button type="button" id="btn-add-rev-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
                            </div>
                            <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea>
                            <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea>
                        </div>

                        <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                            <h3 class="font-bold text-green-700 border-b pb-2 mb-4">5. Approval</h3>
                            <div class="mb-4 hidden" id="iocl-approver-wrapper">
                                <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-app" class="space-y-2 mt-2"></div>
                                <button type="button" id="btn-add-app-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
                            </div>
                            <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2"></textarea>
                            <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer">
                                <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600">
                                <span class="text-sm font-bold text-green-800">Require Photo Evidence for ALL Renewals?</span>
                            </label>
                            <div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div>
                        </div>

                        <div id="iocl-sup-display-section" class="glass hidden">
                            <h3 class="font-bold border-b pb-2 mb-2">Authorized Supervisors (IOCL)</h3>
                            <table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit Trail</th></tr></thead><tbody></tbody></table>
                        </div>

                        <div id="renewals-section" class="glass hidden border-l-4 border-purple-500 bg-purple-50/20">
                            <h3 class="font-bold text-purple-700 border-b pb-2 mb-4">üìÖ Renewal History</h3>
                            <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse">
                                <h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Request Action</h4>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer font-bold text-green-700"><input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Recommend / Approve Renewal</label>
                                    <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700"><input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal Only</label>
                                </div>
                            </div>
                            <div class="overflow-x-auto mb-4 bg-white rounded shadow-sm border">
                                <table class="mobile-table w-full text-xs text-left data-table" id="table-renewals"><thead class="bg-purple-100"><tr><th>Period</th><th>Gas/Prec</th><th>Workers</th><th>Photo</th><th>Requester</th><th>Status</th></tr></thead><tbody id="renewal-history-body"></tbody></table>
                            </div>
                            <div id="form-renewal" class="hidden bg-white p-4 rounded border border-purple-200 shadow-sm">
                                <h4 class="font-bold text-sm mb-2 text-purple-800">New Renewal Request</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-2">
                                    <input type="datetime-local" id="RenewalValidFrom">
                                    <input type="datetime-local" id="RenewalValidTo">
                                    <input id="RenewalHC" placeholder="HC %">
                                    <input id="RenewalOxygen" placeholder="O2 %">
                                </div>
                                <input id="RenewalPrec" placeholder="Specific Precautions for this shift" class="mb-2">
                                <div id="odd-hour-agreement" class="hidden mb-2 p-2 bg-indigo-50 border border-indigo-200 rounded">
                                    <label class="flex items-start gap-2 cursor-pointer">
                                        <input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-600">
                                        <span class="text-xs font-bold text-indigo-900">I agree to ensure proper lighting and safety for odd-hour work.</span>
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Select Workers</label>
                                    <div class="bg-gray-50 p-2 rounded border max-h-32 overflow-y-auto grid grid-cols-2 gap-2" id="renewal-worker-select"></div>
                                </div>
                                <div id="renewal-photo-wrapper" class="hidden mb-2 p-2 bg-red-50 border border-red-200 rounded">
                                    <label class="block text-xs font-bold text-red-700 uppercase mb-1">üì∏ Mandatory Site Photo</label>
                                    <input type="file" id="ren-cam-sub" accept="image/*" capture="environment" class="w-full text-sm bg-white border p-1 rounded">
                                    <p class="text-[10px] text-red-500 mt-1" id="photo-mandate-msg">Required by Approver.</p>
                                </div>
                                <button type="button" onclick="submitRenewal('pending_review')" class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow hover:bg-purple-700">Submit Request</button>
                            </div>
                            <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded border border-yellow-200">
                                <textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" id="btn-approve-renewal" class="bg-green-600 text-white py-2 rounded font-bold shadow">Approve</button>
                                    <button type="button" id="btn-reject-renewal" class="bg-red-600 text-white py-2 rounded font-bold shadow">Reject</button>
                                </div>
                            </div>
                        </div>

                        <div id="closure-section" class="glass hidden border-l-4 border-gray-600">
                            <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">Closure</h3>
                            <label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-3 bg-red-50 rounded border border-red-100 cursor-pointer">
                                <input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5 accent-red-600"> I confirm Site is Restored.
                            </label>
                            <div id="div-closure-req" class="hidden space-y-2">
                                <label class="text-xs font-bold text-gray-500">Requester Remarks</label>
                                <textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-req" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-rev" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Reviewer Remarks</label>
                                <textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-rev" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-app" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Approver Remarks</label>
                                <textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-app" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                        </div>

                        <div class="glass" id="section-e">
                            <h3 class="font-bold text-gray-600 border-b pb-2 mb-4">E. References</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No"><input name="JsaNo" id="JsaNo" placeholder="JSA No">
                                <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip"><input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                                <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No"><input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"> 
                            </div>
                        </div>

                        <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50">
                            <label class="flex items-start gap-3 p-2 cursor-pointer">
                                <input type="checkbox" id="gsr-check" name="GSR_Check_Box" class="mt-1 w-6 h-6 text-orange-600 rounded focus:ring-orange-500 shrink-0">
                                <span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules.</span>
                            </label>
                        </div>
                        
                        <div id="signature-history" class="glass hidden">
                            <h3 class="font-bold mb-2">History</h3>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div>
                            </div>
                        </div>

                        <div id="actions-bar" class="flex flex-col md:flex-row justify-end gap-3 bg-white p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] border-t sticky bottom-0 z-40 rounded-t-lg"></div>
                    </form>
                </div>

                <div id="view-workers" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Worker Management</h2>
                        <button onclick="openWorkerModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-bold">+ Add Worker</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-workers"><thead class="bg-gray-100"><tr><th>Name</th><th>ID</th><th>Role</th><th>Status</th><th>Approval Info</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>

                <div id="view-users" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                        <button onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="bg-purple-600 text-white px-4 py-2 rounded shadow font-bold">+ Add User</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-manage-users"><thead class="bg-gray-100"><tr><th>Name</th><th>Email</th><th>Role</th><th>Location</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>

                <div id="view-admin" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Master Admin Console</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass border-t-4 border-green-600">
                             <h3 class="font-bold text-lg mb-2 text-green-800">üë§ Add Single User</h3>
                             <p class="text-xs text-gray-500 mb-4 bg-green-50 p-2 rounded">Create a single user manually.</p>
                             <button onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">+ Create User</button>
                        </div>
                        <div class="glass border-t-4 border-purple-600">
                            <h3 class="font-bold text-lg mb-2 text-purple-800">üìÇ Bulk User Upload</h3>
                            <p class="text-xs text-gray-500 mb-4 bg-purple-50 p-2 rounded">Upload Excel (.xlsx).</p>
                            <input type="file" id="bulk-excel" accept=".xlsx" class="mb-4 w-full">
                            <button onclick="uploadBulkUsers()" class="w-full bg-purple-600 text-white py-2 rounded font-bold">Upload & Map</button>
                        </div>
                        <div class="glass border-t-4 border-red-600">
                            <h3 class="font-bold text-lg mb-2 text-red-800">üîë Global Reset Password</h3>
                            <input id="reset-email" placeholder="User Email" class="mb-2 w-full">
                            <input id="reset-temp-pass" placeholder="Temp Password" class="mb-2 w-full">
                            <button onclick="resetUserPassword()" class="w-full bg-red-600 text-white py-2 rounded font-bold">Reset Password</button>
                        </div>
                    </div>
                </div>

                <div id="view-map" class="hidden h-full">
                    <h2 class="text-2xl font-bold mb-4">Live Permit Map</h2>
                    <div class="glass h-[600px] w-full p-0 overflow-hidden shadow-inner border-2 border-gray-200 relative"><div id="map" class="w-full h-full"></div></div>
                </div>
            </div>

            <div class="sidebar-right">
                <div class="mb-6" id="charts-container">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Live Stats</h3>
                    <div class="h-40"><canvas id="chartStatus"></canvas></div>
                </div>
                <div id="validity-box" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm text-center">
                    <div class="text-xs font-bold text-green-800 uppercase mb-1">Permit Validity</div>
                    <div id="val-time-from" class="text-sm font-mono text-gray-700 font-bold"></div>
                    <div class="text-center text-gray-400 text-xs my-1">‚¨á</div>
                    <div id="val-time-to" class="text-sm font-mono text-gray-700 font-bold"></div>
                    <div id="val-status" class="mt-2 inline-block px-3 py-1 rounded-full bg-green-200 text-green-800 text-xs font-bold">ACTIVE</div>
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Selection Info</h3>
                    <div id="right-panel-info" class="text-sm text-gray-500 italic bg-gray-50 p-3 rounded border">Select permit to view details.</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-worker" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg relative animate-scale-up">
            <button onclick="document.getElementById('modal-worker').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold text-lg mb-4">Worker Details</h3>
            <form id="worker-form-real" class="grid grid-cols-2 gap-3">
                <input id="w-id" type="hidden">
                <input id="w-name" placeholder="Full Name" class="col-span-2" required>
                <input id="w-father" placeholder="Father Name" class="col-span-2" required>
                <input id="w-address" placeholder="Address" class="col-span-2">
                <input id="w-age" placeholder="Age" type="number" required>
                <select id="w-gender"><option>Male</option><option>Female</option></select>
                <input id="w-contact" placeholder="Contact No">
                <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Other</option></select>
                <input id="w-id-type-other" placeholder="Specify ID" class="hidden col-span-2 bg-yellow-50">
                <input id="w-idcard" placeholder="ID Number" class="col-span-2">
                <button type="submit" class="col-span-2 bg-blue-600 text-white py-3 rounded-lg font-bold shadow">Save Worker</button>
            </form>
        </div>
    </div>

    <div id="view-add-user" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-sm relative animate-scale-up">
            <button onclick="document.getElementById('view-add-user').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold mb-4 text-lg">Add New User</h3>
            <form id="adduser-form" class="space-y-3">
                <input id="new-user-name" placeholder="Full Name" required>
                <input id="new-user-email" placeholder="Email Address" required>
                <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                <input id="new-user-pass" type="password" placeholder="Initial Password" required>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button>
            </form>
        </div>
    </div>

    <script nonce="NONCE_PLACEHOLDER">
        const API = "/api";
        let authToken = null, currentUser = null;
        let mapInstance = null, chartS = null;
        let currentPermitId = null, currentPermitWorkers = [], currentRenewalCount = 0, permitRequirePhoto = false, currentPermitIOCLData = [];
        
        const CL_DATA = { 
            A: ["1. Equipment / Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test: HC / Toxic / O2", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."], 
            B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."], 
            C: ["1. PESO spark elimination."], 
            D: ["1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban."] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        async function apiCall(ep, meth="GET", body=null) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const opts = {method:meth, headers:{'Content-Type':'application/json'}, credentials:'include'};
                if(authToken) opts.headers['Authorization'] = `Bearer ${authToken}`;
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(API+ep, opts);
                if(res.status === 401) { location.reload(); return; }
                return await res.json();
            } catch(e) { console.error(e); return {error: "Network Error"}; }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val; }
        function getNow() { return new Date().toLocaleString("en-GB").replace(',',''); }

        async function initLogin() {
            const regions = await apiCall('/get-hierarchy', 'POST', {});
            const rSel = document.getElementById('login-region');
            rSel.innerHTML = `<option value="">Select Region</option>` + regions.map(r=>`<option>${r}</option>`).join('');
            
            rSel.addEventListener('change', async (e) => {
                const uSel = document.getElementById('login-unit'); uSel.disabled=true; uSel.innerHTML='<option>Loading...</option>';
                const units = await apiCall('/get-hierarchy', 'POST', {region: e.target.value});
                uSel.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option>${u}</option>`).join('');
                uSel.disabled = false;
            });
            document.getElementById('login-unit').addEventListener('change', async (e) => {
                const lSel = document.getElementById('login-loc'); lSel.disabled=true; lSel.innerHTML='<option>Loading...</option>';
                const locs = await apiCall('/get-hierarchy', 'POST', {region: document.getElementById('login-region').value, unit: e.target.value});
                lSel.innerHTML = `<option value="">Select Location</option>` + locs.map(l=>`<option>${l}</option>`).join('');
                lSel.disabled = false;
            });
            const loadUsers = async () => {
                const reg = document.getElementById('login-region').value;
                const unit = document.getElementById('login-unit').value;
                const loc = document.getElementById('login-loc').value;
                const role = document.getElementById('login-role').value;
                if(reg && unit && loc && role) {
                    const uSel = document.getElementById('login-user'); uSel.innerHTML='<option>Loading...</option>';
                    const users = await apiCall('/get-users-by-loc', 'POST', {region:reg, unit:unit, location:loc, role:role});
                    uSel.innerHTML = users.map(u=>`<option value="${u.Email}">${u.Name}</option>`).join('');
                    uSel.disabled = false;
                }
            }
            document.getElementById('login-loc').addEventListener('change', loadUsers);
            document.getElementById('login-role').addEventListener('change', loadUsers);
            
            // REQ C: 1st Renewal Toggle
            document.getElementById('chk-init-renewal').addEventListener('change', (e) => {
                document.getElementById('div-init-renewal').classList.toggle('hidden', !e.target.checked);
            });
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const res = await apiCall('/login', 'POST', {email, password: pass});
            if(res.forceChange) {
                document.getElementById('view-pwd-change').classList.remove('hidden');
                document.getElementById('view-pwd-change').dataset.email = res.email;
            } else if(res.success) {
                authToken = res.token; currentUser = res.user; enterApp();
            } else { alert(res.msg); }
        });

        document.getElementById('btn-force-pwd').addEventListener('click', async () => {
            const p1 = document.getElementById('new-pwd-1').value; const p2 = document.getElementById('new-pwd-2').value;
            const email = document.getElementById('view-pwd-change').dataset.email;
            if(p1 !== p2) return alert("Passwords do not match");
            const res = await apiCall('/force-password-change', 'POST', {email, newPassword: p1});
            if(res.success) { alert("Updated. Please login."); location.reload(); }
        });
        
        document.getElementById('adduser-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                name: document.getElementById("new-user-name").value,
                email: document.getElementById("new-user-email").value,
                role: document.getElementById("new-user-role").value,
                password: document.getElementById("new-user-pass").value
            };
            const res = await apiCall('/add-user', 'POST', body);
            if(res.success) { alert("User Added"); document.getElementById('view-add-user').classList.add('hidden'); loadManageUsers(); } else alert(res.error);
        });

        function enterApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').innerHTML = `<div class="font-bold text-white text-lg">${currentUser.Name}</div><div class="text-orange-400 font-bold uppercase text-xs">${currentUser.Role}</div><div class="text-xs mt-1 text-gray-500 font-mono">${currentUser.Location}</div>`;
            
            if(currentUser.Role === 'Requester') document.getElementById('nav-new-permit').classList.remove('hidden');
            if(currentUser.Role === 'MasterAdmin') document.getElementById('nav-admin').classList.remove('hidden');
            if(currentUser.Role === 'Approver' || currentUser.Role === 'MasterAdmin') document.getElementById('nav-users').classList.remove('hidden');
            if(currentUser.Role !== 'Requester') document.getElementById('nav-map').classList.remove('hidden');
            
            renderChecklists(); renderHazards(); switchView('dashboard');
        }

        function showChangePassword() {
             document.getElementById('view-pwd-change').classList.remove('hidden');
             document.getElementById('view-pwd-change').dataset.email = currentUser.Email;
             document.querySelector('#view-pwd-change h3').innerText = "Change Password";
             document.querySelector('#view-pwd-change button').innerText = "Update Password";
        }
        document.getElementById('btn-close-pwd-modal').addEventListener('click', () => document.getElementById('view-pwd-change').classList.add('hidden'));

        function switchView(viewName) {
            document.querySelectorAll('.content-area > div').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const viewMap = {'dashboard': 'view-dashboard', 'new-permit': 'view-form', 'workers': 'view-workers', 'users': 'view-users', 'map': 'view-map', 'admin': 'view-admin'};
            
            if(document.getElementById(viewMap[viewName])) {
                document.getElementById(viewMap[viewName]).classList.remove('hidden');
                let navId = 'nav-' + viewName;
                if(viewName === 'dashboard') navId = 'nav-dashboard';
                const navItem = document.getElementById(navId) || document.querySelector(`.nav-item[onclick*="${viewName}"]`);
                if(navItem) navItem.classList.add('active');
            }
            
            if(viewName === 'dashboard') loadDashboard();
            if(viewName === 'new-permit') { 
                showNewPermit();
                loadMappedApprovers();
            }
            if(viewName === 'users') loadManageUsers();
            if(viewName === 'workers') loadWorkers('mgmt');
        }

        async function loadMappedApprovers() {
            const reviewers = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: 'Reviewer' });
            const approvers = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: 'Approver' });
            
            const rSel = document.getElementById("ReviewerEmail"); rSel.innerHTML = "";
            reviewers.forEach(u => rSel.innerHTML += `<option value="${u.Email}">${u.Name}</option>`);
            
            const aSel = document.getElementById("ApproverEmail"); aSel.innerHTML = "";
            approvers.forEach(u => aSel.innerHTML += `<option value="${u.Email}">${u.Name}</option>`);
        }

        function renderChecklists() {
            const container = document.getElementById('checklists-container'); container.innerHTML = '';
            Object.keys(CL_DATA).forEach(sec => {
                let itemsHtml = CL_DATA[sec].map((item, i) => {
                    let extraFields = `<input class="w-full text-xs border-b mt-1" placeholder="Remarks" name="${sec}_${i}_Rem">`;
                    if (sec === 'A' && i === 11) {
                        // REQ C: Added specific IDs for auto-sync
                         extraFields = `<div class="grid grid-cols-3 gap-2 mt-2">
                             <input name="GP_Q12_HC" id="GP_Q12_HC" placeholder="HC % LEL" onkeyup="syncGasToRenewal()">
                             <input name="GP_Q12_ToxicGas" id="GP_Q12_ToxicGas" placeholder="Toxic PPM" onkeyup="syncGasToRenewal()">
                             <input name="GP_Q12_Oxygen" id="GP_Q12_Oxygen" placeholder="O2 %" onkeyup="syncGasToRenewal()">
                          </div>`;
                    }
                    return `<div class="p-3 border rounded-lg bg-gray-50 text-xs hover:shadow-md transition">
                        <p class="mb-2 font-semibold text-gray-700 min-h-[30px]">${item}</p>
                        <div class="flex gap-2 justify-center">
                            <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="${sec}_${i}" value="Y" checked class="accent-green-600"> Y</label>
                            <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="${sec}_${i}" value="N" class="accent-red-600"> N</label>
                            <label class="cursor-pointer flex items-center gap-1"><input type="radio" name="${sec}_${i}" value="NA" class="accent-gray-600"> NA</label>
                        </div>
                        ${extraFields}
                    </div>`;
                }).join('');

                container.innerHTML += `<div class="glass border-t-4 border-gray-400">
                    <div class="flex justify-between items-center border-b pb-2 mb-4 bg-gray-50 p-2 rounded">
                        <h4 class="font-bold text-gray-700">Section ${sec} Checks</h4>
                        <div class="flex gap-2 text-xs">
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="Y" class="sec-toggle" data-sec="${sec}"> All Yes</label>
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="N" class="sec-toggle" data-sec="${sec}"> All No</label>
                            <label class="cursor-pointer font-bold"><input type="radio" name="Master_${sec}" value="NA" class="sec-toggle" data-sec="${sec}"> All NA</label>
                        </div>
                    </div>
                    <div class="checklist-grid">${itemsHtml}</div>
                </div>`;
            });
            document.querySelectorAll('.sec-toggle').forEach(el => {
                el.addEventListener('change', (e) => {
                    const sec = e.target.dataset.sec; const val = e.target.value;
                    document.querySelectorAll(`input[name^="${sec}_"]`).forEach(rb => { if(rb.value === val) rb.checked = true; });
                });
            });
        }
        
        // REQ C: Auto-sync logic
        window.syncGasToRenewal = function() {
            if(document.getElementById('chk-init-renewal').checked) {
                safeSet('InitRenHC', getVal('GP_Q12_HC'));
                safeSet('InitRenTox', getVal('GP_Q12_ToxicGas'));
                safeSet('InitRenO2', getVal('GP_Q12_Oxygen'));
            }
        }
        
        function safeSet(id, val) { 
            const el = document.getElementById(id); 
            if(el) el.value = val; 
        }

        function renderHazards() {
            document.getElementById('hazards-grid').innerHTML = HAZARDS.map(h => `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-orange-100 transition shadow-sm font-bold text-gray-700"><input type="checkbox" name="H_${h.replace(/ /g,'')}" value="Y" ${h==='Others'?'id="chk-haz-others"':''} class="accent-orange-600 w-4 h-4"> ${h}</label>`).join('');
            document.getElementById('chk-haz-others')?.addEventListener('change', (e) => document.getElementById('other-hazard-div').classList.toggle('hidden', !e.target.checked));
            document.getElementById('ppe-grid').innerHTML = PPE.map(p => `<label class="flex items-center gap-2 p-3 border rounded-lg bg-gray-50 text-xs cursor-pointer hover:bg-blue-100 transition shadow-sm font-bold text-gray-700"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y" class="accent-blue-600 w-4 h-4"> ${p}</label>`).join('');
            document.getElementById('w-id-type').addEventListener('change', (e) => document.getElementById('w-id-type-other').classList.toggle('hidden', e.target.value !== 'Other'));
        }

        function attachFileValidators() {
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', function() {
                    const file = this.files[0];
                    if(file && !file.type.startsWith('image/')) { alert("WARNING: Only Image files (JPG/PNG) are allowed."); this.value = ''; }
                });
            });
        }

        async function loadManageUsers() {
             const t = document.querySelector('#table-manage-users tbody'); t.innerHTML = '<tr><td colspan="5" class="p-4 text-center">Loading...</td></tr>';
             const roles = ['Requester', 'Reviewer', 'Approver'];
             let allUsers = [];
             for(let r of roles) {
                 const u = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: r });
                 if(Array.isArray(u)) allUsers = [...allUsers, ...u];
             }
             t.innerHTML = '';
             if(allUsers.length === 0) {
                 t.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No users found.</td></tr>`;
             } else {
                 allUsers.forEach(u => {
                     const delBtn = u.Email !== currentUser.Email ? `<button class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1 rounded font-bold text-xs" onclick="deleteUser('${u.Email}')">Delete</button>` : '-';
                     t.innerHTML += `<tr class="hover:bg-gray-50 transition border-b border-gray-100"><td class="p-3 font-bold text-gray-800">${u.Name}</td><td class="p-3 text-gray-600 font-mono text-xs">${u.Email}</td><td class="p-3"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold uppercase">${u.Role}</span></td><td class="p-3 text-gray-500 text-xs">${currentUser.Location}</td><td class="p-3">${delBtn}</td></tr>`;
                 });
             }
        }
        
        async function deleteUser(email) {
            if(!confirm("Are you sure you want to delete user " + email + "? This cannot be undone.")) return;
            const res = await apiCall('/delete-user', 'POST', {email: email});
            if(res.success) { alert("User deleted"); loadManageUsers(); } else { alert(res.error || "Delete failed"); }
        }

        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
            const container = document.getElementById('dashboard-content'); container.innerHTML = '';
            
            // REQ G: Ensure all statuses are caught
            const pending = res.filter(p => p.Status.includes('Pending') || p.Status === 'Submitted');
            const active = res.filter(p => p.Status === 'Active' || p.Status.includes('Renewal'));
            const closed = res.filter(p => p.Status.includes('Closed') || p.Status === 'Rejected');
            
            const renderTable = (title, items, color) => {
                if(items.length === 0) return '';
                return `
                    <div class="glass border-l-4 border-${color}-500 transform transition hover:shadow-lg">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <h3 class="font-bold text-${color}-700 uppercase text-sm tracking-wide flex items-center gap-2">${title}</h3>
                            <span class="bg-${color}-100 text-${color}-800 text-xs font-bold px-3 py-1 rounded-full border border-${color}-200">${items.length}</span>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-xs data-table"><thead><tr><th>ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody>${items.map(p => `<tr onclick="openPermit('${p.PermitID}')" class="group hover:bg-${color}-50 transition"><td class="font-bold text-blue-600 group-hover:underline">${p.PermitID}</td><td class="font-medium">${p.WorkType}</td><td class="text-gray-500">${p.LocationUnit}</td><td><span class="px-2 py-0.5 rounded bg-${color}-50 text-${color}-700 font-bold border border-${color}-200 text-[10px] uppercase">${p.Status}</span></td><td class="font-mono text-gray-500">${p.ValidFrom.split('T')[0]}</td></tr>`).join('')}</tbody></table></div>
                    </div>`;
            };
            container.innerHTML += renderTable('Action Required', pending, 'red');
            container.innerHTML += renderTable('Active Permits', active, 'green');
            container.innerHTML += renderTable('Closed / Archive', closed, 'gray');
            loadStats(res);
        }

        function showNewPermit() {
            document.getElementById("pf").reset();
            currentPermitId = null;
            document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => e.disabled = false);
            
            // REQ A: Requester Editable
            safeSet("RequesterName", currentUser.Name);
            safeSet("Vendor", currentUser.Name);
            document.getElementById("Vendor").readOnly = true;
            document.getElementById("RequesterName").readOnly = false; // Changed to false

            // REQ B: Auto-fill Region/Unit/Location
            const locString = `${currentUser.Region}/${currentUser.Unit}/${currentUser.Location}`;
            safeSet("LocationUnit", locString);

            // REQ C: Ensure 1st Renewal logic is reset
            document.getElementById("init-renewal-wrapper").classList.remove('hidden');
            document.getElementById("div-init-renewal").classList.add('hidden');

            const actionsDiv = document.getElementById("actions-bar"); 
            actionsDiv.innerHTML = "";
            const btn = document.createElement("button");
            btn.className = "w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700";
            btn.innerText = "Submit Application"; 
            btn.type = "button"; 
            btn.onclick = savePermit;
            actionsDiv.appendChild(btn);
            
            loadWorkers('permit_dropdown');
        }

        async function openPermit(id) {
            const p = await apiCall('/permit-data', 'POST', {permitId:id});
            currentPermitId = id; currentPermitIOCLData = p.IOCLSupervisors || []; permitRequirePhoto = (p.RequireRenewalPhotos === 'Y');
            document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-form').classList.remove('hidden');
            document.getElementById('permit-title').innerText = `Permit: ${id}`;
            document.getElementById('permit-header-display').innerText = `Status: ${p.Status}`;
            
            if(currentUser.Role === 'Requester') document.getElementById('ppe-section-wrapper').classList.add('hidden');
            else document.getElementById('ppe-section-wrapper').classList.remove('hidden');
            
            document.querySelectorAll('#pf input, #pf textarea, #pf select').forEach(el => {
                if(el.type === 'checkbox') el.checked = (p[el.name] === 'Y'); else if(el.type !== 'file') el.value = p[el.name] || ''; el.disabled = true;
            });

            document.getElementById('validity-box').classList.remove('hidden');
            document.getElementById('val-time-from').innerText = p.ValidFrom.replace('T', ' '); document.getElementById('val-time-to').innerText = p.ValidTo.replace('T', ' ');
            document.getElementById('val-status').innerText = p.Status.toUpperCase();

            currentPermitWorkers = p.SelectedWorkers;
            const wTable = document.getElementById('worker-display-table'); wTable.classList.remove('hidden');
            wTable.querySelector('tbody').innerHTML = currentPermitWorkers.map(w => `<tr><td>${escapeHtml(w.Name)}</td><td>${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td><td>${escapeHtml(w.Contact)}</td></tr>`).join('');

            renderIOCLTable();

            const rens = JSON.parse(p.RenewalsJSON || "[]");
            const canRenew = (currentUser.Role === 'Requester' && (p.Status === 'Active' || p.Status.includes('Renewal')));
            
            if (rens.length > 0 || canRenew) {
                document.getElementById('renewals-section').classList.remove('hidden');
                document.getElementById('renewal-history-body').innerHTML = rens.map(r => `<tr class="border-b border-gray-100 hover:bg-purple-50"><td class="p-2 font-mono text-[10px]">${r.valid_from}<br>${r.valid_to}</td><td class="p-2">HC:${r.hc}% Tox:${r.toxic}</td><td class="p-2">${r.worker_list?.length || 0}</td><td class="p-2 text-center">${r.photoUrl ? 'üì∏' : '-'}</td><td class="p-2">${r.req_name}</td><td class="p-2 font-bold text-purple-700">${r.status}</td></tr>`).join('');
                if (canRenew) {
                    document.getElementById('form-renewal').classList.remove('hidden');
                    const renSel = document.getElementById('renewal-worker-select');
                    renSel.innerHTML = currentPermitWorkers.map(w => `<label class="flex items-center gap-1 text-xs bg-white p-1 rounded border"><input type="checkbox" value="${escapeHtml(w.Name)}" checked class="ren-worker-cb accent-purple-600"> ${escapeHtml(w.Name)}</label>`).join('');
                    if (permitRequirePhoto) {
                        document.getElementById('renewal-photo-wrapper').classList.remove('hidden'); document.getElementById('ren-cam-sub').required = true;
                    } else {
                        document.getElementById('renewal-photo-wrapper').classList.add('hidden'); document.getElementById('ren-cam-sub').required = false;
                    }
                } else document.getElementById('form-renewal').classList.add('hidden');
            } else document.getElementById('renewals-section').classList.add('hidden');

            const actionsDiv = document.getElementById("actions-bar"); actionsDiv.innerHTML = "";
            const lastRen = rens.length > 0 ? rens[rens.length-1] : null;

            if(currentUser.Role === 'Requester' && p.Status === 'New') {
                showNewPermit();
            }
            if(currentUser.Role === 'Reviewer' && p.Status === 'Pending Review') {
                document.getElementById('fs-reviewer-section').classList.remove('hidden'); document.getElementById('iocl-reviewer-wrapper').classList.remove('hidden');
                document.getElementById('Reviewer_Remarks').disabled = false; document.getElementById('AdditionalPrecautions').disabled = false;
                document.querySelectorAll('#ppe-grid input, .checklist-grid input, .checklist-grid input[type="radio"]').forEach(el => el.disabled = false);
                
                const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-2 rounded shadow font-bold"; b1.innerText = "Reject"; b1.onclick = () => upd('reject');
                const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-2 rounded shadow font-bold"; b2.innerText = "Review & Forward"; b2.onclick = () => upd('review');
                actionsDiv.append(b1, b2);
            }
            if(currentUser.Role === 'Approver' && p.Status === 'Pending Approval') {
                document.getElementById('fs-approver-section').classList.remove('hidden'); document.getElementById('iocl-approver-wrapper').classList.remove('hidden');
                document.getElementById('Approver_Remarks').disabled = false; document.getElementById('RequireRenewalPhotos').disabled = false;
                const b1 = document.createElement("button"); b1.className = "bg-red-600 text-white px-4 py-2 rounded shadow font-bold"; b1.innerText = "Reject"; b1.onclick = () => upd('reject');
                const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-2 rounded shadow font-bold"; b2.innerText = "Final Approve"; b2.onclick = () => upd('approve');
                actionsDiv.append(b1, b2);
            }
            
            if(lastRen && lastRen.status.includes('pending')) {
                if((currentUser.Role === 'Reviewer' && p.Status.includes('Review')) || (currentUser.Role === 'Approver' && p.Status.includes('Approval'))) {
                    document.getElementById('action-renewal').classList.remove('hidden');
                    document.getElementById('btn-approve-renewal').onclick = () => submitRenewal('approve');
                    document.getElementById('btn-reject-renewal').onclick = () => submitRenewal('reject');
                }
            }

            if(p.Status.includes('Closure')) {
                document.getElementById('closure-section').classList.remove('hidden');
                document.getElementById('div-closure-req').classList.remove('hidden');
                if(p.Status !== 'Closure Pending Review') document.getElementById('div-closure-rev').classList.remove('hidden');
                if(p.Status === 'Closed' || p.Status === 'Closure Pending Approval') document.getElementById('div-closure-app').classList.remove('hidden');

                if(currentUser.Role === 'Reviewer' && p.Status === 'Closure Pending Review') {
                    document.getElementById('Closure_Reviewer_Remarks').disabled = false;
                    const b2 = document.createElement("button"); b2.className = "bg-green-600 text-white px-4 py-2 rounded shadow font-bold"; b2.innerText = "Verify Closure"; b2.onclick = () => upd('approve_closure');
                    actionsDiv.appendChild(b2);
                }
                if(currentUser.Role === 'Approver' && p.Status === 'Closure Pending Approval') {
                    document.getElementById('Closure_Approver_Remarks').disabled = false;
                    const b2 = document.createElement("button"); b2.className = "bg-black text-white px-4 py-2 rounded shadow font-bold"; b2.innerText = "Close Permit"; b2.onclick = () => upd('approve');
                    actionsDiv.appendChild(b2);
                }
            }
            attachFileValidators();
        }

        async function submitRenewal(act) {
            if(act === 'approve' || act === 'reject') {
                const remark = document.getElementById('RenewalRemark').value;
                const res = await apiCall('/renewal', 'POST', {PermitID: currentPermitId, action: act, rejectionReason: remark});
                if(res.success) { alert("Action Taken"); switchView('dashboard'); } else alert(res.error);
                return;
            }
            const getVal = (id) => document.getElementById(id).value;
            const rStart = new Date(getVal("RenewalValidFrom"));
            const rEnd = new Date(getVal("RenewalValidTo"));
            
            // REQ F: Subsequent Renewal Validation
            // Need main permit dates. Since we are in openPermit context, we can read from DOM or use cached obj if available.
            // Using DOM reading for simplicity
            const mainStart = new Date(document.getElementById('val-time-from').innerText);
            const mainEnd = new Date(document.getElementById('val-time-to').innerText);

            if(rEnd <= rStart) return alert("Renewal End Time must be greater than Start Time.");
            if((rEnd - rStart) > 8 * 60 * 60 * 1000) return alert("Renewal cannot exceed 8 hours.");
            if(rStart < mainStart || rEnd > mainEnd) return alert("Renewal must be within original Permit Validity period.");

            const fd = new FormData();
            fd.append('PermitID', document.getElementById('PermitID').value);
            fd.append('action', 'initiate'); 
            fd.append('RenewalValidFrom', getVal("RenewalValidFrom"));
            fd.append('RenewalValidTo', getVal("RenewalValidTo"));
            fd.append('hc', getVal("RenewalHC")); fd.append('toxic', getVal("RenewalOxygen")); fd.append('oxygen', getVal("RenewalOxygen")); // Note: reused oxygen ID as placeholder in form
            fd.append('precautions', getVal("RenewalPrec"));
            
            const selWorkers = []; document.querySelectorAll('.ren-worker-cb:checked').forEach(c => selWorkers.push(c.value));
            fd.append('renewalWorkers', JSON.stringify(selWorkers));

            const fileInput = document.getElementById("ren-cam-sub");
            const isPhotoMandatory = !document.getElementById('renewal-photo-wrapper').classList.contains('hidden');
            
            if(isPhotoMandatory && fileInput.files.length === 0) {
                alert("‚õî MANDATORY: You must upload a site condition photo.");
                return;
            }
            if(fileInput.files.length > 0) fd.append('RenewalImage', fileInput.files[0]);

            const res = await fetch(API+'/renewal', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Renewal Request Submitted!"); switchView('dashboard'); } else alert(json.error);
        }

        function openWorkerModal() { 
            document.getElementById('worker-form-real').reset(); 
            window.currentWorkerAction = 'create';
            document.getElementById('modal-worker').classList.remove('hidden'); 
        }

        document.getElementById('worker-form-real').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idTypeRaw = document.getElementById("w-id-type").value;
            const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw;
            
            const body = {
                Action: window.currentWorkerAction,
                Role: currentUser.Role,
                RequestorEmail: currentUser.Email,
                RequestorName: currentUser.Name,
                WorkerID: document.getElementById('w-id').value,
                Details: {
                    Name: document.getElementById("w-name").value,
                    Age: document.getElementById("w-age").value,
                    Father: document.getElementById("w-father").value,
                    Address: document.getElementById("w-address").value,
                    Contact: document.getElementById("w-contact").value,
                    ID: document.getElementById("w-idcard").value,
                    Gender: document.getElementById("w-gender").value,
                    IDType: idTypeFinal
                }
            };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { 
                alert("Worker Saved Successfully"); 
                document.getElementById('modal-worker').classList.add('hidden'); 
                loadWorkers('mgmt'); 
            } else { alert(res.error); }
        });

        async function loadWorkers(context) { 
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:context}); 
            
            if(context === 'permit_dropdown') { 
                const con = document.getElementById('worker-select-area');
                con.innerHTML = res.map(w => `
                    <label class="flex items-center gap-3 border p-3 rounded-lg bg-white shadow-sm cursor-pointer hover:bg-blue-50 transition">
                        <input type="checkbox" name="Worker_${w.WorkerID}" value='${JSON.stringify(w)}' class="w-5 h-5 accent-blue-600 rounded"> 
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${escapeHtml(w.Name)}</div>
                            <div class="text-xs text-gray-500">${w.IDType}: ${w.ID}</div>
                        </div>
                    </label>`).join(''); 
            } else { 
                const t = document.querySelector('#table-workers tbody'); 
                t.innerHTML = "";
                res.forEach(w => {
                    const audit = w.ApprovedBy ? `<div class="text-[10px] text-gray-500">By ${w.ApprovedBy}<br>${w.ApprovedAt}</div>` : '-';
                    let actions = '';
                    if(currentUser.Role === 'Requester') {
                        actions = `<button class="text-red-600 font-bold hover:underline text-xs" onclick="workerAction('${w.WorkerID}', 'delete')">Delete</button>`;
                    } else if (w.Status.includes('Pending')) {
                        actions = `<button class="text-green-600 font-bold text-xs mr-2" onclick="workerAction('${w.WorkerID}', 'approve')">Approve</button>
                                   <button class="text-red-600 font-bold text-xs" onclick="workerAction('${w.WorkerID}', 'reject')">Reject</button>`;
                    }

                    t.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b border-gray-100">
                            <td class="p-3 font-bold">${escapeHtml(w.Name)}</td>
                            <td class="p-3 font-mono text-xs">${escapeHtml(w.IDType)}: ${escapeHtml(w.ID)}</td>
                            <td class="p-3 text-xs">${escapeHtml(w.Role || 'Worker')}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${w.Status.includes('Approved')?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}">${w.Status}</span></td>
                            <td class="p-3">${audit}</td>
                            <td class="p-3">${actions}</td>
                        </tr>`;
                });
            } 
        }
        
        async function workerAction(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role, ApproverName: currentUser.Name}); loadWorkers('mgmt'); }

        async function upd(act) {
            let ioclData = getIOCLData('iocl-sup-container-rev'); 
            if(currentUser.Role === 'Approver') ioclData = getIOCLData('iocl-sup-container-app');

            const body = { 
                PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.Name,
                IOCLSupervisors: ioclData,
                comment: (currentUser.Role==='Reviewer' ? getVal("Reviewer_Remarks") : getVal("Approver_Remarks")),
                AdditionalPrecautions: getVal("AdditionalPrecautions"),
                RequireRenewalPhotos: document.getElementById('RequireRenewalPhotos').checked ? 'Y' : 'N',
                PdfBgColor: getVal('PdfBgColor'),
                Closure_Reviewer_Remarks: getVal('Closure_Reviewer_Remarks'),
                Closure_Approver_Remarks: getVal('Closure_Approver_Remarks'),
                Site_Restored_Check: document.getElementById("Site_Restored_Check").checked ? 'Y' : 'N'
            };
            
            if(currentUser.Role === 'Reviewer' && act === 'review') {
                 document.querySelectorAll('input[type=checkbox]').forEach(c => body[c.name] = c.checked ? 'Y' : 'N');
                 document.querySelectorAll('input[type=radio]:checked').forEach(r => body[r.name] = r.value);
            }

            const res = await apiCall('/update-status', 'POST', body);
            if(res.success) { alert("Status Updated"); switchView('dashboard'); } else alert(res.error);
        }

        function addIOCLRow(containerId, data=null) {
             const div = document.createElement('div'); div.className = "flex gap-2 items-center mb-2 iocl-row";
             div.innerHTML = `
                <input class="iocl-name border p-1 w-1/3 text-xs rounded" placeholder="Name" value="${data?data.name:''}">
                <input class="iocl-desig border p-1 w-1/3 text-xs rounded" placeholder="Desig" value="${data?data.desig:''}">
                <input class="iocl-contact border p-1 w-1/3 text-xs rounded" placeholder="Contact" value="${data?data.contact:''}">
                <button type="button" class="text-red-500 font-bold px-2" onclick="this.parentElement.remove()">x</button>
             `;
             document.getElementById(containerId).appendChild(div);
        }
        function getIOCLData(containerId) {
             const rows = document.querySelectorAll(`#${containerId} .iocl-row`);
             const arr = [];
             rows.forEach(r => {
                 arr.push({
                     name: r.querySelector('.iocl-name').value,
                     desig: r.querySelector('.iocl-desig').value,
                     contact: r.querySelector('.iocl-contact').value,
                     added_by: currentUser.Name, added_at: getNow()
                 });
             });
             return arr;
        }
        function renderIOCLTable() {
            const t = document.querySelector('#table-iocl-display tbody'); t.innerHTML = '';
            if(!currentPermitIOCLData || currentPermitIOCLData.length === 0) { t.innerHTML = '<tr><td colspan="4" class="text-gray-400">None</td></tr>'; return; }
            currentPermitIOCLData.forEach(x => {
                t.innerHTML += `<tr><td>${x.name}</td><td>${x.desig}</td><td>${x.contact}</td><td class="text-xs text-gray-500">By ${x.added_by}</td></tr>`;
            });
            document.getElementById('iocl-sup-display-section').classList.remove('hidden');
        }
        document.getElementById('btn-add-rev-sup').onclick = () => addIOCLRow('iocl-sup-container-rev');
        document.getElementById('btn-add-app-sup').onclick = () => addIOCLRow('iocl-sup-container-app');
        
        async function savePermit() {
            if(!document.getElementById('gsr-check').checked) return alert("You must accept Golden Safety Rules.");
            
            const getVal = (id) => document.getElementById(id).value;
            const validFrom = new Date(getVal("ValidFrom"));
            const validTo = new Date(getVal("ValidTo"));
            
            // REQ E: Permit Validity Validation
            if(isNaN(validFrom) || isNaN(validTo)) return alert("Please enter valid dates.");
            if(validTo <= validFrom) return alert("Permit 'Valid To' must be after 'Valid From'.");
            const durationHrs = (validTo - validFrom) / (1000 * 60 * 60);
            if(durationHrs > 168) return alert("Permit duration cannot exceed 7 days (168 Hours).");

            // REQ F: 1st Renewal Validation
            if(document.getElementById('chk-init-renewal').checked) {
                const renFrom = new Date(getVal("InitRenFrom"));
                const renTo = new Date(getVal("InitRenTo"));
                if(isNaN(renFrom) || isNaN(renTo)) return alert("Please enter valid renewal dates.");
                if(renTo <= renFrom) return alert("Renewal End Time must be greater than Start Time.");
                const renDuration = (renTo - renFrom) / (1000 * 60 * 60);
                if(renDuration > 8) return alert("Renewal period cannot exceed 8 Hours.");
                
                // Nested validity check
                if(renFrom < validFrom || renTo > validTo) return alert("Renewal dates must be within the main Permit Validity period.");
            }

            const fd = new FormData(document.getElementById("pf"));
            document.querySelectorAll('input[type="checkbox"]').forEach(c => { if(c.name) fd.set(c.name, c.checked ? "Y" : "N"); });
            fd.set("GSR_Accepted", "Y");
            const selectedWorkers = [];
            document.querySelectorAll('#worker-select-area input:checked').forEach(c => selectedWorkers.push(JSON.parse(c.value)));
            fd.append("SelectedWorkers", JSON.stringify(selectedWorkers));
            if(currentUser) fd.append("RequesterEmail", currentUser.Email);
            
            // Add custom gas test inputs
            fd.append("GP_Q12_HC", document.getElementsByName('GP_Q12_HC')[0]?.value || "");
            fd.append("GP_Q12_ToxicGas", document.getElementsByName('GP_Q12_ToxicGas')[0]?.value || "");
            fd.append("GP_Q12_Oxygen", document.getElementsByName('GP_Q12_Oxygen')[0]?.value || "");

            // Capture all Remarks
            document.querySelectorAll('input[name$="_Rem"]').forEach(rem => {
                if(rem.value) fd.append(rem.name, rem.value);
            });

            const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Permit Created: "+json.permitId); switchView('dashboard'); } else alert(json.error);
        }

        // --- ADMIN FUNCTIONS ---
        async function uploadBulkUsers() {
            const file = document.getElementById('bulk-excel').files[0];
            if(!file) return alert("Select file");
            const fd = new FormData(); fd.append('excelFile', file);
            document.getElementById('loader').style.display = 'flex';
            const res = await fetch(API+'/admin/bulk-upload', { method: 'POST', headers: {'Authorization': `Bearer ${authToken}`}, body: fd });
            const json = await res.json();
            document.getElementById('loader').style.display = 'none';
            alert(json.success ? "Success" : json.error);
        }

        async function resetUserPassword() {
            const email = document.getElementById('reset-email').value; const pass = document.getElementById('reset-temp-pass').value;
            const res = await apiCall('/admin/reset-password', 'POST', {targetEmail: email, newTempPass: pass});
            alert(res.success ? "Reset Done" : res.error);
        }

        function getGeo() {
             if(!navigator.geolocation) return alert("Geo not supported");
             navigator.geolocation.getCurrentPosition(p => {
                 document.getElementById('ExactLocation').value = `${p.coords.latitude.toFixed(6)}, ${p.coords.longitude.toFixed(6)}`;
                 document.getElementById('Latitude').value = p.coords.latitude;
                 document.getElementById('Longitude').value = p.coords.longitude;
             });
        }
        function logout() { location.reload(); }
        
        async function loadStats(data) {
            if(!data) return;
            document.getElementById('charts-container').classList.remove('hidden');
            const ctx = document.getElementById('chartStatus').getContext('2d');
            if(chartS) chartS.destroy();
            const counts = {}; data.forEach(d => counts[d.Status] = (counts[d.Status]||0)+1);
            chartS = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#f87171', '#4ade80', '#94a3b8'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
        }

        initLogin();
    </script>
</body>
</html>
