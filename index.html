<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>ERPL Mainline Permit System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyADwuqMDCwNSaZKBnWURDCYdqlMxfiWBnU" async></script>

    <style nonce="NONCE_PLACEHOLDER">
        /* GLOBAL SETTINGS */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; margin: 0; padding: 0; }
        
        /* UTILITIES */
        .hidden { display: none !important; }
        .glass { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        
        /* FORM ELEMENTS */
        input, select, textarea { width: 100%; border: 1px solid #d1d5db !important; padding: 10px 12px; border-radius: 8px; font-size: 0.9rem; background: #fff; margin-bottom: 0.5rem; }
        input:focus, select:focus, textarea:focus { border-color: #ea580c !important; outline: none; box-shadow: 0 0 0 2px #fdba74; }
        input:disabled, select:disabled, textarea:disabled { background-color: #f9fafb; color: #6b7280; border-color: #e5e7eb !important; cursor: not-allowed; }
        
        /* LOADER */
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #ea580c; border-radius: 50%; width: 60px; height: 60px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        #main-wrapper { display: flex; height: 100vh; width: 100vw; }
        .sidebar-left { width: 260px; background: #1e293b; color: white; display: flex; flex-direction: column; flex-shrink: 0; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 40; }
        .sidebar-right { width: 320px; background: white; border-left: 1px solid #e5e7eb; overflow-y: auto; flex-shrink: 0; padding: 1.5rem; display: flex; flex-direction: column; gap: 20px; z-index: 30; } 
        .content-area { flex-grow: 1; overflow-y: auto; padding: 2rem; background: #f8fafc; position: relative; scroll-behavior: smooth; }

        /* GRID & TABLES */
        .checklist-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f1f5f9; color: #475569; font-weight: 700; padding: 0.75rem; text-align: left; font-size: 0.8rem; border-bottom: 2px solid #e2e8f0; }
        .data-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; vertical-align: middle; }
        .data-table tr:hover { background: #f8fafc; cursor: pointer; }

        /* RESPONSIVE */
        @media(max-width: 1280px) { .checklist-grid { grid-template-columns: repeat(2, 1fr); } }
        @media(max-width: 1024px) { .sidebar-right { display: none; } .checklist-grid { grid-template-columns: 1fr; } }
        @media(max-width: 768px) { 
            .sidebar-left { position: absolute; left: -260px; height: 100%; } 
            .sidebar-left.open { left: 0; }
            .checklist-grid { grid-template-columns: 1fr; }
            .mobile-table th { display: none; }
            .mobile-table td { display: block; width: 100%; border: none; padding: 4px 8px; }
            .mobile-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        }

        .nav-item { padding: 1rem 1.25rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #94a3b8; transition: all 0.2s; border-left: 4px solid transparent; font-weight: 500; }
        .nav-item:hover { background: #334155; color: white; }
        .nav-item.active { background: #0f172a; color: white; border-left-color: #ea580c; }
        .marked-deleted { text-decoration: line-through; opacity: 0.6; background-color: #fee2e2; }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <div class="mt-6 font-bold text-orange-600 animate-pulse text-xl">Processing...</div>
    </div>

    <div id="view-login" class="fixed inset-0 bg-orange-50 z-50 flex items-center justify-center p-4">
        <div class="glass w-full max-w-md shadow-2xl border-t-4 border-orange-600 p-8">
            <div class="text-center mb-6">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <img src="/public/logo.png" class="h-16 object-contain">
                    <img src="/public/rhino.png" class="h-16 object-contain">
                </div>
                <h1 class="text-3xl font-extrabold text-orange-600">IndianOil ERPL</h1>
                <p class="text-gray-500 font-semibold mt-2">Work Permit System</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg border space-y-3">
                    <select id="login-region" class="w-full"><option value="">Loading...</option></select>
                    <select id="login-unit" class="w-full" disabled><option value="">Select Region</option></select>
                    <select id="login-loc" class="w-full" disabled><option value="">Select Unit</option></select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="login-role">
                        <option value="Requester">Requester</option>
                        <option value="Reviewer">Reviewer</option>
                        <option value="Approver">Approver</option>
                        <option value="MasterAdmin">MasterAdmin</option>
                    </select>
                    <select id="login-user" disabled><option>Select Loc</option></select>
                </div>
                <input type="password" id="login-pass" placeholder="Password">
                <button type="submit" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-orange-700">Login</button>
            </form>
        </div>
    </div>

    <div id="view-pwd-change" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div class="glass w-full max-w-sm border-l-8 border-red-600 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-2xl text-red-600">Password Update</h3>
                <button onclick="document.getElementById('view-pwd-change').classList.add('hidden')" class="text-gray-500 font-bold">‚úï</button>
            </div>
            <input type="password" id="new-pwd-1" placeholder="New Password" class="mb-4">
            <input type="password" id="new-pwd-2" placeholder="Confirm Password" class="mb-6">
            <button id="btn-force-pwd" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-md">Update Password</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="main-wrapper">
            
            <div class="sidebar-left" id="sidebar">
                <div class="p-6 font-bold text-xl text-orange-500 border-b border-gray-700 flex items-center gap-2 bg-gray-900">
                    <img src="/public/rhino.png" class="h-8 w-8 bg-white rounded-full p-1"> <span>ERPL Permit</span>
                </div>
                <div id="user-display" class="p-5 text-xs text-gray-300 bg-gray-800 border-b border-gray-700 font-mono"></div>
                <nav class="flex-1 overflow-y-auto mt-4 space-y-1 px-3">
                    <div class="nav-item active" onclick="switchView('dashboard')" id="nav-dashboard"><span>üìä</span> Dashboard</div>
                    <div class="nav-item hidden" onclick="switchView('new-permit')" id="nav-new-permit"><span>üìù</span> Create Permit</div>
                    <div class="nav-item" onclick="switchView('workers')" id="nav-workers"><span>üë∑</span> Workers</div>
                    <div class="nav-item hidden" id="nav-users" onclick="switchView('users')"><span>üë•</span> User Mgmt</div>
                    <div class="nav-item hidden" onclick="switchView('map')" id="nav-map"><span>üó∫Ô∏è</span> Map View</div>
                    <div class="nav-item hidden" id="nav-admin" onclick="switchView('admin')"><span>üîê</span> Admin</div>
                </nav>
                <div class="p-4 border-t border-gray-700 bg-gray-900 flex flex-col gap-2">
                    <div class="nav-item text-blue-400 hover:bg-blue-900/30 rounded justify-center" onclick="showChangePassword()"><span>üîë</span> Change Pwd</div>
                    <div class="nav-item text-red-400 hover:bg-red-900/30 rounded justify-center" onclick="location.reload()"><span>üö™</span> Sign Out</div>
                </div>
            </div>

            <div class="content-area">
                <button class="md:hidden mb-4 text-gray-600 bg-white p-2 rounded shadow" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞ Menu</button>
                
                <div id="view-dashboard">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <button id="dash-btn-new" onclick="switchView('new-permit')" class="hidden bg-orange-600 text-white px-4 py-2 rounded shadow font-bold">+ New Permit</button>
                    </div>
                    <div id="dashboard-content" class="space-y-6">
                        <h3 class="font-bold text-gray-500 text-xs uppercase mb-2">Action Required</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-pending"><thead class="bg-red-50 text-red-900"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                        <h3 class="font-bold text-gray-500 text-xs uppercase mb-2">Active Permits</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-active"><thead class="bg-green-50 text-green-900"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                        <h3 class="font-bold text-gray-500 text-xs uppercase mb-2">Archive</h3>
                        <div class="glass overflow-x-auto p-0"><table class="mobile-table w-full text-left text-sm data-table" id="table-other"><thead class="bg-gray-50 text-gray-700"><tr><th class="p-3">ID</th><th>Type</th><th>Location</th><th>Status</th><th>Date</th></tr></thead><tbody class="divide-y divide-gray-100"></tbody></table></div>
                    </div>
                </div>

                <div id="view-form" class="hidden">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50/95 backdrop-blur z-20 py-2 border-b">
                        <button onclick="switchView('dashboard')" class="text-blue-600 font-bold">‚Üê Back</button>
                        <div class="text-right"><h2 class="text-xl font-bold text-gray-800" id="permit-title">New</h2><div id="permit-header-display" class="text-xs text-blue-600 font-bold"></div></div>
                    </div>

                    <form id="pf" class="max-w-7xl mx-auto space-y-4 pb-20">
                        <input type="hidden" id="PermitID" name="PermitID">
                        <input type="hidden" id="Status" name="Status">
                        
                        <div class="glass border-t-4 border-orange-500">
                            <h3 class="font-bold text-orange-600 border-b pb-2 mb-4">1. Basic Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label class="text-xs font-bold text-gray-500">Work Type</label><select name="WorkType" id="WorkType"><option>Hot</option><option>Cold</option><option>Confined Space</option><option>Excavation</option></select></div>
                                <div><label class="text-xs font-bold text-gray-500">Specific Work</label><input name="WorkTypeOther" id="WorkTypeOther"></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">GPS</label><div class="flex gap-2"><input name="ExactLocation" id="ExactLocation" class="flex-1"><button type="button" onclick="getGeo()" class="bg-blue-100 text-blue-700 px-3 rounded font-bold">Get</button></div><input type="hidden" id="Latitude" name="Latitude"><input type="hidden" id="Longitude" name="Longitude"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Region/Unit/Location</label><input name="LocationUnit" id="LocationUnit" readonly class="bg-gray-100 font-bold"></div>
                                <div><label class="text-xs font-bold text-gray-500">Location Details</label><input name="WorkLocationDetail"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Valid From</label><input type="datetime-local" name="ValidFrom" id="ValidFrom" onchange="validateDates()"></div>
                                <div><label class="text-xs font-bold text-gray-500">Valid To</label><input type="datetime-local" name="ValidTo" id="ValidTo" onchange="validateDates()"></div>
                                
                                <div><label class="text-xs font-bold text-gray-500">Requester</label><input name="RequesterName" id="RequesterName"></div>
                                <div><label class="text-xs font-bold text-gray-500">Vendor</label><input name="Vendor" id="Vendor" readonly class="bg-gray-100"></div>
                                
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Issued To Dept</label><input name="IssuedToDept"></div>
                                <div><label class="text-xs font-bold text-gray-500">Security Guard</label><input name="SecurityGuard"></div>
                                <div><label class="text-xs font-bold text-gray-500">Emergency Contact</label><input name="EmergencyContact"></div>
                                <div><label class="text-xs font-bold text-gray-500">Fire Stn/Hosp</label><input name="FireStation"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-gray-500">Description</label><textarea name="Desc" rows="2"></textarea></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Reviewer</label><select name="ReviewerEmail" id="ReviewerEmail"></select></div>
                                <div class="md:col-span-2"><label class="text-xs font-bold text-gray-500">Assign Approver</label><select name="ApproverEmail" id="ApproverEmail"></select></div>
                            </div>
                        </div>

                        <div id="init-renewal-wrapper" class="glass border-l-4 border-purple-500 bg-purple-50">
                            <label class="flex items-center gap-2 font-bold cursor-pointer text-purple-800">
                                <input type="checkbox" name="InitRen" value="Y" id="chk-init-renewal" onchange="toggleInitRenewal()"> Request 1st Renewal with Permit
                            </label>
                            <div id="div-init-renewal" class="hidden mt-3 p-3 bg-white rounded border border-purple-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                                    <input type="datetime-local" name="InitRenFrom" placeholder="From">
                                    <input type="datetime-local" name="InitRenTo" placeholder="To">
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    <input name="InitRenHC" placeholder="HC %" readonly class="bg-gray-100">
                                    <input name="InitRenTox" placeholder="Tox" readonly class="bg-gray-100">
                                    <input name="InitRenO2" placeholder="O2 %" readonly class="bg-gray-100">
                                </div>
                                <input name="InitRenPrec" placeholder="Special Precautions for Renewal" class="w-full mt-2">
                            </div>
                        </div>

                        <div id="checklists-container" class="space-y-4"></div>

                        <div class="glass border-t-4 border-blue-500">
                            <h3 class="font-bold text-blue-600 border-b pb-2 mb-4">3. Workers</h3>
                            <div id="worker-select-area" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
                            <div id="worker-display-table" class="hidden overflow-x-auto mt-2"><table class="mobile-table w-full text-xs text-left"><thead class="bg-gray-100"><tr><th>Name</th><th>ID</th><th>Contact</th></tr></thead><tbody id="worker-display-body"></tbody></table></div>
                        </div>

                        <div class="glass border-t-4 border-red-500">
                            <h3 class="font-bold text-red-600 border-b pb-2 mb-4">4. Hazards & PPE</h3>
                            <div id="hazards-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4"></div>
                            <div id="other-hazard-div" class="hidden mb-2"><input name="H_Others_Detail" placeholder="Specify other..." class="w-full"></div>
                            <div id="ppe-section-wrapper" class="hidden">
                                <h4 class="font-bold text-gray-500 text-xs uppercase mb-2">PPE Required (Reviewer)</h4>
                                <div id="ppe-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
                            </div>
                        </div>

                        <div id="gsr-container" class="glass border-l-4 border-orange-600 bg-orange-50 hidden">
                            <label class="flex items-start gap-3 p-2 cursor-pointer">
                                <input type="checkbox" id="gsr-check" class="mt-1 w-6 h-6 text-orange-600">
                                <span class="text-sm font-bold text-gray-800 text-justify">I have read, understood and accepted all terms, conditions and non-compliance penalty of IOCL Golden Safety Rules.</span>
                            </label>
                        </div>

                        <div id="fs-reviewer-section" class="glass hidden border-l-4 border-yellow-500">
                            <h3 class="font-bold text-yellow-700 border-b pb-2 mb-4">4. Reviewer</h3>
                            <div class="mb-4 hidden" id="iocl-reviewer-wrapper">
                                <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-rev" class="space-y-2 mt-2"></div>
                                <button type="button" id="btn-add-rev-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
                            </div>
                            <textarea name="Reviewer_Remarks" id="Reviewer_Remarks" placeholder="Reviewer Remarks" class="w-full"></textarea>
                            <textarea name="AdditionalPrecautions" id="AdditionalPrecautions" placeholder="Additional Precautions" class="w-full mt-2"></textarea>
                        </div>

                        <div id="fs-approver-section" class="glass hidden border-l-4 border-green-500">
                            <h3 class="font-bold text-green-700 border-b pb-2 mb-4">5. Approval</h3>
                            <div class="mb-4 hidden" id="iocl-approver-wrapper">
                                <label class="font-bold text-sm text-gray-700">Authorized IOCL Supervisors</label>
                                <div id="iocl-sup-container-app" class="space-y-2 mt-2"></div>
                                <button type="button" id="btn-add-app-sup" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded font-bold">+ Add Supervisor</button>
                            </div>
                            <textarea name="Approver_Remarks" id="Approver_Remarks" placeholder="Approver Remarks" class="w-full mb-2"></textarea>
                            <label class="flex items-center gap-2 mb-2 p-2 bg-green-50 border border-green-200 rounded cursor-pointer">
                                <input type="checkbox" name="RequireRenewalPhotos" id="RequireRenewalPhotos" value="Y" class="w-5 h-5 accent-green-600">
                                <span class="text-sm font-bold text-green-800">Require Photo Evidence for ALL Renewals?</span>
                            </label>
                            <div id="pdf-color-select" class="mt-2 hidden"><label>PDF Background:</label><select id="PdfBgColor"><option>White</option><option>Red</option><option>Green</option><option>Yellow</option><option>Auto</option></select></div>
                        </div>

                        <div id="iocl-sup-display-section" class="glass hidden">
                            <h3 class="font-bold border-b pb-2 mb-2">Authorized Supervisors (IOCL)</h3>
                            <table class="mobile-table w-full text-xs text-left" id="table-iocl-display"><thead><tr><th>Name</th><th>Designation</th><th>Contact</th><th>Audit Trail</th></tr></thead><tbody></tbody></table>
                        </div>

                        <div id="renewals-section" class="glass hidden border-l-4 border-purple-500 bg-purple-50/20">
                            <h3 class="font-bold text-purple-700 border-b pb-2 mb-4">üìÖ Renewal History</h3>
                            <div id="first-renewal-decision" class="hidden mb-4 p-4 border-2 border-purple-500 bg-purple-50 rounded-lg animate-pulse">
                                <h4 class="font-bold text-purple-900 mb-2">‚ö° 1st Renewal Request Action</h4>
                                <div class="flex gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer font-bold text-green-700"><input type="radio" name="FirstRenewalAction" value="accept" class="w-5 h-5 accent-green-600"> Approve Renewal</label>
                                    <label class="flex items-center gap-2 cursor-pointer font-bold text-red-700"><input type="radio" name="FirstRenewalAction" value="reject" class="w-5 h-5 accent-red-600"> Reject Renewal</label>
                                </div>
                            </div>
                            <div class="overflow-x-auto mb-4 bg-white rounded shadow-sm border">
                                <table class="mobile-table w-full text-xs text-left data-table" id="table-renewals"><thead class="bg-purple-100"><tr><th>Period</th><th>Gas/Prec</th><th>Workers</th><th>Photo</th><th>Requester</th><th>Status</th></tr></thead><tbody id="renewal-history-body"></tbody></table>
                            </div>
                            <div id="form-renewal" class="hidden bg-white p-4 rounded border border-purple-200 shadow-sm">
                                <h4 class="font-bold text-sm mb-2 text-purple-800">New Renewal Request</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-2">
                                    <input type="datetime-local" id="RenewalValidFrom">
                                    <input type="datetime-local" id="RenewalValidTo">
                                    <input id="RenewalHC" placeholder="HC %">
                                    <input id="RenewalOxygen" placeholder="O2 %">
                                </div>
                                <input id="RenewalPrec" placeholder="Specific Precautions for this shift" class="mb-2">
                                <div class="mb-2 bg-indigo-50 p-2 rounded border border-indigo-200">
                                    <label class="flex items-start gap-2 cursor-pointer">
                                        <input type="checkbox" id="OddHourSafetyCheck" class="mt-1 w-5 h-5 accent-indigo-600">
                                        <span class="text-xs font-bold text-indigo-900">I agree to ensure proper lighting/safety for odd-hour work.</span>
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs font-bold text-gray-500 block mb-1">Select Workers</label>
                                    <div class="bg-gray-50 p-2 rounded border max-h-32 overflow-y-auto grid grid-cols-2 gap-2" id="renewal-worker-select"></div>
                                </div>
                                <div id="renewal-photo-wrapper" class="hidden mb-2 p-2 bg-red-50 border border-red-200 rounded">
                                    <label class="block text-xs font-bold text-red-700 uppercase mb-1">üì∏ Mandatory Site Photo</label>
                                    <input type="file" id="ren-cam-sub" accept="image/*" class="w-full text-sm bg-white border p-1 rounded">
                                </div>
                                <button type="button" onclick="submitRenewal('pending_review')" class="w-full bg-purple-600 text-white py-2 rounded font-bold shadow">Submit Request</button>
                            </div>

                            <div id="action-renewal" class="hidden p-4 bg-yellow-50 mt-2 rounded border border-yellow-200">
                                <textarea id="RenewalRemark" placeholder="Rejection Reason / Remarks" class="w-full mb-2"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button" id="btn-approve-renewal" class="bg-green-600 text-white py-2 rounded font-bold shadow">Approve</button>
                                    <button type="button" id="btn-reject-renewal" class="bg-red-600 text-white py-2 rounded font-bold shadow">Reject</button>
                                </div>
                            </div>
                        </div>

                        <div id="closure-section" class="glass hidden border-l-4 border-gray-600">
                            <h3 class="font-bold text-gray-700 border-b pb-2 mb-4">Closure</h3>
                            <label class="flex items-center gap-2 mb-4 font-bold text-red-600 p-3 bg-red-50 rounded border border-red-100 cursor-pointer">
                                <input type="checkbox" id="Site_Restored_Check" name="Site_Restored_Check" class="w-5 h-5 accent-red-600"> I confirm Site is Restored.
                            </label>
                            <div id="div-closure-req" class="hidden space-y-2">
                                <label class="text-xs font-bold text-gray-500">Requester Remarks</label>
                                <textarea id="Closure_Requestor_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-req" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-rev" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Reviewer Remarks</label>
                                <textarea id="Closure_Reviewer_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-rev" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                            <div id="div-closure-app" class="hidden mt-4 space-y-2 border-t pt-4">
                                <label class="text-xs font-bold text-gray-500">Approver Remarks</label>
                                <textarea id="Closure_Approver_Remarks" placeholder="Remarks" class="w-full"></textarea>
                                <span id="ts-clos-app" class="text-xs text-gray-400 block text-right font-mono"></span>
                            </div>
                        </div>

                        <div class="glass" id="section-e">
                            <h3 class="font-bold text-gray-600 border-b pb-2 mb-4">E. References</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input name="SopNo" id="SopNo" placeholder="SOP/SWP/SMP No"><input name="JsaNo" id="JsaNo" placeholder="JSA No">
                                <input name="IoclEquip" id="IoclEquip" placeholder="IOCL Equip"><input name="ContEquip" id="ContEquip" placeholder="Contractor Equip">
                                <input name="WorkOrder" id="WorkOrder" placeholder="Work Order No"><input name="ToolBoxTalk" id="ToolBoxTalk" placeholder="Tool Box Talk Ref"> 
                            </div>
                        </div>

                        <div id="signature-history" class="glass hidden">
                            <h3 class="font-bold mb-2">History</h3>
                            <div class="grid grid-cols-1 gap-2 text-xs">
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Approval:</strong> <span id="sig-app" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Renewal:</strong> <span id="sig-ren" class="text-right"></span></div>
                                <div class="border p-3 rounded bg-gray-50 flex justify-between"><strong>Closure:</strong> <span id="sig-clos" class="text-right"></span></div>
                            </div>
                        </div>

                        <div id="actions-bar" class="flex flex-col md:flex-row justify-end gap-3 bg-white p-4 shadow sticky bottom-0 z-40 rounded-t-lg"></div>
                    </form>
                </div>

                <div id="view-workers" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Worker Management</h2>
                        <button onclick="openWorkerModal()" class="bg-blue-600 text-white px-4 py-2 rounded shadow font-bold">+ Add Worker</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-workers"><thead class="bg-gray-100"><tr><th>Name</th><th>ID</th><th>Role</th><th>Status</th><th>Approval Info</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>

                <div id="view-users" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">User Management</h2>
                        <button onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="bg-purple-600 text-white px-4 py-2 rounded shadow font-bold">+ Add User</button>
                    </div>
                    <div class="glass overflow-x-auto p-0"><table class="w-full text-sm text-left data-table" id="table-manage-users"><thead class="bg-gray-100"><tr><th>Name</th><th>Email</th><th>Role</th><th>Location</th><th>Action</th></tr></thead><tbody class="divide-y"></tbody></table></div>
                </div>

                <div id="view-admin" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Master Admin Console</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass border-t-4 border-green-600">
                             <h3 class="font-bold text-lg mb-2 text-green-800">üë§ Add Single User</h3>
                             <p class="text-xs text-gray-500 mb-4 bg-green-50 p-2 rounded">Create a single user manually.</p>
                             <button onclick="document.getElementById('view-add-user').classList.remove('hidden')" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">+ Create User</button>
                        </div>
                        <div class="glass border-t-4 border-purple-600">
                            <h3 class="font-bold text-lg mb-2 text-purple-800">üìÇ Bulk User Upload</h3>
                            <p class="text-xs text-gray-500 mb-4 bg-purple-50 p-2 rounded">Upload Excel (.xlsx).</p>
                            <input type="file" id="bulk-excel" accept=".xlsx" class="mb-4 w-full">
                            <button onclick="uploadBulkUsers()" class="w-full bg-purple-600 text-white py-2 rounded font-bold">Upload & Map</button>
                        </div>
                        <div class="glass border-t-4 border-red-600">
                            <h3 class="font-bold text-lg mb-2 text-red-800">üîë Global Reset Password</h3>
                            <input id="reset-email" placeholder="User Email" class="mb-2 w-full">
                            <input id="reset-temp-pass" placeholder="Temp Password" class="mb-2 w-full">
                            <button onclick="resetUserPassword()" class="w-full bg-red-600 text-white py-2 rounded font-bold">Reset Password</button>
                        </div>
                    </div>
                </div>

                <div id="view-map" class="hidden h-full">
                    <h2 class="text-2xl font-bold mb-4">Live Permit Map</h2>
                    <div class="glass h-[600px] w-full p-0 overflow-hidden shadow-inner border-2 border-gray-200 relative"><div id="map" class="w-full h-full"></div></div>
                </div>
            </div>

            <div class="sidebar-right">
                <div class="mb-6" id="charts-container">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Live Stats</h3>
                    <div class="h-40"><canvas id="chartStatus"></canvas></div>
                </div>
                <div id="validity-box" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <div class="text-xs font-bold text-green-800 uppercase">Permit Validity</div>
                    <div id="val-time-from" class="text-sm font-mono font-bold"></div>
                    <div class="text-center text-gray-400 text-xs my-1">‚¨á</div>
                    <div id="val-time-to" class="text-sm font-mono font-bold"></div>
                    <div id="val-status" class="mt-2 inline-block px-3 py-1 rounded-full bg-green-200 text-green-800 text-xs font-bold">ACTIVE</div>
                </div>
                <div><h3 class="text-xs font-bold text-gray-400 uppercase mb-2">Selection Info</h3><div id="right-panel-info" class="text-sm text-gray-500 italic bg-gray-50 p-3 rounded border">Select permit to view details.</div></div>
            </div>
        </div>
    </div>

    <div id="modal-worker" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-lg relative animate-scale-up">
            <button onclick="document.getElementById('modal-worker').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold text-lg mb-4">Worker Details</h3>
            <form id="worker-form-real" class="grid grid-cols-2 gap-3">
                <input id="w-id" type="hidden">
                <input id="w-name" placeholder="Full Name" class="col-span-2" required>
                <input id="w-father" placeholder="Father Name" class="col-span-2" required>
                <input id="w-address" placeholder="Address" class="col-span-2">
                <input id="w-age" placeholder="Age" type="number" required>
                <select id="w-gender"><option>Male</option><option>Female</option></select>
                <input id="w-contact" placeholder="Contact No">
                <select id="w-id-type"><option value="Voter Card">Voter Card</option><option value="PAN Card">PAN Card</option><option value="Other">Other</option></select>
                <input id="w-id-type-other" placeholder="Specify ID" class="hidden col-span-2 bg-yellow-50">
                <input id="w-idcard" placeholder="ID Number" class="col-span-2">
                <button type="submit" class="col-span-2 bg-blue-600 text-white py-3 rounded-lg font-bold shadow">Save Worker</button>
            </form>
        </div>
    </div>

    <div id="view-add-user" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="glass w-full max-w-sm relative animate-scale-up">
            <button onclick="document.getElementById('view-add-user').classList.add('hidden')" class="absolute top-4 right-4 text-xl font-bold text-gray-400">‚úï</button>
            <h3 class="font-bold mb-4 text-lg">Add New User</h3>
            <form id="adduser-form" class="space-y-3">
                <input id="new-user-name" placeholder="Full Name" required>
                <input id="new-user-email" placeholder="Email Address" required>
                <select id="new-user-role"><option>Requester</option><option>Reviewer</option><option>Approver</option></select>
                <input id="new-user-pass" type="password" placeholder="Initial Password" required>
                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold shadow">Create User</button>
            </form>
        </div>
    </div>

    <script nonce="NONCE_PLACEHOLDER">
        const API = "/api";
        let authToken = null, currentUser = null, chartS = null;
        let currentPermitId = null, currentPermitWorkers = [], currentRenewalCount = 0, permitRequirePhoto = false, currentPermitIOCLData = [];

        const CL_DATA = { 
            A: ["1. Equipment/Work Area inspected.", "2. Surrounding area checked.", "3. Manholes covered.", "4. Hazards considered.", "5. Equipment blinded.", "6. Drained.", "7. Steamed.", "8. Flushed.", "9. Fire Access.", "10. Iron Sulfide.", "11. Electrical Isolation.", "12. Gas Test: HC/Toxic/O2", "13. Firefighting.", "14. Cordoned.", "15. CCTV.", "16. Ventilation."], 
            B: ["1. Exit.", "2. Standby.", "3. Gas trap.", "4. Spark shield.", "5. Grounding.", "6. Standby (Confined).", "7. Communication.", "8. Rescue.", "9. Cooling.", "10. Inert Gas.", "11. ELCB.", "12. Cylinders.", "13. Spark arrestor.", "14. Welding loc.", "15. Height."], 
            C: ["1. PESO spark elimination."], 
            D: ["1. Shoring.", "2. Soil distance.", "3. Access.", "4. Vehicle ban."] 
        };
        const HAZARDS = ["Lack of Oxygen", "H2S", "Toxic Gases", "Combustible gases", "Pyrophoric Iron", "Corrosive Chemicals", "cave in formation", "Others"];
        const PPE = ["Helmet", "Safety Shoes", "Hand gloves", "Boiler suit", "Face Shield", "Apron", "Goggles", "Dust Respirator", "Fresh Air Mask", "Lifeline", "Safety Harness", "Airline", "Earmuff", "IFR"];

        async function apiCall(ep, meth="GET", body=null) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const opts = {method:meth, headers:{'Content-Type':'application/json'}, credentials:'include'};
                if(authToken) opts.headers['Authorization'] = `Bearer ${authToken}`;
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(API+ep, opts);
                if(res.status === 401) { location.reload(); return; }
                return await res.json();
            } catch(e) { console.error(e); return {error: "Network Error"}; }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        function safeSet(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function escapeHtml(text) { if (!text) return text; return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }

        // --- INIT & LOGIN ---
        async function initLogin() {
            const regions = await apiCall('/get-hierarchy', 'POST', {});
            document.getElementById('login-region').innerHTML = `<option value="">Select Region</option>` + regions.map(r=>`<option>${r}</option>`).join('');
            
            document.getElementById('login-region').addEventListener('change', async (e) => {
                const uSel = document.getElementById('login-unit'); uSel.disabled=true; uSel.innerHTML='<option>Loading...</option>';
                const units = await apiCall('/get-hierarchy', 'POST', {region: e.target.value});
                uSel.innerHTML = `<option value="">Select Unit</option>` + units.map(u=>`<option>${u}</option>`).join('');
                uSel.disabled = false;
            });
            document.getElementById('login-unit').addEventListener('change', async (e) => {
                const lSel = document.getElementById('login-loc'); lSel.disabled=true; lSel.innerHTML='<option>Loading...</option>';
                const locs = await apiCall('/get-hierarchy', 'POST', {region: document.getElementById('login-region').value, unit: e.target.value});
                lSel.innerHTML = `<option value="">Select Location</option>` + locs.map(l=>`<option>${l}</option>`).join('');
                lSel.disabled = false;
            });
            document.getElementById('login-loc').addEventListener('change', async () => {
                const reg = document.getElementById('login-region').value;
                const unit = document.getElementById('login-unit').value;
                const loc = document.getElementById('login-loc').value;
                const role = document.getElementById('login-role').value;
                if(reg && unit && loc && role) {
                    const uSel = document.getElementById('login-user'); uSel.innerHTML='<option>Loading...</option>';
                    const users = await apiCall('/get-users-by-loc', 'POST', {region:reg, unit:unit, location:loc, role:role});
                    uSel.innerHTML = users.map(u=>`<option value="${u.Email}">${u.Name}</option>`).join('');
                    uSel.disabled = false;
                }
            });
            document.getElementById('login-role').addEventListener('change', () => { if(document.getElementById('login-loc').value) document.getElementById('login-loc').dispatchEvent(new Event('change')); });
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await apiCall('/login', 'POST', {email: document.getElementById('login-user').value, password: document.getElementById('login-pass').value});
            if(res.success) { authToken = res.token; currentUser = res.user; enterApp(); } else if (res.forceChange) {
                 document.getElementById('view-pwd-change').classList.remove('hidden');
                 document.getElementById('view-pwd-change').dataset.email = res.email;
            } else alert(res.msg);
        });

        document.getElementById('btn-force-pwd').addEventListener('click', async () => {
            const p1 = document.getElementById('new-pwd-1').value; const p2 = document.getElementById('new-pwd-2').value;
            const email = document.getElementById('view-pwd-change').dataset.email;
            if(p1 !== p2) return alert("Passwords do not match");
            const res = await apiCall('/force-password-change', 'POST', {email, newPassword: p1});
            if(res.success) { alert("Updated. Please login."); location.reload(); }
        });

        function enterApp() {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').innerHTML = `<div class="font-bold text-white text-lg">${currentUser.Name}</div><div class="text-orange-400 text-xs">${currentUser.Role} | ${currentUser.Location}</div>`;
            
            if(currentUser.Role === 'Requester') document.getElementById('nav-new-permit').classList.remove('hidden');
            if(currentUser.Role === 'MasterAdmin') document.getElementById('nav-admin').classList.remove('hidden');
            if(currentUser.Role === 'Approver' || currentUser.Role === 'MasterAdmin') document.getElementById('nav-users').classList.remove('hidden');
            if(currentUser.Role !== 'Requester') document.getElementById('nav-map').classList.remove('hidden');
            
            renderChecklists(); renderHazards(); switchView('dashboard');
        }

        function showChangePassword() {
             document.getElementById('view-pwd-change').classList.remove('hidden');
             document.getElementById('view-pwd-change').dataset.email = currentUser.Email;
        }
        document.getElementById('btn-close-pwd-modal').addEventListener('click', () => document.getElementById('view-pwd-change').classList.add('hidden'));

        function switchView(viewName) {
            document.querySelectorAll('.content-area > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('view-'+viewName).classList.remove('hidden');
            if(viewName === 'dashboard') loadDashboard();
            if(viewName === 'new-permit') { showNewPermit(); }
            if(viewName === 'workers') loadWorkers();
            if(viewName === 'users') loadManageUsers();
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            const res = await apiCall('/dashboard', 'POST', {role: currentUser.Role, email: currentUser.Email});
            const buildTable = (data, id, col) => {
                document.querySelector(`#${id} tbody`).innerHTML = data.map(p => `
                    <tr onclick="openPermit('${p.PermitID}')" class="border-b hover:bg-${col}-50">
                        <td class="p-3 text-${col}-600 font-bold">${p.PermitID}</td>
                        <td>${p.WorkType}</td><td>${p.LocationUnit}</td>
                        <td><span class="bg-${col}-100 text-${col}-800 text-xs px-2 py-1 rounded">${p.Status}</span></td>
                        <td>${p.ValidFrom.split('T')[0]}</td>
                    </tr>`).join('');
            };
            buildTable(res.filter(p => p.Status.includes('Pending')), 'table-pending', 'red');
            buildTable(res.filter(p => p.Status === 'Active' || p.Status.includes('Renewal')), 'table-active', 'green');
            buildTable(res.filter(p => p.Status.includes('Closed')), 'table-other', 'gray');
            
            if(currentUser.Role !== 'Requester') {
                const ctx = document.getElementById('chartStatus').getContext('2d');
                if(chartS) chartS.destroy();
                const counts = {}; res.forEach(d => counts[d.Status] = (counts[d.Status]||0)+1);
                chartS = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#ef4444', '#22c55e', '#9ca3af'] }] }, options: { plugins: { legend: { position: 'right' } } } });
            }
        }

        // --- PERMIT LOGIC ---
        function showNewPermit() {
            document.getElementById("pf").reset();
            currentPermitId = null;
            document.querySelectorAll('#pf input, #pf select, #pf textarea').forEach(e => e.disabled = false);
            
            // Fix A: Enable Requestor Editing
            safeSet("RequesterName", currentUser.Name);
            // Fix B: Auto-fill Location
            safeSet("LocationUnit", `${currentUser.Region}/${currentUser.Unit}/${currentUser.Location}`);
            safeSet("Vendor", currentUser.Name);
            document.getElementById("Vendor").readOnly = true;

            // Fix C & D: Show Renewal & GSR
            document.getElementById("init-renewal-wrapper").classList.remove('hidden');
            document.getElementById("gsr-container").classList.remove('hidden');
            document.getElementById("ppe-section-wrapper").classList.add('hidden');

            const actionsDiv = document.getElementById("actions-bar"); 
            actionsDiv.innerHTML = `<button type="button" onclick="savePermit()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow hover:bg-blue-700">Submit Application</button>`;
            
            loadMappedUsers('Reviewer', 'ReviewerEmail');
            loadMappedUsers('Approver', 'ApproverEmail');
            loadWorkers('permit_dropdown');
        }

        async function loadMappedUsers(role, elId) {
            const users = await apiCall('/get-users-by-loc', 'POST', { region: currentUser.Region, unit: currentUser.Unit, location: currentUser.Location, role: role });
            document.getElementById(elId).innerHTML = users.map(u => `<option value="${u.Email}">${u.Name}</option>`).join('');
        }

        function renderChecklists() {
            const container = document.getElementById('checklists-container'); container.innerHTML = '';
            Object.keys(CL_DATA).forEach(sec => {
                let itemsHtml = CL_DATA[sec].map((item, i) => {
                    let extra = `<input class="w-full text-xs border-b mt-1" placeholder="Remarks" name="${sec}_${i}_Rem">`;
                    // Fix C: Gas Test Inputs
                    if (sec === 'A' && i === 11) {
                         extra = `<div class="grid grid-cols-3 gap-2 mt-2">
                             <input name="GP_Q12_HC" placeholder="HC % LEL" onchange="autoFillRenGas()">
                             <input name="GP_Q12_ToxicGas" placeholder="Toxic PPM" onchange="autoFillRenGas()">
                             <input name="GP_Q12_Oxygen" placeholder="O2 %" onchange="autoFillRenGas()">
                         </div>`;
                    }
                    return `<div class="p-3 border rounded text-xs"><p class="mb-2 font-bold">${item}</p>
                        <div class="flex gap-2 justify-center">
                            <label><input type="radio" name="${sec}_${i}" value="Y" checked> Y</label>
                            <label><input type="radio" name="${sec}_${i}" value="N"> N</label>
                            <label><input type="radio" name="${sec}_${i}" value="NA"> NA</label>
                        </div>${extra}</div>`;
                }).join('');
                // Fix B: Common Toggle
                container.innerHTML += `<div class="glass"><h4 class="font-bold border-b mb-2">Section ${sec} <span class="text-xs float-right"><label><input type="radio" name="M_${sec}" onchange="toggleAll('${sec}','Y')"> All Y</label> <label><input type="radio" name="M_${sec}" onchange="toggleAll('${sec}','N')"> All N</label></span></h4><div class="checklist-grid">${itemsHtml}</div></div>`;
            });
        }
        function toggleAll(sec, val) { document.querySelectorAll(`input[name^="${sec}_"][value="${val}"]`).forEach(cb => cb.checked = true); }

        function renderHazards() {
            document.getElementById('hazards-grid').innerHTML = HAZARDS.map(h => `<label class="flex gap-2 border p-3 rounded bg-gray-50"><input type="checkbox" name="H_${h.replace(/ /g,'')}" value="Y"> ${h}</label>`).join('');
            document.getElementById('ppe-grid').innerHTML = PPE.map(p => `<label class="flex gap-2 border p-3 rounded bg-gray-50"><input type="checkbox" name="P_${p.replace(/ /g,'')}" value="Y"> ${p}</label>`).join('');
        }

        window.autoFillRenGas = function() {
            if(document.getElementById('chk-init-renewal').checked) {
                safeSet('InitRenHC', getVal('GP_Q12_HC'));
                safeSet('InitRenTox', getVal('GP_Q12_ToxicGas'));
                safeSet('InitRenO2', getVal('GP_Q12_Oxygen'));
            }
        }
        window.toggleInitRenewal = function() {
            document.getElementById('div-init-renewal').classList.toggle('hidden', !document.getElementById('chk-init-renewal').checked);
            autoFillRenGas();
        }

        // Fix E: Date Validation
        window.validateDates = function() {
            const f = new Date(document.getElementById('ValidFrom').value);
            const t = new Date(document.getElementById('ValidTo').value);
            if (f && t) {
                if (f >= t) { alert("End time must be after Start time."); document.getElementById('ValidTo').value = ''; }
                const diff = (t - f) / (1000 * 60 * 60 * 24);
                if (diff > 7) { alert("Max validity is 7 days."); document.getElementById('ValidTo').value = ''; }
            }
        }

        async function openPermit(id) {
            const p = await apiCall('/permit-data', 'POST', {permitId:id});
            currentPermitId = id; 
            document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-form').classList.remove('hidden');
            document.getElementById('permit-title').innerText = id;
            
            document.getElementById('ppe-section-wrapper').classList.toggle('hidden', currentUser.Role === 'Requester');
            document.getElementById('val-status').innerText = p.Status;
            document.getElementById('val-status').className = `mt-2 inline-block px-3 py-1 rounded-full text-xs font-bold ${p.Status==='Active'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}`;

            document.querySelectorAll('#pf input, #pf textarea, #pf select').forEach(e => {
                if(e.type === 'checkbox') e.checked = (p[e.name] === 'Y'); else e.value = p[e.name] || ''; e.disabled = true;
            });
            
            // Fix F: Renewal Table Visibility
            const rens = JSON.parse(p.RenewalsJSON || "[]");
            document.getElementById('renewals-section').classList.remove('hidden');
            document.querySelector('#table-renewals tbody').innerHTML = rens.map(r => `<tr class="border-b"><td class="text-xs">${r.valid_from}<br>${r.valid_to}</td><td>${r.hc}/${r.toxic}/${r.oxygen}</td><td>${r.status}</td></tr>`).join('');
            
            const acts = document.getElementById("actions-bar"); acts.innerHTML = "";
            if(currentUser.Role === 'Reviewer' && p.Status === 'Pending Review') {
                 document.getElementById('Reviewer_Remarks').disabled = false;
                 document.querySelectorAll('#ppe-grid input').forEach(i => i.disabled = false);
                 acts.innerHTML = `<button onclick="upd('reject')" class="bg-red-600 text-white px-4 py-2 rounded">Reject</button><button onclick="upd('review')" class="bg-green-600 text-white px-4 py-2 rounded">Review</button>`;
                 document.getElementById('fs-reviewer-section').classList.remove('hidden');
            }
             if(currentUser.Role === 'Approver' && p.Status === 'Pending Approval') {
                 document.getElementById('Approver_Remarks').disabled = false;
                 acts.innerHTML = `<button onclick="upd('reject')" class="bg-red-600 text-white px-4 py-2 rounded">Reject</button><button onclick="upd('approve')" class="bg-green-600 text-white px-4 py-2 rounded">Approve</button>`;
                 document.getElementById('fs-approver-section').classList.remove('hidden');
            }
        }

        async function savePermit() {
            if(!document.getElementById('gsr-check').checked) return alert("Must accept Golden Safety Rules");
            const fd = new FormData(document.getElementById("pf"));
            document.querySelectorAll('input[type="checkbox"]').forEach(c => fd.set(c.name, c.checked ? "Y" : "N"));
            
            fd.append("GP_Q12_HC", document.getElementsByName('GP_Q12_HC')[0]?.value || "");
            fd.append("GP_Q12_ToxicGas", document.getElementsByName('GP_Q12_ToxicGas')[0]?.value || "");
            fd.append("GP_Q12_Oxygen", document.getElementsByName('GP_Q12_Oxygen')[0]?.value || "");

            document.querySelectorAll('input[name$="_Rem"]').forEach(rem => { if(rem.value) fd.append(rem.name, rem.value); });
            const selectedWorkers = [];
            document.querySelectorAll('#worker-select-area input:checked').forEach(c => selectedWorkers.push(JSON.parse(c.value)));
            fd.append("SelectedWorkers", JSON.stringify(selectedWorkers));
            fd.append("RequesterEmail", currentUser.Email);

            const res = await fetch(API+'/save-permit', {method:'POST', body:fd, headers: {'Authorization': `Bearer ${authToken}`}});
            const json = await res.json();
            if(json.success) { alert("Created: "+json.permitId); switchView('dashboard'); } else alert(json.error);
        }

        async function upd(act) {
            const body = { PermitID: currentPermitId, action: act, role: currentUser.Role, user: currentUser.Name, 
                Reviewer_Remarks: document.getElementById('Reviewer_Remarks').value,
                Approver_Remarks: document.getElementById('Approver_Remarks').value
            };
            document.querySelectorAll('#ppe-grid input').forEach(i => body[i.name] = i.checked ? 'Y' : 'N');
            const res = await apiCall('/update-status', 'POST', body);
            if(res.success) { alert("Updated"); switchView('dashboard'); }
        }

        // --- WORKER LOGIC ---
        async function loadWorkers(ctx) {
            const res = await apiCall('/get-workers', 'POST', {role:currentUser.Role, email:currentUser.Email, context:ctx});
            if(ctx === 'permit_dropdown') {
                document.getElementById('worker-select-area').innerHTML = res.map(w => `<label class="flex gap-2 border p-2 rounded"><input type="checkbox" value='${JSON.stringify(w)}' class="accent-blue-600"> ${w.Name}</label>`).join('');
            } else {
                // Fix I: Edit button logic
                document.querySelector('#table-workers tbody').innerHTML = res.map(w => {
                    const audit = w.ApprovedBy ? `<div class="text-xs text-gray-500">By ${w.ApprovedBy}</div>` : '-';
                    const safeData = JSON.stringify(w).replace(/"/g, '&quot;');
                    const act = currentUser.Role === 'Requester' ? 
                        `<button class="text-blue-600 font-bold text-xs mr-2" onclick="openWorkerModal('edit_request', ${safeData})">Edit</button>
                         <button class="text-red-500 font-bold text-xs" onclick="workerAct('${w.WorkerID}','delete')">Delete</button>` 
                        : (w.Status.includes('Pending') ? `<button class="text-green-600 text-xs" onclick="workerAct('${w.WorkerID}','approve')">Approve</button>` : '-');
                    return `<tr class="border-b"><td class="p-2 font-bold">${w.Name}</td><td>${w.ID}</td><td>${w.Status}</td><td>${audit}</td><td>${act}</td></tr>`;
                }).join('');
            }
        }
        async function workerAct(id, act) { await apiCall('/save-worker', 'POST', {WorkerID:id, Action:act, Role:currentUser.Role}); loadWorkers('mgmt'); }

        // --- SHARED MODAL LOGIC ---
        function openWorkerModal(action = 'create', data = null) { 
            const form = document.getElementById('worker-form-real'); form.reset(); 
            window.currentWorkerAction = action;
            if (action === 'edit_request' && data) {
                document.getElementById('w-id').value = data.WorkerID;
                document.getElementById('w-name').value = data.Name;
                document.getElementById('w-father').value = data.Father;
                document.getElementById('w-address').value = data.Address;
                document.getElementById('w-age').value = data.Age;
                document.getElementById('w-gender').value = data.Gender;
                document.getElementById('w-contact').value = data.Contact;
                document.getElementById('w-idcard').value = data.ID;
                
                const isStd = ["Voter Card", "PAN Card"].includes(data.IDType);
                document.getElementById("w-id-type").value = isStd ? data.IDType : "Other";
                document.getElementById("w-id-type-other").classList.toggle('hidden', isStd);
                if(!isStd) document.getElementById("w-id-type-other").value = data.IDType;
            } else {
                document.getElementById("w-id-type-other").classList.add('hidden');
            }
            document.getElementById('modal-worker').classList.remove('hidden'); 
        }

        document.getElementById('w-id-type').addEventListener('change', (e) => {
            document.getElementById("w-id-type-other").classList.toggle('hidden', e.target.value !== 'Other');
        });

        document.getElementById('worker-form-real').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idTypeRaw = document.getElementById("w-id-type").value;
            const idTypeFinal = idTypeRaw === "Other" ? document.getElementById("w-id-type-other").value : idTypeRaw;
            
            const body = {
                Action: window.currentWorkerAction,
                Role: currentUser.Role,
                RequestorEmail: currentUser.Email,
                RequestorName: currentUser.Name,
                WorkerID: document.getElementById('w-id').value,
                Details: {
                    Name: document.getElementById("w-name").value,
                    Age: document.getElementById("w-age").value,
                    Father: document.getElementById("w-father").value,
                    Address: document.getElementById("w-address").value,
                    Contact: document.getElementById("w-contact").value,
                    ID: document.getElementById("w-idcard").value,
                    Gender: document.getElementById("w-gender").value,
                    IDType: idTypeFinal
                }
            };
            const res = await apiCall('/save-worker', 'POST', body);
            if(res.success) { alert("Saved"); document.getElementById('modal-worker').classList.add('hidden'); loadWorkers('mgmt'); } else alert(res.error);
        });

        function getGeo() { navigator.geolocation.getCurrentPosition(p => { document.getElementById('ExactLocation').value = p.coords.latitude+","+p.coords.longitude; document.getElementById('Latitude').value = p.coords.latitude; document.getElementById('Longitude').value = p.coords.longitude; }); }
        function logout() { location.reload(); }
        async function resetUserPassword() { const res = await apiCall('/admin/reset-password', 'POST', {targetEmail: document.getElementById('reset-email').value, newTempPass: document.getElementById('reset-temp-pass').value}); alert(res.success ? "Done" : "Fail"); }
        async function uploadBulkUsers() { const fd=new FormData(); fd.append('excelFile', document.getElementById('bulk-excel').files[0]); const res=await fetch(API+'/admin/bulk-upload',{method:'POST',headers:{'Authorization':`Bearer ${authToken}`},body:fd}); alert((await res.json()).success?"Done":"Fail"); }

        initLogin();
    </script>
</body>
</html>
